<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.6.2">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2022-07-15T11:49:14+08:00</updated><id>http://localhost:4000/</id><title type="html">æ–‡æµ©</title><subtitle>äº’è”ç½‘ITç•Œçš„æ¬è¿å·¥ï¼Œå…¬ä¼—å·ï¼šä¼¼æ°´ä¼¼æµå¹´</subtitle><author><name>WenHao</name></author><entry><title type="html">2022å¹´åº¦è§„åˆ’è®­ç»ƒè¥-è¯¾å ‚ç»ƒä¹ </title><link href="http://localhost:4000/2022/01/05/%E4%BA%BA%E7%94%9F%E8%AE%BE%E8%AE%A1%E8%AF%BE%E5%B9%B4%E5%BA%A6%E8%A7%84%E5%88%92/" rel="alternate" type="text/html" title="2022å¹´åº¦è§„åˆ’è®­ç»ƒè¥-è¯¾å ‚ç»ƒä¹ " /><published>2022-01-05T00:00:00+08:00</published><updated>2022-01-05T00:00:00+08:00</updated><id>http://localhost:4000/2022/01/05/%E4%BA%BA%E7%94%9F%E8%AE%BE%E8%AE%A1%E8%AF%BE%E5%B9%B4%E5%BA%A6%E8%A7%84%E5%88%92</id><content type="html" xml:base="http://localhost:4000/2022/01/05/%E4%BA%BA%E7%94%9F%E8%AE%BE%E8%AE%A1%E8%AF%BE%E5%B9%B4%E5%BA%A6%E8%A7%84%E5%88%92/">&lt;h1 id=&quot;2022å¹´åº¦è§„åˆ’è®­ç»ƒè¥-è¯¾å ‚ç»ƒä¹ &quot;&gt;&lt;strong&gt;2022å¹´åº¦è§„åˆ’è®­ç»ƒè¥-è¯¾å ‚ç»ƒä¹ &lt;/strong&gt;&lt;/h1&gt;

&lt;h1 id=&quot;question&quot;&gt;Questionï¼š&lt;/h1&gt;

&lt;p&gt;&lt;img src=&quot;https://gitee.com/fwh666/fwh_images/raw/master/fwh_images/image-20220106223252493.png&quot; alt=&quot;image-20220106223252493&quot; style=&quot;zoom:50%;&quot; /&gt;&lt;/p&gt;

&lt;h1 id=&quot;äººç”Ÿç°çŠ¶&quot;&gt;äººç”Ÿç°çŠ¶ï¼š&lt;/h1&gt;

&lt;h2 id=&quot;æˆ‘çš„å®šä½&quot;&gt;æˆ‘çš„å®šä½ï¼š&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;äººç”Ÿ&lt;em&gt;æŸæ‹‰å›¾çš„ç»ˆæä¸‰é—®&lt;/em&gt;ï¼šæˆ‘æ˜¯è°ï¼Ÿæˆ‘ä»å“ªé‡Œæ¥ï¼Ÿè¦åˆ°å“ªé‡Œå»ï¼Ÿ&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;ä¸€ä¸ªè·ç¦»ä¸åˆ°åå¹´çš„æ™®é€šåŒ—æ¼‚ï¼Œä¸€ä¸ªé«˜æ¥¼å¤§å¦é‡Œè¡£è¡«æ•´æ´çš„æ™®é€šç¤¾ç•œï¼Œä¸€ä¸ªæœªå©šå•èº«å¤§é¾„çš„æ™®é€šç”·é’å¹´ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªçƒ­çˆ±æ—…è¡Œçƒ­çˆ±æ‘„å½±çƒ­çˆ±ç”Ÿæ´»çš„ä¼ªæ–‡è‰ºé’å¹´ã€‚å½“ç„¶ä¸€ä¸ªä¸æƒ³å½“è£ç¼çš„å¨å¸ˆä¸æ˜¯ä¸ªå¥½å¸æœºï¼Œä¸€ä¸ªä¸ä¼šæ‹ç…§çš„ç å†œä¸æ˜¯å¥½å¨å­ã€‚&lt;/p&gt;

&lt;p&gt;ä»¥ä¸Šè¯´çš„ä¸€åˆ‡ï¼Œéƒ½æŠµä¸è¿‡æ˜¯çˆ¶æ¯çœ¼ä¸­é‚£ä¸ªå¼•ä»¥ä¸ºå‚²ä¸”é•¿ä¸å¤§çš„æ™®é€šç”·å­©å­ã€‚ï¼ˆPsï¼šç”·äººè‡³æ­»æ˜¯å°‘å¹´ï¼‰&lt;/p&gt;

&lt;h2 id=&quot;æœºé‡å›°å¢ƒ&quot;&gt;æœºé‡&amp;amp;&amp;amp;å›°å¢ƒï¼š&lt;/h2&gt;

&lt;p&gt;äº’è”ç½‘è¡Œä¸šäºŒåè½½æˆå°±äº†è®¸å¤šä¼ å¥‡ï¼ŒåŒ—äº¬ä½œä¸ºä¸€çº¿åŸå¸‚ä¾æ—§æ‰¿è½½äº†è®¸è®¸å¤šå¤šçš„æœºä¼šå’Œå¯èƒ½ã€‚æœ€è¿‘åå¹´å¢é€Ÿå‘å±•æœ€å¿«çš„ç§»åŠ¨äº’è”ç½‘å…¬å¸å¿«æ‰‹ï¼Œå°ç±³ç­‰ç­‰è€³ç†Ÿèƒ½è¯¦çš„ä¼ä¸šéƒ½æ˜¯åœ¨è¿™ä¸ªåŸå¸‚å´›èµ·ã€‚ç›¸ä¿¡æœªæ¥ä¾æ—§ä¼šæœ‰æ›´å¤šçš„ä¼ä¸šåœ¨å¹³å‡¡ä¸­æˆå°±ä¸å¹³å‡¡ã€‚å¼•ç”¨é›·å¸ƒæ–¯çš„â€œç«™åœ¨é£å£ä¸Šï¼ŒçŒªéƒ½é£èµ·æ¥ã€‚â€  è¿™ï¼Œå°±æ˜¯è¿™ä¸ªåŸå¸‚çš„æœºé‡ï¼Œä¹Ÿæ˜¯è¿™ä¸ªåŸå¸‚çš„é­…åŠ›ä¹‹ä¸€ã€‚&lt;/p&gt;

&lt;p&gt;åŒ—äº¬ä½œä¸ºä¸€åº§æ‹¥æœ‰ä¸¤åƒä¸‡äººå£çš„è¶…å¤§å‹åŸå¸‚ï¼Œèµ„æºä¾æ—§æ˜¯è¢«å°‘æ•°äººå æœ‰ï¼Œå¤šæ•°åŒ—æ¼‚é¢ä¸´ç€è®¸å¤šæ¥è‡ªå¸éƒ½ç”Ÿæ´»çš„ä¸å‹å¥½ã€‚&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;æœ‰æ—¶ä¼šæ„Ÿå—åˆ°åœ°åŸŸæ­§è§†ï¼ŒåŒ—äº¬åœŸè‘—é‚£ç§ç”Ÿæ¥é«˜äººä¸€ç­‰çš„ä¼˜è¶Šæ„Ÿï¼Œå˜²è®½å¤–åœ°äººï¼Œä¹Ÿè®¸æ˜¯åœ°åŸŸé»‘ç»™å¼ºåŒ–äº†ã€‚&lt;/li&gt;
  &lt;li&gt;é«˜æˆ¿ç§Ÿä¾æ—§æœ€å¤§å›°å¢ƒä¹‹ä¸€ï¼Œè‡³å°‘å ç”¨æ‰€æœ‰æ”¯å‡ºçš„ä¸‰åˆ†ä¹‹ä¸€ã€‚å½“ç„¶ä¹Ÿä¼šè¡ç”Ÿå…¶ä»–é—®é¢˜ç­‰ç­‰ã€‚&lt;/li&gt;
  &lt;li&gt;å·¥ä½œå‹åŠ›å¤§ã€‚æ˜¯çš„ï¼996åŠ ç­ï¼Œäº’è”ç½‘æ‰“å·¥ä»”çš„äººç”Ÿå¸¸æ€ã€‚&lt;/li&gt;
  &lt;li&gt;é€šå‹¤æ—¶é—´é•¿ã€‚å·¥ä½œæ—¥æœ‰äººä¸æ˜¯åœ¨ä¸Šç­å°±æ˜¯åœ¨ä¸Šç­çš„è·¯ä¸Šï¼Œå‡æœŸæœ‹å‹èšé¤ä¹Ÿè¦æ¨ªè·¨ä¸€ä¸ªåŒºä¸¤ä¸ªå°æ—¶ä¸‰åå¤šå…¬é‡Œã€‚è·ç¦»çš„è¿œçš„æƒ…ä¾£åœ¨åŒ—äº¬è°ˆçš„ä¹Ÿåƒæ˜¯ä¸ªå¼‚åœ°æ‹ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ä¸Šè¿°æƒ…å†µæˆ–å¤šæˆ–å°‘æˆ–æ›¾ç»æˆ–ä»¥åç»å†è¿‡ã€‚æœ‰äº›é—®é¢˜å·²ç»æ”¹å–„ï¼Œä½†æœªæ¥ä¾æ—§ä¼šé¢ä¸´å…¶ä»–å›°å¢ƒã€‚æœºé‡ä¸æŒ‘æˆ˜å¹¶å­˜ï¼Œåœ¨å­¦ä¼šç‹¬å½“ä¸€é¢çš„æ—¶å€™ä¹Ÿè¦å­¦ä¼šæŠŠæ¡æœºé‡ã€‚&lt;/p&gt;

&lt;h1 id=&quot;æœŸå¾…çš„è¿œæ–¹&quot;&gt;æœŸå¾…çš„è¿œæ–¹ï¼š&lt;/h1&gt;

&lt;blockquote&gt;
  &lt;p&gt;PSï¼šğŸ‘‡èƒŒæ™¯éŸ³ä¹ä¼šè‡ªåŠ¨æ’­æ”¾çš„ã€‚ä¸è¡Œå°±æˆ³ä¸€ä¸‹ğŸ‘‡&lt;/p&gt;
  &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/npm/aplayer@1.7.0/dist/APlayer.min.css&quot; /&gt;

  &lt;script src=&quot;https://cdn.jsdelivr.net/npm/aplayer@1.7.0/dist/APlayer.min.js&quot;&gt;&lt;/script&gt;

  &lt;script src=&quot;https://cdn.jsdelivr.net/npm/meting@1.1.0/dist/Meting.min.js&quot;&gt;&lt;/script&gt;

&lt;/blockquote&gt;

&lt;div class=&quot;aplayer&quot; data-id=&quot;413077448&quot; data-server=&quot;netease&quot; data-type=&quot;song&quot; data-mode=&quot;single&quot; data-autoplay=&quot;true&quot;&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;ã€Šäººç”Ÿæ˜¯ä¸€æ¬¡çƒ­è¡€çš„æµæµªã€‹ â€“å¼ ç£Š&lt;/p&gt;

  &lt;p&gt;æ ‡è®°åœ¨åœ°å›¾ä¸Šçš„è¿œæ–¹&lt;/p&gt;

  &lt;p&gt;åˆ°è¾¾å‰åªé æƒ³è±¡&lt;/p&gt;

  &lt;p&gt;æˆ‘åªå¸¦äº†ç®€å•çš„è¡Œå›Š&lt;/p&gt;

  &lt;p&gt;å´æ€€æ£çƒ­è¡€çš„å¿ƒè„&lt;/p&gt;

  &lt;p&gt;æˆ‘å°†ç©¿è¶Šæœ€è¿œçš„è¾¹ç–†&lt;/p&gt;

  &lt;p&gt;è®©äººç”Ÿæ˜ åœ¨è„¸ä¸Š&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;äººç”Ÿæ˜¯ä¸€åœºè¿œè¡Œäº¦æ˜¯ä¸€åœºä¿®è¡Œã€‚éœ€ä¸æ–­çš„å»æ¢ç´¢ï¼Œå»é‡è§ï¼Œå»è¿æˆ˜ã€‚å†å¹´å‡æœŸä¼šå»ä¸æ›¾åˆ°è¿‡çš„åœ°æ–¹æ—…è¡Œï¼Œè§è¯†äº†ä¸æ›¾æ¬£èµè¿‡çš„é£æ™¯ï¼Œè€³é—»ç›®ç¹äº†ä¸åŒçš„äººç”Ÿï¼Œå‘ç°äº†åˆ«æ ·çš„æ´»æ³•ï¼Œç”Ÿæ´»çœŸçš„æ˜¯ä¸æ­¢è¿™ä¸€ç§ã€‚æˆ‘æœŸæœ›çš„è¿œæ–¹æ˜¯ä¸€æ¬¡çƒ­è¡€çš„æµæµªï¼Œè‡³å°‘åœ¨ç–«æƒ…å‘ç”Ÿä»¥å‰æ˜¯è¿™æ ·ï¼Œå—¯æ˜¯è¿™æ ·çš„ã€‚&lt;/p&gt;

&lt;p&gt;ç°åœ¨æœ€æœŸå¾…çš„è¿œæ–¹æ˜¯å®¶äººå¹³å®‰ï¼Œæ—¶å¸¸ç›¸ä¼´ã€‚æœ‰é…’æœ‰è‚‰ï¼Œæœ‰çŸ¥å·±ã€‚å³å°å¯Œå³å®‰ï¼Œäº¦å›Šè¤æ˜ é›ªï¼Œè¿½æ±‚æœ€ç®€å•æœ€ç¨³ç¨³çš„å¹¸ç¦ã€‚&lt;/p&gt;

&lt;h2 id=&quot;ä»Šå¹´æœŸæœ›&quot;&gt;ä»Šå¹´æœŸæœ›ï¼š&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;å®¶åº­å¹¸ç¦ç¾æ»¡ï¼Œæ—¶å¸¸é™ªä¼´ã€‚&lt;/li&gt;
  &lt;li&gt;å·¥ä½œäº‹ä¸šä¸æ±‚å°æœ‰æ‰€æˆï¼Œä½†æ±‚ä¸å†…è€—ï¼Œä¸å†…å·ï¼Œä¸äº‰æ–—ã€‚&lt;/li&gt;
  &lt;li&gt;èº«ä½“å¥åº·ï¼Œå¹³å®‰å–œä¹æ˜¯ä»Šå¹´æœ€å¤§çš„æœŸæœ›ã€‚&lt;/li&gt;
  &lt;li&gt;èƒ½ç»§ç»­å‘ç°ç”Ÿæ´»çš„ç¾å¥½ï¼Œå’Œæ‰€æœ‰çš„ä¸æœŸè€Œé‡ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;æœªæ¥æœŸæœ›&quot;&gt;æœªæ¥æœŸæœ›ï¼š&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;è‡ªå·±ä¸æ–­æˆé•¿ï¼Œä¸æ–­ç»å†ï¼Œæˆä¸ºç‹¬å½“ä¸€é¢çš„æˆå¹´äººï¼Œè€Œä¸æ˜¯æ€æƒ³ä¸Šçš„å·¨å©´ã€‚&lt;/li&gt;
  &lt;li&gt;å¤šå»æ„Ÿå—å’Œä½“æ‚Ÿäººç”Ÿçš„å¿«ä¹å’Œå¹¸ç¦ï¼Œå°‘äº›å¤šæ„å–„æ„Ÿï¼Œå°‘äº›ä¼˜æŸ”å¯¡æ–­ã€‚&lt;/li&gt;
  &lt;li&gt;æœŸæœ›èƒ½å¯»æ‰¾åˆ°åšå®šä¸€è¾ˆå­çš„çƒ­çˆ±ï¼ŒæœŸæœ›å¿ƒæ€ä¾æ—§å¹´è½»ï¼Œä¾æ—§çƒ­è¡€ã€‚&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;æœŸå¾…é‡è§æ›´ä¼˜ç§€çš„è‡ªå·±ã€‚&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&quot;è®¡åˆ’&quot;&gt;è®¡åˆ’ï¼š&lt;/h1&gt;

&lt;h2 id=&quot;å¹´åº¦è§„åˆ’&quot;&gt;å¹´åº¦è§„åˆ’ï¼š&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;å®¶åº­ï¼š
    &lt;ul&gt;
      &lt;li&gt;ä¸å†é€ƒé¿å©šå§»ï¼Œç§¯æé¢å¯¹ï¼›&lt;/li&gt;
      &lt;li&gt;æ—¥å¸¸å‡æœŸå¤šå›å®¶é™ªä¼´çˆ¶æ¯ï¼›&lt;/li&gt;
      &lt;li&gt;è¾“å‡ºï¼šç§¯æç»´ç³»ä¸€æ®µæ„Ÿæƒ…ã€‚&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;å·¥ä½œï¼š
    &lt;ul&gt;
      &lt;li&gt;æ‹’ç»996çš„å…¬å¸ï¼›æˆé•¿å‹é¡¹ç›®ï¼›æŠ€æœ¯å¤§ç‰›çš„åŒäº‹ï¼›&lt;/li&gt;
      &lt;li&gt;è¾“å‡ºï¼šæŠ€æœ¯åšæ–‡ä¿æŒä¸€å‘¨ä¸€ç¯‡æ›´æ–°é¢‘ç‡ï¼›&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;å¥åº·ï¼š
    &lt;ul&gt;
      &lt;li&gt;æ‹“å±•å…»ç”Ÿä¸“é¢˜çŸ¥è¯†ï¼›&lt;/li&gt;
      &lt;li&gt;ä¿æŒæ¯å‘¨è‡³å°‘åå…¬é‡Œè·‘æ­¥é”»ç‚¼æ—¶é—´ï¼›&lt;/li&gt;
      &lt;li&gt;è¾“å‡ºï¼šKeepé”»ç‚¼è®°å½•ã€‚&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;é˜…è¯»ï¼š
    &lt;ul&gt;
      &lt;li&gt;ç›®æ ‡ä¸€å¹´30æœ¬ï¼Œæ‹†åˆ†å¹³å‡æ¯æœˆ2æœ¬ä¹¦ç±çš„é˜…è¯»é‡ï¼›&lt;/li&gt;
      &lt;li&gt;ä¹¦å•å‚è§è±†ç“£ä¹¦å•ï¼›&lt;/li&gt;
      &lt;li&gt;è¾“å‡ºï¼šè±†ç“£ä¹¦å•ç‚¹è¯„æ€»ç»“ã€‚&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;æ—…è¡Œï¼š
    &lt;ul&gt;
      &lt;li&gt;å°é•¿å‡æ—…è¡Œç›®æ ‡é›…èŠã€ç¨»åŸã€ä¸‰äºšã€‚&lt;/li&gt;
      &lt;li&gt;é™¤äº†ä¸å¯æŠ—åŠ›å¤–ã€‚&lt;/li&gt;
      &lt;li&gt;è¾“å‡ºï¼šæ—…è¡ŒVlogã€‚&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;æ‘„å½±ï¼š
    &lt;ul&gt;
      &lt;li&gt;é£å…‰æ‘„å½±æŠ€èƒ½æå‡ï¼Œè¾“å‡ºé£å…‰ä½œå“ï¼›&lt;/li&gt;
      &lt;li&gt;äººåƒæ‘„å½±å­¦ä¹ ï¼Œè¾“å‡ºä¸ªäººå­¦ä¹ æ–‡æ¡£ï¼›&lt;/li&gt;
      &lt;li&gt;è§†é¢‘å‰ªè¾‘å­¦ä¹ ï¼Œè¾“å‡ºVlogä½œå“ï¼›&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;å…¶ä»–ï¼šï¼ˆå¯é€‰é¡¹ç›®ï¼‰
    &lt;ul&gt;
      &lt;li&gt;å¨æˆ¿æ—¶é—´ï¼Œæå‡å¨è‰ºï¼Œè¾“å‡ºèœå“ã€‚&lt;/li&gt;
      &lt;li&gt;å°è¯•Getå…¶ä»–æ–°æŠ€èƒ½ï¼Œæ‹“å±•æŠ€èƒ½è®¤çŸ¥ã€‚&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;æ—¥å¸¸è§„åˆ’&quot;&gt;æ—¥å¸¸è§„åˆ’ï¼š&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;æ—©ç¡æ—©èµ·ä¹ æƒ¯ä¿æŒï¼š&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;æ‹’ç»ç†¬å¤œï¼Œæœ€æ™šä¸è¶…å‡Œæ™¨åäºŒç‚¹ã€‚&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;é”»ç‚¼ï¼š&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;ä¿æŒä¸€å‘¨åå…¬é‡Œè·‘æ­¥ï¼Œä¸­é—´ä¸é™å…¶ä»–è¿åŠ¨ã€‚&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;ç¤¾äº¤ï¼š&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;æœ‹å‹å…³ç³»ç”¨å¿ƒç»è¥ï¼ŒåŒæ—¶å¼€å§‹äººç”Ÿå‡æ³•ã€‚&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;å¿ƒæ€ä¸Šï¼š&lt;/p&gt;
    &lt;ul&gt;
      &lt;li&gt;å·¥ä½œä¹‹ä½™ä¾æ—§ä¿æŒæœ‰ç”Ÿæ´»ï¼Œç»§ç»­å¯»æ‰¾å¿ƒæµä½“éªŒã€‚&lt;/li&gt;
      &lt;li&gt;ä¸è¦åœæ­¢æ€è€ƒğŸ¤”ï¼Œä¸è¦åœæ­¢å­¦ä¹ ï¼Œä¸è¦åœæ­¢å®è·µï¼ï¼ï¼&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;</content><author><name>WenHao</name></author><summary type="html">2022å¹´åº¦è§„åˆ’è®­ç»ƒè¥-è¯¾å ‚ç»ƒä¹ </summary></entry><entry><title type="html">Jekyll&amp;amp;&amp;amp;Hexoå‘å¸ƒè¯´æ˜</title><link href="http://localhost:4000/2020/07/18/Jekyll&Hexo/" rel="alternate" type="text/html" title="Jekyll&amp;&amp;Hexoå‘å¸ƒè¯´æ˜" /><published>2020-07-18T00:00:00+08:00</published><updated>2020-07-18T00:00:00+08:00</updated><id>http://localhost:4000/2020/07/18/Jekyll&amp;Hexo</id><content type="html" xml:base="http://localhost:4000/2020/07/18/Jekyll&amp;Hexo/">&lt;h1 id=&quot;jekyllå‘å¸ƒè¯´æ˜&quot;&gt;Jekyllå‘å¸ƒè¯´æ˜ï¼š&lt;/h1&gt;
&lt;ul&gt;
  &lt;li&gt;æœ¬åœ°åšæ–‡å­˜å‚¨è·¯å¾„ï¼š /Users/fwh/A_FWH/SourceTree/wenhaoclub/_posts
    &lt;ul&gt;
      &lt;li&gt;å¿«æ·å‘½ä»¤ï¼šcdwenhaoclub&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;æ–‡ç« å†…å®¹ç¼–è¾‘ï¼šæ³¨æ„æ ‡å¤´æ ¼å¼&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;---
layout: post
lock: need
title: è®°--ç–«æƒ…æœŸé—´çŸ­æš‚å¨è‰ºç”Ÿæ¶¯ğŸ˜ª
categories: [Life]
description: è‡ªå·±ä¹°èœï¼Œè‡ªå·±æ´—èœï¼Œè‡ªå·±çƒ§èœï¼Œè‡ªå·±åƒèœ
keywords: wenhao, æ–‡æµ© ,  fuwenhao.club ,  wenhaoclub , åšé¥­
link: https://cdn.jsdelivr.net/gh/wenhaoclub/blog-assets/images/Java/JVM/head2.jpg
---
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;å†…å®¹ä¸Šä¼ åˆ°GitHubä¸Š&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;åšå®¢è¿œç¨‹åœ°å€ï¼š https://github.com/wenhaoclub/wenhaoclub.github.io.git

å…³äºæ— æ³•ä¸Šä¼ é—®é¢˜ï¼š å‚è€ƒç½‘å€ï¼šhttps://juejin.cn/post/6844904193170341896
1. æ‰“å¼€ https://github.com.ipaddress.com  
2. æ‰“å¼€ https://ipaddress.com/website/github.global.ssl.fastly.net#ipinfo
3. æ‰“å¼€ https://ipaddress.com/website/assets-cdn.github.com
4. sudo vim /etc/hosts  æ›´æ–°ç›¸åº”çš„IPåœ°å€åˆ·æ–°ï¼Œé‡æ–°ä¸Šä¼ GitHubã€‚
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;å»ä¸ªäººæœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼šshblog
    &lt;ul&gt;
      &lt;li&gt;å¿«æ·å‘½ä»¤ï¼šalias shblog=â€™sh /home/fwh/Blog/blog.shâ€™&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;å»ç½‘å€æ£€æŸ¥æ˜¯å¦æœ‰æœ€æ–°çš„æ–‡ç« å†…å®¹ï¼š https://fuwenhao.club&lt;/li&gt;
&lt;/ul&gt;

&lt;hr /&gt;

&lt;h1 id=&quot;hexoå‘å¸ƒè¯´æ˜&quot;&gt;Hexoå‘å¸ƒè¯´æ˜ï¼š&lt;/h1&gt;
&lt;ul&gt;
  &lt;li&gt;æœ¬åœ°åšæ–‡å­˜å‚¨è·¯å¾„ï¼š/Users/fwh/A_FWH/Hexo_fwh_20191127/MyBlog/source/_posts
    &lt;ul&gt;
      &lt;li&gt;å¿«æ·å‘½ä»¤ï¼šcdmyblog&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;æ–‡ç« å†…å®¹ç¼–è¾‘ï¼šæ³¨æ„æ ‡å¤´æ ¼å¼&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;---
layout: post
lock: need
title: è®°--æ–°çš„ç¯å¢ƒ-æ–°çš„å¼€å§‹-æ–°çš„è‡ªå·±
date: 2020-07-04 21:41:03
author: æ–‡æµ©
tags:
  - æ”¹å˜
categories: [Life]
description: å›ç‚‰å¡‘é€ ä¸­â€¦â€¦
keywords: wenhao  , æ–‡æµ©  , ä¼¼æ°´ä¼¼æµå¹´  , wenhaoclub  , fuwenhao.club , æ–‡æµ©çš„åšå®¢
---
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;ul&gt;
  &lt;li&gt;æ–‡ç« å†…å®¹ä¸Šä¼ åˆ°Githubä¸Š&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;hexo  clean   :  æ¸…é™¤æœ¬åœ°é¡µé¢æ•°æ®ï¼›
hexo  g   :  æœ¬åœ°ç”Ÿæˆæœ€æ–°é¡µé¢ï¼›
hexo  s   :  æœ¬åœ°æµè§ˆå™¨åˆ˜è§ˆï¼›
hexo  d  ï¼šæœ¬åœ°å†…å®¹ä¸Šä¼ åˆ°GitHubä¸Šï¼›
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;å»ä¸ªäººæœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼šshHexoblog
    &lt;ul&gt;
      &lt;li&gt;å¿«æ·å‘½ä»¤ï¼šalias shHexoblog=â€™sh /home/fwh/Blog/hexoBlog.shâ€™&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;å»ç½‘å€æ£€æŸ¥æ˜¯å¦æœ‰æœ€æ–°çš„æ–‡ç« å†…å®¹ï¼š https://plus.fuwenhao.club&lt;/li&gt;
&lt;/ul&gt;</content><author><name>WenHao</name></author><summary type="html">Jekyllå‘å¸ƒè¯´æ˜ï¼š æœ¬åœ°åšæ–‡å­˜å‚¨è·¯å¾„ï¼š /Users/fwh/A_FWH/SourceTree/wenhaoclub/_posts å¿«æ·å‘½ä»¤ï¼šcdwenhaoclub æ–‡ç« å†…å®¹ç¼–è¾‘ï¼šæ³¨æ„æ ‡å¤´æ ¼å¼</summary></entry><entry><title type="html">Gitåœºæ™¯ä½¿ç”¨</title><link href="http://localhost:4000/2020/07/17/Git/" rel="alternate" type="text/html" title="Gitåœºæ™¯ä½¿ç”¨" /><published>2020-07-17T00:00:00+08:00</published><updated>2020-07-17T00:00:00+08:00</updated><id>http://localhost:4000/2020/07/17/Git</id><content type="html" xml:base="http://localhost:4000/2020/07/17/Git/">&lt;h1 id=&quot;ä¸€åº”æ™¯åœºæ™¯&quot;&gt;ä¸€ã€åº”æ™¯åœºæ™¯ï¼š&lt;/h1&gt;

&lt;h2 id=&quot;æäº¤ä»£ç &quot;&gt;æäº¤ä»£ç ï¼š&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;git add ***
    &lt;ul&gt;
      &lt;li&gt;æ·»åŠ æ–‡ä»¶&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;git commit -m â€˜å¤‡æ³¨â€™
    &lt;ul&gt;
      &lt;li&gt;æäº¤ä»£ç &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;git push
    &lt;ul&gt;
      &lt;li&gt;æ¨é€ä»£ç &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;æ‹‰å–åˆ†æ”¯&quot;&gt;æ‹‰å–åˆ†æ”¯ï¼š&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;Â git checkout -b develop1.0 origin/develop1.0Â 
    &lt;ul&gt;
      &lt;li&gt;æ‹‰å–develop1.0çš„è¿œç¨‹åˆ†æ”¯åˆ°æœ¬åœ°å¹¶å‘½ådevelop1.0Â ï¼Œåˆ›å»ºå…³è”å…³ç³»ã€‚&lt;/li&gt;
      &lt;li&gt;ä¸¾ä¾‹ï¼šgit checkout -b æœ¬åœ°åˆ†æ”¯åx origin/è¿œç¨‹åˆ†æ”¯åx&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;åˆ›å»ºåˆ†æ”¯&quot;&gt;åˆ›å»ºåˆ†æ”¯ï¼š&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;Â git branch -a
    &lt;ul&gt;
      &lt;li&gt;æŸ¥çœ‹æ‰€æœ‰åˆ†æ”¯&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;Â git branch develop
    &lt;ul&gt;
      &lt;li&gt;åˆ›å»ºdevelopåˆ†æ”¯&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;Â git checkout develop
    &lt;ul&gt;
      &lt;li&gt;åˆ‡æ¢åˆ†æ”¯&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;Â git push â€“set-upstream origin develop
    &lt;ul&gt;
      &lt;li&gt;æ¨é€åˆ†æ”¯develop&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;Â &lt;strong&gt;åœ¨åˆ†æ”¯åŸºç¡€ä¸Šåˆ›å»ºåˆ†æ”¯ï¼š&lt;/strong&gt;
    &lt;ul&gt;
      &lt;li&gt;&lt;strong&gt;å‚è€ƒ&lt;/strong&gt;ï¼š
        &lt;ul&gt;
          &lt;li&gt;git checkout current_branchÂ  Â  Â  åˆ‡æ¢åˆ°å½“å‰åˆ†æ”¯current_branch&lt;/li&gt;
          &lt;li&gt;git pullÂ  Â  Â æ‹‰å–æœ€æ–°çš„&lt;/li&gt;
          &lt;li&gt;git checkout -bÂ new_branchÂ  Â  åŸºäºå½“å‰çš„åˆ†æ”¯ï¼Œåˆ›å»ºnew_branchåˆ†æ”¯&lt;/li&gt;
          &lt;li&gt;git push originÂ new_branchÂ  Â  Â  æ¨é€åˆ°çº¿ä¸Š&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;ä¸¾ä¾‹ï¼š
        &lt;ul&gt;
          &lt;li&gt;åœ¨æŒ‡å®šçš„åˆ†æ”¯ä¸Šåˆ›å»ºæ–°åˆ†æ”¯&lt;/li&gt;
          &lt;li&gt;git checkout -b develop2.0
            &lt;ul&gt;
              &lt;li&gt;1.0ä¸Šåˆ›å»º2.0&lt;/li&gt;
            &lt;/ul&gt;
          &lt;/li&gt;
          &lt;li&gt;git push origin develop2.0
            &lt;ul&gt;
              &lt;li&gt;2.0æ¨é€è¿œç«¯&lt;/li&gt;
            &lt;/ul&gt;
          &lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;Â &lt;strong&gt;ä¿®æ”¹åˆ†æ”¯å-å¹¶æ¨é€ï¼š&lt;/strong&gt;
    &lt;ul&gt;
      &lt;li&gt;git branch -m oldBranchName newBranchName&lt;/li&gt;
      &lt;li&gt;é‡å‘½åï¼šÂ git branch -m develop3.0 release3.0&lt;/li&gt;
      &lt;li&gt;æ¨é€åˆ°è¿œç¨‹ï¼šgit push â€“set-upstream origin release3.0&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;åˆ é™¤åˆ†æ”¯&quot;&gt;åˆ é™¤åˆ†æ”¯ï¼š&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;åˆ é™¤æœ¬åœ°åˆ†æ”¯ï¼šgit branch -d developÂ &lt;/li&gt;
  &lt;li&gt;åˆ é™¤è¿œç¨‹åˆ†æ”¯ï¼šgit push origin â€“delete develop3.0Â &lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;åˆå¹¶åˆ†æ”¯&quot;&gt;åˆå¹¶åˆ†æ”¯ï¼š&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;åˆå¹¶åˆ°ä¸»åˆ†æ”¯ï¼š&lt;/strong&gt;
    &lt;ul&gt;
      &lt;li&gt;git checkout master&lt;/li&gt;
      &lt;li&gt;git merge develop
        &lt;ul&gt;
          &lt;li&gt;åˆå¹¶developä»£ç åˆ°ä¸»åˆ†æ”¯&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;å›æ»šä¸Šä¸€ä¸ªæäº¤&quot;&gt;å›æ»šä¸Šä¸€ä¸ªæäº¤ï¼š&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;git reset â€“hard HEAD^        å›é€€åˆ°ä¸Šä¸ªç‰ˆæœ¬&lt;/li&gt;
  &lt;li&gt;git reset â€“hard commit_id    é€€åˆ°/è¿›åˆ° æŒ‡å®šcommit_id&lt;/li&gt;
  &lt;li&gt;git push origin HEAD â€“force&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;å‚è€ƒåœ°å€ï¼š&lt;a href=&quot;https://www.cnblogs.com/yu-hailong/p/10681905.html&quot;&gt;https://www.cnblogs.com/yu-hailong/p/10681905.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;#&lt;/p&gt;

&lt;h2 id=&quot;å‘½ä»¤æ“ä½œ&quot;&gt;å‘½ä»¤æ“ä½œï¼š&lt;/h2&gt;

&lt;p&gt;&lt;strong&gt;git revert commit ä½œç”¨ä»¥åŠå¦‚ä½•æ’¤é”€æ“ä½œ&lt;/strong&gt;&lt;/p&gt;

&lt;h1 id=&quot;äºŒé—®é¢˜æƒ…æ™¯&quot;&gt;äºŒã€é—®é¢˜æƒ…æ™¯:&lt;/h1&gt;

&lt;ol&gt;
  &lt;li&gt;æœ¬åœ°æœªæ›´æ–°,æäº¤æ¨é€æŠ¥é”™, é‡æ–°æ›´æ–°å,æ— å†²çª,æ˜¯å¦ç»§ç»­æ¨é€å·²ç»æäº¤çš„?&lt;/li&gt;
  &lt;li&gt;åˆ†æ”¯æ‹‰å–&lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;01-å˜æ›´remoteåœ°å€&quot;&gt;01-å˜æ›´remoteåœ°å€&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;1.   [https://github.com/fwh666/fwh-parent.git](https://github.com/fwh666/fwh-parent.git)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;pre&gt;&lt;code class=&quot;language-plain&quot;&gt;# åˆ—å‡ºå·²ç»å­˜åœ¨çš„è¿œç¨‹ä»“åº“
$ git remote

# åˆ—å‡ºè¿œç¨‹ä»“åº“çš„è¯¦ç»†ä¿¡æ¯ï¼Œåœ¨åˆ«ååé¢åˆ—å‡ºURLåœ°å€
$ git remote -v
$ git remote --verbose

# æ·»åŠ è¿œç¨‹ä»“åº“
$ git remote add &amp;lt;è¿œç¨‹ä»“åº“çš„åˆ«å&amp;gt; &amp;lt;è¿œç¨‹ä»“åº“çš„URLåœ°å€&amp;gt;

# ä¿®æ”¹è¿œç¨‹ä»“åº“çš„åˆ«å
$ git remote rename &amp;lt;åŸè¿œç¨‹ä»“åº“çš„åˆ«å&amp;gt; &amp;lt;æ–°çš„åˆ«å&amp;gt;

# åˆ é™¤æŒ‡å®šåç§°çš„è¿œç¨‹ä»“åº“
$ git remote remove &amp;lt;è¿œç¨‹ä»“åº“çš„åˆ«å&amp;gt;

# ä¿®æ”¹è¿œç¨‹ä»“åº“çš„ URL åœ°å€
$ git remote set-url &amp;lt;è¿œç¨‹ä»“åº“çš„åˆ«å&amp;gt; &amp;lt;æ–°çš„è¿œç¨‹ä»“åº“URLåœ°å€&amp;gt;
ä¸¾ä¾‹ï¼š
git remote set-url origin https://github.com/fwh666/fwh-parent.git
git remote set-url origin git@github.com:fwh666/fwh-parent.git

&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&quot;02-ä»£ç è¿ç§»&quot;&gt;02-ä»£ç è¿ç§»ï¼š&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&quot;language-plain&quot;&gt;gitlab é¡¹ç›®ä»£ç è¿ç§»
å°†åŸæ¥æœåŠ¡å™¨ä¸Šçš„é¡¹ç›®ä»£ç è¿ç§»åˆ°å¦ä¸€å°æœåŠ¡å™¨ä¸Šã€‚

é¦–å…ˆæ–°å»ºä¸€ä¸ªç©ºæ–‡ä»¶ï¼Œå°†åŸæœåŠ¡å™¨ä»£ç å–ä¸‹æ¥ã€‚
git clone http://***(åŸæœåŠ¡å™¨ä»£ç åœ°å€)
è¿›å…¥åˆ°å–ä¸‹æ¥çš„gité¡¹ç›®æ–‡ä»¶å¤¹ä¸­ï¼š
cd *****(å–ä¸‹æ¥çš„é¡¹ç›®æ–‡ä»¶å¤¹è·¯å¾„)

ä¸‹é¢å¯ä»¥å‚ç…§gitlabç»™å‡ºçš„æç¤ºï¼Œé¦–å…ˆå°†åŸæ¥çš„originé‡å‘½åä¸€ä¸‹ï¼š
git remote rename origin old-origin
å†æŒ‡å®šéœ€è¦è¿ç§»åˆ°çš„ç›®æ ‡åœ°å€ï¼š
git remote add origin http://***(æ–°æœåŠ¡å™¨ä»£ç éœ€è¦å­˜æ”¾çš„åœ°å€)

ä¸Šä¼ åˆ°æ–°æœåŠ¡å™¨ï¼š
git push origin --all
ä¸Šä¼ tag:
git push origin --tags
å‡å¦‚æœ‰å¤šä¸ªåˆ†æ”¯çš„è¯ï¼Œå°±åˆ‡æ¢åˆ°å¦ä¸€ä¸ªåˆ†æ”¯ï¼Œå†åˆ‡æ¢åˆ°å¦ä¸€ä¸ªåˆ†æ”¯æäº¤ï¼š
git checkout dev(åˆ†æ”¯åç§°)
ä¸çŸ¥é“çš„è¯å¯ä»¥é€šè¿‡ git branch -aÂ  æŸ¥çœ‹åˆ†æ”¯
åˆ‡æ¢åˆ°devåˆ†æ”¯åï¼Œå†æ¬¡æäº¤
git push origin -all
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&quot;03-githubä»“åº“å¿«é€Ÿå¯¼å…¥giteeåŠåŒæ­¥æ›´æ–°&quot;&gt;03-GitHubä»“åº“å¿«é€Ÿå¯¼å…¥GiteeåŠåŒæ­¥æ›´æ–°&lt;/h2&gt;

&lt;p&gt;&lt;a href=&quot;https://gitee.com/help/articles/4284#article-header0&quot;&gt;https://gitee.com/help/articles/4284#article-header0&lt;/a&gt;  æ–¹æ¡ˆ&lt;/p&gt;

&lt;h2 id=&quot;04-gitä»£ç è¿ç§»&quot;&gt;04-Gitä»£ç è¿ç§»ï¼Ÿ&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;å¦‚ä½•ä»ä¸€ä¸ªä»“åº“æŠŠç°æœ‰ä»£ç è¿ç§»åˆ°å¦ä¸€ä¸ªä»“åº“ï¼Ÿ&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;05-git-flsä¸Šä¼ å¤§æ–‡ä»¶åˆ°gitee&quot;&gt;05-git-flsä¸Šä¼ å¤§æ–‡ä»¶åˆ°gitee&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;2-1. å®‰è£…ï¼Œæˆ‘æ˜¯ç”¨çš„æ˜¯Macbook Proï¼Œæ‰€ä»¥é€‰æ‹©macOSç”¨æˆ·å®‰è£…æ–¹å¼ Homebrew å®‰è£…
    &lt;ul&gt;
      &lt;li&gt;brew install git-lfs&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;2-2. æ‰“å¼€ç»ˆç«¯ï¼Œcdåˆ°gitä»“åº“æœ¬åœ°è·¯å¾„ï¼Œåˆå§‹åŒ–lfs
    &lt;ul&gt;
      &lt;li&gt;git lfs install&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;2-3. è¿½è¸ªå•ä¸ªæ–‡ä»¶
    &lt;ul&gt;
      &lt;li&gt;git lfs track&lt;/li&gt;
      &lt;li&gt;&lt;strong&gt;eg:git lfs track â€œ*.psdâ€    æ³¨æ„ï¼šè¦é€‰æ‹©åŒ¹é…ä¸Šä¼ çš„æ–‡ä»¶ç±»å‹&lt;/strong&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;2-4. æ·»åŠ lfsè¿½è¸ªæ–‡ä»¶ï¼Œæäº¤ä»“åº“ï¼ˆæ­¤å¤„ä¸€å®šè¦å…ˆæäº¤è¿½è¸ªæ–‡ä»¶åˆ°ä»“åº“ï¼Œåœ¨æäº¤å…¶ä»–æ–‡ä»¶ï¼‰
    &lt;ul&gt;
      &lt;li&gt;git add .gitattributes&lt;/li&gt;
      &lt;li&gt;git commit -m â€œtrack *.psd files using Git LFSâ€&lt;/li&gt;
      &lt;li&gt;git add .&lt;/li&gt;
      &lt;li&gt;git commit -m â€œsubmit other filesâ€&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;2-5. éªŒè¯æ˜¯å¦è¿½è¸ªå¤§æ–‡ä»¶ï¼Œå¦‚æœè¾“å…¥åä¸æ˜¾ç¤ºåˆ™è¿½è¸ªä¸æˆåŠŸ
    &lt;ul&gt;
      &lt;li&gt;git lfs ls-files&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;2-6. æ¨é€è‡³è¿œç¨‹ä»“åº“
    &lt;ul&gt;
      &lt;li&gt;git push origin master
æ³¨æ„ï¼š&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;ç›®å‰ä½¿ç”¨çš„æ˜¯GitHubçš„ä»“åº“æµ‹è¯•ã€‚Giteeå¾…éªŒè¯ã€‚&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://git-lfs.github.com/&quot;&gt;https://git-lfs.github.com/&lt;/a&gt; ä¸‹è½½åœ°å€&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://blog.csdn.net/wang1992326/article/details/89680533&quot;&gt;https://blog.csdn.net/wang1992326/article/details/89680533&lt;/a&gt;  æ“ä½œè¯´æ˜&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;06-æœ¬åœ°ä»£ç åˆå§‹ä¸Šä¼ åˆ°ç äº‘&quot;&gt;06-æœ¬åœ°ä»£ç åˆå§‹ä¸Šä¼ åˆ°ç äº‘ï¼Ÿ&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://blog.csdn.net/tongluren381/article/details/106615356/&quot;&gt;https://blog.csdn.net/tongluren381/article/details/106615356/&lt;/a&gt; å‚è€ƒåœ°å€&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;07-è§£å†³ç äº‘å‡ºç°gitgiteecom-permission-denied-publickey&quot;&gt;07-è§£å†³ç äº‘å‡ºç°git@gitee.com: Permission denied (publickey).&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;ç”Ÿæˆsshçš„key&lt;/li&gt;
  &lt;li&gt;å°†keyé‡æ–°æ·»åŠ åˆ°sshkeyä¸­&lt;/li&gt;
  &lt;li&gt;å‚è€ƒåœ°å€: &lt;a href=&quot;https://blog.csdn.net/dyy_csdn/article/details/81508809&quot;&gt;https://blog.csdn.net/dyy_csdn/article/details/81508809&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content><author><name>WenHao</name></author><summary type="html">ä¸€ã€åº”æ™¯åœºæ™¯ï¼š</summary></entry><entry><title type="html">springçš„IOCæºç è§£æ</title><link href="http://localhost:4000/2020/07/16/spring-ioc/" rel="alternate" type="text/html" title="springçš„IOCæºç è§£æ" /><published>2020-07-16T00:00:00+08:00</published><updated>2020-07-16T00:00:00+08:00</updated><id>http://localhost:4000/2020/07/16/spring-ioc</id><content type="html" xml:base="http://localhost:4000/2020/07/16/spring-ioc/">&lt;p&gt;Spring Beançš„ç”Ÿå‘½å‘¨æœŸ
å‰è¨€
Spring æœ€é‡è¦çš„æ¦‚å¿µæ˜¯ IOC å’Œ AOPï¼Œå…¶ä¸­IOCåˆæ˜¯Springä¸­çš„æ ¹åŸºï¼š&lt;/p&gt;

&lt;p&gt;æœ¬æ–‡è¦è¯´çš„ IOC æ€»ä½“æ¥è¯´æœ‰ä¸¤å¤„åœ°æ–¹æœ€é‡è¦ï¼Œä¸€ä¸ªæ˜¯åˆ›å»º Bean å®¹å™¨ï¼Œä¸€ä¸ªæ˜¯åˆå§‹åŒ– Beanã€‚ä¸ºäº†ä¿æŒæ–‡ç« çš„ä¸¥è°¨æ€§ï¼Œå¦‚æœåŒå­¦ä»¬å‘ç°æ–‡ç« æœ‰è¯¯è¯·ä¸€å®šä¸åæŒ‡å‡ºã€‚&lt;/p&gt;

&lt;p&gt;Demo:
é…ç½®ç±» MainConfig.javaï¼š
/**&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;Created by xsls on 2019/8/15.
 */
@Configuration
@ComponentScan(basePackages = {â€œcom.tuling.iocbeanlifecicleâ€}) 
public class MainConfig {&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;}&lt;/p&gt;

&lt;p&gt;Bean Car.javaï¼š&lt;/p&gt;

&lt;p&gt;@Component
public class Car {&lt;/p&gt;

&lt;p&gt;private String name;
   @Autowired
   private Tank tank;&lt;/p&gt;

&lt;p&gt;public void setTank(Tank tank) {
      this.tank = tank;
   }&lt;/p&gt;

&lt;p&gt;public Tank getTank() {
      return tank;
   }&lt;/p&gt;

&lt;p&gt;public String getName() {
      return name;
   }&lt;/p&gt;

&lt;p&gt;public void setName(String name) {
      this.name = name;
   }&lt;/p&gt;

&lt;p&gt;public Car() {
      System.out.println(â€œcaråŠ è½½â€¦.â€);
   }&lt;/p&gt;

&lt;p&gt;}&lt;/p&gt;

&lt;p&gt;Bean MainStart.javaï¼š
public static void main(String[] args)   {
   // åŠ è½½springä¸Šä¸‹æ–‡
   AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext(MainConfig.class);&lt;/p&gt;

&lt;p&gt;Car car =  context.getBean(â€œcarâ€,Car.class);
   System.out.println(car.getName());
}&lt;/p&gt;

&lt;p&gt;Spring IoCå®¹å™¨çš„åŠ è½½è¿‡ç¨‹
1.å®ä¾‹åŒ–åŒ–å®¹å™¨ï¼šAnnotationConfigApplicationContext ï¼š
ä»è¿™é‡Œå‡ºå‘ï¼š
 // åŠ è½½springä¸Šä¸‹æ–‡
   AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext(MainConfig.class);&lt;/p&gt;

&lt;p&gt;AnnotationConfigApplicationContextçš„ç»“æ„å…³ç³»ï¼š&lt;/p&gt;

&lt;p&gt;åˆ›å»ºAnnotationConfigApplicationContextå¯¹è±¡
//æ ¹æ®å‚æ•°ç±»å‹å¯ä»¥çŸ¥é“ï¼Œå…¶å®å¯ä»¥ä¼ å…¥å¤šä¸ªannotatedClassesï¼Œä½†æ˜¯è¿™ç§æƒ…å†µå‡ºç°çš„æ¯”è¾ƒå°‘
    public AnnotationConfigApplicationContext(Class&amp;lt;?&amp;gt;â€¦ annotatedClasses) {
        //è°ƒç”¨æ— å‚æ„é€ å‡½æ•°ï¼Œä¼šå…ˆè°ƒç”¨çˆ¶ç±»GenericApplicationContextçš„æ„é€ å‡½æ•°
        //çˆ¶ç±»çš„æ„é€ å‡½æ•°é‡Œé¢å°±æ˜¯åˆå§‹åŒ–DefaultListableBeanFactoryï¼Œå¹¶ä¸”èµ‹å€¼ç»™beanFactory
        //æœ¬ç±»çš„æ„é€ å‡½æ•°é‡Œé¢ï¼Œåˆå§‹åŒ–äº†ä¸€ä¸ªè¯»å–å™¨ï¼šAnnotatedBeanDefinitionReader readï¼Œä¸€ä¸ªæ‰«æå™¨ClassPathBeanDefinitionScanner scanner
        //scannerçš„ç”¨å¤„ä¸æ˜¯å¾ˆå¤§ï¼Œå®ƒä»…ä»…æ˜¯åœ¨æˆ‘ä»¬å¤–éƒ¨æ‰‹åŠ¨è°ƒç”¨ .scan ç­‰æ–¹æ³•æ‰æœ‰ç”¨ï¼Œå¸¸è§„æ–¹å¼æ˜¯ä¸ä¼šç”¨åˆ°scannerå¯¹è±¡çš„
        this();
        //æŠŠä¼ å…¥çš„ç±»è¿›è¡Œæ³¨å†Œï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªæƒ…å†µï¼Œ
        //ä¼ å…¥ä¼ ç»Ÿçš„é…ç½®ç±»
        //ä¼ å…¥beanï¼ˆè™½ç„¶ä¸€èˆ¬æ²¡æœ‰äººä¼šè¿™ä¹ˆåš
        //çœ‹åˆ°åé¢ä¼šçŸ¥é“springæŠŠä¼ ç»Ÿçš„å¸¦ä¸Š@Configurationçš„é…ç½®ç±»ç§°ä¹‹ä¸ºFULLé…ç½®ç±»ï¼Œä¸å¸¦@Configurationçš„ç§°ä¹‹ä¸ºLiteé…ç½®ç±»
        //ä½†æ˜¯æˆ‘ä»¬è¿™é‡Œå…ˆæŠŠå¸¦ä¸Š@Configurationçš„é…ç½®ç±»ç§°ä¹‹ä¸ºä¼ ç»Ÿé…ç½®ç±»ï¼Œä¸å¸¦çš„ç§°ä¹‹ä¸ºæ™®é€šbean
        register(annotatedClasses);
        //åˆ·æ–°
        refresh();
    }&lt;/p&gt;

&lt;p&gt;æˆ‘ä»¬å…ˆæ¥ä¸ºæ„é€ æ–¹æ³•åšä¸€ä¸ªç®€å•çš„è¯´æ˜ï¼š
è¿™æ˜¯ä¸€ä¸ªæœ‰å‚çš„æ„é€ æ–¹æ³•ï¼Œå¯ä»¥æ¥æ”¶å¤šä¸ªé…ç½®ç±»ï¼Œä¸è¿‡ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåªä¼šä¼ å…¥ä¸€ä¸ªé…ç½®ç±»ã€‚
è¿™ä¸ªé…ç½®ç±»æœ‰ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„å¸¦ä¸Š@Configurationæ³¨è§£çš„é…ç½®ç±»ï¼Œè¿˜æœ‰ä¸€ç§æ˜¯æ²¡æœ‰å¸¦ä¸Š@Configurationï¼Œä½†æ˜¯å¸¦æœ‰@Componentï¼Œ@Importï¼Œ@ImportResouceï¼Œ@Serviceï¼Œ@ComponentScanç­‰æ³¨è§£çš„é…ç½®ç±»ï¼Œåœ¨Springå†…éƒ¨æŠŠå‰è€…ç§°ä¸ºFullé…ç½®ç±»ï¼ŒæŠŠåè€…ç§°ä¹‹ä¸ºLiteé…ç½®ç±»ã€‚åœ¨æœ¬æºç åˆ†æä¸­ï¼Œæœ‰äº›åœ°æ–¹ä¹ŸæŠŠLiteé…ç½®ç±»ç§°ä¸ºæ™®é€šBeanã€‚
ä½¿ç”¨æ–­ç‚¹è°ƒè¯•ï¼Œé€šè¿‡this()è°ƒç”¨æ­¤ç±»æ— å‚çš„æ„é€ æ–¹æ³•ï¼Œä»£ç åˆ°ä¸‹é¢ï¼š
public class AnnotationConfigApplicationContext extends GenericApplicationContext implements AnnotationConfigRegistry {&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;//æ³¨è§£beanå®šä¹‰è¯»å–å™¨ï¼Œä¸»è¦ä½œç”¨æ˜¯ç”¨æ¥è¯»å–è¢«æ³¨è§£çš„äº†bean
private final AnnotatedBeanDefinitionReader reader;

//æ‰«æå™¨ï¼Œå®ƒä»…ä»…æ˜¯åœ¨æˆ‘ä»¬å¤–éƒ¨æ‰‹åŠ¨è°ƒç”¨ .scan ç­‰æ–¹æ³•æ‰æœ‰ç”¨ï¼Œå¸¸è§„æ–¹å¼æ˜¯ä¸ä¼šç”¨åˆ°scannerå¯¹è±¡çš„
private final ClassPathBeanDefinitionScanner scanner;

/**
 * Create a new AnnotationConfigApplicationContext that needs to be populated
 * through {@link #register} calls and then manually {@linkplain #refresh refreshed}.
 */
public AnnotationConfigApplicationContext() {
    //ä¼šéšå¼è°ƒç”¨çˆ¶ç±»çš„æ„é€ æ–¹æ³•ï¼Œåˆå§‹åŒ–DefaultListableBeanFactory

    //åˆå§‹åŒ–ä¸€ä¸ªBeanè¯»å–å™¨
    this.reader = new AnnotatedBeanDefinitionReader(this);

    //åˆå§‹åŒ–ä¸€ä¸ªæ‰«æå™¨ï¼Œå®ƒä»…ä»…æ˜¯åœ¨æˆ‘ä»¬å¤–éƒ¨æ‰‹åŠ¨è°ƒç”¨ .scan ç­‰æ–¹æ³•æ‰æœ‰ç”¨ï¼Œå¸¸è§„æ–¹å¼æ˜¯ä¸ä¼šç”¨åˆ°scannerå¯¹è±¡çš„
    this.scanner = new ClassPathBeanDefinitionScanner(this);
} }
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;é¦–å…ˆæ— å‚æ„é€ æ–¹æ³•ä¸­å°±æ˜¯å¯¹è¯»å–å™¨readerå’Œæ‰«æå™¨scannerè¿›è¡Œäº†å®ä¾‹åŒ–ï¼Œreaderçš„ç±»å‹æ˜¯AnnotatedBeanDefinitionReaderï¼Œå¯ä»¥çœ‹å‡ºå®ƒæ˜¯ä¸€ä¸ª â€œæ‰“äº†æ³¨è§£çš„Beanå®šä¹‰è¯»å–å™¨â€ï¼Œscannerçš„ç±»å‹æ˜¯ClassPathBeanDefinitionScannerï¼Œå®ƒä»…ä»…æ˜¯åœ¨å¤–é¢æ‰‹åŠ¨è°ƒç”¨.scanæ–¹æ³•ï¼Œæˆ–è€…è°ƒç”¨å‚æ•°ä¸ºStringçš„æ„é€ æ–¹æ³•ï¼Œä¼ å…¥éœ€è¦æ‰«æçš„åŒ…åæ‰ä¼šç”¨åˆ°ï¼Œåƒè¿™æ ·æ–¹å¼ä¼ å…¥çš„é…ç½®ç±»æ˜¯ä¸ä¼šç”¨åˆ°è¿™ä¸ªscannerå¯¹è±¡çš„ã€‚
AnnotationConfigApplicationContextç±»æ˜¯æœ‰ç»§æ‰¿å…³ç³»çš„ï¼Œä¼šéšå¼è°ƒç”¨çˆ¶ç±»çš„æ„é€ æ–¹æ³•ï¼š
ä¸‹é¢ä»£ç 
2.å®ä¾‹åŒ–å·¥å‚ï¼šDefaultListableBeanFactory
public class GenericApplicationContext extends AbstractApplicationContext implements BeanDefinitionRegistry {&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;private final DefaultListableBeanFactory beanFactory;

@Nullable
private ResourceLoader resourceLoader;

private boolean customClassLoader = false;

private final AtomicBoolean refreshed = new AtomicBoolean();


/**
 * Create a new GenericApplicationContext.
 * @see #registerBeanDefinition
 * @see #refresh
 */
public GenericApplicationContext() {
    this.beanFactory = new DefaultListableBeanFactory();
} }
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;DefaultListableBeanFactoryçš„å…³ç³»å›¾&lt;/p&gt;

&lt;p&gt;DefaultListableBeanFactoryæ˜¯ç›¸å½“é‡è¦çš„ï¼Œä»å­—é¢æ„æ€å°±å¯ä»¥çœ‹å‡ºå®ƒæ˜¯ä¸€ä¸ªBeançš„å·¥å‚ï¼Œä»€ä¹ˆæ˜¯Beançš„å·¥å‚ï¼Ÿå½“ç„¶å°±æ˜¯ç”¨æ¥ç”Ÿäº§å’Œè·å¾—Beançš„ã€‚&lt;/p&gt;

&lt;p&gt;3.å®ä¾‹åŒ–å»ºBeanDefinitionè¯»å–å™¨ï¼š AnnotatedBeanDefinitionReaderï¼š
å…¶ä¸»è¦åšäº†2ä»¶äº‹æƒ…
1.æ³¨å†Œå†…ç½®BeanPostProcessor
2.æ³¨å†Œç›¸å…³çš„BeanDefinition&lt;/p&gt;

&lt;p&gt;è®©æˆ‘ä»¬æŠŠç›®å…‰å›åˆ°AnnotationConfigApplicationContextçš„æ— å‚æ„é€ æ–¹æ³•ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹Springåœ¨åˆå§‹åŒ–AnnotatedBeanDefinitionReaderçš„æ—¶å€™åšäº†ä»€ä¹ˆï¼š
 public AnnotatedBeanDefinitionReader(BeanDefinitionRegistry registry) {
        this(registry, getOrCreateEnvironment(registry));
    }&lt;/p&gt;

&lt;p&gt;è¿™é‡Œçš„BeanDefinitionRegistryå½“ç„¶å°±æ˜¯AnnotationConfigApplicationContextçš„å®ä¾‹äº†ï¼Œè¿™é‡Œåˆç›´æ¥è°ƒç”¨äº†æ­¤ç±»å…¶ä»–çš„æ„é€ æ–¹æ³•ï¼š
    public AnnotatedBeanDefinitionReader(BeanDefinitionRegistry registry, Environment environment) {
        Assert.notNull(registry, â€œBeanDefinitionRegistry must not be nullâ€);
        Assert.notNull(environment, â€œEnvironment must not be nullâ€);
        this.registry = registry;
        this.conditionEvaluator = new ConditionEvaluator(registry, environment, null);
        AnnotationConfigUtils.registerAnnotationConfigProcessors(this.registry);
    }&lt;/p&gt;

&lt;p&gt;è®©æˆ‘ä»¬æŠŠç›®å…‰ç§»åŠ¨åˆ°è¿™ä¸ªæ–¹æ³•çš„æœ€åä¸€è¡Œï¼Œè¿›å…¥registerAnnotationConfigProcessorsæ–¹æ³•ï¼š
    public static void registerAnnotationConfigProcessors(BeanDefinitionRegistry registry) {
        registerAnnotationConfigProcessors(registry, null);
    }&lt;/p&gt;

&lt;p&gt;è¿™åˆæ˜¯ä¸€ä¸ªé—¨é¢æ–¹æ³•ï¼Œå†ç‚¹è¿›å»ï¼Œè¿™ä¸ªæ–¹æ³•çš„è¿”å›å€¼Setï¼Œä½†æ˜¯ä¸Šæ¸¸æ–¹æ³•å¹¶æ²¡æœ‰å»æ¥æ”¶è¿™ä¸ªè¿”å›å€¼ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•çš„è¿”å›å€¼ä¹Ÿä¸æ˜¯å¾ˆé‡è¦äº†ï¼Œå½“ç„¶æ–¹æ³•å†…éƒ¨ç»™è¿™ä¸ªè¿”å›å€¼èµ‹å€¼ä¹Ÿä¸é‡è¦äº†ã€‚ç”±äºè¿™ä¸ªæ–¹æ³•å†…å®¹æ¯”è¾ƒå¤šï¼Œè¿™é‡Œå°±æŠŠæœ€æ ¸å¿ƒçš„è´´å‡ºæ¥ï¼Œè¿™ä¸ªæ–¹æ³•çš„æ ¸å¿ƒå°±æ˜¯æ³¨å†ŒSpringå†…ç½®çš„å¤šä¸ªBeanï¼š
if (!registry.containsBeanDefinition(CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME)) {
            RootBeanDefinition def = new RootBeanDefinition(ConfigurationClassPostProcessor.class);
            def.setSource(source);
            beanDefs.add(registerPostProcessor(registry, def, CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME));
}&lt;/p&gt;

&lt;p&gt;åˆ¤æ–­å®¹å™¨ä¸­æ˜¯å¦å·²ç»å­˜åœ¨äº†ConfigurationClassPostProcessor Bean
å¦‚æœä¸å­˜åœ¨ï¼ˆå½“ç„¶è¿™é‡Œè‚¯å®šæ˜¯ä¸å­˜åœ¨çš„ï¼‰ï¼Œå°±é€šè¿‡RootBeanDefinitionçš„æ„é€ æ–¹æ³•è·å¾—ConfigurationClassPostProcessorçš„BeanDefinitionï¼ŒRootBeanDefinitionæ˜¯BeanDefinitionçš„å­ç±»
æ‰§è¡ŒregisterPostProcessoræ–¹æ³•ï¼ŒregisterPostProcessoræ–¹æ³•å†…éƒ¨å°±æ˜¯æ³¨å†ŒBeanï¼Œå½“ç„¶è¿™é‡Œæ³¨å†Œå…¶ä»–Beanä¹Ÿæ˜¯ä¸€æ ·çš„æµç¨‹ã€‚&lt;/p&gt;

&lt;p&gt;BeanDefinitionæ˜¯ä»€ä¹ˆï¼Ÿ
BeanDefinitionè”ç³»å›¾
å‘ä¸Š&lt;/p&gt;

&lt;p&gt;BeanMetadataElementæ¥å£ï¼šBeanDefinitionå…ƒæ•°æ®ï¼Œè¿”å›è¯¥Beançš„æ¥æº
AttributeAccessoræ¥å£ï¼šæä¾›å¯¹BeanDefinitionå±æ€§æ“ä½œèƒ½åŠ›ï¼Œ
å‘ä¸‹&lt;/p&gt;

&lt;p&gt;å®ƒæ˜¯ç”¨æ¥æè¿°Beançš„ï¼Œé‡Œé¢å­˜æ”¾ç€å…³äºBeançš„ä¸€ç³»åˆ—ä¿¡æ¯ï¼Œæ¯”å¦‚Beançš„ä½œç”¨åŸŸï¼ŒBeanæ‰€å¯¹åº”çš„Classï¼Œæ˜¯å¦æ‡’åŠ è½½ï¼Œæ˜¯å¦Primaryç­‰ç­‰ï¼Œè¿™ä¸ªBeanDefinitionä¹Ÿç›¸å½“é‡è¦ï¼Œæˆ‘ä»¬ä»¥åä¼šå¸¸å¸¸å’Œå®ƒæ‰“äº¤é“ã€‚**
registerPostProcessoræ–¹æ³•ï¼š
    private static BeanDefinitionHolder registerPostProcessor(
            BeanDefinitionRegistry registry, RootBeanDefinition definition, String beanName) {&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;    definition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);
    registry.registerBeanDefinition(beanName, definition);
    return new BeanDefinitionHolder(definition, beanName);
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;è¿™æ–¹æ³•ä¸ºBeanDefinitionè®¾ç½®äº†ä¸€ä¸ªRoleï¼ŒROLE_INFRASTRUCTUREä»£è¡¨è¿™æ˜¯springå†…éƒ¨çš„ï¼Œå¹¶éç”¨æˆ·å®šä¹‰çš„ï¼Œç„¶ååˆè°ƒç”¨äº†registerBeanDefinitionæ–¹æ³•ï¼Œå†ç‚¹è¿›å»ï¼ŒOh Noï¼Œä½ ä¼šå‘ç°å®ƒæ˜¯ä¸€ä¸ªæ¥å£ï¼Œæ²¡åŠæ³•ç›´æ¥ç‚¹è¿›å»äº†ï¼Œé¦–å…ˆè¦çŸ¥é“registryå®ç°ç±»æ˜¯ä»€ä¹ˆï¼Œé‚£ä¹ˆå®ƒçš„å®ç°æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿç­”æ¡ˆæ˜¯DefaultListableBeanFactoryï¼š
public void registerBeanDefinition(String beanName, BeanDefinition beanDefinition)
            throws BeanDefinitionStoreException {
        this.beanFactory.registerBeanDefinition(beanName, beanDefinition);
    }&lt;/p&gt;

&lt;p&gt;è¿™åˆæ˜¯ä¸€ä¸ªé—¨é¢æ–¹æ³•ï¼Œå†ç‚¹è¿›å»ï¼Œæ ¸å¿ƒåœ¨äºä¸‹é¢ä¸¤è¡Œä»£ç ï¼š
//beanDefinitionMapæ˜¯Map&amp;lt;String, BeanDefinition&amp;gt;ï¼Œ
//è¿™é‡Œå°±æ˜¯æŠŠbeanNameä½œä¸ºkeyï¼ŒScopedProxyModeä½œä¸ºvalueï¼Œæ¨åˆ°mapé‡Œé¢
this.beanDefinitionMap.put(beanName, beanDefinition);&lt;/p&gt;

&lt;p&gt;//beanDefinitionNameså°±æ˜¯ä¸€ä¸ªList&lt;String&gt;,è¿™é‡Œå°±æ˜¯æŠŠbeanNameæ”¾åˆ°Listä¸­å»
this.beanDefinitionNames.add(beanName);&lt;/String&gt;&lt;/p&gt;

&lt;p&gt;ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºDefaultListableBeanFactoryå°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„å®¹å™¨äº†ï¼Œé‡Œé¢æ”¾ç€beanDefinitionMapï¼ŒbeanDefinitionNamesï¼ŒbeanDefinitionMapæ˜¯ä¸€ä¸ªhashMapï¼ŒbeanNameä½œä¸ºKey,beanDefinitionä½œä¸ºValueï¼ŒbeanDefinitionNamesæ˜¯ä¸€ä¸ªé›†åˆï¼Œé‡Œé¢å­˜æ”¾äº†beanNameã€‚æ‰“ä¸ªæ–­ç‚¹ï¼Œç¬¬ä¸€æ¬¡è¿è¡Œåˆ°è¿™é‡Œï¼Œç›‘è§†è¿™ä¸¤ä¸ªå˜é‡ï¼š&lt;/p&gt;

&lt;p&gt;DefaultListableBeanFactoryä¸­çš„beanDefinitionMapï¼ŒbeanDefinitionNamesä¹Ÿæ˜¯ç›¸å½“é‡è¦çš„ï¼Œä»¥åä¼šç»å¸¸çœ‹åˆ°å®ƒï¼Œæœ€å¥½çœ‹åˆ°å®ƒï¼Œç¬¬ä¸€æ—¶é—´å°±å¯ä»¥ååº”å‡ºå®ƒé‡Œé¢æ”¾äº†ä»€ä¹ˆæ•°æ®
è¿™é‡Œä»…ä»…æ˜¯æ³¨å†Œï¼Œå¯ä»¥ç®€å•çš„ç†è§£ä¸ºæŠŠä¸€äº›åŸæ–™æ”¾å…¥å·¥å‚ï¼Œå·¥å‚è¿˜æ²¡æœ‰çœŸæ­£çš„å»ç”Ÿäº§ã€‚
ä¸Šé¢å·²ç»ä»‹ç»è¿‡ï¼Œè¿™é‡Œä¼šä¸€è¿ä¸²æ³¨å†Œå¥½å‡ ä¸ªBeanï¼Œåœ¨è¿™å…¶ä¸­æœ€é‡è¦çš„ä¸€ä¸ªBeanï¼ˆæ²¡æœ‰ä¹‹ä¸€ï¼‰å°±æ˜¯BeanDefinitionRegistryPostProcessor Beanã€‚
ConfigurationClassPostProcessorå®ç°BeanDefinitionRegistryPostProcessoræ¥å£ï¼ŒBeanDefinitionRegistryPostProcessoræ¥å£åˆæ‰©å±•äº†BeanFactoryPostProcessoræ¥å£ï¼ŒBeanFactoryPostProcessoræ˜¯Springçš„æ‰©å±•ç‚¹ä¹‹ä¸€ï¼ŒConfigurationClassPostProcessoræ˜¯Springæä¸ºé‡è¦çš„ä¸€ä¸ªç±»ï¼Œå¿…é¡»ç‰¢ç‰¢çš„è®°ä½ä¸Šé¢æ‰€è¯´çš„è¿™ä¸ªç±»å’Œå®ƒçš„ç»§æ‰¿å…³ç³»ã€‚&lt;/p&gt;

&lt;p&gt;é™¤äº†æ³¨å†Œäº†ConfigurationClassPostProcessorï¼Œè¿˜æ³¨å†Œäº†å…¶ä»–Beanï¼Œå…¶ä»–Beanä¹Ÿéƒ½å®ç°äº†å…¶ä»–æ¥å£ï¼Œæ¯”å¦‚BeanPostProcessorç­‰ã€‚
BeanPostProcessoræ¥å£ä¹Ÿæ˜¯Springçš„æ‰©å±•ç‚¹ä¹‹ä¸€ã€‚
è‡³æ­¤ï¼Œå®ä¾‹åŒ–AnnotatedBeanDefinitionReader readeråˆ†æå®Œæ¯•ã€‚&lt;/p&gt;

&lt;p&gt;4.åˆ›å»ºBeanDefinitionæ‰«æå™¨:ClassPathBeanDefinitionScanner&lt;/p&gt;

&lt;p&gt;ç”±äºå¸¸è§„ä½¿ç”¨æ–¹å¼æ˜¯ä¸ä¼šç”¨åˆ°AnnotationConfigApplicationContexté‡Œé¢çš„scannerçš„ï¼Œè¿™é‡Œçš„scannerä»…ä»…æ˜¯ä¸ºäº†ç¨‹åºå‘˜å¯ä»¥æ‰‹åŠ¨è°ƒç”¨AnnotationConfigApplicationContextå¯¹è±¡çš„scanæ–¹æ³•ã€‚æ‰€ä»¥è¿™é‡Œå°±ä¸çœ‹scanneræ˜¯å¦‚ä½•è¢«å®ä¾‹åŒ–çš„äº†ã€‚&lt;/p&gt;

&lt;p&gt;5.æ³¨å†Œé…ç½®ç±»ä¸ºBeanDefinitionï¼š register(annotatedClasses);
æŠŠç›®å…‰å›åˆ°æœ€å¼€å§‹ï¼Œå†åˆ†æç¬¬äºŒè¡Œä»£ç ï¼š
register(annotatedClasses);&lt;/p&gt;

&lt;p&gt;1
è¿™é‡Œä¼ è¿›å»çš„æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæœ€ç»ˆä¼šå¾ªç¯è°ƒç”¨å¦‚ä¸‹æ–¹æ³•ï¼š
    &lt;T&gt; void doRegisterBean(Class&lt;T&gt; annotatedClass, @Nullable Supplier&lt;T&gt; instanceSupplier, @Nullable String name,
            @Nullable Class&amp;lt;? extends Annotation&amp;gt;[] qualifiers, BeanDefinitionCustomizer... definitionCustomizers) {
        //AnnotatedGenericBeanDefinitionå¯ä»¥ç†è§£ä¸ºä¸€ç§æ•°æ®ç»“æ„ï¼Œæ˜¯ç”¨æ¥æè¿°Beançš„ï¼Œè¿™é‡Œçš„ä½œç”¨å°±æ˜¯æŠŠä¼ å…¥çš„æ ‡è®°äº†æ³¨è§£çš„ç±»
        //è½¬ä¸ºAnnotatedGenericBeanDefinitionæ•°æ®ç»“æ„ï¼Œé‡Œé¢æœ‰ä¸€ä¸ªgetMetadataæ–¹æ³•ï¼Œå¯ä»¥æ‹¿åˆ°ç±»ä¸Šçš„æ³¨è§£
        AnnotatedGenericBeanDefinition abd = new AnnotatedGenericBeanDefinition(annotatedClass);&lt;/T&gt;&lt;/T&gt;&lt;/T&gt;&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;    //åˆ¤æ–­æ˜¯å¦éœ€è¦è·³è¿‡æ³¨è§£ï¼Œspringä¸­æœ‰ä¸€ä¸ª@Conditionæ³¨è§£ï¼Œå½“ä¸æ»¡è¶³æ¡ä»¶ï¼Œè¿™ä¸ªbeanå°±ä¸ä¼šè¢«è§£æ
    if (this.conditionEvaluator.shouldSkip(abd.getMetadata())) {
        return;
    }

    abd.setInstanceSupplier(instanceSupplier);

    //è§£æbeançš„ä½œç”¨åŸŸï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®çš„è¯ï¼Œé»˜è®¤ä¸ºå•ä¾‹
    ScopeMetadata scopeMetadata = this.scopeMetadataResolver.resolveScopeMetadata(abd);
    abd.setScope(scopeMetadata.getScopeName());

    //è·å¾—beanName
    String beanName = (name != null ? name : this.beanNameGenerator.generateBeanName(abd, this.registry));

    //è§£æé€šç”¨æ³¨è§£ï¼Œå¡«å……åˆ°AnnotatedGenericBeanDefinitionï¼Œè§£æçš„æ³¨è§£ä¸ºLazyï¼ŒPrimaryï¼ŒDependsOnï¼ŒRoleï¼ŒDescription
    AnnotationConfigUtils.processCommonDefinitionAnnotations(abd);

    //é™å®šç¬¦å¤„ç†ï¼Œä¸æ˜¯ç‰¹æŒ‡@Qualifieræ³¨è§£ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯Primary,æˆ–è€…æ˜¯Lazyï¼Œæˆ–è€…æ˜¯å…¶ä»–ï¼ˆç†è®ºä¸Šæ˜¯ä»»ä½•æ³¨è§£ï¼Œè¿™é‡Œæ²¡æœ‰åˆ¤æ–­æ³¨è§£çš„æœ‰æ•ˆæ€§ï¼‰ï¼Œå¦‚æœæˆ‘ä»¬åœ¨å¤–é¢ï¼Œä»¥ç±»ä¼¼è¿™ç§
    //AnnotationConfigApplicationContext annotationConfigApplicationContext = new AnnotationConfigApplicationContext(Appconfig.class);å¸¸è§„æ–¹å¼å»åˆå§‹åŒ–springï¼Œ
    //qualifiersæ°¸è¿œéƒ½æ˜¯ç©ºçš„ï¼ŒåŒ…æ‹¬ä¸Šé¢çš„nameå’ŒinstanceSupplieréƒ½æ˜¯åŒæ ·çš„é“ç†
    //ä½†æ˜¯springæä¾›äº†å…¶ä»–æ–¹å¼å»æ³¨å†Œbeanï¼Œå°±å¯èƒ½ä¼šä¼ å…¥äº†
    if (qualifiers != null) {
        //å¯ä»¥ä¼ å…¥qualifieræ•°ç»„ï¼Œæ‰€ä»¥éœ€è¦å¾ªç¯å¤„ç†
        for (Class&amp;lt;? extends Annotation&amp;gt; qualifier : qualifiers) {
            //Primaryæ³¨è§£ä¼˜å…ˆ
            if (Primary.class == qualifier) {
                abd.setPrimary(true);
            }
            //Lazyæ³¨è§£
            else if (Lazy.class == qualifier) {
                abd.setLazyInit(true);
            }
            //å…¶ä»–ï¼ŒAnnotatedGenericBeanDefinitionæœ‰ä¸ªMap&amp;lt;String,AutowireCandidateQualifier&amp;gt;å±æ€§ï¼Œç›´æ¥pushè¿›å»
            else {
                abd.addQualifier(new AutowireCandidateQualifier(qualifier));
            }
        }
    }

    for (BeanDefinitionCustomizer customizer : definitionCustomizers) {
        customizer.customize(abd);
    }

    //è¿™ä¸ªæ–¹æ³•ç”¨å¤„ä¸å¤§ï¼Œå°±æ˜¯æŠŠAnnotatedGenericBeanDefinitionæ•°æ®ç»“æ„å’ŒbeanNameå°è£…åˆ°ä¸€ä¸ªå¯¹è±¡ä¸­
    BeanDefinitionHolder definitionHolder = new BeanDefinitionHolder(abd, beanName);

    definitionHolder = AnnotationConfigUtils.applyScopedProxyMode(scopeMetadata, definitionHolder, this.registry);

    //æ³¨å†Œï¼Œæœ€ç»ˆä¼šè°ƒç”¨DefaultListableBeanFactoryä¸­çš„registerBeanDefinitionæ–¹æ³•å»æ³¨å†Œï¼Œ
    //DefaultListableBeanFactoryç»´æŠ¤ç€ä¸€ç³»åˆ—ä¿¡æ¯ï¼Œæ¯”å¦‚beanDefinitionNamesï¼ŒbeanDefinitionMap
    //beanDefinitionNamesæ˜¯ä¸€ä¸ªList&amp;lt;String&amp;gt;,ç”¨æ¥ä¿å­˜beanName
    //beanDefinitionMapæ˜¯ä¸€ä¸ªMap,ç”¨æ¥ä¿å­˜beanNameå’ŒbeanDefinition
    BeanDefinitionReaderUtils.registerBeanDefinition(definitionHolder, this.registry);
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;åœ¨è¿™é‡Œåˆè¦è¯´æ˜ä¸‹ï¼Œä»¥å¸¸è§„æ–¹å¼å»æ³¨å†Œé…ç½®ç±»ï¼Œæ­¤æ–¹æ³•ä¸­é™¤äº†ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå…¶ä»–å‚æ•°éƒ½æ˜¯é»˜è®¤å€¼ã€‚
é€šè¿‡AnnotatedGenericBeanDefinitionçš„æ„é€ æ–¹æ³•ï¼Œè·å¾—é…ç½®ç±»çš„BeanDefinitionï¼Œè¿™é‡Œæ˜¯ä¸æ˜¯ä¼¼æ›¾ç›¸ä¼¼ï¼Œåœ¨æ³¨å†ŒConfigurationClassPostProcessorç±»çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯é€šè¿‡æ„é€ æ–¹æ³•å»è·å¾—BeanDefinitionçš„ï¼Œåªä¸è¿‡å½“æ—¶æ˜¯é€šè¿‡RootBeanDefinitionå»è·å¾—ï¼Œç°åœ¨æ˜¯é€šè¿‡AnnotatedGenericBeanDefinitionå»è·å¾—ã€‚&lt;/p&gt;

&lt;p&gt;åˆ¤æ–­éœ€ä¸éœ€è¦è·³è¿‡æ³¨å†Œï¼ŒSpringä¸­æœ‰ä¸€ä¸ª@Conditionæ³¨è§£ï¼Œå¦‚æœä¸æ»¡è¶³æ¡ä»¶ï¼Œå°±ä¼šè·³è¿‡è¿™ä¸ªç±»çš„æ³¨å†Œã€‚
ç„¶åæ˜¯è§£æä½œç”¨åŸŸï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®çš„è¯ï¼Œé»˜è®¤ä¸ºå•ä¾‹ã€‚
è·å¾—BeanNameã€‚
è§£æé€šç”¨æ³¨è§£ï¼Œå¡«å……åˆ°AnnotatedGenericBeanDefinitionï¼Œè§£æçš„æ³¨è§£ä¸ºLazyï¼ŒPrimaryï¼ŒDependsOnï¼ŒRoleï¼ŒDescriptionã€‚
é™å®šç¬¦å¤„ç†ï¼Œä¸æ˜¯ç‰¹æŒ‡@Qualifieræ³¨è§£ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯Primaryï¼Œæˆ–è€…æ˜¯Lazyï¼Œæˆ–è€…æ˜¯å…¶ä»–ï¼ˆç†è®ºä¸Šæ˜¯ä»»ä½•æ³¨è§£ï¼Œè¿™é‡Œæ²¡æœ‰åˆ¤æ–­æ³¨è§£çš„æœ‰æ•ˆæ€§ï¼‰ã€‚
æŠŠAnnotatedGenericBeanDefinitionæ•°æ®ç»“æ„å’ŒbeanNameå°è£…åˆ°ä¸€ä¸ªå¯¹è±¡ä¸­ï¼ˆè¿™ä¸ªä¸æ˜¯å¾ˆé‡è¦ï¼Œå¯ä»¥ç®€å•çš„ç†è§£ä¸ºæ–¹ä¾¿ä¼ å‚ï¼‰ã€‚
æ³¨å†Œï¼Œæœ€ç»ˆä¼šè°ƒç”¨DefaultListableBeanFactoryä¸­çš„registerBeanDefinitionæ–¹æ³•å»æ³¨å†Œï¼š
    public static void registerBeanDefinition(
            BeanDefinitionHolder definitionHolder, BeanDefinitionRegistry registry)
            throws BeanDefinitionStoreException {&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;    //è·å–beanName
    // Register bean definition under primary name.
    String beanName = definitionHolder.getBeanName();

    //æ³¨å†Œbean
    registry.registerBeanDefinition(beanName, definitionHolder.getBeanDefinition());

            //Springæ”¯æŒåˆ«å
    // Register aliases for bean name, if any.
    String[] aliases = definitionHolder.getAliases();
    if (aliases != null) {
        for (String alias : aliases) {
            registry.registerAlias(beanName, alias);
        }
    }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;è¿™ä¸ªregisterBeanDefinitionæ˜¯ä¸æ˜¯åˆæœ‰ä¸€ç§ä¼¼æ›¾ç›¸ä¼¼çš„æ„Ÿè§‰ï¼Œæ²¡é”™ï¼Œåœ¨ä¸Šé¢æ³¨å†ŒSpringå†…ç½®çš„Beançš„æ—¶å€™ï¼Œå·²ç»è§£æè¿‡è¿™ä¸ªæ–¹æ³•äº†ï¼Œè¿™é‡Œå°±ä¸é‡å¤äº†ï¼Œæ­¤æ—¶ï¼Œè®©æˆ‘ä»¬å†è§‚å¯Ÿä¸‹beanDefinitionMap beanDefinitionNamesä¸¤ä¸ªå˜é‡ï¼Œé™¤äº†Springå†…ç½®çš„Beanï¼Œè¿˜æœ‰æˆ‘ä»¬ä¼ è¿›æ¥çš„Beanï¼Œè¿™é‡Œçš„Beanå½“ç„¶å°±æ˜¯æˆ‘ä»¬çš„é…ç½®ç±»äº†ï¼š&lt;/p&gt;

&lt;p&gt;åˆ°è¿™é‡Œæ³¨å†Œé…ç½®ç±»ä¹Ÿåˆ†æå®Œæ¯•äº†ã€‚&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;refresh()
å¤§å®¶å¯ä»¥çœ‹åˆ°å…¶å®åˆ°è¿™é‡Œï¼ŒSpringè¿˜æ²¡æœ‰è¿›è¡Œæ‰«æï¼Œåªæ˜¯å®ä¾‹åŒ–äº†ä¸€ä¸ªå·¥å‚ï¼Œæ³¨å†Œäº†ä¸€äº›å†…ç½®çš„Beanå’Œæˆ‘ä»¬ä¼ è¿›å»çš„é…ç½®ç±»ï¼ŒçœŸæ­£çš„å¤§å¤´æ˜¯åœ¨ç¬¬ä¸‰è¡Œä»£ç ï¼š
refresh();&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;è¿™ä¸ªæ–¹æ³•åšäº†å¾ˆå¤šäº‹æƒ…ï¼Œè®©æˆ‘ä»¬ç‚¹å¼€è¿™ä¸ªæ–¹æ³•ï¼š
	public void refresh() throws BeansException, IllegalStateException {
		synchronized (this.startupShutdownMonitor) {
			// Prepare this context for refreshing.
			//åˆ·æ–°é¢„å¤„ç†ï¼Œå’Œä¸»æµç¨‹å…³ç³»ä¸å¤§ï¼Œå°±æ˜¯ä¿å­˜äº†å®¹å™¨çš„å¯åŠ¨æ—¶é—´ï¼Œå¯åŠ¨æ ‡å¿—ç­‰
			prepareRefresh();&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;		//DefaultListableBeanFactory
		// Tell the subclass to refresh the internal bean factory.
		//å’Œä¸»æµç¨‹å…³ç³»ä¹Ÿä¸å¤§ï¼Œæœ€ç»ˆè·å¾—äº†DefaultListableBeanFactoryï¼Œ
		// DefaultListableBeanFactoryå®ç°äº†ConfigurableListableBeanFactory
		ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();

		// Prepare the bean factory for use in this context.
		//è¿˜æ˜¯ä¸€äº›å‡†å¤‡å·¥ä½œï¼Œæ·»åŠ äº†ä¸¤ä¸ªåç½®å¤„ç†å™¨ï¼šApplicationContextAwareProcessorï¼ŒApplicationListenerDetector
		//è¿˜è®¾ç½®äº† å¿½ç•¥è‡ªåŠ¨è£…é… å’Œ å…è®¸è‡ªåŠ¨è£…é… çš„æ¥å£,å¦‚æœä¸å­˜åœ¨æŸä¸ªbeançš„æ—¶å€™ï¼Œspringå°±è‡ªåŠ¨æ³¨å†Œsingleton bean
		//è¿˜è®¾ç½®äº†beanè¡¨è¾¾å¼è§£æå™¨ ç­‰
		prepareBeanFactory(beanFactory);

		try {
			// Allows post-processing of the bean factory in context subclasses.
			//è¿™æ˜¯ä¸€ä¸ªç©ºæ–¹æ³•
			postProcessBeanFactory(beanFactory);

			// Invoke factory processors registered as beans in the context.
			//æ‰§è¡Œè‡ªå®šä¹‰çš„BeanFactoryProcessorå’Œå†…ç½®çš„BeanFactoryProcessor
			invokeBeanFactoryPostProcessors(beanFactory);

			// Register bean processors that intercept bean creation.
			// æ³¨å†ŒBeanPostProcessor
			registerBeanPostProcessors(beanFactory);

			// Initialize message source for this context.
			initMessageSource();

			// Initialize event multicaster for this context.
			initApplicationEventMulticaster();

			// Initialize other special beans in specific context subclasses.
			// ç©ºæ–¹æ³•
			onRefresh();

			// Check for listener beans and register them.
			registerListeners();

			// Instantiate all remaining (non-lazy-init) singletons.
			finishBeanFactoryInitialization(beanFactory);

			// Last step: publish corresponding event.
			finishRefresh();
		}

		catch (BeansException ex) {
			if (logger.isWarnEnabled()) {
				logger.warn(&quot;Exception encountered during context initialization - &quot; +
						&quot;cancelling refresh attempt: &quot; + ex);
			}

			// Destroy already created singletons to avoid dangling resources.
			destroyBeans();

			// Reset 'active' flag.
			cancelRefresh(ex);

			// Propagate exception to caller.
			throw ex;
		}

		finally {
			// Reset common introspection caches in Spring's core, since we
			// might not ever need metadata for singleton beans anymore...
			resetCommonCaches();
		}
	}
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;é‡Œé¢æœ‰å¾ˆå¤šå°æ–¹æ³•ï¼Œæˆ‘ä»¬ä»Šå¤©çš„ç›®æ ‡æ˜¯åˆ†æå‰äº”ä¸ªå°æ–¹æ³•ï¼š
6.1 prepareRefresh
ä»å‘½åæ¥çœ‹ï¼Œå°±çŸ¥é“è¿™ä¸ªæ–¹æ³•ä¸»è¦åšäº†ä¸€äº›åˆ·æ–°å‰çš„å‡†å¤‡å·¥ä½œï¼Œå’Œä¸»æµç¨‹å…³ç³»ä¸å¤§ï¼Œä¸»è¦æ˜¯ä¿å­˜äº†å®¹å™¨çš„å¯åŠ¨æ—¶é—´ï¼Œå¯åŠ¨æ ‡å¿—ç­‰ã€‚
6.2 ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory()
è¿™ä¸ªæ–¹æ³•å’Œä¸»æµç¨‹å…³ç³»ä¹Ÿä¸æ˜¯å¾ˆå¤§ï¼Œå¯ä»¥ç®€å•çš„è®¤ä¸ºï¼Œå°±æ˜¯æŠŠbeanFactoryå–å‡ºæ¥è€Œå·²ã€‚XMLæ¨¡å¼ä¸‹ä¼šåœ¨è¿™é‡Œè¯»å–BeanDefinition
6.3 prepareBeanFactory
			//è¿˜æ˜¯ä¸€äº›å‡†å¤‡å·¥ä½œï¼Œæ·»åŠ äº†ä¸¤ä¸ªåç½®å¤„ç†å™¨ï¼šApplicationContextAwareProcessorï¼ŒApplicationListenerDetector
			//è¿˜è®¾ç½®äº† å¿½ç•¥è‡ªåŠ¨è£…é… å’Œ å…è®¸è‡ªåŠ¨è£…é… çš„æ¥å£,å¦‚æœä¸å­˜åœ¨æŸä¸ªbeançš„æ—¶å€™ï¼Œspringå°±è‡ªåŠ¨æ³¨å†Œsingleton bean
			//è¿˜è®¾ç½®äº†beanè¡¨è¾¾å¼è§£æå™¨ ç­‰
			prepareBeanFactory(beanFactory);&lt;/p&gt;

&lt;p&gt;è¿™ä»£ç ç›¸æ¯”å‰é¢ä¸¤ä¸ªå°±æ¯”è¾ƒé‡è¦äº†ï¼Œæˆ‘ä»¬éœ€è¦ç‚¹è¿›å»å¥½å¥½çœ‹çœ‹ï¼Œåšäº†ä»€ä¹ˆæ“ä½œ:
	protected void prepareBeanFactory(ConfigurableListableBeanFactory beanFactory) {
		// Tell the internal bean factory to use the contextâ€™s class loader etc.
		beanFactory.setBeanClassLoader(getClassLoader());//è®¾ç½®ç±»åŠ è½½å™¨&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;	//è®¾ç½®beanè¡¨è¾¾å¼è§£æå™¨
	beanFactory.setBeanExpressionResolver(new StandardBeanExpressionResolver(beanFactory.getBeanClassLoader()));

	//å±æ€§ç¼–è¾‘å™¨æ”¯æŒ
	beanFactory.addPropertyEditorRegistrar(new ResourceEditorRegistrar(this, getEnvironment()));

	// Configure the bean factory with context callbacks.
	//æ·»åŠ ä¸€ä¸ªåç½®å¤„ç†å™¨ï¼šApplicationContextAwareProcessorï¼Œæ­¤åç½®å¤„ç†å¤„ç†å™¨å®ç°äº†BeanPostProcessoræ¥å£
	beanFactory.addBeanPostProcessor(new ApplicationContextAwareProcessor(this));

	//ä»¥ä¸‹æ¥å£ï¼Œå¿½ç•¥è‡ªåŠ¨è£…é…
	beanFactory.ignoreDependencyInterface(EnvironmentAware.class);
	beanFactory.ignoreDependencyInterface(EmbeddedValueResolverAware.class);
	beanFactory.ignoreDependencyInterface(ResourceLoaderAware.class);
	beanFactory.ignoreDependencyInterface(ApplicationEventPublisherAware.class);
	beanFactory.ignoreDependencyInterface(MessageSourceAware.class);
	beanFactory.ignoreDependencyInterface(ApplicationContextAware.class);

	// BeanFactory interface not registered as resolvable type in a plain factory.
	// MessageSource registered (and found for autowiring) as a bean.
	//ä»¥ä¸‹æ¥å£ï¼Œå…è®¸è‡ªåŠ¨è£…é…,ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è‡ªåŠ¨è£…é…çš„ç±»å‹ï¼Œï¼Œç¬¬äºŒä¸ªå­—æ®µæ˜¯è‡ªåŠ¨è£…é…çš„å€¼
	beanFactory.registerResolvableDependency(BeanFactory.class, beanFactory);
	beanFactory.registerResolvableDependency(ResourceLoader.class, this);
	beanFactory.registerResolvableDependency(ApplicationEventPublisher.class, this);
	beanFactory.registerResolvableDependency(ApplicationContext.class, this);

	// Register early post-processor for detecting inner beans as ApplicationListeners.
	//æ·»åŠ ä¸€ä¸ªåç½®å¤„ç†å™¨ï¼šApplicationListenerDetectorï¼Œæ­¤åç½®å¤„ç†å™¨å®ç°äº†BeanPostProcessoræ¥å£
	beanFactory.addBeanPostProcessor(new ApplicationListenerDetector(this));

	// Detect a LoadTimeWeaver and prepare for weaving, if found.
	if (beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) {
		beanFactory.addBeanPostProcessor(new LoadTimeWeaverAwareProcessor(beanFactory));
		// Set a temporary ClassLoader for type matching.
		beanFactory.setTempClassLoader(new ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader()));
	}

	//å¦‚æœæ²¡æœ‰æ³¨å†Œè¿‡beanåç§°ä¸ºXXXï¼Œspringå°±è‡ªå·±åˆ›å»ºä¸€ä¸ªåç§°ä¸ºXXXçš„singleton bean
	//Register default environment beans.

	if (!beanFactory.containsLocalBean(ENVIRONMENT_BEAN_NAME)) {
		beanFactory.registerSingleton(ENVIRONMENT_BEAN_NAME, getEnvironment());
	}
	if (!beanFactory.containsLocalBean(SYSTEM_PROPERTIES_BEAN_NAME)) {
		beanFactory.registerSingleton(SYSTEM_PROPERTIES_BEAN_NAME, getEnvironment().getSystemProperties());
	}
	if (!beanFactory.containsLocalBean(SYSTEM_ENVIRONMENT_BEAN_NAME)) {
		beanFactory.registerSingleton(SYSTEM_ENVIRONMENT_BEAN_NAME, getEnvironment().getSystemEnvironment());
	}
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;ä¸»è¦åšäº†å¦‚ä¸‹çš„æ“ä½œï¼š
è®¾ç½®äº†ä¸€ä¸ªç±»åŠ è½½å™¨
è®¾ç½®äº†beanè¡¨è¾¾å¼è§£æå™¨
æ·»åŠ äº†å±æ€§ç¼–è¾‘å™¨çš„æ”¯æŒ
æ·»åŠ äº†ä¸€ä¸ªåç½®å¤„ç†å™¨ï¼šApplicationContextAwareProcessorï¼Œæ­¤åç½®å¤„ç†å™¨å®ç°äº†BeanPostProcessoræ¥å£
è®¾ç½®äº†ä¸€äº›å¿½ç•¥è‡ªåŠ¨è£…é…çš„æ¥å£
è®¾ç½®äº†ä¸€äº›å…è®¸è‡ªåŠ¨è£…é…çš„æ¥å£ï¼Œå¹¶ä¸”è¿›è¡Œäº†èµ‹å€¼æ“ä½œ
åœ¨å®¹å™¨ä¸­è¿˜æ²¡æœ‰XXçš„beançš„æ—¶å€™ï¼Œå¸®æˆ‘ä»¬æ³¨å†ŒbeanNameä¸ºXXçš„singleton bean
6.4 postProcessBeanFactory(beanFactory)
				//è¿™æ˜¯ä¸€ä¸ªç©ºæ–¹æ³•
				postProcessBeanFactory(beanFactory);&lt;/p&gt;

&lt;p&gt;è¿™æ˜¯ä¸€ä¸ªç©ºæ–¹æ³•ï¼Œå¯èƒ½ä»¥åSpringä¼šè¿›è¡Œæ‰©å±•æŠŠã€‚
6.5-invokeBeanFactoryPostProcessors(beanFactory)
å¯ä»¥ç»“åˆæµç¨‹å›¾ä¸€èµ·è§‚çœ‹æ›´ä½³ï¼š
https://www.processon.com/view/link/5f18298a7d9c0835d38a57c0
				//æ‰§è¡Œè‡ªå®šä¹‰çš„BeanFactoryProcessorå’Œå†…ç½®çš„BeanFactoryProcessor
				invokeBeanFactoryPostProcessors(beanFactory);
é‡ç‚¹ä»£ç ç»ˆäºæ¥äº†ï¼Œå¯ä»¥è¯´ è¿™å¥ä»£ç æ˜¯ç›®å‰ä¸ºæ­¢æœ€é‡è¦ï¼Œä¹Ÿæ˜¯å†…å®¹æœ€å¤šçš„ä»£ç äº†ï¼Œæˆ‘ä»¬æœ‰å¿…è¦å¥½å¥½åˆ†æä¸‹ï¼š
	protected void invokeBeanFactoryPostProcessors(ConfigurableListableBeanFactory beanFactory) {&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;	//getBeanFactoryPostProcessorsçœŸæ˜¯å‘ï¼Œç¬¬ä¸€æ¬¡çœ‹åˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œæ„£ä½äº†ï¼Œæ€»è§‰å¾—è·å¾—çš„æ°¸è¿œéƒ½æ˜¯ç©ºçš„é›†åˆï¼Œæ‰å…¥å‘é‡Œï¼Œä¹…ä¹…æ— æ³•è‡ªæ‹”
	//åæ¥æ‰çŸ¥é“springå…è®¸æˆ‘ä»¬æ‰‹åŠ¨æ·»åŠ BeanFactoryPostProcessor
	//å³ï¼šannotationConfigApplicationContext.addBeanFactoryPostProcessor(XXX);
	PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, getBeanFactoryPostProcessors());

	// Detect a LoadTimeWeaver and prepare for weaving, if found in the meantime
	// (e.g. through an @Bean method registered by ConfigurationClassPostProcessor)
	if (beanFactory.getTempClassLoader() == null &amp;amp;&amp;amp; beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) {
		beanFactory.addBeanPostProcessor(new LoadTimeWeaverAwareProcessor(beanFactory));
		beanFactory.setTempClassLoader(new ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader()));
	}
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;è®©æˆ‘ä»¬çœ‹çœ‹ç¬¬ä¸€ä¸ªå°æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°ï¼š
	public List&lt;BeanFactoryPostProcessor&gt; getBeanFactoryPostProcessors() {
		return this.beanFactoryPostProcessors;
	}&lt;/BeanFactoryPostProcessor&gt;&lt;/p&gt;

&lt;p&gt;è¿™é‡Œè·å¾—çš„æ˜¯BeanFactoryPostProcessorï¼Œå½“æˆ‘çœ‹åˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œæ„£ä½äº†ï¼Œé€šè¿‡IDEAçš„æŸ¥æ‰¾å¼•ç”¨åŠŸèƒ½ï¼Œæˆ‘å‘ç°è¿™ä¸ªé›†åˆæ°¸è¿œéƒ½æ˜¯ç©ºçš„ï¼Œæ ¹æœ¬æ²¡æœ‰ä»£ç ä¸ºè¿™ä¸ªé›†åˆæ·»åŠ æ•°æ®ï¼Œå¾ˆä¹…éƒ½æ²¡æœ‰æƒ³é€šï¼Œåæ¥æ‰çŸ¥é“æˆ‘ä»¬åœ¨å¤–éƒ¨å¯ä»¥æ‰‹åŠ¨æ·»åŠ ä¸€ä¸ªåç½®å¤„ç†å™¨ï¼Œè€Œä¸æ˜¯äº¤ç»™Springå»æ‰«æï¼Œå³ï¼š
		AnnotationConfigApplicationContext annotationConfigApplicationContext =
				new AnnotationConfigApplicationContext(AppConfig.class);
		annotationConfigApplicationContext.addBeanFactoryPostProcessor(XXX);&lt;/p&gt;

&lt;p&gt;åªæœ‰è¿™æ ·ï¼Œè¿™ä¸ªé›†åˆæ‰ä¸ä¼šä¸ºç©ºï¼Œä½†æ˜¯åº”è¯¥æ²¡æœ‰äººè¿™ä¹ˆåšå§ï¼Œå½“ç„¶ä¹Ÿæœ‰å¯èƒ½æ˜¯æˆ‘å­¤é™‹å¯¡é—»ã€‚
è®©æˆ‘ä»¬ç‚¹å¼€invokeBeanFactoryPostProcessorsæ–¹æ³•ï¼š
	public static void invokeBeanFactoryPostProcessors(
			ConfigurableListableBeanFactory beanFactory, List&lt;BeanFactoryPostProcessor&gt; beanFactoryPostProcessors) {&lt;/BeanFactoryPostProcessor&gt;&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;	// Invoke BeanDefinitionRegistryPostProcessors first, if any.
	Set&amp;lt;String&amp;gt; processedBeans = new HashSet&amp;lt;&amp;gt;();

	//beanFactoryæ˜¯DefaultListableBeanFactoryï¼Œæ˜¯BeanDefinitionRegistryçš„å®ç°ç±»ï¼Œæ‰€ä»¥è‚¯å®šæ»¡è¶³if
	if (beanFactory instanceof BeanDefinitionRegistry) {
		BeanDefinitionRegistry registry = (BeanDefinitionRegistry) beanFactory;

		//regularPostProcessors ç”¨æ¥å­˜æ”¾BeanFactoryPostProcessorï¼Œ
		List&amp;lt;BeanFactoryPostProcessor&amp;gt; regularPostProcessors = new ArrayList&amp;lt;&amp;gt;();

		//registryProcessors ç”¨æ¥å­˜æ”¾BeanDefinitionRegistryPostProcessor
		//BeanDefinitionRegistryPostProcessoræ‰©å±•äº†BeanFactoryPostProcessor
		List&amp;lt;BeanDefinitionRegistryPostProcessor&amp;gt; registryProcessors = new ArrayList&amp;lt;&amp;gt;();

		// å¾ªç¯ä¼ è¿›æ¥çš„beanFactoryPostProcessorsï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼ŒbeanFactoryPostProcessorsè‚¯å®šæ²¡æœ‰æ•°æ®
		// å› ä¸ºbeanFactoryPostProcessorsæ˜¯è·å¾—æ‰‹åŠ¨æ·»åŠ çš„ï¼Œè€Œä¸æ˜¯springæ‰«æçš„
		// åªæœ‰æ‰‹åŠ¨è°ƒç”¨annotationConfigApplicationContext.addBeanFactoryPostProcessor(XXX)æ‰ä¼šæœ‰æ•°æ®
		for (BeanFactoryPostProcessor postProcessor : beanFactoryPostProcessors) {
			// åˆ¤æ–­postProcessoræ˜¯ä¸æ˜¯BeanDefinitionRegistryPostProcessorï¼Œå› ä¸ºBeanDefinitionRegistryPostProcessor
			// æ‰©å±•äº†BeanFactoryPostProcessorï¼Œæ‰€ä»¥è¿™é‡Œå…ˆè¦åˆ¤æ–­æ˜¯ä¸æ˜¯BeanDefinitionRegistryPostProcessor
			// æ˜¯çš„è¯ï¼Œç›´æ¥æ‰§è¡ŒpostProcessBeanDefinitionRegistryæ–¹æ³•ï¼Œç„¶åæŠŠå¯¹è±¡è£…åˆ°registryProcessorsé‡Œé¢å»
			if (postProcessor instanceof BeanDefinitionRegistryPostProcessor) {
				BeanDefinitionRegistryPostProcessor registryProcessor =
						(BeanDefinitionRegistryPostProcessor) postProcessor;
				registryProcessor.postProcessBeanDefinitionRegistry(registry);
				registryProcessors.add(registryProcessor);
			}

			else {//ä¸æ˜¯çš„è¯ï¼Œå°±è£…åˆ°regularPostProcessors
				regularPostProcessors.add(postProcessor);
			}
		}

		// Do not initialize FactoryBeans here: We need to leave all regular beans
		// uninitialized to let the bean factory post-processors apply to them!
		// Separate between BeanDefinitionRegistryPostProcessors that implement
		// PriorityOrdered, Ordered, and the rest.
		//ä¸€ä¸ªä¸´æ—¶å˜é‡ï¼Œç”¨æ¥è£…è½½BeanDefinitionRegistryPostProcessor
		//BeanDefinitionRegistryç»§æ‰¿äº†PostProcessorBeanFactoryPostProcessor
		List&amp;lt;BeanDefinitionRegistryPostProcessor&amp;gt; currentRegistryProcessors = new ArrayList&amp;lt;&amp;gt;();

		// First, invoke the BeanDefinitionRegistryPostProcessors that implement PriorityOrdered.
		// è·å¾—å®ç°BeanDefinitionRegistryPostProcessoræ¥å£çš„ç±»çš„BeanName:org.springframework.context.annotation.internalConfigurationAnnotationProcessor
		// å¹¶ä¸”è£…å…¥æ•°ç»„postProcessorNamesï¼Œæˆ‘ç†è§£ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåªä¼šæ‰¾åˆ°ä¸€ä¸ª
		// è¿™é‡Œåˆæœ‰ä¸€ä¸ªå‘ï¼Œä¸ºä»€ä¹ˆæˆ‘è‡ªå·±åˆ›å»ºäº†ä¸€ä¸ªå®ç°BeanDefinitionRegistryPostProcessoræ¥å£çš„ç±»ï¼Œä¹Ÿæ‰“ä¸Šäº†@Componentæ³¨è§£
		// é…ç½®ç±»ä¹ŸåŠ ä¸Šäº†@Componentæ³¨è§£ï¼Œä½†æ˜¯è¿™é‡Œå´æ²¡æœ‰æ‹¿åˆ°
		// å› ä¸ºç›´åˆ°è¿™ä¸€æ­¥ï¼ŒSpringè¿˜æ²¡æœ‰å»æ‰«æï¼Œæ‰«ææ˜¯åœ¨ConfigurationClassPostProcessorç±»ä¸­å®Œæˆçš„ï¼Œä¹Ÿå°±æ˜¯ä¸‹é¢çš„ç¬¬ä¸€ä¸ª
		// invokeBeanDefinitionRegistryPostProcessorsæ–¹æ³•
		String[] postProcessorNames =
				beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false);

		for (String ppName : postProcessorNames) {
			if (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) {
				//è·å¾—ConfigurationClassPostProcessorç±»ï¼Œå¹¶ä¸”æ”¾åˆ°currentRegistryProcessors
				//ConfigurationClassPostProcessoræ˜¯å¾ˆé‡è¦çš„ä¸€ä¸ªç±»ï¼Œå®ƒå®ç°äº†BeanDefinitionRegistryPostProcessoræ¥å£
				//BeanDefinitionRegistryPostProcessoræ¥å£åˆå®ç°äº†BeanFactoryPostProcessoræ¥å£
				//ConfigurationClassPostProcessoræ˜¯æå…¶é‡è¦çš„ç±»
				//é‡Œé¢æ‰§è¡Œäº†æ‰«æBeanï¼ŒImportï¼ŒImportResouceç­‰å„ç§æ“ä½œ
				//ç”¨æ¥å¤„ç†é…ç½®ç±»ï¼ˆæœ‰ä¸¤ç§æƒ…å†µ ä¸€ç§æ˜¯ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„é…ç½®ç±»ï¼Œä¸€ç§æ˜¯æ™®é€šçš„beanï¼‰çš„å„ç§é€»è¾‘
				currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));
				//æŠŠnameæ”¾åˆ°processedBeansï¼Œåç»­ä¼šæ ¹æ®è¿™ä¸ªé›†åˆæ¥åˆ¤æ–­å¤„ç†å™¨æ˜¯å¦å·²ç»è¢«æ‰§è¡Œè¿‡äº†
				processedBeans.add(ppName);
			}
		}

		//å¤„ç†æ’åº
		sortPostProcessors(currentRegistryProcessors, beanFactory);

		//åˆå¹¶Processorsï¼Œä¸ºä»€ä¹ˆè¦åˆå¹¶ï¼Œå› ä¸ºregistryProcessorsæ˜¯è£…è½½BeanDefinitionRegistryPostProcessorçš„
		//ä¸€å¼€å§‹çš„æ—¶å€™ï¼Œspringåªä¼šæ‰§è¡ŒBeanDefinitionRegistryPostProcessorç‹¬æœ‰çš„æ–¹æ³•
		//è€Œä¸ä¼šæ‰§è¡ŒBeanDefinitionRegistryPostProcessorçˆ¶ç±»çš„æ–¹æ³•ï¼Œå³BeanFactoryProcessorçš„æ–¹æ³•
		//æ‰€ä»¥è¿™é‡Œéœ€è¦æŠŠå¤„ç†å™¨æ”¾å…¥ä¸€ä¸ªé›†åˆä¸­ï¼Œåç»­ç»Ÿä¸€æ‰§è¡Œçˆ¶ç±»çš„æ–¹æ³•
		registryProcessors.addAll(currentRegistryProcessors);

		//å¯ä»¥ç†è§£ä¸ºæ‰§è¡ŒConfigurationClassPostProcessorçš„postProcessBeanDefinitionRegistryæ–¹æ³•
		//Springçƒ­æ’æ’­çš„ä½“ç°ï¼ŒåƒConfigurationClassPostProcessorå°±ç›¸å½“äºä¸€ä¸ªç»„ä»¶ï¼ŒSpringå¾ˆå¤šäº‹æƒ…å°±æ˜¯äº¤ç»™ç»„ä»¶å»ç®¡ç†
		//å¦‚æœä¸æƒ³ç”¨è¿™ä¸ªç»„ä»¶ï¼Œç›´æ¥æŠŠæ³¨å†Œç»„ä»¶çš„é‚£ä¸€æ­¥å»æ‰å°±å¯ä»¥
		invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);

		//å› ä¸ºcurrentRegistryProcessorsæ˜¯ä¸€ä¸ªä¸´æ—¶å˜é‡ï¼Œæ‰€ä»¥éœ€è¦æ¸…é™¤
		currentRegistryProcessors.clear();

		// Next, invoke the BeanDefinitionRegistryPostProcessors that implement Ordered.
		// å†æ¬¡æ ¹æ®BeanDefinitionRegistryPostProcessorè·å¾—BeanNameï¼Œçœ‹è¿™ä¸ªBeanNameæ˜¯å¦å·²ç»è¢«æ‰§è¡Œè¿‡äº†ï¼Œæœ‰æ²¡æœ‰å®ç°Orderedæ¥å£
		// å¦‚æœæ²¡æœ‰è¢«æ‰§è¡Œè¿‡ï¼Œä¹Ÿå®ç°äº†Orderedæ¥å£çš„è¯ï¼ŒæŠŠå¯¹è±¡æ¨é€åˆ°currentRegistryProcessorsï¼Œåç§°æ¨é€åˆ°processedBeans
		// å¦‚æœæ²¡æœ‰å®ç°Orderedæ¥å£çš„è¯ï¼Œè¿™é‡Œä¸æŠŠæ•°æ®åŠ åˆ°currentRegistryProcessorsï¼ŒprocessedBeansä¸­ï¼Œåç»­å†åšå¤„ç†
		// è¿™é‡Œæ‰å¯ä»¥è·å¾—æˆ‘ä»¬å®šä¹‰çš„å®ç°äº†BeanDefinitionRegistryPostProcessorçš„Bean
		postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false);
		for (String ppName : postProcessorNames) {
			if (!processedBeans.contains(ppName) &amp;amp;&amp;amp; beanFactory.isTypeMatch(ppName, Ordered.class)) {
				currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));
				processedBeans.add(ppName);
			}
		}

		//å¤„ç†æ’åº
		sortPostProcessors(currentRegistryProcessors, beanFactory);

		//åˆå¹¶Processors
		registryProcessors.addAll(currentRegistryProcessors);

		//æ‰§è¡Œæˆ‘ä»¬è‡ªå®šä¹‰çš„BeanDefinitionRegistryPostProcessor
		invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);

		//æ¸…ç©ºä¸´æ—¶å˜é‡
		currentRegistryProcessors.clear();

		// Finally, invoke all other BeanDefinitionRegistryPostProcessors until no further ones appear.
		// ä¸Šé¢çš„ä»£ç æ˜¯æ‰§è¡Œäº†å®ç°äº†Orderedæ¥å£çš„BeanDefinitionRegistryPostProcessorï¼Œ
		// ä¸‹é¢çš„ä»£ç å°±æ˜¯æ‰§è¡Œæ²¡æœ‰å®ç°Orderedæ¥å£çš„BeanDefinitionRegistryPostProcessor
		boolean reiterate = true;
		while (reiterate) {
			reiterate = false;
			postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false);
			for (String ppName : postProcessorNames) {
				if (!processedBeans.contains(ppName)) {
					currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));
					processedBeans.add(ppName);
					reiterate = true;
				}
			}
			sortPostProcessors(currentRegistryProcessors, beanFactory);
			registryProcessors.addAll(currentRegistryProcessors);
			invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);
			currentRegistryProcessors.clear();
		}

		// Now, invoke the postProcessBeanFactory callback of all processors handled so far.
		//registryProcessorsé›†åˆè£…è½½BeanDefinitionRegistryPostProcessor
		//ä¸Šé¢çš„ä»£ç æ˜¯æ‰§è¡Œå­ç±»ç‹¬æœ‰çš„æ–¹æ³•ï¼Œè¿™é‡Œéœ€è¦å†æŠŠçˆ¶ç±»çš„æ–¹æ³•ä¹Ÿæ‰§è¡Œä¸€æ¬¡
		invokeBeanFactoryPostProcessors(registryProcessors, beanFactory);

		//regularPostProcessorsè£…è½½BeanFactoryPostProcessorï¼Œæ‰§è¡ŒBeanFactoryPostProcessorçš„æ–¹æ³•
		//ä½†æ˜¯regularPostProcessorsä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ˜¯ä¸ä¼šæœ‰æ•°æ®çš„ï¼Œåªæœ‰åœ¨å¤–é¢æ‰‹åŠ¨æ·»åŠ BeanFactoryPostProcessorï¼Œæ‰ä¼šæœ‰æ•°æ®
		invokeBeanFactoryPostProcessors(regularPostProcessors, beanFactory);
	}

	else {
		// Invoke factory processors registered with the context instance.
		invokeBeanFactoryPostProcessors(beanFactoryPostProcessors, beanFactory);
	}

	// Do not initialize FactoryBeans here: We need to leave all regular beans
	// uninitialized to let the bean factory post-processors apply to them!
	//æ‰¾åˆ°BeanFactoryPostProcessorå®ç°ç±»çš„BeanNameæ•°ç»„
	String[] postProcessorNames =
			beanFactory.getBeanNamesForType(BeanFactoryPostProcessor.class, true, false);

	// Separate between BeanFactoryPostProcessors that implement PriorityOrdered,
	// Ordered, and the rest.
	List&amp;lt;BeanFactoryPostProcessor&amp;gt; priorityOrderedPostProcessors = new ArrayList&amp;lt;&amp;gt;();
	List&amp;lt;String&amp;gt; orderedPostProcessorNames = new ArrayList&amp;lt;&amp;gt;();
	List&amp;lt;String&amp;gt; nonOrderedPostProcessorNames = new ArrayList&amp;lt;&amp;gt;();
	//å¾ªç¯BeanNameæ•°ç»„
	for (String ppName : postProcessorNames) {
		//å¦‚æœè¿™ä¸ªBeanè¢«æ‰§è¡Œè¿‡äº†ï¼Œè·³è¿‡
		if (processedBeans.contains(ppName)) {
			// skip - already processed in first phase above
		}
		//å¦‚æœå®ç°äº†PriorityOrderedæ¥å£ï¼ŒåŠ å…¥åˆ°priorityOrderedPostProcessors
		else if (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) {
			priorityOrderedPostProcessors.add(beanFactory.getBean(ppName, BeanFactoryPostProcessor.class));
		}
		//å¦‚æœå®ç°äº†Orderedæ¥å£ï¼ŒåŠ å…¥åˆ°orderedPostProcessorNames
		else if (beanFactory.isTypeMatch(ppName, Ordered.class)) {
			orderedPostProcessorNames.add(ppName);
		}
		//å¦‚æœæ—¢æ²¡æœ‰å®ç°PriorityOrderedï¼Œä¹Ÿæ²¡æœ‰å®ç°Orderedã€‚åŠ å…¥åˆ°nonOrderedPostProcessorNames
		else {
			nonOrderedPostProcessorNames.add(ppName);
		}
	}

	//æ’åºå¤„ç†priorityOrderedPostProcessorsï¼Œå³å®ç°äº†PriorityOrderedæ¥å£çš„BeanFactoryPostProcessor
	// First, invoke the BeanFactoryPostProcessors that implement PriorityOrdered.
	sortPostProcessors(priorityOrderedPostProcessors, beanFactory);
	//æ‰§è¡ŒpriorityOrderedPostProcessors
	invokeBeanFactoryPostProcessors(priorityOrderedPostProcessors, beanFactory);

	//æ‰§è¡Œå®ç°äº†Orderedæ¥å£çš„BeanFactoryPostProcessor
	// Next, invoke the BeanFactoryPostProcessors that implement Ordered.
	List&amp;lt;BeanFactoryPostProcessor&amp;gt; orderedPostProcessors = new ArrayList&amp;lt;&amp;gt;();
	for (String postProcessorName : orderedPostProcessorNames) {
		orderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));
	}
	sortPostProcessors(orderedPostProcessors, beanFactory);
	invokeBeanFactoryPostProcessors(orderedPostProcessors, beanFactory);

	// æ‰§è¡Œæ—¢æ²¡æœ‰å®ç°PriorityOrderedæ¥å£ï¼Œä¹Ÿæ²¡æœ‰å®ç°Orderedæ¥å£çš„BeanFactoryPostProcessor
	// Finally, invoke all other BeanFactoryPostProcessors.
	List&amp;lt;BeanFactoryPostProcessor&amp;gt; nonOrderedPostProcessors = new ArrayList&amp;lt;&amp;gt;();
	for (String postProcessorName : nonOrderedPostProcessorNames) {
		nonOrderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));
	}
	invokeBeanFactoryPostProcessors(nonOrderedPostProcessors, beanFactory);

	// Clear cached merged bean definitions since the post-processors might have
	// modified the original metadata, e.g. replacing placeholders in values...
	beanFactory.clearMetadataCache();
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;é¦–å…ˆåˆ¤æ–­beanFactoryæ˜¯ä¸æ˜¯BeanDefinitionRegistryçš„å®ä¾‹ï¼Œå½“ç„¶è‚¯å®šæ˜¯çš„ï¼Œç„¶åæ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼š
å®šä¹‰äº†ä¸€ä¸ªSetï¼Œè£…è½½BeanNameï¼Œåé¢ä¼šæ ¹æ®è¿™ä¸ªSetï¼Œæ¥åˆ¤æ–­åç½®å¤„ç†å™¨æ˜¯å¦è¢«æ‰§è¡Œè¿‡äº†ã€‚
å®šä¹‰äº†ä¸¤ä¸ªListï¼Œä¸€ä¸ªæ˜¯regularPostProcessorsï¼Œç”¨æ¥è£…è½½BeanFactoryPostProcessorï¼Œä¸€ä¸ªæ˜¯registryProcessorsç”¨æ¥è£…è½½BeanDefinitionRegistryPostProcessorï¼Œå…¶ä¸­BeanDefinitionRegistryPostProcessoræ‰©å±•äº†BeanFactoryPostProcessorã€‚BeanDefinitionRegistryPostProcessoræœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯ç‹¬æœ‰çš„postProcessBeanDefinitionRegistryæ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯çˆ¶ç±»çš„postProcessBeanFactoryæ–¹æ³•ã€‚
å¾ªç¯ä¼ è¿›æ¥çš„beanFactoryPostProcessorsï¼Œä¸Šé¢å·²ç»è§£é‡Šè¿‡äº†ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¿™é‡Œæ°¸è¿œéƒ½æ˜¯ç©ºçš„ï¼Œåªæœ‰æ‰‹åŠ¨add beanFactoryPostProcessorï¼Œè¿™é‡Œæ‰ä¼šæœ‰æ•°æ®ã€‚æˆ‘ä»¬å‡è®¾beanFactoryPostProcessorsæœ‰æ•°æ®ï¼Œè¿›å…¥å¾ªç¯ï¼Œåˆ¤æ–­postProcessoræ˜¯ä¸æ˜¯BeanDefinitionRegistryPostProcessorï¼Œå› ä¸ºBeanDefinitionRegistryPostProcessoræ‰©å±•äº†BeanFactoryPostProcessorï¼Œæ‰€ä»¥è¿™é‡Œå…ˆè¦åˆ¤æ–­æ˜¯ä¸æ˜¯BeanDefinitionRegistryPostProcessorï¼Œæ˜¯çš„è¯ï¼Œæ‰§è¡ŒpostProcessBeanDefinitionRegistryæ–¹æ³•ï¼Œç„¶åæŠŠå¯¹è±¡è£…åˆ°registryProcessorsé‡Œé¢å»ï¼Œä¸æ˜¯çš„è¯ï¼Œå°±è£…åˆ°regularPostProcessorsã€‚
å®šä¹‰äº†ä¸€ä¸ªä¸´æ—¶å˜é‡ï¼šcurrentRegistryProcessorsï¼Œç”¨æ¥è£…è½½BeanDefinitionRegistryPostProcessorã€‚
getBeanNamesForTypeï¼Œé¡¾åæ€ä¹‰ï¼Œæ˜¯æ ¹æ®ç±»å‹æŸ¥åˆ°BeanNamesï¼Œè¿™é‡Œæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œå°±æ˜¯å»å“ªé‡Œæ‰¾ï¼Œç‚¹å¼€è¿™ä¸ªæ–¹æ³•çš„è¯ï¼Œå°±çŸ¥é“æ˜¯å¾ªç¯beanDefinitionNameså»æ‰¾ï¼Œè¿™ä¸ªæ–¹æ³•ä»¥åä¹Ÿä¼šç»å¸¸çœ‹åˆ°ã€‚è¿™é‡Œä¼ äº†BeanDefinitionRegistryPostProcessor.classï¼Œå°±æ˜¯æ‰¾åˆ°ç±»å‹ä¸ºBeanDefinitionRegistryPostProcessorçš„åç½®å¤„ç†å™¨ï¼Œå¹¶ä¸”èµ‹å€¼ç»™postProcessorNamesã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåªä¼šæ‰¾åˆ°ä¸€ä¸ªï¼Œå°±æ˜¯org.springframework.context.annotation.internalConfigurationAnnotationProcessorï¼Œä¹Ÿå°±æ˜¯ConfigurationAnnotationProcessorã€‚è¿™ä¸ªåç½®å¤„ç†å™¨åœ¨ä¸Šä¸€èŠ‚ä¸­å·²ç»è¯´æ˜è¿‡äº†ï¼Œååˆ†é‡è¦ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆæˆ‘è‡ªå·±å†™äº†ä¸ªç±»ï¼Œå®ç°äº†BeanDefinitionRegistryPostProcessoræ¥å£ï¼Œä¹Ÿæ‰“ä¸Šäº†@Componentæ³¨è§£ï¼Œä½†æ˜¯è¿™é‡Œæ²¡æœ‰è·å¾—ï¼Œå› ä¸ºç›´åˆ°è¿™ä¸€æ­¥ï¼ŒSpringè¿˜æ²¡æœ‰å®Œæˆæ‰«æï¼Œæ‰«ææ˜¯åœ¨ConfigurationClassPostProcessorç±»ä¸­å®Œæˆçš„ï¼Œä¹Ÿå°±æ˜¯ä¸‹é¢ç¬¬ä¸€ä¸ªinvokeBeanDefinitionRegistryPostProcessorsæ–¹æ³•ã€‚
å¾ªç¯postProcessorNamesï¼Œå…¶å®ä¹Ÿå°±æ˜¯org.springframework.context.annotation.internalConfigurationAnnotationProcessorï¼Œåˆ¤æ–­æ­¤åç½®å¤„ç†å™¨æ˜¯å¦å®ç°äº†PriorityOrderedæ¥å£ï¼ˆConfigurationAnnotationProcessorä¹Ÿå®ç°äº†PriorityOrderedæ¥å£ï¼‰ï¼Œ
å¦‚æœå®ç°äº†ï¼ŒæŠŠå®ƒæ·»åŠ åˆ°currentRegistryProcessorsè¿™ä¸ªä¸´æ—¶å˜é‡ä¸­ï¼Œå†æ”¾å…¥processedBeansï¼Œä»£è¡¨è¿™ä¸ªåç½®å¤„ç†å·²ç»è¢«å¤„ç†è¿‡äº†ã€‚å½“ç„¶ç°åœ¨è¿˜æ²¡æœ‰å¤„ç†ï¼Œä½†æ˜¯é©¬ä¸Šå°±è¦å¤„ç†äº†ã€‚ã€‚ã€‚&lt;/p&gt;

&lt;p&gt;è¿›è¡Œæ’åºï¼ŒPriorityOrderedæ˜¯ä¸€ä¸ªæ’åºæ¥å£ï¼Œå¦‚æœå®ç°äº†å®ƒï¼Œå°±è¯´æ˜æ­¤åç½®å¤„ç†å™¨æ˜¯æœ‰é¡ºåºçš„ï¼Œæ‰€ä»¥éœ€è¦æ’åºã€‚å½“ç„¶ç›®å‰è¿™é‡Œåªæœ‰ä¸€ä¸ªåç½®å¤„ç†å™¨ï¼Œå°±æ˜¯ConfigurationClassPostProcessorã€‚
æŠŠcurrentRegistryProcessorsåˆå¹¶åˆ°registryProcessorsï¼Œä¸ºä»€ä¹ˆéœ€è¦åˆå¹¶ï¼Ÿå› ä¸ºä¸€å¼€å§‹springåªä¼šæ‰§è¡ŒBeanDefinitionRegistryPostProcessorç‹¬æœ‰çš„æ–¹æ³•ï¼Œè€Œä¸ä¼šæ‰§è¡ŒBeanDefinitionRegistryPostProcessorçˆ¶ç±»çš„æ–¹æ³•ï¼Œå³BeanFactoryProcessoræ¥å£ä¸­çš„æ–¹æ³•ï¼Œæ‰€ä»¥éœ€è¦æŠŠè¿™äº›åç½®å¤„ç†å™¨æ”¾å…¥ä¸€ä¸ªé›†åˆä¸­ï¼Œåç»­ç»Ÿä¸€æ‰§è¡ŒBeanFactoryProcessoræ¥å£ä¸­çš„æ–¹æ³•ã€‚å½“ç„¶ç›®å‰è¿™é‡Œåªæœ‰ä¸€ä¸ªåç½®å¤„ç†å™¨ï¼Œå°±æ˜¯ConfigurationClassPostProcessorã€‚
å¯ä»¥ç†è§£ä¸ºæ‰§è¡ŒcurrentRegistryProcessorsä¸­çš„ConfigurationClassPostProcessorä¸­çš„postProcessBeanDefinitionRegistryæ–¹æ³•ï¼Œè¿™å°±æ˜¯Springè®¾è®¡æ€æƒ³çš„ä½“ç°äº†ï¼Œåœ¨è¿™é‡Œä½“ç°çš„å°±æ˜¯å…¶ä¸­çš„çƒ­æ’æ‹”ï¼Œæ’ä»¶åŒ–å¼€å‘çš„æ€æƒ³ã€‚Springä¸­å¾ˆå¤šä¸œè¥¿éƒ½æ˜¯äº¤ç»™æ’ä»¶å»å¤„ç†çš„ï¼Œè¿™ä¸ªåç½®å¤„ç†å™¨å°±ç›¸å½“äºä¸€ä¸ªæ’ä»¶ï¼Œå¦‚æœä¸æƒ³ç”¨äº†ï¼Œç›´æ¥ä¸æ·»åŠ å°±æ˜¯äº†ã€‚è¿™ä¸ªæ–¹æ³•ç‰¹åˆ«é‡è¦ï¼Œæˆ‘ä»¬åé¢ä¼šè¯¦ç»†è¯´æ¥ã€‚&lt;/p&gt;

&lt;p&gt;æ¸…ç©ºcurrentRegistryProcessorsï¼Œå› ä¸ºcurrentRegistryProcessorsæ˜¯ä¸€ä¸ªä¸´æ—¶å˜é‡ï¼Œå·²ç»å®Œæˆäº†ç›®å‰çš„ä½¿å‘½ï¼Œæ‰€ä»¥éœ€è¦æ¸…ç©ºï¼Œå½“ç„¶åé¢è¿˜ä¼šç”¨åˆ°ã€‚
å†æ¬¡æ ¹æ®BeanDefinitionRegistryPostProcessorè·å¾—BeanNameï¼Œç„¶åè¿›è¡Œå¾ªç¯ï¼Œçœ‹è¿™ä¸ªåç½®å¤„ç†å™¨æ˜¯å¦è¢«æ‰§è¡Œè¿‡äº†ï¼Œå¦‚æœæ²¡æœ‰è¢«æ‰§è¡Œè¿‡ï¼Œä¹Ÿå®ç°äº†Orderedæ¥å£çš„è¯ï¼ŒæŠŠæ­¤åç½®å¤„ç†å™¨æ¨é€åˆ°currentRegistryProcessorså’ŒprocessedBeansä¸­ã€‚
è¿™é‡Œå°±å¯ä»¥è·å¾—æˆ‘ä»¬å®šä¹‰çš„ï¼Œå¹¶ä¸”æ‰“ä¸Š@Componentæ³¨è§£çš„åç½®å¤„ç†å™¨äº†ï¼Œå› ä¸ºSpringå·²ç»å®Œæˆäº†æ‰«æï¼Œä½†æ˜¯è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºConfigurationClassPostProcessoråœ¨ä¸Šé¢å·²ç»è¢«æ‰§è¡Œè¿‡äº†ï¼Œæ‰€ä»¥è™½ç„¶å¯ä»¥é€šè¿‡getBeanNamesForTypeè·å¾—ï¼Œä½†æ˜¯å¹¶ä¸ä¼šåŠ å…¥åˆ°currentRegistryProcessorså’ŒprocessedBeansã€‚
å¤„ç†æ’åºã€‚
åˆå¹¶Processorsï¼Œåˆå¹¶çš„ç†ç”±å’Œä¸Šé¢æ˜¯ä¸€æ ·çš„ã€‚
æ‰§è¡Œæˆ‘ä»¬è‡ªå®šä¹‰çš„BeanDefinitionRegistryPostProcessorã€‚
æ¸…ç©ºä¸´æ—¶å˜é‡ã€‚
åœ¨ä¸Šé¢çš„æ–¹æ³•ä¸­ï¼Œä»…ä»…æ˜¯æ‰§è¡Œäº†å®ç°äº†Orderedæ¥å£çš„BeanDefinitionRegistryPostProcessorï¼Œè¿™é‡Œæ˜¯æ‰§è¡Œæ²¡æœ‰å®ç°Orderedæ¥å£çš„BeanDefinitionRegistryPostProcessorã€‚
ä¸Šé¢çš„ä»£ç æ˜¯æ‰§è¡Œå­ç±»ç‹¬æœ‰çš„æ–¹æ³•ï¼Œè¿™é‡Œéœ€è¦å†æŠŠçˆ¶ç±»çš„æ–¹æ³•ä¹Ÿæ‰§è¡Œä¸€æ¬¡ã€‚
æ‰§è¡ŒregularPostProcessorsä¸­çš„åç½®å¤„ç†å™¨çš„æ–¹æ³•ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒregularPostProcessorsæ˜¯ä¸ä¼šæœ‰æ•°æ®çš„ï¼Œåªæœ‰åœ¨å¤–é¢æ‰‹åŠ¨æ·»åŠ BeanFactoryPostProcessorï¼Œæ‰ä¼šæœ‰æ•°æ®ã€‚
æŸ¥æ‰¾å®ç°äº†BeanFactoryPostProcessorçš„åç½®å¤„ç†å™¨ï¼Œå¹¶ä¸”æ‰§è¡Œåç½®å¤„ç†å™¨ä¸­çš„æ–¹æ³•ã€‚å’Œä¸Šé¢çš„é€»è¾‘å·®ä¸å¤šï¼Œä¸å†è¯¦ç»†è¯´æ˜ã€‚
è¿™å°±æ˜¯è¿™ä¸ªæ–¹æ³•ä¸­åšçš„ä¸»è¦çš„äº‹æƒ…äº†ï¼Œå¯ä»¥è¯´æ˜¯æ¯”è¾ƒå¤æ‚çš„ã€‚ä½†æ˜¯é€»è¾‘è¿˜æ˜¯æ¯”è¾ƒæ¸…æ™°çš„ï¼Œåœ¨ç¬¬9æ­¥çš„æ—¶å€™ï¼Œæˆ‘è¯´æœ‰ä¸€ä¸ªæ–¹æ³•ä¼šè¯¦ç»†è¯´æ¥ï¼Œç°åœ¨å°±è®©æˆ‘ä»¬å¥½å¥½çœ‹çœ‹è¿™ä¸ªæ–¹æ³•ç©¶ç«Ÿåšäº†ä»€ä¹ˆå§ã€‚&lt;/p&gt;

&lt;p&gt;è¿™é‡Œé¢è°ƒç”¨é“¾å¾ˆæ·±ï¼Œ åœ¨è¯¾ç¨‹ä¸­è¯¦ç»†è®²è§£ï¼Œç¯‡å¹…æœ‰é™ã€‚&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;public void processConfigBeanDefinitions(BeanDefinitionRegistry registry) {
	List&amp;lt;BeanDefinitionHolder&amp;gt; configCandidates = new ArrayList&amp;lt;&amp;gt;();
	String[] candidateNames = registry.getBeanDefinitionNames();//è·å¾—æ‰€æœ‰çš„BeanDefinitionçš„Nameï¼Œæ”¾å…¥candidateNamesæ•°ç»„

	//å¾ªç¯candidateNamesæ•°ç»„
	for (String beanName : candidateNames) {
		BeanDefinition beanDef = registry.getBeanDefinition(beanName);//æ ¹æ®beanNameè·å¾—BeanDefinition

		// å†…éƒ¨æœ‰ä¸¤ä¸ªæ ‡è®°ä½æ¥æ ‡è®°æ˜¯å¦å·²ç»å¤„ç†è¿‡äº†
		// è¿™é‡Œä¼šå¼•å‘ä¸€è¿ä¸²çŸ¥è¯†ç›²ç‚¹
		// å½“æˆ‘ä»¬æ³¨å†Œé…ç½®ç±»çš„æ—¶å€™ï¼Œå¯ä»¥ä¸åŠ Configurationæ³¨è§£ï¼Œç›´æ¥ä½¿ç”¨Component ComponentScan Import ImportResourceæ³¨è§£ï¼Œç§°ä¹‹ä¸ºLiteé…ç½®ç±»
		// å¦‚æœåŠ äº†Configurationæ³¨è§£ï¼Œå°±ç§°ä¹‹ä¸ºFullé…ç½®ç±»
		// å¦‚æœæˆ‘ä»¬æ³¨å†Œäº†Liteé…ç½®ç±»ï¼Œæˆ‘ä»¬getBeanè¿™ä¸ªé…ç½®ç±»ï¼Œä¼šå‘ç°å®ƒå°±æ˜¯åŸæœ¬çš„é‚£ä¸ªé…ç½®ç±»
		// å¦‚æœæˆ‘ä»¬æ³¨å†Œäº†Fullé…ç½®ç±»ï¼Œæˆ‘ä»¬getBeanè¿™ä¸ªé…ç½®ç±»ï¼Œä¼šå‘ç°å®ƒå·²ç»ä¸æ˜¯åŸæœ¬é‚£ä¸ªé…ç½®ç±»äº†ï¼Œè€Œæ˜¯å·²ç»è¢«cgilbä»£ç†çš„ç±»äº†
		// å†™ä¸€ä¸ªAç±»ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªæ„é€ æ–¹æ³•ï¼Œæ‰“å°å‡ºâ€œä½ å¥½â€
		// å†å†™ä¸€ä¸ªé…ç½®ç±»ï¼Œé‡Œé¢æœ‰ä¸¤ä¸ªbeanæ³¨è§£çš„æ–¹æ³•
		// å…¶ä¸­ä¸€ä¸ªæ–¹æ³•newäº†A ç±»ï¼Œå¹¶ä¸”è¿”å›Açš„å¯¹è±¡ï¼ŒæŠŠæ­¤æ–¹æ³•ç§°ä¹‹ä¸ºgetA
		// ç¬¬äºŒä¸ªæ–¹æ³•åˆè°ƒç”¨äº†getAæ–¹æ³•
		// å¦‚æœé…ç½®ç±»æ˜¯Liteé…ç½®ç±»ï¼Œä¼šå‘ç°æ‰“å°äº†ä¸¤æ¬¡â€œä½ å¥½â€ï¼Œä¹Ÿå°±æ˜¯è¯´Aç±»è¢«newäº†ä¸¤æ¬¡
		// å¦‚æœé…ç½®ç±»æ˜¯Fullé…ç½®ç±»ï¼Œä¼šå‘ç°åªæ‰“å°äº†ä¸€æ¬¡â€œä½ å¥½â€ï¼Œä¹Ÿå°±æ˜¯è¯´Aç±»åªè¢«newäº†ä¸€æ¬¡ï¼Œå› ä¸ºè¿™ä¸ªç±»è¢«cgilbä»£ç†äº†ï¼Œæ–¹æ³•å·²ç»è¢«æ”¹å†™
		if (ConfigurationClassUtils.isFullConfigurationClass(beanDef) ||
				ConfigurationClassUtils.isLiteConfigurationClass(beanDef)) {
			if (logger.isDebugEnabled()) {
				logger.debug(&quot;Bean definition has already been processed as a configuration class: &quot; + beanDef);
			}
		}

		//åˆ¤æ–­æ˜¯å¦ä¸ºé…ç½®ç±»ï¼ˆæœ‰ä¸¤ç§æƒ…å†µ ä¸€ç§æ˜¯ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„é…ç½®ç±»ï¼Œä¸€ç§æ˜¯æ™®é€šçš„beanï¼‰ï¼Œ
		//åœ¨è¿™ä¸ªæ–¹æ³•å†…éƒ¨ï¼Œä¼šåšåˆ¤æ–­ï¼Œè¿™ä¸ªé…ç½®ç±»æ˜¯Fullé…ç½®ç±»ï¼Œè¿˜æ˜¯Liteé…ç½®ç±»ï¼Œå¹¶ä¸”åšä¸Šæ ‡è®°
		//æ»¡è¶³æ¡ä»¶ï¼ŒåŠ å…¥åˆ°configCandidates
		else if (ConfigurationClassUtils.checkConfigurationClassCandidate(beanDef, this.metadataReaderFactory)) {
			configCandidates.add(new BeanDefinitionHolder(beanDef, beanName));
		}
	}

	// å¦‚æœæ²¡æœ‰é…ç½®ç±»ï¼Œç›´æ¥è¿”å›
	// Return immediately if no @Configuration classes were found
	if (configCandidates.isEmpty()) {
		return;
	}

	// Sort by previously determined @Order value, if applicable
	//å¤„ç†æ’åº
	configCandidates.sort((bd1, bd2) -&amp;gt; {
		int i1 = ConfigurationClassUtils.getOrder(bd1.getBeanDefinition());
		int i2 = ConfigurationClassUtils.getOrder(bd2.getBeanDefinition());
		return Integer.compare(i1, i2);
	});

	// Detect any custom bean name generation strategy supplied through the enclosing application context
	SingletonBeanRegistry sbr = null;
	// DefaultListableBeanFactoryæœ€ç»ˆä¼šå®ç°SingletonBeanRegistryæ¥å£ï¼Œæ‰€ä»¥å¯ä»¥è¿›å…¥åˆ°è¿™ä¸ªif
	if (registry instanceof SingletonBeanRegistry) {
		sbr = (SingletonBeanRegistry) registry;
		if (!this.localBeanNameGeneratorSet) {
			//springä¸­å¯ä»¥ä¿®æ”¹é»˜è®¤çš„beanå‘½åæ–¹å¼ï¼Œè¿™é‡Œå°±æ˜¯çœ‹ç”¨æˆ·æœ‰æ²¡æœ‰è‡ªå®šä¹‰beanå‘½åæ–¹å¼ï¼Œè™½ç„¶ä¸€èˆ¬æ²¡æœ‰äººä¼šè¿™ä¹ˆåš
			BeanNameGenerator generator = (BeanNameGenerator) sbr.getSingleton(CONFIGURATION_BEAN_NAME_GENERATOR);
			if (generator != null) {
				this.componentScanBeanNameGenerator = generator;
				this.importBeanNameGenerator = generator;
			}
		}
	}

	if (this.environment == null) {
		this.environment = new StandardEnvironment();
	}

	// Parse each @Configuration class
	ConfigurationClassParser parser = new ConfigurationClassParser(
			this.metadataReaderFactory, this.problemReporter, this.environment,
			this.resourceLoader, this.componentScanBeanNameGenerator, registry);

	Set&amp;lt;BeanDefinitionHolder&amp;gt; candidates = new LinkedHashSet&amp;lt;&amp;gt;(configCandidates);
	Set&amp;lt;ConfigurationClass&amp;gt; alreadyParsed = new HashSet&amp;lt;&amp;gt;(configCandidates.size());
	do {
		//è§£æé…ç½®ç±»ï¼ˆä¼ ç»Ÿæ„ä¹‰ä¸Šçš„é…ç½®ç±»æˆ–è€…æ˜¯æ™®é€šbeanï¼Œæ ¸å¿ƒæ¥äº†ï¼‰
		parser.parse(candidates);
		parser.validate();

		Set&amp;lt;ConfigurationClass&amp;gt; configClasses = new LinkedHashSet&amp;lt;&amp;gt;(parser.getConfigurationClasses());
		configClasses.removeAll(alreadyParsed);

		// Read the model and create bean definitions based on its content
		if (this.reader == null) {
			this.reader = new ConfigurationClassBeanDefinitionReader(
					registry, this.sourceExtractor, this.resourceLoader, this.environment,
					this.importBeanNameGenerator, parser.getImportRegistry());
		}
		this.reader.loadBeanDefinitions(configClasses);//ç›´åˆ°è¿™ä¸€æ­¥æ‰æŠŠImportçš„ç±»ï¼Œ@Bean @ImportRosource è½¬æ¢æˆBeanDefinition
		alreadyParsed.addAll(configClasses);//æŠŠconfigClassesåŠ å…¥åˆ°alreadyParsedï¼Œä»£è¡¨

		candidates.clear();
		//è·å¾—æ³¨å†Œå™¨é‡Œé¢BeanDefinitionçš„æ•°é‡ å’Œ candidateNamesè¿›è¡Œæ¯”è¾ƒ
		//å¦‚æœå¤§äºçš„è¯ï¼Œè¯´æ˜æœ‰æ–°çš„BeanDefinitionæ³¨å†Œè¿›æ¥äº†
		if (registry.getBeanDefinitionCount() &amp;gt; candidateNames.length) {
			String[] newCandidateNames = registry.getBeanDefinitionNames();//ä»æ³¨å†Œå™¨é‡Œé¢è·å¾—BeanDefinitionNames
			Set&amp;lt;String&amp;gt; oldCandidateNames = new HashSet&amp;lt;&amp;gt;(Arrays.asList(candidateNames));//candidateNamesè½¬æ¢set
			Set&amp;lt;String&amp;gt; alreadyParsedClasses = new HashSet&amp;lt;&amp;gt;();
			//å¾ªç¯alreadyParsedã€‚æŠŠç±»ååŠ å…¥åˆ°alreadyParsedClasses
			for (ConfigurationClass configurationClass : alreadyParsed) {
				alreadyParsedClasses.add(configurationClass.getMetadata().getClassName());
			}
			for (String candidateName : newCandidateNames) {
				if (!oldCandidateNames.contains(candidateName)) {
					BeanDefinition bd = registry.getBeanDefinition(candidateName);
					if (ConfigurationClassUtils.checkConfigurationClassCandidate(bd, this.metadataReaderFactory) &amp;amp;&amp;amp;
							!alreadyParsedClasses.contains(bd.getBeanClassName())) {
						candidates.add(new BeanDefinitionHolder(bd, candidateName));
					}
				}
			}
			candidateNames = newCandidateNames;
		}
	}
	while (!candidates.isEmpty());

	// Register the ImportRegistry as a bean in order to support ImportAware @Configuration classes
	if (sbr != null &amp;amp;&amp;amp; !sbr.containsSingleton(IMPORT_REGISTRY_BEAN_NAME)) {
		sbr.registerSingleton(IMPORT_REGISTRY_BEAN_NAME, parser.getImportRegistry());
	}

	if (this.metadataReaderFactory instanceof CachingMetadataReaderFactory) {
		// Clear cache in externally provided MetadataReaderFactory; this is a no-op
		// for a shared cache since it'll be cleared by the ApplicationContext.
		((CachingMetadataReaderFactory) this.metadataReaderFactory).clearCache();
	}
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;è·å¾—æ‰€æœ‰çš„BeanNameï¼Œæ”¾å…¥candidateNamesæ•°ç»„ã€‚
å¾ªç¯candidateNamesæ•°ç»„ï¼Œæ ¹æ®beanNameè·å¾—BeanDefinitionï¼Œåˆ¤æ–­æ­¤BeanDefinitionæ˜¯å¦å·²ç»è¢«å¤„ç†è¿‡äº†ã€‚
åˆ¤æ–­æ˜¯å¦æ˜¯é…ç½®ç±»ï¼Œå¦‚æœæ˜¯çš„è¯ã€‚åŠ å…¥åˆ°configCandidatesæ•°ç»„ï¼Œåœ¨åˆ¤æ–­çš„æ—¶å€™ï¼Œè¿˜ä¼šæ ‡è®°é…ç½®ç±»å±äºFullé…ç½®ç±»ï¼Œè¿˜æ˜¯Liteé…ç½®ç±»ï¼Œè¿™é‡Œä¼šå¼•å‘ä¸€è¿ä¸²çš„çŸ¥è¯†ç›²ç‚¹ï¼š
3.1 å½“æˆ‘ä»¬æ³¨å†Œé…ç½®ç±»çš„æ—¶å€™ï¼Œå¯ä»¥ä¸åŠ @Configurationæ³¨è§£ï¼Œç›´æ¥ä½¿ç”¨@Component @ComponentScan @Import @ImportResourceç­‰æ³¨è§£ï¼ŒSpringæŠŠè¿™ç§é…ç½®ç±»ç§°ä¹‹ä¸ºLiteé…ç½®ç±»ï¼Œ å¦‚æœåŠ äº†@Configurationæ³¨è§£ï¼Œå°±ç§°ä¹‹ä¸ºFullé…ç½®ç±»ã€‚
3.2 å¦‚æœæˆ‘ä»¬æ³¨å†Œäº†Liteé…ç½®ç±»ï¼Œæˆ‘ä»¬getBeanè¿™ä¸ªé…ç½®ç±»ï¼Œä¼šå‘ç°å®ƒå°±æ˜¯åŸæœ¬çš„é‚£ä¸ªé…ç½®ç±»ï¼Œå¦‚æœæˆ‘ä»¬æ³¨å†Œäº†Fullé…ç½®ç±»ï¼Œæˆ‘ä»¬getBeanè¿™ä¸ªé…ç½®ç±»ï¼Œä¼šå‘ç°å®ƒå·²ç»ä¸æ˜¯åŸæœ¬é‚£ä¸ªé…ç½®ç±»äº†ï¼Œè€Œæ˜¯å·²ç»è¢«cgilbä»£ç†çš„ç±»äº†ã€‚
3.3 å†™ä¸€ä¸ªAç±»ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªæ„é€ æ–¹æ³•ï¼Œæ‰“å°å‡ºâ€œä½ å¥½â€ï¼Œå†å†™ä¸€ä¸ªé…ç½®ç±»ï¼Œé‡Œé¢æœ‰ä¸¤ä¸ªè¢«@beanæ³¨è§£çš„æ–¹æ³•ï¼Œå…¶ä¸­ä¸€ä¸ªæ–¹æ³•newäº†Aç±»ï¼Œå¹¶ä¸”è¿”å›Açš„å¯¹è±¡ï¼ŒæŠŠæ­¤æ–¹æ³•ç§°ä¹‹ä¸ºgetAï¼Œç¬¬äºŒä¸ªæ–¹æ³•åˆè°ƒç”¨äº†getAæ–¹æ³•ï¼Œå¦‚æœé…ç½®ç±»æ˜¯Liteé…ç½®ç±»ï¼Œä¼šå‘ç°æ‰“å°äº†ä¸¤æ¬¡â€œä½ å¥½â€ï¼Œä¹Ÿå°±æ˜¯è¯´Aç±»è¢«newäº†ä¸¤æ¬¡ï¼Œå¦‚æœé…ç½®ç±»æ˜¯Fullé…ç½®ç±»ï¼Œä¼šå‘ç°åªæ‰“å°äº†ä¸€æ¬¡â€œä½ å¥½â€ï¼Œä¹Ÿå°±æ˜¯è¯´Aç±»åªè¢«newäº†ä¸€æ¬¡ï¼Œå› ä¸ºè¿™ä¸ªç±»è¢«cgilbä»£ç†äº†ï¼Œæ–¹æ³•å·²ç»è¢«æ”¹å†™ã€‚&lt;/p&gt;

&lt;p&gt;å¦‚æœæ²¡æœ‰é…ç½®ç±»ç›´æ¥è¿”å›ã€‚
å¤„ç†æ’åºã€‚
è§£æé…ç½®ç±»ï¼Œå¯èƒ½æ˜¯Fullé…ç½®ç±»ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯Liteé…ç½®ç±»ï¼Œè¿™ä¸ªå°æ–¹æ³•æ˜¯æ­¤æ–¹æ³•çš„æ ¸å¿ƒï¼Œç¨åå…·ä½“è¯´æ˜ã€‚
åœ¨ç¬¬6æ­¥çš„æ—¶å€™ï¼Œåªæ˜¯æ³¨å†Œäº†éƒ¨åˆ†Beanï¼Œåƒ @Import @Beanç­‰ï¼Œæ˜¯æ²¡æœ‰è¢«æ³¨å†Œçš„ï¼Œè¿™é‡Œç»Ÿä¸€å¯¹è¿™äº›è¿›è¡Œæ³¨å†Œã€‚
ä¸‹é¢æ˜¯è§£æé…ç½®ç±»çš„è¿‡ç¨‹ï¼š
	public void parse(Set&lt;BeanDefinitionHolder&gt; configCandidates) {
		this.deferredImportSelectors = new LinkedList&amp;lt;&amp;gt;();
		//å¾ªç¯ä¼ è¿›æ¥çš„é…ç½®ç±»
		for (BeanDefinitionHolder holder : configCandidates) {
			BeanDefinition bd = holder.getBeanDefinition();//è·å¾—BeanDefinition
			try {
				//å¦‚æœè·å¾—BeanDefinitionæ˜¯AnnotatedBeanDefinitionçš„å®ä¾‹
				if (bd instanceof AnnotatedBeanDefinition) {
					parse(((AnnotatedBeanDefinition) bd).getMetadata(), holder.getBeanName());
				} else if (bd instanceof AbstractBeanDefinition &amp;amp;&amp;amp; ((AbstractBeanDefinition) bd).hasBeanClass()) {
					parse(((AbstractBeanDefinition) bd).getBeanClass(), holder.getBeanName());
				} else {
					parse(bd.getBeanClassName(), holder.getBeanName());
				}
			} catch (BeanDefinitionStoreException ex) {
				throw ex;
			} catch (Throwable ex) {
				throw new BeanDefinitionStoreException(
						&quot;Failed to parse configuration class [&quot; + bd.getBeanClassName() + &quot;]&quot;, ex);
			}
		}&lt;/BeanDefinitionHolder&gt;&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;	//æ‰§è¡ŒDeferredImportSelector
	processDeferredImportSelectors();
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;å› ä¸ºå¯ä»¥æœ‰å¤šä¸ªé…ç½®ç±»ï¼Œæ‰€ä»¥éœ€è¦å¾ªç¯å¤„ç†ã€‚æˆ‘ä»¬çš„é…ç½®ç±»çš„BeanDefinitionæ˜¯AnnotatedBeanDefinitionçš„å®ä¾‹ï¼Œæ‰€ä»¥ä¼šè¿›å…¥ç¬¬ä¸€ä¸ªifï¼š
protected final void parse(AnnotationMetadata metadata, String beanName) throws IOException {
		processConfigurationClass(new ConfigurationClass(metadata, beanName));
	}
	protected void processConfigurationClass(ConfigurationClass configClass) throws IOException {&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;	//åˆ¤æ–­æ˜¯å¦éœ€è¦è·³è¿‡
	if (this.conditionEvaluator.shouldSkip(configClass.getMetadata(), ConfigurationPhase.PARSE_CONFIGURATION)) {
		return;
	}

	ConfigurationClass existingClass = this.configurationClasses.get(configClass);
	if (existingClass != null) {
		if (configClass.isImported()) {
			if (existingClass.isImported()) {
				existingClass.mergeImportedBy(configClass);
			}
			// Otherwise ignore new imported config class; existing non-imported class overrides it.
			return;
		} else {
			// Explicit bean definition found, probably replacing an import.
			// Let's remove the old one and go with the new one.
			this.configurationClasses.remove(configClass);
			this.knownSuperclasses.values().removeIf(configClass::equals);
		}
	}

	// Recursively process the configuration class and its superclass hierarchy.
	SourceClass sourceClass = asSourceClass(configClass);
	do {
		sourceClass = doProcessConfigurationClass(configClass, sourceClass);
	}
	while (sourceClass != null);

	this.configurationClasses.put(configClass, configClass);
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;é‡ç‚¹åœ¨äºdoProcessConfigurationClassæ–¹æ³•ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„ï¼Œæœ€åä¸€è¡Œä»£ç ï¼Œä¼šæŠŠconfigClassæ”¾å…¥ä¸€ä¸ªMapï¼Œä¼šåœ¨ä¸Šé¢ç¬¬7æ­¥ä¸­ç”¨åˆ°ã€‚&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;protected final SourceClass doProcessConfigurationClass(ConfigurationClass configClass, SourceClass sourceClass)
		throws IOException {

	//é€’å½’å¤„ç†å†…éƒ¨ç±»ï¼Œä¸€èˆ¬ä¸ä¼šå†™å†…éƒ¨ç±»
	// Recursively process any member (nested) classes first
	processMemberClasses(configClass, sourceClass);

	// Process any @PropertySource annotations
	//å¤„ç†@PropertySourceæ³¨è§£ï¼Œ@PropertySourceæ³¨è§£ç”¨æ¥åŠ è½½propertiesæ–‡ä»¶
	for (AnnotationAttributes propertySource : AnnotationConfigUtils.attributesForRepeatable(
			sourceClass.getMetadata(), PropertySources.class,
			org.springframework.context.annotation.PropertySource.class)) {
		if (this.environment instanceof ConfigurableEnvironment) {
			processPropertySource(propertySource);
		} else {
			logger.warn(&quot;Ignoring @PropertySource annotation on [&quot; + sourceClass.getMetadata().getClassName() +
					&quot;]. Reason: Environment must implement ConfigurableEnvironment&quot;);
		}
	}

	// Process any @ComponentScan annotations
	//è·å¾—ComponentScanæ³¨è§£å…·ä½“çš„å†…å®¹ï¼ŒComponentScanæ³¨è§£é™¤äº†æœ€å¸¸ç”¨çš„basePackageä¹‹å¤–ï¼Œè¿˜æœ‰includeFiltersï¼ŒexcludeFiltersç­‰
	Set&amp;lt;AnnotationAttributes&amp;gt; componentScans = AnnotationConfigUtils.attributesForRepeatable(
			sourceClass.getMetadata(), ComponentScans.class, ComponentScan.class);

	//å¦‚æœæ²¡æœ‰æ‰“ä¸ŠComponentScanï¼Œæˆ–è€…è¢«@Conditionæ¡ä»¶è·³è¿‡ï¼Œå°±ä¸å†è¿›å…¥è¿™ä¸ªif
	if (!componentScans.isEmpty() &amp;amp;&amp;amp;
			!this.conditionEvaluator.shouldSkip(sourceClass.getMetadata(), ConfigurationPhase.REGISTER_BEAN)) {
		//å¾ªç¯å¤„ç†componentScans
		for (AnnotationAttributes componentScan : componentScans) {
			// The config class is annotated with @ComponentScan -&amp;gt; perform the scan immediately
			//componentScanå°±æ˜¯@ComponentScanä¸Šçš„å…·ä½“å†…å®¹ï¼ŒsourceClass.getMetadata().getClassName()å°±æ˜¯é…ç½®ç±»çš„åç§°
			Set&amp;lt;BeanDefinitionHolder&amp;gt; scannedBeanDefinitions =
					this.componentScanParser.parse(componentScan, sourceClass.getMetadata().getClassName());
			// Check the set of scanned definitions for any further config classes and parse recursively if needed
			for (BeanDefinitionHolder holder : scannedBeanDefinitions) {
				BeanDefinition bdCand = holder.getBeanDefinition().getOriginatingBeanDefinition();
				if (bdCand == null) {
					bdCand = holder.getBeanDefinition();
				}
				if (ConfigurationClassUtils.checkConfigurationClassCandidate(bdCand, this.metadataReaderFactory)) {
					//é€’å½’è°ƒç”¨ï¼Œå› ä¸ºå¯èƒ½ç»„ä»¶ç±»æœ‰è¢«@Beanæ ‡è®°çš„æ–¹æ³•ï¼Œæˆ–è€…ç»„ä»¶ç±»æœ¬èº«ä¹Ÿæœ‰ComponentScanç­‰æ³¨è§£
					parse(bdCand.getBeanClassName(), holder.getBeanName());
				}
			}
		}
	}

	// Process any @Import annotations
	//å¤„ç†@Importæ³¨è§£
	//@Importæ³¨è§£æ˜¯springä¸­å¾ˆé‡è¦çš„ä¸€ä¸ªæ³¨è§£ï¼ŒSpringbootå¤§é‡åº”ç”¨è¿™ä¸ªæ³¨è§£
	//@Importä¸‰ç§ç±»ï¼Œä¸€ç§æ˜¯Importæ™®é€šç±»ï¼Œä¸€ç§æ˜¯Import ImportSelectorï¼Œè¿˜æœ‰ä¸€ç§æ˜¯Import ImportBeanDefinitionRegistrar
	//getImports(sourceClass)æ˜¯è·å¾—importçš„å†…å®¹ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªset
	processImports(configClass, sourceClass, getImports(sourceClass), true);

	// Process any @ImportResource annotations
	//å¤„ç†@ImportResourceæ³¨è§£
	AnnotationAttributes importResource =
			AnnotationConfigUtils.attributesFor(sourceClass.getMetadata(), ImportResource.class);
	if (importResource != null) {
		String[] resources = importResource.getStringArray(&quot;locations&quot;);
		Class&amp;lt;? extends BeanDefinitionReader&amp;gt; readerClass = importResource.getClass(&quot;reader&quot;);
		for (String resource : resources) {
			String resolvedResource = this.environment.resolveRequiredPlaceholders(resource);
			configClass.addImportedResource(resolvedResource, readerClass);
		}
	}

	//å¤„ç†@Beançš„æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°è·å¾—äº†å¸¦æœ‰@Beançš„æ–¹æ³•åï¼Œä¸æ˜¯é©¬ä¸Šè½¬æ¢æˆBeanDefinitionï¼Œè€Œæ˜¯å…ˆç”¨ä¸€ä¸ªsetæ¥æ”¶
	// Process individual @Bean methods
	Set&amp;lt;MethodMetadata&amp;gt; beanMethods = retrieveBeanMethodMetadata(sourceClass);
	for (MethodMetadata methodMetadata : beanMethods) {
		configClass.addBeanMethod(new BeanMethod(methodMetadata, configClass));
	}

	// Process default methods on interfaces
	processInterfaces(configClass, sourceClass);

	// Process superclass, if any
	if (sourceClass.getMetadata().hasSuperClass()) {
		String superclass = sourceClass.getMetadata().getSuperClassName();
		if (superclass != null &amp;amp;&amp;amp; !superclass.startsWith(&quot;java&quot;) &amp;amp;&amp;amp;
				!this.knownSuperclasses.containsKey(superclass)) {
			this.knownSuperclasses.put(superclass, configClass);
			// Superclass found, return its annotation metadata and recurse
			return sourceClass.getSuperClass();
		}
	}

	// No superclass -&amp;gt; processing is complete
	return null;
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;é€’å½’å¤„ç†å†…éƒ¨ç±»ï¼Œä¸€èˆ¬ä¸ä¼šä½¿ç”¨å†…éƒ¨ç±»ã€‚
å¤„ç†@PropertySourceæ³¨è§£ï¼Œ@PropertySourceæ³¨è§£ç”¨æ¥åŠ è½½propertiesæ–‡ä»¶ã€‚
è·å¾—ComponentScanæ³¨è§£å…·ä½“çš„å†…å®¹ï¼ŒComponentScanæ³¨è§£é™¤äº†æœ€å¸¸ç”¨çš„basePackageä¹‹å¤–ï¼Œè¿˜æœ‰includeFiltersï¼ŒexcludeFiltersç­‰ã€‚
åˆ¤æ–­æœ‰æ²¡æœ‰è¢«@ComponentScansæ ‡è®°ï¼Œæˆ–è€…è¢«@Conditionæ¡ä»¶å¸¦è¿‡ï¼Œå¦‚æœæ»¡è¶³æ¡ä»¶çš„è¯ï¼Œè¿›å…¥ifï¼Œè¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š
4.1 æ‰§è¡Œæ‰«ææ“ä½œï¼ŒæŠŠæ‰«æå‡ºæ¥çš„æ”¾å…¥setï¼Œè¿™ä¸ªæ–¹æ³•ç¨åå†è¯¦ç»†è¯´æ˜ã€‚
4.2 å¾ªç¯setï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯é…ç½®ç±»ï¼Œæ˜¯çš„è¯ï¼Œé€’å½’è°ƒç”¨parseæ–¹æ³•ï¼Œå› ä¸ºè¢«æ‰«æå‡ºæ¥çš„ç±»ï¼Œè¿˜æ˜¯ä¸€ä¸ªé…ç½®ç±»ï¼Œæœ‰@ComponentScansæ³¨è§£ï¼Œæˆ–è€…å…¶ä¸­æœ‰è¢«@Beanæ ‡è®°çš„æ–¹æ³• ç­‰ç­‰ï¼Œæ‰€ä»¥éœ€è¦å†æ¬¡è¢«è§£æã€‚
å¤„ç†@Importæ³¨è§£ï¼Œ@Importæ˜¯Springä¸­å¾ˆé‡è¦çš„ä¸€ä¸ªæ³¨è§£ï¼Œæ­£æ˜¯ç”±äºå®ƒçš„å­˜åœ¨ï¼Œè®©Springéå¸¸çµæ´»ï¼Œä¸ç®¡æ˜¯Springå†…éƒ¨ï¼Œè¿˜æ˜¯ä¸Springæ•´åˆçš„ç¬¬ä¸‰æ–¹æŠ€æœ¯ï¼Œéƒ½å¤§é‡çš„è¿ç”¨äº†@Importæ³¨è§£ï¼Œ@Importæœ‰ä¸‰ç§æƒ…å†µï¼Œä¸€ç§æ˜¯Importæ™®é€šç±»ï¼Œä¸€ç§æ˜¯Import ImportSelectorï¼Œè¿˜æœ‰ä¸€ç§æ˜¯Import ImportBeanDefinitionRegistrarï¼ŒgetImports(sourceClass)æ˜¯è·å¾—importçš„å†…å®¹ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªsetï¼Œè¿™ä¸ªæ–¹æ³•ç¨åå†è¯¦ç»†è¯´æ˜ã€‚
å¤„ç†@ImportResourceæ³¨è§£ã€‚
å¤„ç†@Beançš„æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°è·å¾—äº†å¸¦æœ‰@Beançš„æ–¹æ³•åï¼Œä¸æ˜¯é©¬ä¸Šè½¬æ¢æˆBeanDefinitionï¼Œè€Œæ˜¯å…ˆç”¨ä¸€ä¸ªsetæ¥æ”¶ã€‚
æˆ‘ä»¬å…ˆæ¥çœ‹4.1ä¸­çš„é‚£ä¸ªæ–¹æ³•ï¼š&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;public Set&amp;lt;BeanDefinitionHolder&amp;gt; parse(AnnotationAttributes componentScan, final String declaringClass) {
	//æ‰«æå™¨ï¼Œè¿˜è®°ä¸è®°åœ¨new AnnotationConfigApplicationContextçš„æ—¶å€™
	//ä¼šè°ƒç”¨AnnotationConfigApplicationContextçš„æ„é€ æ–¹æ³•
	//æ„é€ æ–¹æ³•é‡Œé¢æœ‰ä¸€å¥ this.scanner = new ClassPathBeanDefinitionScanner(this);
	//å½“æ—¶è¯´è¿™ä¸ªå¯¹è±¡ä¸é‡è¦ï¼Œè¿™é‡Œå°±æ˜¯è¯æ˜äº†ã€‚å¸¸è§„ç”¨æ³•ä¸­ï¼Œå®é™…ä¸Šæ‰§è¡Œæ‰«æçš„åªä¼šæ˜¯è¿™é‡Œçš„scannerå¯¹è±¡
	ClassPathBeanDefinitionScanner scanner = new ClassPathBeanDefinitionScanner(this.registry,
			componentScan.getBoolean(&quot;useDefaultFilters&quot;), this.environment, this.resourceLoader);

	//åˆ¤æ–­æ˜¯å¦é‡å†™äº†é»˜è®¤çš„å‘½åè§„åˆ™
	Class&amp;lt;? extends BeanNameGenerator&amp;gt; generatorClass = componentScan.getClass(&quot;nameGenerator&quot;);
	boolean useInheritedGenerator = (BeanNameGenerator.class == generatorClass);
	scanner.setBeanNameGenerator(useInheritedGenerator ? this.beanNameGenerator :
			BeanUtils.instantiateClass(generatorClass));

	ScopedProxyMode scopedProxyMode = componentScan.getEnum(&quot;scopedProxy&quot;);
	if (scopedProxyMode != ScopedProxyMode.DEFAULT) {
		scanner.setScopedProxyMode(scopedProxyMode);
	}
	else {
		Class&amp;lt;? extends ScopeMetadataResolver&amp;gt; resolverClass = componentScan.getClass(&quot;scopeResolver&quot;);
		scanner.setScopeMetadataResolver(BeanUtils.instantiateClass(resolverClass));
	}

	scanner.setResourcePattern(componentScan.getString(&quot;resourcePattern&quot;));

	//addIncludeFilter addExcludeFilter,æœ€ç»ˆæ˜¯å¾€List&amp;lt;TypeFilter&amp;gt;é‡Œé¢å¡«å……æ•°æ®
	//TypeFilteræ˜¯ä¸€ä¸ªå‡½æ•°å¼æ¥å£ï¼Œå‡½æ•°å¼æ¥å£åœ¨java8çš„æ—¶å€™å¤§æ”¾å¼‚å½©ï¼Œåªå®šä¹‰äº†ä¸€ä¸ªè™šæ–¹æ³•çš„æ¥å£è¢«ç§°ä¸ºå‡½æ•°å¼æ¥å£
	//å½“è°ƒç”¨scanner.addIncludeFilter  scanner.addExcludeFilter ä»…ä»…æŠŠ å®šä¹‰çš„è§„åˆ™å¡è¿›å»ï¼Œå¹¶ä¹ˆæœ‰çœŸæ­£å»æ‰§è¡ŒåŒ¹é…è¿‡ç¨‹

	//å¤„ç†includeFilters
	for (AnnotationAttributes filter : componentScan.getAnnotationArray(&quot;includeFilters&quot;)) {
		for (TypeFilter typeFilter : typeFiltersFor(filter)) {
			scanner.addIncludeFilter(typeFilter);
		}
	}

	//å¤„ç†excludeFilters
	for (AnnotationAttributes filter : componentScan.getAnnotationArray(&quot;excludeFilters&quot;)) {
		for (TypeFilter typeFilter : typeFiltersFor(filter)) {
			scanner.addExcludeFilter(typeFilter);
		}
	}

	boolean lazyInit = componentScan.getBoolean(&quot;lazyInit&quot;);
	if (lazyInit) {
		scanner.getBeanDefinitionDefaults().setLazyInit(true);
	}

	Set&amp;lt;String&amp;gt; basePackages = new LinkedHashSet&amp;lt;&amp;gt;();
	String[] basePackagesArray = componentScan.getStringArray(&quot;basePackages&quot;);
	for (String pkg : basePackagesArray) {
		String[] tokenized = StringUtils.tokenizeToStringArray(this.environment.resolvePlaceholders(pkg),
				ConfigurableApplicationContext.CONFIG_LOCATION_DELIMITERS);
		Collections.addAll(basePackages, tokenized);
	}
	// ä»ä¸‹é¢çš„ä»£ç å¯ä»¥çœ‹å‡ºComponentScansæŒ‡å®šæ‰«æç›®æ ‡ï¼Œé™¤äº†æœ€å¸¸ç”¨çš„basePackagesï¼Œè¿˜æœ‰ä¸¤ç§æ–¹å¼
	// 1.æŒ‡å®šbasePackageClassesï¼Œå°±æ˜¯æŒ‡å®šå¤šä¸ªç±»ï¼Œåªè¦æ˜¯ä¸è¿™å‡ ä¸ªç±»åŒçº§çš„ï¼Œæˆ–è€…åœ¨è¿™å‡ ä¸ªç±»ä¸‹çº§çš„éƒ½å¯ä»¥è¢«æ‰«æåˆ°ï¼Œè¿™ç§æ–¹å¼å…¶å®æ˜¯springæ¯”è¾ƒæ¨èçš„
	// å› ä¸ºæŒ‡å®šbasePackagesæ²¡æœ‰IDEçš„æ£€æŸ¥ï¼Œå®¹æ˜“å‡ºé”™ï¼Œä½†æ˜¯æŒ‡å®šä¸€ä¸ªç±»ï¼Œå°±æœ‰IDEçš„æ£€æŸ¥äº†ï¼Œä¸å®¹æ˜“å‡ºé”™ï¼Œç»å¸¸ä¼šç”¨ä¸€ä¸ªç©ºçš„ç±»æ¥ä½œä¸ºbasePackageClasses
	// 2.ç›´æ¥ä¸æŒ‡å®šï¼Œé»˜è®¤ä¼šæŠŠä¸é…ç½®ç±»åŒçº§ï¼Œæˆ–è€…åœ¨é…ç½®ç±»ä¸‹çº§çš„ä½œä¸ºæ‰«æç›®æ ‡
	for (Class&amp;lt;?&amp;gt; clazz : componentScan.getClassArray(&quot;basePackageClasses&quot;)) {
		basePackages.add(ClassUtils.getPackageName(clazz));
	}
	if (basePackages.isEmpty()) {
		basePackages.add(ClassUtils.getPackageName(declaringClass));
	}

	//æŠŠè§„åˆ™å¡«å……åˆ°æ’é™¤è§„åˆ™ï¼šList&amp;lt;TypeFilter&amp;gt;ï¼Œè¿™é‡Œå°±æŠŠ æ³¨å†Œç±»è‡ªèº«å½“ä½œæ’é™¤è§„åˆ™ï¼ŒçœŸæ­£æ‰§è¡ŒåŒ¹é…çš„æ—¶å€™ï¼Œä¼šæŠŠè‡ªèº«ç»™æ’é™¤
	scanner.addExcludeFilter(new AbstractTypeHierarchyTraversingFilter(false, false) {
		@Override
		protected boolean matchClassName(String className) {
			return declaringClass.equals(className);
		}
	});
	//basePackagesæ˜¯ä¸€ä¸ªLinkedHashSet&amp;lt;String&amp;gt;ï¼Œè¿™é‡Œå°±æ˜¯æŠŠbasePackagesè½¬ä¸ºå­—ç¬¦ä¸²æ•°ç»„çš„å½¢å¼
	return scanner.doScan(StringUtils.toStringArray(basePackages));
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;å®šä¹‰äº†ä¸€ä¸ªæ‰«æå™¨scannerï¼Œè¿˜è®°ä¸è®°åœ¨new AnnotationConfigApplicationContextçš„æ—¶å€™ï¼Œä¼šè°ƒç”¨AnnotationConfigApplicationContextçš„æ„é€ æ–¹æ³•ï¼Œæ„é€ æ–¹æ³•é‡Œé¢æœ‰ä¸€å¥ this.scanner = new ClassPathBeanDefinitionScanner(this);å½“æ—¶è¯´è¿™ä¸ªå¯¹è±¡ä¸é‡è¦ï¼Œè¿™é‡Œå°±æ˜¯è¯æ˜äº†ã€‚å¸¸è§„ç”¨æ³•ä¸­ï¼Œå®é™…ä¸Šæ‰§è¡Œæ‰«æçš„åªä¼šæ˜¯è¿™é‡Œçš„scannerå¯¹è±¡ã€‚
å¤„ç†includeFiltersï¼Œå°±æ˜¯æŠŠè§„åˆ™æ·»åŠ åˆ°scannerã€‚
å¤„ç†excludeFiltersï¼Œå°±æ˜¯æŠŠè§„åˆ™æ·»åŠ åˆ°scannerã€‚
è§£æbasePackagesï¼Œè·å¾—éœ€è¦æ‰«æå“ªäº›åŒ…ã€‚
æ·»åŠ ä¸€ä¸ªé»˜è®¤çš„æ’é™¤è§„åˆ™ï¼šæ’é™¤è‡ªèº«ã€‚
æ‰§è¡Œæ‰«æï¼Œç¨åè¯¦ç»†è¯´æ˜ã€‚
è¿™é‡Œéœ€è¦åšä¸€ä¸ªè¡¥å……è¯´æ˜ï¼Œæ·»åŠ è§„åˆ™çš„æ—¶å€™ï¼Œåªæ˜¯æŠŠå…·ä½“çš„è§„åˆ™æ”¾å…¥è§„åˆ™ç±»çš„é›†åˆä¸­å»ï¼Œè§„åˆ™ç±»æ˜¯ä¸€ä¸ªå‡½æ•°å¼æ¥å£ï¼Œåªå®šä¹‰äº†ä¸€ä¸ªè™šæ–¹æ³•çš„æ¥å£è¢«ç§°ä¸ºå‡½æ•°å¼æ¥å£ï¼Œå‡½æ•°å¼æ¥å£åœ¨java8çš„æ—¶å€™å¤§æ”¾å¼‚å½©ï¼Œè¿™é‡Œåªæ˜¯æŠŠè§„åˆ™æ–¹å¡è¿›å»ï¼Œå¹¶æ²¡æœ‰çœŸæ­£æ‰§è¡ŒåŒ¹é…è§„åˆ™ã€‚
æˆ‘ä»¬æ¥çœ‹çœ‹åˆ°åº•æ˜¯æ€ä¹ˆæ‰§è¡Œæ‰«æçš„ï¼š
	protected Set&lt;BeanDefinitionHolder&gt; doScan(String... basePackages) {
		Assert.notEmpty(basePackages, &quot;At least one base package must be specified&quot;);
		Set&lt;BeanDefinitionHolder&gt; beanDefinitions = new LinkedHashSet&amp;lt;&amp;gt;();
		//å¾ªç¯å¤„ç†basePackages
		for (String basePackage : basePackages) {
			//æ ¹æ®åŒ…åæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„BeanDefinitioné›†åˆ
			Set&lt;BeanDefinition&gt; candidates = findCandidateComponents(basePackage);
			for (BeanDefinition candidate : candidates) {
				ScopeMetadata scopeMetadata = this.scopeMetadataResolver.resolveScopeMetadata(candidate);
				candidate.setScope(scopeMetadata.getScopeName());
				String beanName = this.beanNameGenerator.generateBeanName(candidate, this.registry);
				//ç”±findCandidateComponentså†…éƒ¨å¯çŸ¥ï¼Œè¿™é‡Œçš„candidateæ˜¯ScannedGenericBeanDefinition
				//è€ŒScannedGenericBeanDefinitionæ˜¯AbstractBeanDefinitionå’ŒAnnotatedBeanDefinitionçš„ä¹‹ç±»
				//æ‰€ä»¥ä¸‹é¢çš„ä¸¤ä¸ªiféƒ½ä¼šè¿›å…¥
				if (candidate instanceof AbstractBeanDefinition) {
					//å†…éƒ¨ä¼šè®¾ç½®é»˜è®¤å€¼
					postProcessBeanDefinition((AbstractBeanDefinition) candidate, beanName);
				}
				if (candidate instanceof AnnotatedBeanDefinition) {
					//å¦‚æœæ˜¯AnnotatedBeanDefinitionï¼Œè¿˜ä¼šå†è®¾ç½®ä¸€æ¬¡å€¼
					AnnotationConfigUtils.processCommonDefinitionAnnotations((AnnotatedBeanDefinition) candidate);
				}
				if (checkCandidate(beanName, candidate)) {
					BeanDefinitionHolder definitionHolder = new BeanDefinitionHolder(candidate, beanName);
					definitionHolder =
							AnnotationConfigUtils.applyScopedProxyMode(scopeMetadata, definitionHolder, this.registry);
					beanDefinitions.add(definitionHolder);
					registerBeanDefinition(definitionHolder, this.registry);
				}
			}
		}
		return beanDefinitions;
	}&lt;/BeanDefinition&gt;&lt;/BeanDefinitionHolder&gt;&lt;/BeanDefinitionHolder&gt;&lt;/p&gt;

&lt;p&gt;å› ä¸ºbasePackageså¯èƒ½æœ‰å¤šä¸ªï¼Œæ‰€ä»¥éœ€è¦å¾ªç¯å¤„ç†ï¼Œæœ€ç»ˆä¼šè¿›è¡ŒBeançš„æ³¨å†Œã€‚ä¸‹é¢å†æ¥çœ‹çœ‹findCandidateComponentsæ–¹æ³•ï¼š
	public Set&lt;BeanDefinition&gt; findCandidateComponents(String basePackage) {
		//springæ”¯æŒcomponentç´¢å¼•æŠ€æœ¯ï¼Œéœ€è¦å¼•å…¥ä¸€ä¸ªç»„ä»¶ï¼Œå› ä¸ºå¤§éƒ¨åˆ†æƒ…å†µä¸ä¼šå¼•å…¥è¿™ä¸ªç»„ä»¶
		//æ‰€ä»¥ä¸ä¼šè¿›å…¥åˆ°è¿™ä¸ªif
		if (this.componentsIndex != null &amp;amp;&amp;amp; indexSupportsIncludeFilters()) {
			return addCandidateComponentsFromIndex(this.componentsIndex, basePackage);
		}
		else {
			return scanCandidateComponents(basePackage);
		}
	}&lt;/BeanDefinition&gt;&lt;/p&gt;

&lt;p&gt;Springæ”¯æŒcomponentç´¢å¼•æŠ€æœ¯ï¼Œéœ€è¦å¼•å…¥ä¸€ä¸ªç»„ä»¶ï¼Œå¤§éƒ¨åˆ†é¡¹ç›®æ²¡æœ‰å¼•å…¥è¿™ä¸ªç»„ä»¶ï¼Œæ‰€ä»¥ä¼šè¿›å…¥scanCandidateComponentsæ–¹æ³•ï¼š
private Set&lt;BeanDefinition&gt; scanCandidateComponents(String basePackage) {
		Set&lt;BeanDefinition&gt; candidates = new LinkedHashSet&amp;lt;&amp;gt;();
		try {
			//æŠŠ ä¼ è¿›æ¥çš„ç±»ä¼¼ å‘½åç©ºé—´å½¢å¼çš„å­—ç¬¦ä¸²è½¬æ¢æˆç±»ä¼¼ç±»æ–‡ä»¶åœ°å€çš„å½¢å¼ï¼Œç„¶ååœ¨å‰é¢åŠ ä¸Šclasspath*:
			//å³ï¼šcom.xx=&amp;gt;classpath*:com/xx/**/*.class
			String packageSearchPath = ResourcePatternResolver.CLASSPATH_ALL_URL_PREFIX +
					resolveBasePackage(basePackage) + '/' + this.resourcePattern;
			//æ ¹æ®packageSearchPathï¼Œè·å¾—ç¬¦åˆè¦æ±‚çš„æ–‡ä»¶
			Resource[] resources = getResourcePatternResolver().getResources(packageSearchPath);
			boolean traceEnabled = logger.isTraceEnabled();
			boolean debugEnabled = logger.isDebugEnabled();
			//å¾ªç¯èµ„æº
			for (Resource resource : resources) {
				if (traceEnabled) {
					logger.trace(&quot;Scanning &quot; + resource);
				}&lt;/BeanDefinition&gt;&lt;/BeanDefinition&gt;&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;			if (resource.isReadable()) {//åˆ¤æ–­èµ„æºæ˜¯å¦å¯è¯»ï¼Œå¹¶ä¸”ä¸æ˜¯ä¸€ä¸ªç›®å½•
				try {
					//metadataReader å…ƒæ•°æ®è¯»å–å™¨ï¼Œè§£æresourceï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºæè¿°èµ„æºçš„æ•°æ®ç»“æ„
					MetadataReader metadataReader = getMetadataReaderFactory().getMetadataReader(resource);
					//åœ¨isCandidateComponentæ–¹æ³•å†…éƒ¨ä¼šçœŸæ­£æ‰§è¡ŒåŒ¹é…è§„åˆ™
					//æ³¨å†Œé…ç½®ç±»è‡ªèº«ä¼šè¢«æ’é™¤ï¼Œä¸ä¼šè¿›å…¥åˆ°è¿™ä¸ªif
					if (isCandidateComponent(metadataReader)) {
						ScannedGenericBeanDefinition sbd = new ScannedGenericBeanDefinition(metadataReader);
						sbd.setResource(resource);
						sbd.setSource(resource);
						if (isCandidateComponent(sbd)) {
							if (debugEnabled) {
								logger.debug(&quot;Identified candidate component class: &quot; + resource);
							}
							candidates.add(sbd);
						}
						else {
							if (debugEnabled) {
								logger.debug(&quot;Ignored because not a concrete top-level class: &quot; + resource);
							}
						}
					}
					else {
						if (traceEnabled) {
							logger.trace(&quot;Ignored because not matching any filter: &quot; + resource);
						}
					}
				}
				catch (Throwable ex) {
					throw new BeanDefinitionStoreException(
							&quot;Failed to read candidate component class: &quot; + resource, ex);
				}
			}
			else {
				if (traceEnabled) {
					logger.trace(&quot;Ignored because not readable: &quot; + resource);
				}
			}
		}
	}
	catch (IOException ex) {
		throw new BeanDefinitionStoreException(&quot;I/O failure during classpath scanning&quot;, ex);
	}
	return candidates;
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;æŠŠä¼ è¿›æ¥çš„ç±»ä¼¼å‘½åç©ºé—´å½¢å¼çš„å­—ç¬¦ä¸²è½¬æ¢æˆç±»ä¼¼ç±»æ–‡ä»¶åœ°å€çš„å½¢å¼ï¼Œç„¶ååœ¨å‰é¢åŠ ä¸Šclasspathï¼Œå³ï¼šcom.xx=&amp;gt;classpath:com/xx/&lt;em&gt;*/&lt;/em&gt;.classã€‚
æ ¹æ®packageSearchPathï¼Œè·å¾—ç¬¦åˆè¦æ±‚çš„æ–‡ä»¶ã€‚
å¾ªç¯ç¬¦åˆè¦æ±‚çš„æ–‡ä»¶ï¼Œè¿›ä¸€æ­¥è¿›è¡Œåˆ¤æ–­ã€‚
æœ€ç»ˆä¼šæŠŠç¬¦åˆè¦æ±‚çš„æ–‡ä»¶ï¼Œè½¬æ¢ä¸ºBeanDefinitionï¼Œå¹¶ä¸”è¿”å›ã€‚&lt;/p&gt;

&lt;p&gt;@Importè§£æï¼š
ç›´åˆ°è¿™é‡Œï¼Œä¸Šé¢è¯´çš„4.1ä¸­æåˆ°çš„æ–¹æ³•ç»ˆäºåˆ†æå®Œæ¯•äº†ï¼Œè®©æˆ‘ä»¬å†çœ‹çœ‹ä¸Šé¢æåˆ°çš„ç¬¬5æ­¥ä¸­çš„å¤„ç†@Importæ³¨è§£æ–¹æ³•ï¼š&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;//è¿™ä¸ªæ–¹æ³•å†…éƒ¨ç›¸å½“ç›¸å½“å¤æ‚ï¼ŒimportCandidatesæ˜¯Importçš„å†…å®¹ï¼Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œå·²ç»è¯´è¿‡å¯èƒ½æœ‰ä¸‰ç§æƒ…å†µ
//è¿™é‡Œå†è¯´ä¸‹ï¼Œ1.Importæ™®é€šç±»ï¼Œ2.Import ImportSelectorï¼Œ3.Import ImportBeanDefinitionRegistrar
//å¾ªç¯importCandidatesï¼Œåˆ¤æ–­å±äºå“ªç§æƒ…å†µ
//å¦‚æœæ˜¯æ™®é€šç±»ï¼Œä¼šè¿›åˆ°elseï¼Œè°ƒç”¨processConfigurationClassæ–¹æ³•
//è¿™ä¸ªæ–¹æ³•æ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œæ²¡é”™ï¼ŒprocessImportsè¿™ä¸ªæ–¹æ³•å°±æ˜¯åœ¨processConfigurationClassæ–¹æ³•ä¸­è¢«è°ƒç”¨çš„
//processImportsåˆä¸»åŠ¨è°ƒç”¨processConfigurationClassæ–¹æ³•ï¼Œæ˜¯ä¸€ä¸ªé€’å½’è°ƒç”¨ï¼Œå› ä¸ºImportçš„æ™®é€šç±»ï¼Œä¹Ÿæœ‰å¯èƒ½è¢«åŠ äº†Importæ³¨è§£ï¼Œ@ComponentScanæ³¨è§£ æˆ–è€…å…¶ä»–æ³¨è§£ï¼Œæ‰€ä»¥æ™®é€šç±»éœ€è¦å†æ¬¡è¢«è§£æ
//å¦‚æœImport ImportSelectorå°±è·‘åˆ°äº†ç¬¬ä¸€ä¸ªifä¸­å»ï¼Œé¦–å…ˆæ‰§è¡ŒAwareæ¥å£æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨å®ç°ImportSelectorçš„åŒæ—¶ï¼Œè¿˜å¯ä»¥å®ç°Awareæ¥å£
//ç„¶ååˆ¤æ–­æ˜¯ä¸æ˜¯DeferredImportSelectorï¼ŒDeferredImportSelectoræ‰©å±•äº†ImportSelector
//å¦‚æœä¸æ˜¯çš„è¯ï¼Œè°ƒç”¨selectImportsæ–¹æ³•ï¼Œè·å¾—å…¨é™å®šç±»åæ•°ç»„ï¼Œåœ¨è½¬æ¢æˆç±»çš„æ•°ç»„ï¼Œç„¶åå†è°ƒç”¨processImportsï¼Œåˆç‰¹ä¹ˆçš„æ˜¯ä¸€ä¸ªé€’å½’è°ƒç”¨...
//å¯èƒ½åˆæœ‰ä¸‰ç§æƒ…å†µï¼Œä¸€ç§æƒ…å†µæ˜¯selectImportsçš„ç±»æ˜¯ä¸€ä¸ªæ™®é€šç±»ï¼Œç¬¬äºŒç§æƒ…å†µæ˜¯selectImportsçš„ç±»æ˜¯ä¸€ä¸ªImportBeanDefinitionRegistrarç±»ï¼Œç¬¬ä¸‰ç§æƒ…å†µæ˜¯è¿˜æ˜¯ä¸€ä¸ªImportSelectorç±»...
//æ‰€ä»¥åˆéœ€è¦é€’å½’è°ƒç”¨
//å¦‚æœImport ImportBeanDefinitionRegistrarå°±è·‘åˆ°äº†ç¬¬äºŒä¸ªifï¼Œè¿˜æ˜¯ä¼šæ‰§è¡ŒAwareæ¥å£æ–¹æ³•ï¼Œè¿™é‡Œç»ˆäºæ²¡æœ‰é€’å½’äº†ï¼Œä¼šæŠŠæ•°æ®æ”¾åˆ°ConfigurationClassä¸­çš„Map&amp;lt;ImportBeanDefinitionRegistrar, AnnotationMetadata&amp;gt; importBeanDefinitionRegistrarsä¸­å»
private void processImports(ConfigurationClass configClass, SourceClass currentSourceClass,
							Collection&amp;lt;SourceClass&amp;gt; importCandidates, boolean checkForCircularImports) {

	if (importCandidates.isEmpty()) {
		return;
	}

	if (checkForCircularImports &amp;amp;&amp;amp; isChainedImportOnStack(configClass)) {
		this.problemReporter.error(new CircularImportProblem(configClass, this.importStack));
	} else {
		this.importStack.push(configClass);
		try {
			for (SourceClass candidate : importCandidates) {
				if (candidate.isAssignable(ImportSelector.class)) {
					// Candidate class is an ImportSelector -&amp;gt; delegate to it to determine imports
					Class&amp;lt;?&amp;gt; candidateClass = candidate.loadClass();
					ImportSelector selector = BeanUtils.instantiateClass(candidateClass, ImportSelector.class);
					ParserStrategyUtils.invokeAwareMethods(
							selector, this.environment, this.resourceLoader, this.registry);
					if (this.deferredImportSelectors != null &amp;amp;&amp;amp; selector instanceof DeferredImportSelector) {
						this.deferredImportSelectors.add(
								new DeferredImportSelectorHolder(configClass, (DeferredImportSelector) selector));
					} else {
						String[] importClassNames = selector.selectImports(currentSourceClass.getMetadata());
						Collection&amp;lt;SourceClass&amp;gt; importSourceClasses = asSourceClasses(importClassNames);
						processImports(configClass, currentSourceClass, importSourceClasses, false);
					}
				} else if (candidate.isAssignable(ImportBeanDefinitionRegistrar.class)) {
					// Candidate class is an ImportBeanDefinitionRegistrar -&amp;gt;
					// delegate to it to register additional bean definitions
					Class&amp;lt;?&amp;gt; candidateClass = candidate.loadClass();
					ImportBeanDefinitionRegistrar registrar =
							BeanUtils.instantiateClass(candidateClass, ImportBeanDefinitionRegistrar.class);
					ParserStrategyUtils.invokeAwareMethods(
							registrar, this.environment, this.resourceLoader, this.registry);
					configClass.addImportBeanDefinitionRegistrar(registrar, currentSourceClass.getMetadata());
				} else {
					// Candidate class not an ImportSelector or ImportBeanDefinitionRegistrar -&amp;gt;
					// process it as an @Configuration class
					this.importStack.registerImport(
							currentSourceClass.getMetadata(), candidate.getMetadata().getClassName());
					processConfigurationClass(candidate.asConfigClass(configClass));
				}
			}
		} catch (BeanDefinitionStoreException ex) {
			throw ex;
		} catch (Throwable ex) {
			throw new BeanDefinitionStoreException(
					&quot;Failed to process import candidates for configuration class [&quot; +
							configClass.getMetadata().getClassName() + &quot;]&quot;, ex);
		} finally {
			this.importStack.pop();
		}
	}
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;è¿™ä¸ªæ–¹æ³•å¤§æ¦‚çš„ä½œç”¨å·²ç»åœ¨æ³¨é‡Šä¸­å·²ç»å†™æ˜äº†ï¼Œå°±ä¸å†é‡å¤äº†ã€‚
ç›´åˆ°è¿™é‡Œï¼Œæ‰æŠŠConfigurationClassPostProcessorä¸­çš„processConfigBeanDefinitionsæ–¹æ³•ç®€å•çš„è¿‡äº†ä¸€ä¸‹ã€‚
ä½†æ˜¯è¿™è¿˜æ²¡æœ‰ç»“æŸï¼Œè¿™é‡Œåªä¼šè§£æ@Importçš„Beanè€Œå·²ï¼Œ ä¸ä¼šæ³¨å†Œã€‚&lt;/p&gt;

&lt;p&gt;åç»­è¿˜æœ‰ä¸ªç‚¹ï¼šprocessConfigBeanDefinitionsæ˜¯BeanDefinitionRegistryPostProcessoræ¥å£ä¸­çš„æ–¹æ³•ï¼ŒBeanDefinitionRegistryPostProcessoræ‰©å±•äº†BeanFactoryPostProcessorï¼Œè¿˜æœ‰postProcessBeanFactoryæ–¹æ³•æ²¡æœ‰åˆ†æï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯å¹²å˜›çš„ï¼Œç®€å•çš„æ¥è¯´ï¼Œå°±æ˜¯åˆ¤æ–­é…ç½®ç±»æ˜¯Liteé…ç½®ç±»ï¼Œè¿˜æ˜¯Fullé…ç½®ç±»ï¼Œå¦‚æœæ˜¯é…ç½®ç±»ï¼Œå°±ä¼šè¢«Cglibä»£ç†ï¼Œç›®çš„å°±æ˜¯ä¿è¯Beançš„ä½œç”¨åŸŸã€‚å…³äºè¿™ä¸ªæ–¹æ³•å®åœ¨æ˜¯æ¯”è¾ƒå¤æ‚ï¼Œè¯¾ç¨‹ä¸­è®²è§£ã€‚&lt;/p&gt;

&lt;p&gt;æˆ‘ä»¬æ¥åšä¸€ä¸ªæ€»ç»“ï¼ŒConfigurationClassPostProcessorä¸­çš„processConfigBeanDefinitionsæ–¹æ³•ååˆ†é‡è¦ï¼Œä¸»è¦æ˜¯å®Œæˆæ‰«æï¼Œæœ€ç»ˆæ³¨å†Œæˆ‘ä»¬å®šä¹‰çš„Beanã€‚&lt;/p&gt;

&lt;p&gt;6.6-registerBeanPostProcessors(beanFactory);
å®ä¾‹åŒ–å’Œæ³¨å†ŒbeanFactoryä¸­æ‰©å±•äº†BeanPostProcessorçš„beanã€‚
ä¾‹å¦‚ï¼š
AutowiredAnnotationBeanPostProcessor(å¤„ç†è¢«@Autowiredæ³¨è§£ä¿®é¥°çš„beanå¹¶æ³¨å…¥)
RequiredAnnotationBeanPostProcessor(å¤„ç†è¢«@Requiredæ³¨è§£ä¿®é¥°çš„æ–¹æ³•)
CommonAnnotationBeanPostProcessor(å¤„ç†@PreDestroyã€@PostConstructã€@Resourceç­‰å¤šä¸ªæ³¨è§£çš„ä½œç”¨)ç­‰ã€‚&lt;/p&gt;

&lt;p&gt;6.7-initMessageSource()
// åˆå§‹åŒ–å›½é™…åŒ–èµ„æºå¤„ç†å™¨. ä¸æ˜¯ä¸»çº¿ä»£ç å¿½ç•¥ï¼Œæ²¡ä»€ä¹ˆå­¦ä¹ ä»·å€¼ã€‚
initMessageSource();&lt;/p&gt;

&lt;p&gt;6.8-initApplicationEventMulticaster()
// åˆ›å»ºäº‹ä»¶å¤šæ’­å™¨
äº‹ä»¶ç›¸å…³ä¼šå•ç‹¬è®²è§£ï¼šSpringäº‹ä»¶ç›‘å¬æœºåˆ¶&lt;/p&gt;

&lt;p&gt;6.9-onRefresh();
æ¨¡æ¿æ–¹æ³•ï¼Œåœ¨å®¹å™¨åˆ·æ–°çš„æ—¶å€™å¯ä»¥è‡ªå®šä¹‰é€»è¾‘ï¼Œä¸åŒçš„Springå®¹å™¨åšä¸åŒçš„äº‹æƒ…ã€‚&lt;/p&gt;

&lt;p&gt;6.10-registerListeners();
æ³¨å†Œç›‘å¬å™¨ï¼Œå¹¿æ’­early application events
äº‹ä»¶ç›¸å…³ä¼šå•ç‹¬è®²è§£ï¼šSpringäº‹ä»¶ç›‘å¬æœºåˆ¶&lt;/p&gt;

&lt;p&gt;6-11-finishBeanFactoryInitialization(beanFactory);
å®ä¾‹åŒ–æ‰€æœ‰å‰©ä½™çš„ï¼ˆéæ‡’åŠ è½½ï¼‰å•ä¾‹
æ¯”å¦‚invokeBeanFactoryPostProcessorsæ–¹æ³•ä¸­æ ¹æ®å„ç§æ³¨è§£è§£æå‡ºæ¥çš„ç±»ï¼Œåœ¨è¿™ä¸ªæ—¶å€™éƒ½ä¼šè¢«åˆå§‹åŒ–ã€‚
å®ä¾‹åŒ–çš„è¿‡ç¨‹å„ç§BeanPostProcessorå¼€å§‹èµ·ä½œç”¨ã€‚&lt;/p&gt;

&lt;p&gt;è¿™ä¸ªæ–¹æ³•æ˜¯ç”¨æ¥å®ä¾‹åŒ–æ‡’åŠ è½½å•ä¾‹Beançš„ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„Beanéƒ½æ˜¯åœ¨è¿™é‡Œè¢«åˆ›å»ºå‡ºæ¥çš„ï¼ˆå½“ç„¶æˆ‘è¿™é‡Œè¯´çš„çš„æ˜¯ç»å¤§éƒ¨åˆ†æƒ…å†µæ˜¯è¿™æ ·çš„ï¼‰ï¼š
finishBeanFactoryInitialization(beanFactory);&lt;/p&gt;

&lt;p&gt;æˆ‘ä»¬å†è¿›å…¥finishBeanFactoryInitializationè¿™æ–¹æ³•ï¼Œé‡Œé¢æœ‰ä¸€ä¸ªbeanFactory.preInstantiateSingletons()æ–¹æ³•ï¼š
        //åˆå§‹åŒ–æ‰€æœ‰çš„éæ‡’åŠ è½½å•ä¾‹
        beanFactory.preInstantiateSingletons();&lt;/p&gt;

&lt;p&gt;æˆ‘ä»¬å°è¯•å†ç‚¹è¿›å»ï¼Œè¿™ä¸ªæ—¶å€™ä½ ä¼šå‘ç°è¿™æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå¥½åœ¨å®ƒåªæœ‰ä¸€ä¸ªå®ç°ç±»ï¼Œæ‰€ä»¥å¯ä»¥æˆ‘ä»¬æ¥åˆ°äº†ä»–çš„å”¯ä¸€å®ç°ï¼Œå®ç°ç±»å°±æ˜¯org.springframework.beans.factory.support.DefaultListableBeanFactoryï¼Œè¿™é‡Œé¢æ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œæˆ‘ä»¬çš„Beanå°±æ˜¯å¾ªç¯è¢«åˆ›å»ºå‡ºæ¥çš„ï¼Œæˆ‘ä»¬æ‰¾åˆ°å…¶ä¸­çš„getBeanæ–¹æ³•ï¼š
getBean(beanName);&lt;/p&gt;

&lt;p&gt;è¿™é‡Œæœ‰ä¸€ä¸ªåˆ†æ”¯ï¼Œå¦‚æœBeanæ˜¯FactoryBeanï¼Œå¦‚ä½•å¦‚ä½•ï¼Œå¦‚æœBeanä¸æ˜¯FactoryBeanå¦‚ä½•å¦‚ä½•ï¼Œå¥½åœ¨ä¸ç®¡æ˜¯ä¸æ˜¯FactoryBeanï¼Œæœ€ç»ˆè¿˜æ˜¯ä¼šè°ƒç”¨getBeanæ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ¯«ä¸çŠ¹è±«çš„ç‚¹è¿›å»ï¼Œç‚¹è¿›å»ä¹‹åï¼Œä½ ä¼šå‘ç°ï¼Œè¿™æ˜¯ä¸€ä¸ªé—¨é¢æ–¹æ³•ï¼Œç›´æ¥è°ƒç”¨äº†doGetBeanæ–¹æ³•ï¼š
    return doGetBean(name, null, null, false);&lt;/p&gt;

&lt;p&gt;å†è¿›å»ï¼Œä¸æ–­çš„æ·±å…¥ï¼Œæ¥è¿‘æˆ‘ä»¬è¦å¯»æ‰¾çš„ä¸œè¥¿ã€‚
è¿™é‡Œé¢çš„æ¯”è¾ƒå¤æ‚ï¼Œä½†æ˜¯æœ‰æˆ‘åœ¨ï¼Œæˆ‘å¯ä»¥ç›´æ¥å‘Šè¯‰ä½ ï¼Œä¸‹ä¸€æ­¥æˆ‘ä»¬è¦è¿›å…¥å“ªé‡Œï¼Œæˆ‘ä»¬è¦è¿›å…¥
if (mbd.isSingleton()) {&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;                //getSingletonä¸­çš„ç¬¬äºŒä¸ªå‚æ•°ç±»å‹æ˜¯ObjectFactory&amp;lt;?&amp;gt;ï¼Œæ˜¯ä¸€ä¸ªå‡½æ•°å¼æ¥å£ï¼Œä¸ä¼šç«‹åˆ»æ‰§è¡Œï¼Œè€Œæ˜¯åœ¨
                //getSingletonæ–¹æ³•ä¸­ï¼Œè°ƒç”¨ObjectFactoryçš„getObjectï¼Œæ‰ä¼šæ‰§è¡ŒcreateBean
                sharedInstance = getSingleton(beanName, () -&amp;gt; {
                    try {
                        return createBean(beanName, mbd, args);
                    }
                    catch (BeansException ex) {
                        destroySingleton(beanName);
                        throw ex;
                    }
                });
                bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);
            }
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;è¿™é‡Œé¢çš„createBeanæ–¹æ³•ï¼Œå†ç‚¹è¿›å»å•Šï¼Œä½†æ˜¯åˆç‚¹ä¸è¿›å»äº†ï¼Œè¿™æ˜¯æ¥å£å•Šï¼Œä½†æ˜¯åˆ«æ…Œï¼Œè¿™ä¸ªæ¥å£åˆåªæœ‰ä¸€ä¸ªå®ç°ç±»ï¼Œæ‰€ä»¥è¯´ æ²¡äº‹ï¼Œå°±æ˜¯å¹²ï¼Œè¿™ä¸ªå®ç°ç±»ä¸ºorg.springframework.beans.factory.support.AbstractAutowireCapableBeanFactoryã€‚
è¿™ä¸ªå®ç°çš„æ–¹æ³•é‡Œé¢åˆåšäº†å¾ˆå¤šäº‹æƒ…ï¼Œæˆ‘ä»¬å°±ä¸å»çœ‹äº†ï¼Œæˆ‘å°±æ˜¯å¸¦ç€å¤§å®¶æ‰¾åˆ°é‚£å‡ ä¸ªç”Ÿå‘½å‘¨æœŸçš„å›è°ƒåˆ°åº•å®šä¹‰åœ¨å“ªé‡Œå°±OKäº†ã€‚
    Object beanInstance = doCreateBean(beanName, mbdToUse, args);//åˆ›å»ºbeanï¼Œæ ¸å¿ƒ
            if (logger.isDebugEnabled()) {
                logger.debug(â€œFinished creating instance of bean â€˜â€ + beanName + â€œâ€™â€);
            }
            return beanInstance;&lt;/p&gt;

&lt;p&gt;å†ç»§ç»­æ·±å…¥doCreateBeanæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åˆåšäº†ä¸€å †ä¸€å †çš„äº‹æƒ…ï¼Œä½†æ˜¯å€¼å¾—å¼€å¿ƒçš„äº‹æƒ…å°±æ˜¯ æˆ‘ä»¬å·²ç»æ‰¾åˆ°äº†æˆ‘ä»¬è¦å¯»æ‰¾çš„ä¸œè¥¿äº†ã€‚
åˆ›å»ºå®ä¾‹
é¦–å…ˆæ˜¯åˆ›å»ºå®ä¾‹ï¼Œä½äºï¼š
instanceWrapper = createBeanInstance(beanName, mbd, args);//åˆ›å»ºbeançš„å®ä¾‹ã€‚æ ¸å¿ƒ&lt;/p&gt;

&lt;p&gt;å¡«å……å±æ€§
å…¶æ¬¡æ˜¯å¡«å……å±æ€§ï¼Œä½äºï¼š
populateBean(beanName, mbd, instanceWrapper);//å¡«å……å±æ€§ï¼Œç‚’é¸¡é‡è¦&lt;/p&gt;

&lt;p&gt;åœ¨å¡«å……å±æ€§ä¸‹é¢æœ‰ä¸€è¡Œä»£ç ï¼š
    exposedObject = initializeBean(beanName, exposedObject, mbd);&lt;/p&gt;

&lt;p&gt;ç»§ç»­æ·±å…¥è¿›å»ã€‚
awareç³»åˆ—æ¥å£çš„å›è°ƒ
awareç³»åˆ—æ¥å£çš„å›è°ƒä½äºinitializeBeanä¸­çš„invokeAwareMethodsæ–¹æ³•ï¼š
invokeAwareMethods(beanName, bean);
private void invokeAwareMethods(final String beanName, final Object bean) {
        if (bean instanceof Aware) {
            if (bean instanceof BeanNameAware) {
                ((BeanNameAware) bean).setBeanName(beanName);
            }
            if (bean instanceof BeanClassLoaderAware) {
                ClassLoader bcl = getBeanClassLoader();
                if (bcl != null) {
                    ((BeanClassLoaderAware) bean).setBeanClassLoader(bcl);
                }
            }
            if (bean instanceof BeanFactoryAware) {
                ((BeanFactoryAware) bean).setBeanFactory(AbstractAutowireCapableBeanFactory.this);
            }
        }
    }&lt;/p&gt;

&lt;p&gt;BeanPostProcessorçš„postProcessBeforeInitializationæ–¹æ³•
BeanPostProcessorçš„postProcessBeforeInitializationæ–¹æ³•ä½äºinitializeBeançš„
if (mbd == null || !mbd.isSynthetic()) {
            wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName);
        }
    @Override
    public Object applyBeanPostProcessorsBeforeInitialization(Object existingBean, String beanName)
            throws BeansException {&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;    Object result = existingBean;
    for (BeanPostProcessor processor : getBeanPostProcessors()) {
        Object current = processor.postProcessBeforeInitialization(result, beanName);
        if (current == null) {
            return result;
        }
        result = current;
    }
    return result;
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;afterPropertiesSet init-method
afterPropertiesSet init-methodä½äºinitializeBeanä¸­çš„
    invokeInitMethods(beanName, wrappedBean, mbd);&lt;/p&gt;

&lt;p&gt;è¿™é‡Œé¢è°ƒç”¨äº†ä¸¤ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯afterPropertiesSetæ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯init-methodæ–¹æ³•ï¼š
    ((InitializingBean) bean).afterPropertiesSet();
invokeCustomInitMethod(beanName, bean, mbd);&lt;/p&gt;

&lt;p&gt;BeanPostProcessorçš„postProcessAfterInitializationæ–¹æ³•
BeanPostProcessorçš„postProcessAfterInitializationæ–¹æ³•ä½äºinitializeBeançš„
if (mbd == null || !mbd.isSynthetic()) {
            wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);
        }
    public Object applyBeanPostProcessorsAfterInitialization(Object existingBean, String beanName)
            throws BeansException {&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;    Object result = existingBean;
    for (BeanPostProcessor processor : getBeanPostProcessors()) {
        Object current = processor.postProcessAfterI nitialization(result, beanName);
        if (current == null) {
            return result;
        }
        result = current;
    }
    return result;
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;å½“ç„¶åœ¨å®é™…çš„å¼€å‘ä¸­ï¼Œåº”è¯¥æ²¡äººä¼šå»é”€æ¯Springçš„åº”ç”¨ä¸Šä¸‹æ–‡æŠŠï¼Œæ‰€ä»¥å‰©ä½™çš„ä¸¤ä¸ªé”€æ¯çš„å›è°ƒå°±ä¸å»æ‰¾äº†ã€‚&lt;/p&gt;

&lt;p&gt;Spring Beançš„ç”Ÿå‘½å‘¨æœŸ
Spring In Actionä»¥åŠå¸‚é¢ä¸Šæµä¼ çš„å¤§éƒ¨åˆ†åšå®¢æ˜¯è¿™æ ·çš„ï¼š
å®ä¾‹åŒ–Beanå¯¹è±¡ï¼Œè¿™ä¸ªæ—¶å€™Beançš„å¯¹è±¡æ˜¯éå¸¸ä½çº§çš„ï¼ŒåŸºæœ¬ä¸èƒ½å¤Ÿè¢«æˆ‘ä»¬ä½¿ç”¨ï¼Œå› ä¸ºè¿æœ€åŸºæœ¬çš„å±æ€§éƒ½æ²¡æœ‰è®¾ç½®ï¼Œå¯ä»¥ç†è§£ä¸ºè¿Autowiredæ³¨è§£éƒ½æ˜¯æ²¡æœ‰è§£æçš„ï¼›
å¡«å……å±æ€§ï¼Œå½“åšå®Œè¿™ä¸€æ­¥ï¼ŒBeanå¯¹è±¡åŸºæœ¬æ˜¯å®Œæ•´çš„äº†ï¼Œå¯ä»¥ç†è§£ä¸ºAutowiredæ³¨è§£å·²ç»è§£æå®Œæ¯•ï¼Œä¾èµ–æ³¨å…¥å®Œæˆäº†ï¼›
å¦‚æœBeanå®ç°äº†BeanNameAwareæ¥å£ï¼Œåˆ™è°ƒç”¨setBeanNameæ–¹æ³•ï¼›
å¦‚æœBeanå®ç°äº†BeanClassLoaderAwareæ¥å£ï¼Œåˆ™è°ƒç”¨setBeanClassLoaderæ–¹æ³•ï¼›
å¦‚æœBeanå®ç°äº†BeanFactoryAwareæ¥å£ï¼Œåˆ™è°ƒç”¨setBeanFactoryæ–¹æ³•ï¼›
è°ƒç”¨BeanPostProcessorçš„postProcessBeforeInitializationæ–¹æ³•ï¼›
å¦‚æœBeanå®ç°äº†InitializingBeanæ¥å£ï¼Œè°ƒç”¨afterPropertiesSetæ–¹æ³•ï¼›
å¦‚æœBeanå®šä¹‰äº†init-methodæ–¹æ³•ï¼Œåˆ™è°ƒç”¨Beançš„init-methodæ–¹æ³•ï¼›
è°ƒç”¨BeanPostProcessorçš„postProcessAfterInitializationæ–¹æ³•ï¼›å½“è¿›è¡Œåˆ°è¿™ä¸€æ­¥ï¼ŒBeanå·²ç»è¢«å‡†å¤‡å°±ç»ªäº†ï¼Œä¸€ç›´åœç•™åœ¨åº”ç”¨çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œç›´åˆ°è¢«é”€æ¯ï¼›
å¦‚æœåº”ç”¨çš„ä¸Šä¸‹æ–‡è¢«é”€æ¯äº†ï¼Œå¦‚æœBeanå®ç°äº†DisposableBeanæ¥å£ï¼Œåˆ™è°ƒç”¨destroyæ–¹æ³•ï¼Œå¦‚æœBeanå®šä¹‰äº†destory-methodå£°æ˜äº†é”€æ¯æ–¹æ³•ä¹Ÿä¼šè¢«è°ƒç”¨ã€‚&lt;/p&gt;

&lt;p&gt;ä¸ºäº†éªŒè¯ä¸Šé¢çš„é€»è¾‘ï¼Œå¯ä»¥åšä¸ªè¯•éªŒï¼š
é¦–å…ˆå®šä¹‰äº†ä¸€ä¸ªBeanï¼Œé‡Œé¢æœ‰å„ç§å›è°ƒå’Œé’©å­ï¼Œå…¶ä¸­éœ€è¦æ³¨æ„ä¸‹ï¼Œæˆ‘åœ¨SpringBeançš„æ„é€ æ–¹æ³•ä¸­æ‰“å°äº†studentServiceï¼Œçœ‹SpringBeanè¢«newçš„å‡ºæ¥çš„æ—¶å€™ï¼ŒstudentServiceæ˜¯å¦è¢«æ³¨å…¥äº†ï¼›åˆåœ¨setBeanNameä¸­æ‰“å°äº†studentServiceï¼Œçœ‹æ­¤æ—¶studentServiceæ˜¯å¦è¢«æ³¨å…¥äº†ï¼Œä»¥æ­¤æ¥éªŒè¯ï¼ŒBeanæ˜¯ä½•æ—¶å®Œæˆçš„è‡ªåŠ¨æ³¨å…¥çš„ï¼ˆè¿™ä¸ªStudentServiceImpl ç±»çš„ä»£ç å°±ä¸è´´å‡ºæ¥äº†ï¼Œæ— éå°±æ˜¯ä¸€ä¸ªæœ€æ™®é€šçš„Beanï¼‰ï¼š
public class SpringBean implements InitializingBean, DisposableBean, BeanNameAware, BeanFactoryAware, BeanClassLoaderAware {&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;public SpringBean() {
    System.out.println(&quot;SpringBeanæ„é€ æ–¹æ³•:&quot; + studentService);
    System.out.println(&quot;SpringBeanæ„é€ æ–¹æ³•&quot;);
}

@Autowired
StudentServiceImpl studentService;

@Override
public void afterPropertiesSet() throws Exception {
    System.out.println(&quot;afterPropertiesSet&quot;);
}

@Override
public void destroy() throws Exception {
    System.out.println(&quot;destroy&quot;);
}

@Override
public void setBeanClassLoader(ClassLoader classLoader) {
    System.out.println(&quot;setBeanClassLoader&quot;);
}

@Override
public void setBeanFactory(BeanFactory beanFactory) throws BeansException {
    System.out.println(&quot;setBeanFactory&quot;);
}

@Override
public void setBeanName(String name) {
    System.out.println(&quot;setBeanName:&quot; + studentService);
    System.out.println(&quot;setBeanName&quot;);
}

public void initMethod() {
    System.out.println(&quot;initMethod&quot;);
}

public void destroyMethod() {
    System.out.println(&quot;destroyMethod&quot;);
} }
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;å†å®šä¹‰ä¸€ä¸ªBeanPostProcessorï¼Œåœ¨é‡å†™çš„ä¸¤ä¸ªæ–¹æ³•ä¸­è¿›è¡Œäº†åˆ¤æ–­ï¼Œå¦‚æœä¼ è¿›æ¥çš„beanNameæ˜¯springBeanæ‰è¿›è¡Œæ‰“å°ï¼š
@Component
public class MyBeanPostProcessor implements BeanPostProcessor {
    @Override
    public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException {
        if(beanName.equals(â€œspringBeanâ€)) {
            System.out.println(â€œpostProcessBeforeInitializationâ€);
        }
        return bean;
    }&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;@Override
public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {
    if(beanName.equals(&quot;springBean&quot;)) {
        System.out.println(&quot;postProcessAfterInitialization&quot;);
    }
    return bean;
} }
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;å®šä¹‰ä¸€ä¸ªé…ç½®ç±»ï¼Œå®Œæˆè‡ªåŠ¨æ‰«æï¼Œä½†æ˜¯SpringBeanæ˜¯æ‰‹åŠ¨æ³¨å†Œçš„ï¼Œå¹¶ä¸”å£°æ˜äº†initMethodå’ŒdestroyMethodï¼š
@Configuration
@ComponentScan
public class AppConfig {
    @Bean(initMethod = â€œinitMethodâ€,destroyMethod = â€œdestroyMethodâ€)
    public SpringBean springBean() {
        return new SpringBean();
    }
}&lt;/p&gt;

&lt;p&gt;æœ€åå°±æ˜¯å¯åŠ¨ç±»äº†ï¼š
    public static void main(String[] args) {
        AnnotationConfigApplicationContext annotationConfigApplicationContext =
                new AnnotationConfigApplicationContext(AppConfig.class);
        annotationConfigApplicationContext.destroy();
    }&lt;/p&gt;

&lt;p&gt;è¿è¡Œç»“æœï¼š
SpringBeanæ„é€ æ–¹æ³•:null
SpringBeanæ„é€ æ–¹æ³•
setBeanName:com.codebear.StudentServiceImpl@31190526
setBeanName
setBeanClassLoader
setBeanFactory
postProcessBeforeInitialization
afterPropertiesSet
initMethod
postProcessAfterInitialization
destroy
destroyMethod&lt;/p&gt;

&lt;p&gt;å¯ä»¥çœ‹åˆ°ï¼Œè¯•éªŒç»“æœå’Œä¸Šé¢åˆ†æçš„å®Œå…¨ä¸€è‡´ã€‚
è¿™å°±æ˜¯å¹¿ä¸ºæµä¼ çš„Springç”Ÿå‘½å‘¨æœŸã€‚
ä¹Ÿè®¸ä½ åœ¨åº”ä»˜é¢è¯•çš„æ—¶å€™ï¼Œæ˜¯æ­»è®°ç¡¬èƒŒè¿™äº›ç»“è®ºçš„ï¼Œç°åœ¨æˆ‘å¸¦ç€ä½ æ‰¾åˆ°è¿™äº›æ–¹æ³•ï¼Œè·Ÿæˆ‘æ¥ã€‚&lt;/p&gt;

&lt;p&gt;6-12-finishRefresh();
refreshåšå®Œä¹‹åéœ€è¦åšçš„å…¶ä»–äº‹æƒ…ã€‚
æ¸…é™¤ä¸Šä¸‹æ–‡èµ„æºç¼“å­˜ï¼ˆå¦‚æ‰«æä¸­çš„ASMå…ƒæ•°æ®ï¼‰
åˆå§‹åŒ–ä¸Šä¸‹æ–‡çš„ç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨ï¼Œå¹¶åˆ·æ–°ï¼ˆæ‰¾å‡ºSpringå®¹å™¨ä¸­å®ç°äº†Lifecycleæ¥å£çš„beanå¹¶æ‰§è¡Œstart()æ–¹æ³•ï¼‰ã€‚
å‘å¸ƒContextRefreshedEventäº‹ä»¶å‘ŠçŸ¥å¯¹åº”çš„ApplicationListenerè¿›è¡Œå“åº”çš„æ“ä½œ&lt;/p&gt;

&lt;p&gt;protected void finishRefresh() {
    // Initialize lifecycle processor for this context.
    // 1.ä¸ºæ­¤ä¸Šä¸‹æ–‡åˆå§‹åŒ–ç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨
    initLifecycleProcessor();&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;// Propagate refresh to lifecycle processor first.
// 2.é¦–å…ˆå°†åˆ·æ–°å®Œæ¯•äº‹ä»¶ä¼ æ’­åˆ°ç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨ï¼ˆè§¦å‘isAutoStartupæ–¹æ³•è¿”å›trueçš„SmartLifecycleçš„startæ–¹æ³•ï¼‰
getLifecycleProcessor().onRefresh();
 
// Publish the final event.
// 3.æ¨é€ä¸Šä¸‹æ–‡åˆ·æ–°å®Œæ¯•äº‹ä»¶åˆ°ç›¸åº”çš„ç›‘å¬å™¨
publishEvent(new ContextRefreshedEvent(this));
 
// Participate in LiveBeansView MBean, if active.
LiveBeansView.registerApplicationContext(this);
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;è¿™é‡Œå•ç‹¬ä»‹ç»ä¸‹publishEvent
@Override
public void publishEvent(ApplicationEvent event) {
    publishEvent(event, null);
}&lt;/p&gt;

&lt;p&gt;protected void publishEvent(Object event, ResolvableType eventType) {
    Assert.notNull(event, â€œEvent must not be nullâ€);
    if (logger.isTraceEnabled()) {
        logger.trace(â€œPublishing event in â€œ + getDisplayName() + â€œ: â€œ + event);
    }&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;// Decorate event as an ApplicationEvent if necessary
// 1.å¦‚æœ‰å¿…è¦ï¼Œå°†äº‹ä»¶è£…é¥°ä¸ºApplicationEvent
ApplicationEvent applicationEvent;
if (event instanceof ApplicationEvent) {
    applicationEvent = (ApplicationEvent) event;
} else {
    applicationEvent = new PayloadApplicationEvent&amp;lt;Object&amp;gt;(this, event);
    if (eventType == null) {
        eventType = ((PayloadApplicationEvent) applicationEvent).getResolvableType();
    }
}
 
// Multicast right now if possible - or lazily once the multicaster is initialized
if (this.earlyApplicationEvents != null) {
    this.earlyApplicationEvents.add(applicationEvent);
} else {
    // 2.ä½¿ç”¨äº‹ä»¶å¹¿æ’­å™¨å¹¿æ’­äº‹ä»¶åˆ°ç›¸åº”çš„ç›‘å¬å™¨
    getApplicationEventMulticaster().multicastEvent(applicationEvent, eventType);
}
 
// Publish event via parent context as well...
// 3.åŒæ ·çš„ï¼Œé€šè¿‡parentå‘å¸ƒäº‹ä»¶......
if (this.parent != null) {
    if (this.parent instanceof AbstractApplicationContext) {
        ((AbstractApplicationContext) this.parent).publishEvent(event, eventType);
    } else {
        this.parent.publishEvent(event);
    }
} }
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2.ä½¿ç”¨äº‹ä»¶å¹¿æ’­å™¨å¹¿æ’­äº‹ä»¶åˆ°ç›¸åº”çš„ç›‘å¬å™¨multicastEvent
@Override
public void multicastEvent(final ApplicationEvent event, ResolvableType eventType) {
    ResolvableType type = (eventType != null ? eventType : resolveDefaultEventType(event));
    // 1.getApplicationListenersï¼šè¿”å›ä¸ç»™å®šäº‹ä»¶ç±»å‹åŒ¹é…çš„åº”ç”¨ç›‘å¬å™¨é›†åˆ
    for (final ApplicationListener&amp;lt;?&amp;gt; listener : getApplicationListeners(event, type)) {
        // 2.è¿”å›æ­¤å¹¿æ’­å™¨çš„å½“å‰ä»»åŠ¡æ‰§è¡Œç¨‹åº
        Executor executor = getTaskExecutor();
        if (executor != null) {
            executor.execute(new Runnable() {
                @Override
                public void run() {
                    // 3.1 executorä¸ä¸ºnullï¼Œåˆ™ä½¿ç”¨executorè°ƒç”¨ç›‘å¬å™¨
                    invokeListener(listener, event);
                }
            });
        } else {
            // 3.2 å¦åˆ™ï¼Œç›´æ¥è°ƒç”¨ç›‘å¬å™¨
            invokeListener(listener, event);
        }
    }
}&lt;/p&gt;

&lt;p&gt;3.2 è°ƒç”¨ç›‘å¬å™¨invokeListener
protected void invokeListener(ApplicationListener&amp;lt;?&amp;gt; listener, ApplicationEvent event) {
    // 1.è¿”å›æ­¤å¹¿æ’­å™¨çš„å½“å‰é”™è¯¯å¤„ç†ç¨‹åº
    ErrorHandler errorHandler = getErrorHandler();
    if (errorHandler != null) {
        try {
            // 2.1 å¦‚æœerrorHandlerä¸ä¸ºnullï¼Œåˆ™ä½¿ç”¨å¸¦é”™è¯¯å¤„ç†çš„æ–¹å¼è°ƒç”¨ç»™å®šçš„ç›‘å¬å™¨
            doInvokeListener(listener, event);
        } catch (Throwable err) {
            errorHandler.handleError(err);
        }
    } else {
        // 2.2 å¦åˆ™ï¼Œç›´æ¥è°ƒç”¨è°ƒç”¨ç»™å®šçš„ç›‘å¬å™¨
        doInvokeListener(listener, event);
    }
}&lt;/p&gt;

&lt;p&gt;private void doInvokeListener(ApplicationListener listener, ApplicationEvent event) {
    try {
        // è§¦å‘ç›‘å¬å™¨çš„onApplicationEventæ–¹æ³•ï¼Œå‚æ•°ä¸ºç»™å®šçš„äº‹ä»¶
        listener.onApplicationEvent(event);
    } catch (ClassCastException ex) {
        String msg = ex.getMessage();
        if (msg == null || msg.startsWith(event.getClass().getName())) {
            // Possibly a lambda-defined listener which we could not resolve the generic event type for
            Log logger = LogFactory.getLog(getClass());
            if (logger.isDebugEnabled()) {
                logger.debug(â€œNon-matching event type for listener: â€œ + listener, ex);
            }
        } else {
            throw ex;
        }
    }
}&lt;/p&gt;

&lt;p&gt;è¿™æ ·ï¼Œå½“ Spring æ‰§è¡Œåˆ° finishRefresh æ–¹æ³•æ—¶ï¼Œå°±ä¼šå°† ContextRefreshedEvent äº‹ä»¶æ¨é€åˆ° MyRefreshedListener ä¸­ã€‚
è·Ÿ ContextRefreshedEvent ç›¸ä¼¼çš„è¿˜æœ‰ï¼šContextStartedEventã€ContextClosedEventã€ContextStoppedEventï¼Œæœ‰å…´è¶£çš„å¯ä»¥è‡ªå·±çœ‹çœ‹è¿™å‡ ä¸ªäº‹ä»¶çš„ä½¿ç”¨åœºæ™¯ã€‚
å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ç›‘å¬äº‹ä»¶ï¼Œåªéœ€è¦ç»§æ‰¿ ApplicationContextEvent æŠ½è±¡ç±»å³å¯ã€‚&lt;/p&gt;

&lt;p&gt;é—®é¢˜ï¼š
1.BeanFactoryå’ŒFactoryBeançš„åŒºåˆ«ï¼Ÿ
2.è¯·ä»‹ç»BeanFactoryPostProcessoråœ¨Springä¸­çš„ç”¨é€”ã€‚
3.SpringIoCçš„åŠ è½½è¿‡ç¨‹ã€‚
4.Beançš„ç”Ÿå‘½å‘¨æœŸã€‚
5.Springä¸­æœ‰å“ªäº›æ‰©å±•æ¥å£åŠè°ƒç”¨æ—¶æœºã€‚&lt;/p&gt;

&lt;p&gt;æ–‡æ¡£ï¼š02-Spring-IoCæºç .note
é“¾æ¥ï¼šhttp://note.youdao.com/noteshare?id=278c04e50441c35a44fe633e3739e073&amp;amp;sub=DF7D9C6E622C4B4B8CF9D3D2D33C7684&lt;/p&gt;</content><author><name>WenHao</name></author><summary type="html">Spring Beançš„ç”Ÿå‘½å‘¨æœŸ å‰è¨€ Spring æœ€é‡è¦çš„æ¦‚å¿µæ˜¯ IOC å’Œ AOPï¼Œå…¶ä¸­IOCåˆæ˜¯Springä¸­çš„æ ¹åŸºï¼š</summary></entry><entry><title type="html">springçš„è®¾è®¡æ¨¡å¼</title><link href="http://localhost:4000/2020/07/15/spring-design/" rel="alternate" type="text/html" title="springçš„è®¾è®¡æ¨¡å¼" /><published>2020-07-15T00:00:00+08:00</published><updated>2020-07-15T00:00:00+08:00</updated><id>http://localhost:4000/2020/07/15/spring-design</id><content type="html" xml:base="http://localhost:4000/2020/07/15/spring-design/">&lt;h1 id=&quot;1ç®€å•å·¥å‚&quot;&gt;1.ç®€å•å·¥å‚&lt;/h1&gt;

&lt;h2 id=&quot;å®ç°æ–¹å¼&quot;&gt;å®ç°æ–¹å¼ï¼š&lt;/h2&gt;

&lt;p&gt;BeanFactoryã€‚Springä¸­çš„BeanFactoryå°±æ˜¯ç®€å•å·¥å‚æ¨¡å¼çš„ä½“ç°ï¼Œæ ¹æ®ä¼ å…¥ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†æ¥è·å¾—Beanå¯¹è±¡ï¼Œä½†æ˜¯å¦æ˜¯åœ¨ä¼ å…¥å‚æ•°ååˆ›å»ºè¿˜æ˜¯ä¼ å…¥å‚æ•°å‰åˆ›å»ºè¿™ä¸ªè¦æ ¹æ®å…·ä½“æƒ…å†µæ¥å®šã€‚&lt;/p&gt;

&lt;p&gt;å®è´¨ï¼š&lt;/p&gt;

&lt;p&gt;ç”±ä¸€ä¸ªå·¥å‚ç±»æ ¹æ®ä¼ å…¥çš„å‚æ•°ï¼ŒåŠ¨æ€å†³å®šåº”è¯¥åˆ›å»ºå“ªä¸€ä¸ªäº§å“ç±»ã€‚&lt;/p&gt;

&lt;h2 id=&quot;å®ç°åŸç†&quot;&gt;å®ç°åŸç†ï¼š&lt;/h2&gt;

&lt;p&gt;&lt;strong&gt;beanå®¹å™¨çš„å¯åŠ¨é˜¶æ®µï¼š&lt;/strong&gt;
è¯»å–beançš„é…ç½®,å°†beanå…ƒç´ åˆ†åˆ«è½¬æ¢æˆä¸€ä¸ªBeanDefinitionå¯¹è±¡ã€‚
ç„¶åé€šè¿‡BeanDefinitionRegistryå°†è¿™äº›beanæ³¨å†Œåˆ°beanFactoryä¸­ï¼Œä¿å­˜åœ¨å®ƒçš„ä¸€ä¸ªConcurrentHashMapä¸­ã€‚
å°†BeanDefinitionæ³¨å†Œåˆ°äº†beanFactoryä¹‹åï¼Œåœ¨è¿™é‡ŒSpringä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªæ‰©å±•çš„åˆ‡å£ï¼Œå…è®¸æˆ‘ä»¬é€šè¿‡å®ç°æ¥å£BeanFactoryPostProcessor åœ¨æ­¤å¤„æ¥æ’å…¥æˆ‘ä»¬å®šä¹‰çš„ä»£ç ã€‚
å…¸å‹çš„ä¾‹å­å°±æ˜¯ï¼šPropertyPlaceholderConfigurerï¼Œæˆ‘ä»¬ä¸€èˆ¬åœ¨é…ç½®æ•°æ®åº“çš„dataSourceæ—¶ä½¿ç”¨åˆ°çš„å ä½ç¬¦çš„å€¼ï¼Œå°±æ˜¯å®ƒæ³¨å…¥è¿›å»çš„ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;å®¹å™¨ä¸­beançš„å®ä¾‹åŒ–é˜¶æ®µï¼š&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;å®ä¾‹åŒ–é˜¶æ®µä¸»è¦æ˜¯é€šè¿‡åå°„æˆ–è€…CGLIBå¯¹beanè¿›è¡Œå®ä¾‹åŒ–ï¼Œåœ¨è¿™ä¸ªé˜¶æ®µSpringåˆç»™æˆ‘ä»¬æš´éœ²äº†å¾ˆå¤šçš„æ‰©å±•ç‚¹ï¼š
å„ç§çš„Awareæ¥å£ï¼Œæ¯”å¦‚ BeanFactoryAwareï¼Œå¯¹äºå®ç°äº†è¿™äº›Awareæ¥å£çš„beanï¼Œåœ¨å®ä¾‹åŒ–beanæ—¶Springä¼šå¸®æˆ‘ä»¬æ³¨å…¥å¯¹åº”çš„BeanFactoryçš„å®ä¾‹ã€‚
BeanPostProcessoræ¥å£ï¼Œå®ç°äº†BeanPostProcessoræ¥å£çš„beanï¼Œåœ¨å®ä¾‹åŒ–beanæ—¶Springä¼šå¸®æˆ‘ä»¬è°ƒç”¨æ¥å£ä¸­çš„æ–¹æ³•ã€‚
InitializingBeanæ¥å£ï¼Œå®ç°äº†InitializingBeanæ¥å£çš„beanï¼Œåœ¨å®ä¾‹åŒ–beanæ—¶Springä¼šå¸®æˆ‘ä»¬è°ƒç”¨æ¥å£ä¸­çš„æ–¹æ³•ã€‚
DisposableBeanæ¥å£ï¼Œå®ç°äº†BeanPostProcessoræ¥å£çš„beanï¼Œåœ¨è¯¥beanæ­»äº¡æ—¶Springä¼šå¸®æˆ‘ä»¬è°ƒç”¨æ¥å£ä¸­çš„æ–¹æ³•ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;è®¾è®¡æ„ä¹‰ï¼š&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;æ¾è€¦åˆã€‚å¯ä»¥å°†åŸæ¥ç¡¬ç¼–ç çš„ä¾èµ–ï¼Œé€šè¿‡Springè¿™ä¸ªbeanFactoryè¿™ä¸ªå·¥å‚æ¥æ³¨å…¥ä¾èµ–ï¼Œä¹Ÿå°±æ˜¯è¯´åŸæ¥åªæœ‰ä¾èµ–æ–¹å’Œè¢«ä¾èµ–æ–¹ï¼Œç°åœ¨æˆ‘ä»¬å¼•å…¥äº†ç¬¬ä¸‰æ–¹â€”â€”springè¿™ä¸ªbeanFactoryï¼Œç”±å®ƒæ¥è§£å†³beanä¹‹é—´çš„ä¾èµ–é—®é¢˜ï¼Œè¾¾åˆ°äº†æ¾è€¦åˆçš„æ•ˆæœ.&lt;/p&gt;

&lt;p&gt;beançš„é¢å¤–å¤„ç†ã€‚é€šè¿‡Springæ¥å£çš„æš´éœ²ï¼Œåœ¨å®ä¾‹åŒ–beançš„é˜¶æ®µæˆ‘ä»¬å¯ä»¥è¿›è¡Œä¸€äº›é¢å¤–çš„å¤„ç†ï¼Œè¿™äº›é¢å¤–çš„å¤„ç†åªéœ€è¦è®©beanå®ç°å¯¹åº”çš„æ¥å£å³å¯ï¼Œé‚£ä¹ˆspringå°±ä¼šåœ¨beançš„ç”Ÿå‘½å‘¨æœŸè°ƒç”¨æˆ‘ä»¬å®ç°çš„æ¥å£æ¥å¤„ç†è¯¥beanã€‚[éå¸¸é‡è¦]&lt;/p&gt;

&lt;h1 id=&quot;2å·¥å‚æ–¹æ³•&quot;&gt;2.å·¥å‚æ–¹æ³•&lt;/h1&gt;

&lt;p&gt;å®ç°æ–¹å¼ï¼š&lt;/p&gt;

&lt;p&gt;FactoryBeanæ¥å£ã€‚&lt;/p&gt;

&lt;h2 id=&quot;å®ç°åŸç†-1&quot;&gt;å®ç°åŸç†ï¼š&lt;/h2&gt;

&lt;p&gt;å®ç°äº†FactoryBeanæ¥å£çš„beanæ˜¯ä¸€ç±»å«åšfactoryçš„beanã€‚å…¶ç‰¹ç‚¹æ˜¯ï¼Œspringä¼šåœ¨ä½¿ç”¨getBean()è°ƒç”¨è·å¾—è¯¥beanæ—¶ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨è¯¥beançš„getObject()æ–¹æ³•ï¼Œæ‰€ä»¥è¿”å›çš„ä¸æ˜¯factoryè¿™ä¸ªbeanï¼Œè€Œæ˜¯è¿™ä¸ªbean.getOjbect()æ–¹æ³•çš„è¿”å›å€¼ã€‚&lt;/p&gt;

&lt;p&gt;ä¾‹å­ï¼š&lt;/p&gt;

&lt;p&gt;å…¸å‹çš„ä¾‹å­æœ‰springä¸mybatisçš„ç»“åˆã€‚&lt;/p&gt;

&lt;p&gt;ä»£ç ç¤ºä¾‹ï¼š&lt;/p&gt;

&lt;p&gt;è¯´æ˜ï¼š&lt;/p&gt;

&lt;p&gt;æˆ‘ä»¬çœ‹ä¸Šé¢è¯¥beanï¼Œå› ä¸ºå®ç°äº†FactoryBeanæ¥å£ï¼Œæ‰€ä»¥è¿”å›çš„ä¸æ˜¯ SqlSessionFactoryBean çš„å®ä¾‹ï¼Œè€Œæ˜¯å®ƒçš„ SqlSessionFactoryBean.getObject() çš„è¿”å›å€¼ã€‚&lt;/p&gt;

&lt;p&gt;æ‰©å±•ï¼šè®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆé¬¼ï¼ˆå·¥å‚æ–¹æ³•ï¼‰&lt;/p&gt;

&lt;h1 id=&quot;3å•ä¾‹æ¨¡å¼&quot;&gt;3.å•ä¾‹æ¨¡å¼&lt;/h1&gt;

&lt;p&gt;Springä¾èµ–æ³¨å…¥Beanå®ä¾‹é»˜è®¤æ˜¯å•ä¾‹çš„ã€‚&lt;/p&gt;

&lt;p&gt;Springçš„ä¾èµ–æ³¨å…¥ï¼ˆåŒ…æ‹¬lazy-initæ–¹å¼ï¼‰éƒ½æ˜¯å‘ç”Ÿåœ¨AbstractBeanFactoryçš„getBeané‡Œã€‚getBeançš„doGetBeanæ–¹æ³•è°ƒç”¨getSingletonè¿›è¡Œbeançš„åˆ›å»ºã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;åˆ†ægetSingleton()æ–¹æ³•&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Object&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;getSingleton&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;beanName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;){&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;//å‚æ•°trueè®¾ç½®æ ‡è¯†å…è®¸æ—©æœŸä¾èµ–&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;getSingleton&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;beanName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Object&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;getSingleton&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;beanName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;allowEarlyReference&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;//æ£€æŸ¥ç¼“å­˜ä¸­æ˜¯å¦å­˜åœ¨å®ä¾‹&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Object&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;singletonObject&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;singletonObjects&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;beanName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;singletonObject&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;isSingletonCurrentlyInCreation&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;beanName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;//å¦‚æœä¸ºç©ºï¼Œåˆ™é”å®šå…¨å±€å˜é‡å¹¶è¿›è¡Œå¤„ç†ã€‚&lt;/span&gt;
        &lt;span class=&quot;kd&quot;&gt;synchronized&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;singletonObjects&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;//å¦‚æœæ­¤beanæ­£åœ¨åŠ è½½ï¼Œåˆ™ä¸å¤„ç†&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;singletonObject&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;earlySingletonObjects&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;beanName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;singletonObject&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;allowEarlyReference&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;  
&lt;span class=&quot;c1&quot;&gt;//å½“æŸäº›æ–¹æ³•éœ€è¦æå‰åˆå§‹åŒ–çš„æ—¶å€™åˆ™ä¼šè°ƒç”¨addSingleFactory æ–¹æ³•å°†å¯¹åº”çš„ObjectFactoryåˆå§‹åŒ–ç­–ç•¥å­˜å‚¨åœ¨singletonFactories&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;ObjectFactory&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;singletonFactory&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;singletonFactories&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;beanName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;singletonFactory&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;//è°ƒç”¨é¢„å…ˆè®¾å®šçš„getObjectæ–¹æ³•&lt;/span&gt;
                    &lt;span class=&quot;n&quot;&gt;singletonObject&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;singletonFactory&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getObject&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;//è®°å½•åœ¨ç¼“å­˜ä¸­ï¼ŒearlysingletonObjectså’ŒsingletonFactoriesäº’æ–¥&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;earlySingletonObjects&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;put&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;beanName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;singletonObject&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;singletonFactories&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;remove&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;beanName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
                &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;singletonObject&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;NULL_OBJECT&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;singletonObject&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;


&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;getSingleton()è¿‡ç¨‹å›¾&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://gitee.com/fwh666/fwh_images/raw/master/fwh_images/image-20210806092021578.png&quot; alt=&quot;image-20210806092021578&quot; style=&quot;zoom:50%;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;psï¼šspringä¾èµ–æ³¨å…¥æ—¶ï¼Œä½¿ç”¨äº† åŒé‡åˆ¤æ–­åŠ é” çš„å•ä¾‹æ¨¡å¼&lt;/p&gt;

&lt;p&gt;æ€»ç»“&lt;/p&gt;

&lt;p&gt;å•ä¾‹æ¨¡å¼å®šä¹‰ï¼šä¿è¯ä¸€ä¸ªç±»ä»…æœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶æä¾›ä¸€ä¸ªè®¿é—®å®ƒçš„å…¨å±€è®¿é—®ç‚¹ã€‚&lt;/p&gt;

&lt;p&gt;Springå¯¹å•ä¾‹çš„å®ç°ï¼šspringä¸­çš„å•ä¾‹æ¨¡å¼å®Œæˆäº†ååŠå¥è¯ï¼Œå³æä¾›äº†å…¨å±€çš„è®¿é—®ç‚¹BeanFactoryã€‚ä½†æ²¡æœ‰ä»æ„é€ å™¨çº§åˆ«å»æ§åˆ¶å•ä¾‹ï¼Œè¿™æ˜¯å› ä¸ºspringç®¡ç†çš„æ˜¯ä»»æ„çš„javaå¯¹è±¡ã€‚&lt;/p&gt;

&lt;p&gt;æ‰©å±•ï¼šè®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆé¬¼ï¼ˆå•ä¾‹ï¼‰&lt;/p&gt;

&lt;h1 id=&quot;4é€‚é…å™¨æ¨¡å¼&quot;&gt;4.é€‚é…å™¨æ¨¡å¼&lt;/h1&gt;

&lt;p&gt;å®ç°æ–¹å¼ï¼š&lt;/p&gt;

&lt;p&gt;SpringMVCä¸­çš„é€‚é…å™¨HandlerAdatperã€‚&lt;/p&gt;

&lt;h2 id=&quot;å®ç°åŸç†-2&quot;&gt;å®ç°åŸç†ï¼š&lt;/h2&gt;

&lt;p&gt;HandlerAdatperæ ¹æ®Handlerè§„åˆ™æ‰§è¡Œä¸åŒçš„Handlerã€‚&lt;/p&gt;

&lt;p&gt;å®ç°è¿‡ç¨‹ï¼š&lt;/p&gt;

&lt;p&gt;DispatcherServletæ ¹æ®HandlerMappingè¿”å›çš„handlerï¼Œå‘HandlerAdatperå‘èµ·è¯·æ±‚ï¼Œå¤„ç†Handlerã€‚&lt;/p&gt;

&lt;p&gt;HandlerAdapteræ ¹æ®è§„åˆ™æ‰¾åˆ°å¯¹åº”çš„Handlerå¹¶è®©å…¶æ‰§è¡Œï¼Œæ‰§è¡Œå®Œæ¯•åHandlerä¼šå‘HandlerAdapterè¿”å›ä¸€ä¸ªModelAndViewï¼Œæœ€åç”±HandlerAdapterå‘DispatchServeletè¿”å›ä¸€ä¸ªModelAndViewã€‚&lt;/p&gt;

&lt;p&gt;å®ç°æ„ä¹‰ï¼š&lt;/p&gt;

&lt;p&gt;HandlerAdatperä½¿å¾—Handlerçš„æ‰©å±•å˜å¾—å®¹æ˜“ï¼Œåªéœ€è¦å¢åŠ ä¸€ä¸ªæ–°çš„Handlerå’Œä¸€ä¸ªå¯¹åº”çš„HandlerAdapterå³å¯ã€‚&lt;/p&gt;

&lt;p&gt;å› æ­¤Springå®šä¹‰äº†ä¸€ä¸ªé€‚é…æ¥å£ï¼Œä½¿å¾—æ¯ä¸€ç§Controlleræœ‰ä¸€ç§å¯¹åº”çš„é€‚é…å™¨å®ç°ç±»ï¼Œè®©é€‚é…å™¨ä»£æ›¿controlleræ‰§è¡Œç›¸åº”çš„æ–¹æ³•ã€‚è¿™æ ·åœ¨æ‰©å±•Controlleræ—¶ï¼Œåªéœ€è¦å¢åŠ ä¸€ä¸ªé€‚é…å™¨ç±»å°±å®Œæˆäº†SpringMVCçš„æ‰©å±•äº†ã€‚&lt;/p&gt;

&lt;p&gt;æ‰©å±•ï¼šè®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆé¬¼ï¼ˆé€‚é…å™¨ï¼‰&lt;/p&gt;

&lt;h1 id=&quot;5è£…é¥°å™¨æ¨¡å¼&quot;&gt;5.è£…é¥°å™¨æ¨¡å¼&lt;/h1&gt;

&lt;p&gt;å®ç°æ–¹å¼ï¼š&lt;/p&gt;

&lt;p&gt;Springä¸­ç”¨åˆ°çš„åŒ…è£…å™¨æ¨¡å¼åœ¨ç±»åä¸Šæœ‰ä¸¤ç§è¡¨ç°ï¼šä¸€ç§æ˜¯ç±»åä¸­å«æœ‰Wrapperï¼Œå¦ä¸€ç§æ˜¯ç±»åä¸­å«æœ‰Decoratorã€‚&lt;/p&gt;

&lt;p&gt;å®è´¨ï¼š&lt;/p&gt;

&lt;p&gt;åŠ¨æ€åœ°ç»™ä¸€ä¸ªå¯¹è±¡æ·»åŠ ä¸€äº›é¢å¤–çš„èŒè´£ã€‚&lt;/p&gt;

&lt;p&gt;å°±å¢åŠ åŠŸèƒ½æ¥è¯´ï¼ŒDecoratoræ¨¡å¼ç›¸æ¯”ç”Ÿæˆå­ç±»æ›´ä¸ºçµæ´»ã€‚&lt;/p&gt;

&lt;p&gt;æ‰©å±•ï¼šè®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆé¬¼ï¼ˆè£…é¥°ï¼‰&lt;/p&gt;

&lt;h1 id=&quot;6ä»£ç†æ¨¡å¼&quot;&gt;6.ä»£ç†æ¨¡å¼&lt;/h1&gt;

&lt;p&gt;å®ç°æ–¹å¼ï¼š&lt;/p&gt;

&lt;p&gt;AOPåº•å±‚ï¼Œå°±æ˜¯åŠ¨æ€ä»£ç†æ¨¡å¼çš„å®ç°ã€‚&lt;/p&gt;

&lt;p&gt;åŠ¨æ€ä»£ç†ï¼š&lt;/p&gt;

&lt;p&gt;åœ¨å†…å­˜ä¸­æ„å»ºçš„ï¼Œä¸éœ€è¦æ‰‹åŠ¨ç¼–å†™ä»£ç†ç±»&lt;/p&gt;

&lt;p&gt;é™æ€ä»£ç†ï¼š&lt;/p&gt;

&lt;p&gt;éœ€è¦æ‰‹å·¥ç¼–å†™ä»£ç†ç±»ï¼Œä»£ç†ç±»å¼•ç”¨è¢«ä»£ç†å¯¹è±¡ã€‚&lt;/p&gt;

&lt;p&gt;å®ç°åŸç†ï¼š&lt;/p&gt;

&lt;p&gt;åˆ‡é¢åœ¨åº”ç”¨è¿è¡Œçš„æ—¶åˆ»è¢«ç»‡å…¥ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåœ¨ç»‡å…¥åˆ‡é¢æ—¶ï¼ŒAOPå®¹å™¨ä¼šä¸ºç›®æ ‡å¯¹è±¡åˆ›å»ºåŠ¨æ€çš„åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡ã€‚SpringAOPå°±æ˜¯ä»¥è¿™ç§æ–¹å¼ç»‡å…¥åˆ‡é¢çš„ã€‚&lt;/p&gt;

&lt;p&gt;ç»‡å…¥ï¼šæŠŠåˆ‡é¢åº”ç”¨åˆ°ç›®æ ‡å¯¹è±¡å¹¶åˆ›å»ºæ–°çš„ä»£ç†å¯¹è±¡çš„è¿‡ç¨‹ã€‚&lt;/p&gt;

&lt;p&gt;æ‰©å±•ï¼šè®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆé¬¼ï¼ˆä»£ç†ï¼‰&lt;/p&gt;

&lt;h1 id=&quot;7è§‚å¯Ÿè€…æ¨¡å¼&quot;&gt;7.è§‚å¯Ÿè€…æ¨¡å¼&lt;/h1&gt;

&lt;p&gt;å®ç°æ–¹å¼ï¼š&lt;/p&gt;

&lt;p&gt;springçš„äº‹ä»¶é©±åŠ¨æ¨¡å‹ä½¿ç”¨çš„æ˜¯ è§‚å¯Ÿè€…æ¨¡å¼ ï¼ŒSpringä¸­Observeræ¨¡å¼å¸¸ç”¨çš„åœ°æ–¹æ˜¯listenerçš„å®ç°ã€‚&lt;/p&gt;

&lt;p&gt;å…·ä½“å®ç°ï¼š&lt;/p&gt;

&lt;p&gt;äº‹ä»¶æœºåˆ¶çš„å®ç°éœ€è¦ä¸‰ä¸ªéƒ¨åˆ†,äº‹ä»¶æº,äº‹ä»¶,äº‹ä»¶ç›‘å¬å™¨&lt;/p&gt;

&lt;p&gt;ApplicationEventæŠ½è±¡ç±»[äº‹ä»¶]&lt;/p&gt;

&lt;p&gt;ç»§æ‰¿è‡ªjdkçš„EventObject,æ‰€æœ‰çš„äº‹ä»¶éƒ½éœ€è¦ç»§æ‰¿ApplicationEvent,å¹¶ä¸”é€šè¿‡æ„é€ å™¨å‚æ•°sourceå¾—åˆ°äº‹ä»¶æº.&lt;/p&gt;

&lt;p&gt;è¯¥ç±»çš„å®ç°ç±»ApplicationContextEventè¡¨ç¤ºApplicaitonContextçš„å®¹å™¨äº‹ä»¶.&lt;/p&gt;

&lt;p&gt;ä»£ç ï¼š&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;abstract&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;ApplicationEvent&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;EventObject&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;serialVersionUID&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;7099057708183571937L&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;timestamp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;ApplicationEvent&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Object&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;){&lt;/span&gt;
        &lt;span class=&quot;kd&quot;&gt;super&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;timestamp&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;System&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;currentTimeMillis&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;longget&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;Timestamp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(){&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;returnthis&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;timestamp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;ApplicationListeneræ¥å£[äº‹ä»¶ç›‘å¬å™¨]&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;ç»§æ‰¿è‡ªjdkçš„EventListener,æ‰€æœ‰çš„ç›‘å¬å™¨éƒ½è¦å®ç°è¿™ä¸ªæ¥å£ã€‚&lt;/p&gt;

&lt;p&gt;è¿™ä¸ªæ¥å£åªæœ‰ä¸€ä¸ªonApplicationEvent()æ–¹æ³•,è¯¥æ–¹æ³•æ¥å—ä¸€ä¸ªApplicationEventæˆ–å…¶å­ç±»å¯¹è±¡ä½œä¸ºå‚æ•°,åœ¨æ–¹æ³•ä½“ä¸­,å¯ä»¥é€šè¿‡ä¸åŒå¯¹Eventç±»çš„åˆ¤æ–­æ¥è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚&lt;/p&gt;

&lt;p&gt;å½“äº‹ä»¶è§¦å‘æ—¶æ‰€æœ‰çš„ç›‘å¬å™¨éƒ½ä¼šæ”¶åˆ°æ¶ˆæ¯ã€‚&lt;/p&gt;

&lt;p&gt;ä»£ç ï¼š&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;ApplicationListener&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;EextendsApplicationEvent&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;EventListener&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;voidonApplicationEvent&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;E&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;event&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;ApplicationContextæ¥å£[äº‹ä»¶æº]&lt;/p&gt;

&lt;p&gt;ApplicationContextæ˜¯springä¸­çš„å…¨å±€å®¹å™¨ï¼Œç¿»è¯‘è¿‡æ¥æ˜¯â€åº”ç”¨ä¸Šä¸‹æ–‡â€ã€‚&lt;/p&gt;

&lt;p&gt;å®ç°äº†ApplicationEventPublisheræ¥å£ã€‚&lt;/p&gt;

&lt;p&gt;èŒè´£ï¼š&lt;/p&gt;

&lt;p&gt;è´Ÿè´£è¯»å–beançš„é…ç½®æ–‡æ¡£,ç®¡ç†beançš„åŠ è½½,ç»´æŠ¤beanä¹‹é—´çš„ä¾èµ–å…³ç³»,å¯ä»¥è¯´æ˜¯è´Ÿè´£beançš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸ,å†é€šä¿—ä¸€ç‚¹å°±æ˜¯æˆ‘ä»¬å¹³æ—¶æ‰€è¯´çš„IOCå®¹å™¨ã€‚&lt;/p&gt;

&lt;p&gt;ä»£ç ï¼š&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;ApplicationEventPublisher&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;voidpublishEvent&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ApplicationEvent&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;event&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;   
&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;voi&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;dpublishEvent&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ApplicationEvent&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;event&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Assert&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;notNull&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;event&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;Event must not be null&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;logger&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;isTraceEnabled&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;())&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
         &lt;span class=&quot;n&quot;&gt;logger&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;trace&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Publishing event in &quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;getDisplayName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;: &quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;event&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;getApplicationEventMulticaster&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;multicastEvent&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;event&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;parent&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;parent&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;publishEvent&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;event&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;ApplicationEventMulticasteræŠ½è±¡ç±»[äº‹ä»¶æºä¸­publishEventæ–¹æ³•éœ€è¦è°ƒç”¨å…¶æ–¹æ³•getApplicationEventMulticaster]&lt;/p&gt;

&lt;p&gt;å±äºäº‹ä»¶å¹¿æ’­å™¨,å®ƒçš„ä½œç”¨æ˜¯æŠŠApplicationcontextå‘å¸ƒçš„Eventå¹¿æ’­ç»™æ‰€æœ‰çš„ç›‘å¬å™¨.&lt;/p&gt;

&lt;p&gt;ä»£ç ï¼š&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;abstract&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;classAbstractApplicationContext&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;DefaultResourceLoader&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ConfigurableApplicationContext&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;DisposableBean&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;  
&lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ApplicationEventMulticaster&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;applicationEventMulticaster&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;  
&lt;span class=&quot;n&quot;&gt;protectedvoid&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;registerListeners&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;  
&lt;span class=&quot;c1&quot;&gt;// Register statically specified listeners first.  &lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ApplicationListener&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;listener&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;getApplicationListeners&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;())&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;  
    &lt;span class=&quot;n&quot;&gt;getApplicationEventMulticaster&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;addApplicationListener&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;listener&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;  
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;  
&lt;span class=&quot;c1&quot;&gt;// Do not initialize FactoryBeans here: We need to leave all regular beans  &lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// uninitialized to let post-processors apply to them!  &lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;listenerBeanNames&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;getBeanNamesForType&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ApplicationListener&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;  
&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lisName&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;listenerBeanNames&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;  
    &lt;span class=&quot;n&quot;&gt;getApplicationEventMulticaster&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;addApplicationListenerBean&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lisName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;  
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;  
  &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;  
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;æ‰©å±•ï¼šè®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆé¬¼ï¼ˆè§‚å¯Ÿè€…ï¼‰&lt;/p&gt;

&lt;h1 id=&quot;8ç­–ç•¥æ¨¡å¼&quot;&gt;8.ç­–ç•¥æ¨¡å¼&lt;/h1&gt;

&lt;p&gt;å®ç°æ–¹å¼ï¼š&lt;/p&gt;

&lt;p&gt;Springæ¡†æ¶çš„èµ„æºè®¿é—®Resourceæ¥å£ã€‚è¯¥æ¥å£æä¾›äº†æ›´å¼ºçš„èµ„æºè®¿é—®èƒ½åŠ›ï¼ŒSpring æ¡†æ¶æœ¬èº«å¤§é‡ä½¿ç”¨äº† Resource æ¥å£æ¥è®¿é—®åº•å±‚èµ„æºã€‚&lt;/p&gt;

&lt;p&gt;Resource æ¥å£ä»‹ç»&lt;/p&gt;

&lt;p&gt;source æ¥å£æ˜¯å…·ä½“èµ„æºè®¿é—®ç­–ç•¥çš„æŠ½è±¡ï¼Œä¹Ÿæ˜¯æ‰€æœ‰èµ„æºè®¿é—®ç±»æ‰€å®ç°çš„æ¥å£ã€‚&lt;/p&gt;

&lt;p&gt;Resource æ¥å£ä¸»è¦æä¾›äº†å¦‚ä¸‹å‡ ä¸ªæ–¹æ³•:
getInputStream()ï¼šå®šä½å¹¶æ‰“å¼€èµ„æºï¼Œè¿”å›èµ„æºå¯¹åº”çš„è¾“å…¥æµã€‚æ¯æ¬¡è°ƒç”¨éƒ½è¿”å›æ–°çš„è¾“å…¥æµã€‚è°ƒç”¨è€…å¿…é¡»è´Ÿè´£å…³é—­è¾“å…¥æµã€‚
exists()ï¼šè¿”å› Resource æ‰€æŒ‡å‘çš„èµ„æºæ˜¯å¦å­˜åœ¨ã€‚
isOpen()ï¼šè¿”å›èµ„æºæ–‡ä»¶æ˜¯å¦æ‰“å¼€ï¼Œå¦‚æœèµ„æºæ–‡ä»¶ä¸èƒ½å¤šæ¬¡è¯»å–ï¼Œæ¯æ¬¡è¯»å–ç»“æŸåº”è¯¥æ˜¾å¼å…³é—­ï¼Œä»¥é˜²æ­¢èµ„æºæ³„æ¼ã€‚
getDescription()ï¼šè¿”å›èµ„æºçš„æè¿°ä¿¡æ¯ï¼Œé€šå¸¸ç”¨äºèµ„æºå¤„ç†å‡ºé”™æ—¶è¾“å‡ºè¯¥ä¿¡æ¯ï¼Œé€šå¸¸æ˜¯å…¨é™å®šæ–‡ä»¶åæˆ–å®é™… URLã€‚
getFileï¼šè¿”å›èµ„æºå¯¹åº”çš„ File å¯¹è±¡ã€‚
getURLï¼šè¿”å›èµ„æºå¯¹åº”çš„ URL å¯¹è±¡ã€‚
æœ€åä¸¤ä¸ªæ–¹æ³•é€šå¸¸æ— é¡»ä½¿ç”¨ï¼Œä»…åœ¨é€šè¿‡ç®€å•æ–¹å¼è®¿é—®æ— æ³•å®ç°æ—¶ï¼ŒResource æä¾›ä¼ ç»Ÿçš„èµ„æºè®¿é—®çš„åŠŸèƒ½ã€‚&lt;/p&gt;

&lt;p&gt;Resource æ¥å£æœ¬èº«æ²¡æœ‰æä¾›è®¿é—®ä»»ä½•åº•å±‚èµ„æºçš„å®ç°é€»è¾‘ï¼Œé’ˆå¯¹ä¸åŒçš„åº•å±‚èµ„æºï¼ŒSpring å°†ä¼šæä¾›ä¸åŒçš„ Resource å®ç°ç±»ï¼Œä¸åŒçš„å®ç°ç±»è´Ÿè´£ä¸åŒçš„èµ„æºè®¿é—®é€»è¾‘ã€‚&lt;/p&gt;

&lt;p&gt;Spring ä¸º Resource æ¥å£æä¾›äº†å¦‚ä¸‹å®ç°ç±»ï¼š
UrlResourceï¼šè®¿é—®ç½‘ç»œèµ„æºçš„å®ç°ç±»ã€‚
ClassPathResourceï¼šè®¿é—®ç±»åŠ è½½è·¯å¾„é‡Œèµ„æºçš„å®ç°ç±»ã€‚
FileSystemResourceï¼šè®¿é—®æ–‡ä»¶ç³»ç»Ÿé‡Œèµ„æºçš„å®ç°ç±»ã€‚
ServletContextResourceï¼šè®¿é—®ç›¸å¯¹äº ServletContext è·¯å¾„é‡Œçš„èµ„æºçš„å®ç°ç±».
InputStreamResourceï¼šè®¿é—®è¾“å…¥æµèµ„æºçš„å®ç°ç±»ã€‚
ByteArrayResourceï¼šè®¿é—®å­—èŠ‚æ•°ç»„èµ„æºçš„å®ç°ç±»ã€‚
è¿™äº› Resource å®ç°ç±»ï¼Œé’ˆå¯¹ä¸åŒçš„çš„åº•å±‚èµ„æºï¼Œæä¾›äº†ç›¸åº”çš„èµ„æºè®¿é—®é€»è¾‘ï¼Œå¹¶æä¾›ä¾¿æ·çš„åŒ…è£…ï¼Œä»¥åˆ©äºå®¢æˆ·ç«¯ç¨‹åºçš„èµ„æºè®¿é—®ã€‚&lt;/p&gt;

&lt;p&gt;æ‰©å±•ï¼šè®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆé¬¼ï¼ˆç­–ç•¥ï¼‰&lt;/p&gt;

&lt;h1 id=&quot;9æ¨¡ç‰ˆæ–¹æ³•æ¨¡å¼&quot;&gt;9.æ¨¡ç‰ˆæ–¹æ³•æ¨¡å¼&lt;/h1&gt;

&lt;p&gt;ç»å…¸æ¨¡æ¿æ–¹æ³•å®šä¹‰ï¼š&lt;/p&gt;

&lt;p&gt;çˆ¶ç±»å®šä¹‰äº†éª¨æ¶ï¼ˆè°ƒç”¨å“ªäº›æ–¹æ³•åŠé¡ºåºï¼‰ï¼ŒæŸäº›ç‰¹å®šæ–¹æ³•ç”±å­ç±»å®ç°ã€‚&lt;/p&gt;

&lt;p&gt;æœ€å¤§çš„å¥½å¤„ï¼šä»£ç å¤ç”¨ï¼Œå‡å°‘é‡å¤ä»£ç ã€‚é™¤äº†å­ç±»è¦å®ç°çš„ç‰¹å®šæ–¹æ³•ï¼Œå…¶ä»–æ–¹æ³•åŠæ–¹æ³•è°ƒç”¨é¡ºåºéƒ½åœ¨çˆ¶ç±»ä¸­é¢„å…ˆå†™å¥½äº†ã€‚&lt;/p&gt;

&lt;p&gt;æ‰€ä»¥çˆ¶ç±»æ¨¡æ¿æ–¹æ³•ä¸­æœ‰ä¸¤ç±»æ–¹æ³•ï¼š&lt;/p&gt;

&lt;p&gt;å…±åŒçš„æ–¹æ³•ï¼šæ‰€æœ‰å­ç±»éƒ½ä¼šç”¨åˆ°çš„ä»£ç &lt;/p&gt;

&lt;p&gt;ä¸åŒçš„æ–¹æ³•ï¼šå­ç±»è¦è¦†ç›–çš„æ–¹æ³•ï¼Œåˆ†ä¸ºä¸¤ç§ï¼š
æŠ½è±¡æ–¹æ³•ï¼šçˆ¶ç±»ä¸­çš„æ˜¯æŠ½è±¡æ–¹æ³•ï¼Œå­ç±»å¿…é¡»è¦†ç›–
é’©å­æ–¹æ³•ï¼šçˆ¶ç±»ä¸­æ˜¯ä¸€ä¸ªç©ºæ–¹æ³•ï¼Œå­ç±»ç»§æ‰¿äº†é»˜è®¤ä¹Ÿæ˜¯ç©ºçš„
æ³¨ï¼šä¸ºä»€ä¹ˆå«é’©å­ï¼Œå­ç±»å¯ä»¥é€šè¿‡è¿™ä¸ªé’©å­ï¼ˆæ–¹æ³•ï¼‰ï¼Œæ§åˆ¶çˆ¶ç±»ï¼Œå› ä¸ºè¿™ä¸ªé’©å­å®é™…æ˜¯çˆ¶ç±»çš„æ–¹æ³•ï¼ˆç©ºæ–¹æ³•ï¼‰ï¼&lt;/p&gt;

&lt;p&gt;Springæ¨¡æ¿æ–¹æ³•æ¨¡å¼å®è´¨ï¼š&lt;/p&gt;

&lt;p&gt;æ˜¯æ¨¡æ¿æ–¹æ³•æ¨¡å¼å’Œå›è°ƒæ¨¡å¼çš„ç»“åˆï¼Œæ˜¯Template Methodä¸éœ€è¦ç»§æ‰¿çš„å¦ä¸€ç§å®ç°æ–¹å¼ã€‚Springå‡ ä¹æ‰€æœ‰çš„å¤–æ¥æ‰©å±•éƒ½é‡‡ç”¨è¿™ç§æ¨¡å¼ã€‚&lt;/p&gt;

&lt;p&gt;æ¨èï¼šè®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆé¬¼ï¼ˆæ¨¡æ¿æ–¹æ³•ï¼‰&lt;/p&gt;

&lt;p&gt;å…·ä½“å®ç°ï¼š&lt;/p&gt;

&lt;p&gt;JDBCçš„æŠ½è±¡å’Œå¯¹Hibernateçš„é›†æˆï¼Œéƒ½é‡‡ç”¨äº†ä¸€ç§ç†å¿µæˆ–è€…å¤„ç†æ–¹å¼ï¼Œé‚£å°±æ˜¯æ¨¡æ¿æ–¹æ³•æ¨¡å¼ä¸ç›¸åº”çš„Callbackæ¥å£ç›¸ç»“åˆã€‚&lt;/p&gt;

&lt;p&gt;é‡‡ç”¨æ¨¡æ¿æ–¹æ³•æ¨¡å¼æ˜¯ä¸ºäº†ä»¥ä¸€ç§ç»Ÿä¸€è€Œé›†ä¸­çš„æ–¹å¼æ¥å¤„ç†èµ„æºçš„è·å–å’Œé‡Šæ”¾ï¼Œä»¥JdbcTempalteä¸ºä¾‹:&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;abstract&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;JdbcTemplate&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;  
&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Object&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;execute&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ï¼ˆ&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sql&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ï¼‰&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;  
        &lt;span class=&quot;n&quot;&gt;Connection&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;con&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;  
        &lt;span class=&quot;n&quot;&gt;Statement&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;stmt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;  
&lt;span class=&quot;k&quot;&gt;try&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;  
            &lt;span class=&quot;n&quot;&gt;con&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;getConnection&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ï¼ˆï¼‰&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;  
            &lt;span class=&quot;n&quot;&gt;stmt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;con&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;createStatement&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ï¼ˆï¼‰&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;  
&lt;span class=&quot;n&quot;&gt;Object&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;retValue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;executeWithStatement&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ï¼ˆ&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;stmt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sql&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ï¼‰&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;  
&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;retValue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;  
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;catch&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ï¼ˆ&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;SQLException&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ï¼‰&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;  
             &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;  
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;finally&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;  
            &lt;span class=&quot;n&quot;&gt;closeStatement&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ï¼ˆ&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;stmt&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ï¼‰&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;  
            &lt;span class=&quot;n&quot;&gt;releaseConnection&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ï¼ˆ&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;con&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ï¼‰&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;  
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;  
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;   
&lt;span class=&quot;kd&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;abstract&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Object&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;executeWithStatement&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ï¼ˆ&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Statement&lt;/span&gt;   &lt;span class=&quot;n&quot;&gt;stmt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sql&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ï¼‰&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;  
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;  
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;å¼•å…¥å›è°ƒåŸå› ï¼š&lt;/p&gt;

&lt;p&gt;JdbcTemplateæ˜¯æŠ½è±¡ç±»ï¼Œä¸èƒ½å¤Ÿç‹¬ç«‹ä½¿ç”¨ï¼Œæˆ‘ä»¬æ¯æ¬¡è¿›è¡Œæ•°æ®è®¿é—®çš„æ—¶å€™éƒ½è¦ç»™å‡ºä¸€ä¸ªç›¸åº”çš„å­ç±»å®ç°,è¿™æ ·è‚¯å®šä¸æ–¹ä¾¿ï¼Œæ‰€ä»¥å°±å¼•å…¥äº†å›è°ƒã€‚&lt;/p&gt;

&lt;p&gt;å›è°ƒä»£ç 
publicinterfaceStatementCallback{&lt;br /&gt;
Object doWithStatementï¼ˆStatement stmtï¼‰;&lt;br /&gt;
} &lt;br /&gt;
åˆ©ç”¨å›è°ƒæ–¹æ³•é‡å†™JdbcTemplateæ–¹æ³•&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;JdbcTemplate&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;  
&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Object&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;execute&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ï¼ˆ&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;StatementCallback&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;callback&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ï¼‰&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;  
        &lt;span class=&quot;n&quot;&gt;Connection&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;con&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;  
        &lt;span class=&quot;n&quot;&gt;Statement&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;stmt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;  
&lt;span class=&quot;k&quot;&gt;try&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;  
            &lt;span class=&quot;n&quot;&gt;con&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;getConnection&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ï¼ˆï¼‰&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;  
            &lt;span class=&quot;n&quot;&gt;stmt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;con&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;createStatement&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ï¼ˆï¼‰&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;  
&lt;span class=&quot;n&quot;&gt;Object&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;retValue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;callback&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;doWithStatement&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ï¼ˆ&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;stmt&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ï¼‰&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;  
&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;retValue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;  
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;catch&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ï¼ˆ&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;SQLException&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ï¼‰&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;  
            &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;  
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;finally&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;  
            &lt;span class=&quot;n&quot;&gt;closeStatement&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ï¼ˆ&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;stmt&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ï¼‰&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;  
            &lt;span class=&quot;n&quot;&gt;releaseConnection&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ï¼ˆ&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;con&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ï¼‰&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;  
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;  
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;  
    &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;//å…¶å®ƒæ–¹æ³•å®šä¹‰  &lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;   

&lt;span class=&quot;n&quot;&gt;Jdbc&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;JdbcTemplate&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;jdbcTemplate&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=...;&lt;/span&gt;  
&lt;span class=&quot;n&quot;&gt;finalString&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sql&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=...;&lt;/span&gt;  
    &lt;span class=&quot;n&quot;&gt;StatementCallback&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;callback&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;StatementCallback&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(){&lt;/span&gt;  
&lt;span class=&quot;n&quot;&gt;publicObject&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;doWithStatement&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Statement&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;stmt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;){&lt;/span&gt;  
&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...;&lt;/span&gt;  
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;  
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;    
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;jdbcTemplate.execute(callback);&lt;/p&gt;

&lt;p&gt;ä¸ºä»€ä¹ˆJdbcTemplateæ²¡æœ‰ä½¿ç”¨ç»§æ‰¿ï¼Ÿ&lt;/p&gt;

&lt;p&gt;å› ä¸ºè¿™ä¸ªç±»çš„æ–¹æ³•å¤ªå¤šï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯æƒ³ç”¨åˆ°JdbcTemplateå·²æœ‰çš„ç¨³å®šçš„ã€å…¬ç”¨çš„æ•°æ®åº“è¿æ¥ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ€ä¹ˆåŠå‘¢ï¼Ÿ&lt;/p&gt;

&lt;p&gt;æˆ‘ä»¬å¯ä»¥æŠŠå˜åŒ–çš„ä¸œè¥¿æŠ½å‡ºæ¥ä½œä¸ºä¸€ä¸ªå‚æ•°ä¼ å…¥JdbcTemplateçš„æ–¹æ³•ä¸­ã€‚ä½†æ˜¯å˜åŒ–çš„ä¸œè¥¿æ˜¯ä¸€æ®µä»£ç ï¼Œè€Œä¸”è¿™æ®µä»£ç ä¼šç”¨åˆ°JdbcTemplateä¸­çš„å˜é‡ã€‚æ€ä¹ˆåŠï¼Ÿ&lt;/p&gt;

&lt;p&gt;é‚£æˆ‘ä»¬å°±ç”¨å›è°ƒå¯¹è±¡å§ã€‚åœ¨è¿™ä¸ªå›è°ƒå¯¹è±¡ä¸­å®šä¹‰ä¸€ä¸ªæ“çºµJdbcTemplateä¸­å˜é‡çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å»å®ç°è¿™ä¸ªæ–¹æ³•ï¼Œå°±æŠŠå˜åŒ–çš„ä¸œè¥¿é›†ä¸­åˆ°è¿™é‡Œäº†ã€‚ç„¶åæˆ‘ä»¬å†ä¼ å…¥è¿™ä¸ªå›è°ƒå¯¹è±¡åˆ°JdbcTemplateï¼Œä»è€Œå®Œæˆäº†è°ƒç”¨ã€‚&lt;/p&gt;

&lt;h1 id=&quot;10è´£ä»»é“¾æ¨¡å¼&quot;&gt;10.è´£ä»»é“¾æ¨¡å¼&lt;/h1&gt;

&lt;p&gt;CglibAopProxyç±»ç¬¬688è¡Œï¼š
new CglibMethodInvocation(proxy, target, method, args, targetClass, chain, methodProxy).proceed();&lt;/p&gt;

&lt;p&gt;å‚æ•° chain:æ‹¦æˆªå™¨é“¾ï¼Œä¿å«äº†ç›®æ ‡æ–¹æ³•çš„æ‰€æœ‰åˆ‡é¢æ–¹æ³• ï¼Œä»chainé‡Œé¢çš„æ•°ç»„å…ƒç´ çš„é¡ºåºæ¥çœ‹ï¼Œæ‹¦æˆªå™¨çš„é¡ºåºbeforeä¸å†afterå‰é¢æ‰§è¡Œ
 æ¯ä¸€ä¸ª  **Interceptoræœ‰ä¸€ä¸ªinvoke()æ–¹æ³•
Interceptoræ˜¯ä¸€ä¸ªç©ºæ¥å£  MethodInterceptor extends Interceptor  ï¼Œä»¥ä¸‹æ˜¯Interceptorçš„ç»§æ‰¿ç»“æ„ï¼š&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Advice&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;

&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Interceptor&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Advice&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;

&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;MethodInterceptor&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Interceptor&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Object&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;invoke&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;MethodInvocation&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;invocation&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Throwable&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;


&lt;span class=&quot;n&quot;&gt;Object&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;invoke&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;MethodInvocation&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;invocation&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Throwable&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ï¼›æ–¹æ³•ï¼š&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;å‚æ•°&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;ï¼š&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;MethodInvocation&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;ç±»ä¸­æœ‰&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;proceed&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;æ–¹æ³•ï¼Œä»¥ä¸‹æ˜¯&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;MethodInvocation&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;çš„ç»§æ‰¿ç»“æ„ï¼š&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Joinpoint&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;Object&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;proceed&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Throwable&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;Object&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;getThis&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;AccessibleObject&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;getStaticPart&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Invocation&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Joinpoint&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Object&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;getArguments&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;MethodInvocation&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Invocation&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Method&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;getMethod&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;


&lt;span class=&quot;n&quot;&gt;MethodInvocation&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Invocation&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;JoinPoint&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;proceed&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;æ–¹æ³•æ—¶&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;JoinPoint&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;æ¥å£å£°æ˜çš„&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;ç„¶å
ReflectiveMethodInvocation implements ProxyMethodInvocation ,ProxyMethodInvocation extends MethodInvocation
springçš„æ‹¦æˆªå™¨ xxxInterceptoréƒ½å®ç°äº†è‡ªå·±çš„ Object invoke(MethodInvocation invocation)æ–¹æ³•&lt;/p&gt;

&lt;p&gt;ReflectiveMethodInvocationç±»ä¸­çš„ proceed()æ–¹æ³•ä¼šéå†æ‹¦æˆªå™¨é“¾ï¼Œè°ƒç”¨æ¯ä¸ªæ‹¦æˆªå™¨çš„invokeæ–¹æ³•ï¼Œä¼ å…¥ReflectiveMethodInvocationè‡ªèº«ä½œä¸ºå‚æ•°ï¼Œ&lt;/p&gt;

&lt;p&gt;æ¯ä¸ªæ‹¦æˆªå™¨çš„invokeæ–¹æ³•åšä¸¤ä»¶äº‹(è¿™ä¸¤ä»¶äº‹çš„æ‰§è¡Œé¡ºåºå› æ‹¦æˆªå™¨çš„åŠŸèƒ½è€Œå¼‚)ï¼š1.æ‰§è¡Œè‡ªå·±çš„ä¸šåŠ¡é€»è¾‘ 2.æ‰§è¡ŒReflectiveMethodInvocationçš„proceed()ï¼šè¿™æ ·å°±å®ç°äº†é“¾å¼è°ƒç”¨&lt;/p&gt;

&lt;p&gt;è¿™å°±æ˜¯è´£ä»»é“¾æ¨¡å¼ï¼š
   ç»Ÿä¸€çš„ä¸šåŠ¡æ¥å£ï¼šHandleræ¥å£ ä¸­çš„æ–¹æ³•invoke(),å³ä¸šåŠ¡æ–¹æ³•
   è´£ä»»é“¾ç›¸å½“äºä¸€ä¸ªè´Ÿè´£äººé›†åˆï¼Œæ¯ä¸€ä¸ªè´Ÿè´£äººéƒ½å®ç°äº†è‡ªå·±çš„invoke()æ–¹æ³•æ¥å¤„ç†ä¼ è¿›æ¥çš„æ•°æ®æˆ–å¯¹è±¡æˆ–å¯¹è±¡çš„æŒ‡å®šæ–¹æ³•
   å¦‚ä½•é€šçŸ¥ä¸‹ä¸€ä¸ªè´Ÿè´£äººå¤„ç†ä¸šåŠ¡ï¼š
      æ–¹æ³•1ï¼šè®¾è®¡ä¸€ä¸ªè´£ä»»é“¾æ‰§è¡Œå™¨ï¼ŒåŒ…å«è´£ä»»é“¾é›†åˆã€‚è´£ä»»é“¾æ‰§è¡Œå™¨ä¸­æœ‰ä¸€ä¸ªproceed(),æ–¹æ³•å†…éå†æ‰§è¡Œè´Ÿè´£äººçš„invoke()æ–¹æ³•ï¼Œinvokeæ–¹æ³•ä»¥æ‰§è¡Œå™¨ä½œä¸ºå‚æ•°ï¼š
            invoke(æ‰§è¡Œå™¨)ï¼Œinvoke(æ‰§è¡Œå™¨)å¤„ç†å®Œä¸šåŠ¡åï¼Œæ‰§è¡Œå™¨åˆè°ƒç”¨proceed()æ–¹æ³•ï¼Œå°†ç´¢å¼•ç§»åˆ°ä¸‹ä¸€ä¸ªè´Ÿè´£äººä½ç½®ã€‚
            è¿™æ ·ï¼šæ‰§è¡Œå™¨å’Œè´Ÿè´£äººçš„æ–¹æ³•ç›¸äº’è°ƒç”¨ï¼Œè€Œæ‰§è¡Œå™¨é€šè¿‡ç§»åŠ¨ç´¢å¼•é€šçŸ¥ä¸‹ä¸€ä¸ªè´Ÿè´£äººå¤„ç†ä¸šåŠ¡ã€‚
      æ–¹æ³•2ï¼šåŸºäºé“¾è¡¨çš„è´£ä»»é“¾ï¼Œæ¯ä¸€ä¸ªè´Ÿè´£äººæ˜¯ä¸€ä¸ªè´£ä»»èŠ‚ç‚¹Nodeï¼ŒåŒ…å«æŒ‡å‘ä¸‹ä¸€ä¸ªè´Ÿè´£äººçš„nextå¼•ç”¨
            è´Ÿè´£äººçš„å¤„ç†ä¸šåŠ¡çš„æ–¹æ³• invoke()è¿™æ—¶ä¸å¸¦å‚æ•°ï¼Œinvoke()æ–¹æ³•é‡Œé¢é€’å½’è°ƒç”¨invoke()æ–¹æ³•ï¼Œå¹¶è®¾ç½®å‡ºå£æ¡ä»¶ã€‚
            å¦‚ä½•é€šçŸ¥ä¸‹ä¸€ä¸ªè´Ÿè´£äººå¤„ç†ä¸šåŠ¡ï¼šinvoke()æ–¹æ³•ï¼š1.å¤„ç†ä¸šåŠ¡ï¼Œ2.next.invoke()ï¼Œ3.å‡ºå£æ¡ä»¶å¯ä»¥æ˜¯next!=null&lt;/p&gt;</content><author><name>WenHao</name></author><summary type="html">1.ç®€å•å·¥å‚</summary></entry><entry><title type="html">å¹¶å‘ç¼–ç¨‹(åä¸‰)-æ— é”å¹¶å‘æ¡†æ¶-Disruptor</title><link href="http://localhost:4000/2020/07/13/Disruptor/" rel="alternate" type="text/html" title="å¹¶å‘ç¼–ç¨‹(åä¸‰)-æ— é”å¹¶å‘æ¡†æ¶-Disruptor" /><published>2020-07-13T00:00:00+08:00</published><updated>2020-07-13T00:00:00+08:00</updated><id>http://localhost:4000/2020/07/13/Disruptor</id><content type="html" xml:base="http://localhost:4000/2020/07/13/Disruptor/">&lt;h1 id=&quot;è®¤è¯†disruptor&quot;&gt;è®¤è¯†Disruptor&lt;/h1&gt;

&lt;p&gt;Disruptoræ˜¯ä¸€ä¸ªå¼€æºæ¡†æ¶ï¼Œç ”å‘çš„åˆè¡·æ˜¯ä¸ºäº†è§£å†³é«˜å¹¶å‘ä¸‹åˆ—é˜Ÿé”çš„é—®é¢˜ï¼Œæœ€æ—©ç”±LMAXï¼ˆä¸€ç§æ–°å‹é›¶å”®é‡‘èäº¤æ˜“å¹³å°ï¼‰æå‡ºå¹¶ä½¿ç”¨ï¼Œèƒ½å¤Ÿåœ¨æ— é”çš„æƒ…å†µä¸‹å®ç°é˜Ÿåˆ—çš„å¹¶å‘æ“ä½œï¼Œå¹¶å·ç§°èƒ½å¤Ÿåœ¨ä¸€ä¸ªçº¿ç¨‹é‡Œæ¯ç§’å¤„ç†6ç™¾ä¸‡ç¬”è®¢å•(è¿™ä¸ªçœŸå‡å°±ä¸æ¸…æ¥šäº†ï¼ç‰›çš®è°éƒ½ä¼šå¹)ã€‚
æ¡†æ¶æœ€ç»å…¸ä¹Ÿæ˜¯æœ€å¤šçš„åº”ç”¨åœºæ™¯ï¼šç”Ÿäº§æ¶ˆè´¹ã€‚
è®²åˆ°ç”Ÿäº§æ¶ˆè´¹æ¨¡å‹ï¼Œå¤§å®¶åº”è¯¥é©¬ä¸Šå°±èƒ½å›å¿†èµ·å‰é¢æˆ‘ä»¬å·²ç»å­¦ä¹ è¿‡çš„BlockingQueueè¯¾ç¨‹ï¼Œé‡Œé¢æˆ‘ä»¬å­¦ä¹ è¿‡å¤šç§é˜Ÿåˆ—ï¼Œä½†æ˜¯è¿™äº›é˜Ÿåˆ—å¤§å¤šæ˜¯åŸºäºæ¡ä»¶é˜»å¡æ–¹å¼çš„ï¼Œæ€§èƒ½è¿˜ä¸å¤Ÿä¼˜ç§€ï¼
ArrayBlockingQueueï¼šåŸºäºæ•°ç»„å½¢å¼çš„é˜Ÿåˆ—ï¼Œé€šè¿‡åŠ é”çš„æ–¹å¼ï¼Œæ¥ä¿è¯å¤šçº¿ç¨‹æƒ…å†µä¸‹æ•°æ®çš„å®‰å…¨ï¼›
LinkedBlockingQueueï¼šåŸºäºé“¾è¡¨å½¢å¼çš„é˜Ÿåˆ—ï¼Œä¹Ÿé€šè¿‡åŠ é”çš„æ–¹å¼ï¼Œæ¥ä¿è¯å¤šçº¿ç¨‹æƒ…å†µä¸‹æ•°æ®çš„å®‰å…¨ï¼›
ConcurrentLinkedQueueï¼šåŸºäºé“¾è¡¨å½¢å¼çš„é˜Ÿåˆ—ï¼Œé€šè¿‡compare and swap(ç®€ç§°CAS)åè®®çš„æ–¹å¼ï¼Œ
æ¥ä¿è¯å¤šçº¿ç¨‹æƒ…å†µä¸‹æ•°æ®çš„å®‰å…¨ï¼Œä¸åŠ é”ï¼Œä¸»è¦ä½¿ç”¨äº†Javaä¸­çš„sun.misc.Unsafeç±»æ¥å®ç°ï¼›&lt;/p&gt;

&lt;h2 id=&quot;æ ¸å¿ƒè®¾è®¡åŸç†&quot;&gt;æ ¸å¿ƒè®¾è®¡åŸç†&lt;/h2&gt;

&lt;p&gt;Disruptoré€šè¿‡ä»¥ä¸‹è®¾è®¡æ¥è§£å†³é˜Ÿåˆ—é€Ÿåº¦æ…¢çš„é—®é¢˜ï¼š
ç¯å½¢æ•°ç»„ç»“æ„ï¼š
ä¸ºäº†é¿å…åƒåœ¾å›æ”¶ï¼Œé‡‡ç”¨æ•°ç»„è€Œéé“¾è¡¨ã€‚åŒæ—¶ï¼Œæ•°ç»„å¯¹å¤„ç†å™¨çš„ç¼“å­˜æœºåˆ¶æ›´åŠ å‹å¥½ï¼ˆå›é¡¾ä¸€ä¸‹ï¼šCPUåŠ è½½ç©ºé—´å±€éƒ¨æ€§åŸåˆ™ï¼‰ã€‚
å…ƒç´ ä½ç½®å®šä½ï¼š
æ•°ç»„é•¿åº¦2^nï¼Œé€šè¿‡ä½è¿ç®—ï¼ŒåŠ å¿«å®šä½çš„é€Ÿåº¦ã€‚ä¸‹æ ‡é‡‡å–é€’å¢çš„å½¢å¼ã€‚ä¸ç”¨æ‹…å¿ƒindexæº¢å‡ºçš„é—®é¢˜ã€‚indexæ˜¯longç±»å‹ï¼Œå³ä½¿100ä¸‡QPSçš„å¤„ç†é€Ÿåº¦ï¼Œä¹Ÿéœ€è¦30ä¸‡å¹´æ‰èƒ½ç”¨å®Œã€‚
æ— é”è®¾è®¡ï¼š
æ¯ä¸ªç”Ÿäº§è€…æˆ–è€…æ¶ˆè´¹è€…çº¿ç¨‹ï¼Œä¼šå…ˆç”³è¯·å¯ä»¥æ“ä½œçš„å…ƒç´ åœ¨æ•°ç»„ä¸­çš„ä½ç½®ï¼Œç”³è¯·åˆ°ä¹‹åï¼Œç›´æ¥åœ¨è¯¥ä½ç½®å†™å…¥æˆ–è€…è¯»å–æ•°æ®ã€‚&lt;/p&gt;

&lt;h2 id=&quot;æ•°æ®ç»“æ„&quot;&gt;æ•°æ®ç»“æ„&lt;/h2&gt;

&lt;p&gt;æ¡†æ¶ä½¿ç”¨RingBufferæ¥ä½œä¸ºé˜Ÿåˆ—çš„æ•°æ®ç»“æ„ï¼ŒRingBufferå°±æ˜¯ä¸€ä¸ªå¯è‡ªå®šä¹‰å¤§å°çš„ç¯å½¢æ•°ç»„ã€‚é™¤æ•°ç»„å¤–è¿˜æœ‰ä¸€ä¸ªåºåˆ—å·(sequence)ï¼Œç”¨ä»¥æŒ‡å‘ä¸‹ä¸€ä¸ªå¯ç”¨çš„å…ƒç´ ï¼Œä¾›ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…ä½¿ç”¨ã€‚åŸç†å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š&lt;/p&gt;

&lt;p&gt;Sequence
markï¼šDisruptoré€šè¿‡é¡ºåºé€’å¢çš„åºå·æ¥ç¼–å·ç®¡ç†é€šè¿‡å…¶è¿›è¡Œäº¤æ¢çš„æ•°æ®ï¼ˆäº‹ä»¶ï¼‰ï¼Œå¯¹æ•°æ®(äº‹ä»¶)çš„å¤„ç†è¿‡ç¨‹æ€»æ˜¯æ²¿ç€åºå·é€ä¸ªé€’å¢å¤„ç†ã€‚
æ•°ç»„+åºåˆ—å·è®¾è®¡çš„ä¼˜åŠ¿æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ
å›é¡¾ä¸€ä¸‹æˆ‘ä»¬è®²HashMapæ—¶ï¼Œåœ¨çŸ¥é“ç´¢å¼•(index)ä¸‹æ ‡çš„æƒ…å†µä¸‹ï¼Œå­˜ä¸å–æ•°ç»„ä¸Šçš„å…ƒç´ æ—¶é—´å¤æ‚åº¦åªæœ‰O(1)ï¼Œè€Œè¿™ä¸ªindexæˆ‘ä»¬å¯ä»¥é€šè¿‡åºåˆ—å·ä¸æ•°ç»„çš„é•¿åº¦å–æ¨¡æ¥è®¡ç®—å¾—å‡ºï¼Œindex=sequence % table.lengthã€‚å½“ç„¶ä¹Ÿå¯ä»¥ç”¨ä½è¿ç®—æ¥è®¡ç®—æ•ˆç‡æ›´é«˜ï¼Œæ­¤æ—¶table.lengthå¿…é¡»æ˜¯2çš„å¹‚æ¬¡æ–¹(åŸç†å‰é¢è®²è¿‡)ã€‚&lt;/p&gt;

&lt;h2 id=&quot;æ¦‚å¿µä¸ä½œç”¨&quot;&gt;æ¦‚å¿µä¸ä½œç”¨&lt;/h2&gt;

&lt;p&gt;RingBufferâ€”â€”Disruptoråº•å±‚æ•°æ®ç»“æ„å®ç°ï¼Œæ ¸å¿ƒç±»ï¼Œæ˜¯çº¿ç¨‹é—´äº¤æ¢æ•°æ®çš„ä¸­è½¬åœ°ï¼›
Sequencerâ€”â€”åºå·ç®¡ç†å™¨ï¼Œç”Ÿäº§åŒæ­¥çš„å®ç°è€…ï¼Œè´Ÿè´£æ¶ˆè´¹è€…/ç”Ÿäº§è€…å„è‡ªåºå·ã€åºå·æ …æ çš„ç®¡ç†å’Œåè°ƒ,Sequenceræœ‰å•ç”Ÿäº§è€…,å¤šç”Ÿäº§è€…ä¸¤ç§ä¸åŒçš„æ¨¡å¼,é‡Œé¢å®ç°äº†å„ç§åŒæ­¥çš„ç®—æ³•ï¼›
Sequenceâ€”â€”åºå·ï¼Œå£°æ˜ä¸€ä¸ªåºå·ï¼Œç”¨äºè·Ÿè¸ªringbufferä¸­ä»»åŠ¡çš„å˜åŒ–å’Œæ¶ˆè´¹è€…çš„æ¶ˆè´¹æƒ…å†µï¼Œdisruptoré‡Œé¢å¤§éƒ¨åˆ†çš„å¹¶å‘ä»£ç éƒ½æ˜¯é€šè¿‡å¯¹Sequenceçš„å€¼åŒæ­¥ä¿®æ”¹å®ç°çš„,è€Œéé”,è¿™æ˜¯disruptoré«˜æ€§èƒ½çš„ä¸€ä¸ªä¸»è¦åŸå› ï¼›
SequenceBarrierâ€”â€”åºå·æ …æ ï¼Œç®¡ç†å’Œåè°ƒç”Ÿäº§è€…çš„æ¸¸æ ‡åºå·å’Œå„ä¸ªæ¶ˆè´¹è€…çš„åºå·ï¼Œç¡®ä¿ç”Ÿäº§è€…ä¸ä¼šè¦†ç›–æ¶ˆè´¹è€…æœªæ¥å¾—åŠå¤„ç†çš„æ¶ˆæ¯ï¼Œç¡®ä¿å­˜åœ¨ä¾èµ–çš„æ¶ˆè´¹è€…ä¹‹é—´èƒ½å¤ŸæŒ‰ç…§æ­£ç¡®çš„é¡ºåºå¤„ç†ï¼Œ Sequence Barrieræ˜¯ç”±Sequenceråˆ›å»ºçš„,å¹¶è¢«ProcessoræŒæœ‰ï¼›
EventProcessorâ€”â€”äº‹ä»¶å¤„ç†å™¨ï¼Œç›‘å¬RingBufferçš„äº‹ä»¶ï¼Œå¹¶æ¶ˆè´¹å¯ç”¨äº‹ä»¶ï¼Œä»RingBufferè¯»å–çš„äº‹ä»¶ä¼šäº¤ç”±å®é™…çš„ç”Ÿäº§è€…å®ç°ç±»æ¥æ¶ˆè´¹ï¼›å®ƒä¼šä¸€ç›´ä¾¦å¬ä¸‹ä¸€ä¸ªå¯ç”¨çš„åºå·ï¼Œç›´åˆ°è¯¥åºå·å¯¹åº”çš„äº‹ä»¶å·²ç»å‡†å¤‡å¥½ã€‚
EventHandlerâ€”â€”ä¸šåŠ¡å¤„ç†å™¨ï¼Œæ˜¯å®é™…æ¶ˆè´¹è€…çš„æ¥å£ï¼Œå®Œæˆå…·ä½“çš„ä¸šåŠ¡é€»è¾‘å®ç°ï¼Œç¬¬ä¸‰æ–¹å®ç°è¯¥æ¥å£ï¼›ä»£è¡¨ç€æ¶ˆè´¹è€…ã€‚
Producerâ€”â€”ç”Ÿäº§è€…æ¥å£ï¼Œç¬¬ä¸‰æ–¹çº¿ç¨‹å……å½“è¯¥è§’è‰²ï¼Œproducerå‘RingBufferå†™å…¥äº‹ä»¶ã€‚
Wait Strategyï¼šWait Strategyå†³å®šäº†ä¸€ä¸ªæ¶ˆè´¹è€…æ€ä¹ˆç­‰å¾…ç”Ÿäº§è€…å°†äº‹ä»¶ï¼ˆEventï¼‰æ”¾å…¥Disruptorä¸­ã€‚&lt;/p&gt;

&lt;h2 id=&quot;ç­‰å¾…ç­–ç•¥&quot;&gt;ç­‰å¾…ç­–ç•¥&lt;/h2&gt;

&lt;h3 id=&quot;blockingwaitstrategy&quot;&gt;BlockingWaitStrategy&lt;/h3&gt;

&lt;p&gt;Disruptorçš„é»˜è®¤ç­–ç•¥æ˜¯BlockingWaitStrategyã€‚åœ¨BlockingWaitStrategyå†…éƒ¨æ˜¯ä½¿ç”¨é”å’Œconditionæ¥æ§åˆ¶çº¿ç¨‹çš„å”¤é†’ã€‚BlockingWaitStrategyæ˜¯æœ€ä½æ•ˆçš„ç­–ç•¥ï¼Œä½†å…¶å¯¹CPUçš„æ¶ˆè€—æœ€å°å¹¶ä¸”åœ¨å„ç§ä¸åŒéƒ¨ç½²ç¯å¢ƒä¸­èƒ½æä¾›æ›´åŠ ä¸€è‡´çš„æ€§èƒ½è¡¨ç°ã€‚&lt;/p&gt;

&lt;h3 id=&quot;sleepingwaitstrategy&quot;&gt;SleepingWaitStrategy&lt;/h3&gt;

&lt;p&gt;SleepingWaitStrategy çš„æ€§èƒ½è¡¨ç°è·Ÿ BlockingWaitStrategy å·®ä¸å¤šï¼Œå¯¹ CPU çš„æ¶ˆè€—ä¹Ÿç±»ä¼¼ï¼Œä½†å…¶å¯¹ç”Ÿäº§è€…çº¿ç¨‹çš„å½±å“æœ€å°ï¼Œé€šè¿‡ä½¿ç”¨LockSupport.parkNanos(1)æ¥å®ç°å¾ªç¯ç­‰å¾…ã€‚ä¸€èˆ¬æ¥è¯´Linuxç³»ç»Ÿä¼šæš‚åœä¸€ä¸ªçº¿ç¨‹çº¦60Âµsï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œç”Ÿäº§çº¿ç¨‹ä¸éœ€è¦é‡‡å–ä»»ä½•å…¶ä»–è¡ŒåŠ¨å°±å¯ä»¥å¢åŠ é€‚å½“çš„è®¡æ•°å™¨ï¼Œä¹Ÿä¸éœ€è¦èŠ±è´¹æ—¶é—´ä¿¡å·é€šçŸ¥æ¡ä»¶å˜é‡ã€‚ä½†æ˜¯ï¼Œåœ¨ç”Ÿäº§è€…çº¿ç¨‹å’Œä½¿ç”¨è€…çº¿ç¨‹ä¹‹é—´ç§»åŠ¨äº‹ä»¶çš„å¹³å‡å»¶è¿Ÿä¼šæ›´é«˜ã€‚å®ƒåœ¨ä¸éœ€è¦ä½å»¶è¿Ÿå¹¶ä¸”å¯¹ç”Ÿäº§çº¿ç¨‹çš„å½±å“è¾ƒå°çš„æƒ…å†µæœ€å¥½ã€‚ä¸€ä¸ªå¸¸è§çš„ç”¨ä¾‹æ˜¯å¼‚æ­¥æ—¥å¿—è®°å½•ã€‚&lt;/p&gt;

&lt;h3 id=&quot;yieldingwaitstrategy&quot;&gt;YieldingWaitStrategy&lt;/h3&gt;

&lt;p&gt;YieldingWaitStrategyæ˜¯å¯ä»¥ä½¿ç”¨åœ¨ä½å»¶è¿Ÿç³»ç»Ÿçš„ç­–ç•¥ä¹‹ä¸€ã€‚YieldingWaitStrategyå°†è‡ªæ—‹ä»¥ç­‰å¾…åºåˆ—å¢åŠ åˆ°é€‚å½“çš„å€¼ã€‚åœ¨å¾ªç¯ä½“å†…ï¼Œå°†è°ƒç”¨Thread.yieldï¼ˆï¼‰ï¼Œä»¥å…è®¸å…¶ä»–æ’é˜Ÿçš„çº¿ç¨‹è¿è¡Œã€‚åœ¨è¦æ±‚æé«˜æ€§èƒ½ä¸”äº‹ä»¶å¤„ç†çº¿æ•°å°äº CPU é€»è¾‘æ ¸å¿ƒæ•°çš„åœºæ™¯ä¸­ï¼Œæ¨èä½¿ç”¨æ­¤ç­–ç•¥ï¼›ä¾‹å¦‚ï¼ŒCPUå¼€å¯è¶…çº¿ç¨‹çš„ç‰¹æ€§ã€‚&lt;/p&gt;

&lt;h3 id=&quot;busyspinwaitstrategy&quot;&gt;BusySpinWaitStrategy&lt;/h3&gt;

&lt;p&gt;æ€§èƒ½æœ€å¥½ï¼Œé€‚åˆç”¨äºä½å»¶è¿Ÿçš„ç³»ç»Ÿã€‚åœ¨è¦æ±‚æé«˜æ€§èƒ½ä¸”äº‹ä»¶å¤„ç†çº¿ç¨‹æ•°å°äºCPUé€»è¾‘æ ¸å¿ƒæ•°çš„åœºæ™¯ä¸­ï¼Œæ¨èä½¿ç”¨æ­¤ç­–ç•¥ï¼›ä¾‹å¦‚ï¼ŒCPUå¼€å¯è¶…çº¿ç¨‹çš„ç‰¹æ€§ã€‚&lt;/p&gt;

&lt;h3 id=&quot;phasedbackoffwaitstrategy&quot;&gt;PhasedBackoffWaitStrategy&lt;/h3&gt;

&lt;p&gt;è‡ªæ—‹ + yield + è‡ªå®šä¹‰ç­–ç•¥ï¼ŒCPUèµ„æºç´§ç¼ºï¼Œååé‡å’Œå»¶è¿Ÿå¹¶ä¸é‡è¦çš„åœºæ™¯ã€‚&lt;/p&gt;

&lt;h2 id=&quot;å†™æ•°æ®&quot;&gt;å†™æ•°æ®&lt;/h2&gt;

&lt;p&gt;å•çº¿ç¨‹å†™æ•°æ®çš„æµç¨‹ï¼š
ç”³è¯·å†™å…¥mä¸ªå…ƒç´ ï¼›
è‹¥æ˜¯æœ‰mä¸ªå…ƒç´ å¯ä»¥å…¥ï¼Œåˆ™è¿”å›æœ€å¤§çš„åºåˆ—å·ã€‚è¿™å„¿ä¸»è¦åˆ¤æ–­æ˜¯å¦ä¼šè¦†ç›–æœªè¯»çš„å…ƒç´ ï¼›
è‹¥æ˜¯è¿”å›çš„æ­£ç¡®ï¼Œåˆ™ç”Ÿäº§è€…å¼€å§‹å†™å…¥å…ƒç´ ã€‚&lt;/p&gt;

&lt;h1 id=&quot;æ¡†æ¶çš„ä½¿ç”¨&quot;&gt;æ¡†æ¶çš„ä½¿ç”¨&lt;/h1&gt;

&lt;h2 id=&quot;ç”Ÿäº§æ¶ˆè´¹æ¨¡å‹çš„åº”ç”¨&quot;&gt;ç”Ÿäº§æ¶ˆè´¹æ¨¡å‹çš„åº”ç”¨&lt;/h2&gt;

&lt;p&gt;1ã€å¼•å…¥ä¾èµ–&lt;/p&gt;
&lt;dependencies&gt;
   &lt;dependency&gt;
      &lt;groupId&gt;com.lmax&lt;/groupId&gt;
      &lt;artifactId&gt;disruptor&lt;/artifactId&gt;
      &lt;version&gt;3.2.1&lt;/version&gt;
   &lt;/dependency&gt;
&lt;/dependencies&gt;

&lt;p&gt;2ã€å®šä¹‰Event
//å®šä¹‰äº‹ä»¶event  é€šè¿‡Disruptor è¿›è¡Œäº¤æ¢çš„æ•°æ®ç±»å‹ã€‚
public class LongEvent {&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;private Long value;

public Long getValue() {
    return value;
}

public void setValue(Long value) {
    this.value = value;
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;}&lt;/p&gt;

&lt;p&gt;3ã€å®šä¹‰EventFactory
æˆ‘ä»¬éœ€è¦Disruptorä¸ºæˆ‘ä»¬åˆ›å»ºEventï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦å®šä¹‰äº‹ä»¶å·¥å‚ï¼Œå®ç°æ¡†æ¶å®šä¹‰çš„æ¥å£
public class LongEventFactory implements EventFactory&lt;LongEvent&gt; {
    public LongEvent newInstance() {
        return new LongEvent();
    }
}&lt;/LongEvent&gt;&lt;/p&gt;

&lt;p&gt;4ã€å®šä¹‰äº‹ä»¶æ¶ˆè´¹è€…
public class LongEventHandler implements EventHandler&lt;LongEvent&gt;  {
    public void onEvent(LongEvent event, long sequence, boolean endOfBatch) throws Exception {
         System.out.println(&quot;æ¶ˆè´¹è€…:&quot;+event.getValue());
    }
}&lt;/LongEvent&gt;&lt;/p&gt;

&lt;p&gt;5ã€å®šä¹‰ç”Ÿäº§è€…&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;LongEventProducer&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RingBuffer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;LongEvent&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ringBuffer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;LongEventProducer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;RingBuffer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;LongEvent&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ringBuffer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;ringBuffer&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ringBuffer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;onData&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ByteBuffer&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;byteBuffer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// 1.ringBuffer äº‹ä»¶é˜Ÿåˆ— ä¸‹ä¸€ä¸ªæ§½&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sequence&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ringBuffer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;next&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Long&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;data&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;//2.å–å‡ºç©ºçš„äº‹ä»¶é˜Ÿåˆ—&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;LongEvent&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;longEvent&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ringBuffer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sequence&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;data&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;byteBuffer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getLong&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;//3.è·å–äº‹ä»¶é˜Ÿåˆ—ä¼ é€’çš„æ•°æ®&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;longEvent&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;setValue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;Thread&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;sleep&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;InterruptedException&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;c1&quot;&gt;// TODO Auto-generated catch block&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;printStackTrace&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;finally&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;System&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;out&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;println&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;ç”Ÿäº§è¿™å‡†å¤‡å‘é€æ•°æ®&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;//4.å‘å¸ƒäº‹ä»¶&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;ringBuffer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;publish&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sequence&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;}&lt;/p&gt;

&lt;p&gt;6ã€å®šä¹‰Mainå…¥å£
public class DisruptorMain {&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// 1.åˆ›å»ºä¸€ä¸ªå¯ç¼“å­˜çš„çº¿ç¨‹ æä¾›çº¿ç¨‹æ¥å‡ºå‘Consumer çš„äº‹ä»¶å¤„ç†&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;ExecutorService&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;executor&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Executors&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;newCachedThreadPool&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// 2.åˆ›å»ºå·¥å‚&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;EventFactory&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;LongEvent&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;eventFactory&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;LongEventFactory&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// 3.åˆ›å»ºringBuffer å¤§å°&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ringBufferSize&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1024&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// ringBufferSizeå¤§å°ä¸€å®šè¦æ˜¯2çš„Næ¬¡æ–¹&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// 4.åˆ›å»ºDisruptor&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Disruptor&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;LongEvent&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;disruptor&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Disruptor&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;LongEvent&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;eventFactory&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ringBufferSize&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;executor&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;ProducerType&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;SINGLE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;YieldingWaitStrategy&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;());&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// 5.è¿æ¥æ¶ˆè´¹ç«¯æ–¹æ³•&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;disruptor&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;handleEventsWith&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;LongEventHandler&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;());&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// 6.å¯åŠ¨&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;disruptor&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// 7.åˆ›å»ºRingBufferå®¹å™¨&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;RingBuffer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;LongEvent&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ringBuffer&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;disruptor&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getRingBuffer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// 8.åˆ›å»ºç”Ÿäº§è€…&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;LongEventProducer&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;producer&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;LongEventProducer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ringBuffer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// 9.æŒ‡å®šç¼“å†²åŒºå¤§å°&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;ByteBuffer&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;byteBuffer&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ByteBuffer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;allocate&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;byteBuffer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;putLong&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;producer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;onData&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;byteBuffer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;//10.å…³é—­disruptorå’Œexecutor&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;disruptor&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;shutdown&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;executor&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;shutdown&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</content><author><name>WenHao</name></author><summary type="html">è®¤è¯†Disruptor</summary></entry><entry><title type="html">å¹¶å‘ç¼–ç¨‹(åäºŒ)-å¹¶å‘ç¼–ç¨‹ä¹‹Future&amp;amp;ForkJoinæ¡†æ¶åŸç†åˆ†æ</title><link href="http://localhost:4000/2020/07/12/ForkJoin/" rel="alternate" type="text/html" title="å¹¶å‘ç¼–ç¨‹(åäºŒ)-å¹¶å‘ç¼–ç¨‹ä¹‹Future&amp;ForkJoinæ¡†æ¶åŸç†åˆ†æ" /><published>2020-07-12T00:00:00+08:00</published><updated>2020-07-12T00:00:00+08:00</updated><id>http://localhost:4000/2020/07/12/ForkJoin</id><content type="html" xml:base="http://localhost:4000/2020/07/12/ForkJoin/">&lt;h1 id=&quot;ä»»åŠ¡æ€§è´¨ç±»å‹&quot;&gt;ä»»åŠ¡æ€§è´¨ç±»å‹&lt;/h1&gt;

&lt;h2 id=&quot;cpuå¯†é›†å‹cpu-bound&quot;&gt;CPUå¯†é›†å‹ï¼ˆCPU-boundï¼‰&lt;/h2&gt;

&lt;p&gt;CPUå¯†é›†å‹ä¹Ÿå«è®¡ç®—å¯†é›†å‹ï¼ŒæŒ‡çš„æ˜¯ç³»ç»Ÿçš„ç¡¬ç›˜ã€å†…å­˜æ€§èƒ½ç›¸å¯¹CPUè¦å¥½å¾ˆå¤šï¼Œæ­¤æ—¶ï¼Œç³»ç»Ÿè¿ä½œå¤§éƒ¨åˆ†çš„çŠ¶å†µæ˜¯CPU Loading 100%ï¼ŒCPUè¦è¯»/å†™I/O(ç¡¬ç›˜/å†…å­˜)ï¼ŒI/Oåœ¨å¾ˆçŸ­çš„æ—¶é—´å°±å¯ä»¥å®Œæˆï¼Œè€ŒCPUè¿˜æœ‰è®¸å¤šè¿ç®—è¦å¤„ç†ï¼ŒCPU Loadingå¾ˆé«˜ã€‚
åœ¨å¤šé‡ç¨‹åºç³»ç»Ÿä¸­ï¼Œå¤§éƒ¨ä»½æ—¶é—´ç”¨æ¥åšè®¡ç®—ã€é€»è¾‘åˆ¤æ–­ç­‰CPUåŠ¨ä½œçš„ç¨‹åºç§°ä¹‹CPU boundã€‚ä¾‹å¦‚ä¸€ä¸ªè®¡ç®—åœ†å‘¨ç‡è‡³å°æ•°ç‚¹ä¸€åƒä½ä»¥ä¸‹çš„ç¨‹åºï¼Œåœ¨æ‰§è¡Œçš„è¿‡ç¨‹å½“ä¸­ç»å¤§éƒ¨ä»½æ—¶é—´ç”¨åœ¨ä¸‰è§’å‡½æ•°å’Œå¼€æ ¹å·çš„è®¡ç®—ï¼Œä¾¿æ˜¯å±äºCPU boundçš„ç¨‹åºã€‚
CPU boundçš„ç¨‹åºä¸€èˆ¬è€Œè¨€CPUå ç”¨ç‡ç›¸å½“é«˜ã€‚è¿™å¯èƒ½æ˜¯å› ä¸ºä»»åŠ¡æœ¬èº«ä¸å¤ªéœ€è¦è®¿é—®I/Oè®¾å¤‡ï¼Œä¹Ÿå¯èƒ½æ˜¯å› ä¸ºç¨‹åºæ˜¯å¤šçº¿ç¨‹å®ç°å› æ­¤å±è”½æ‰äº†ç­‰å¾…I/Oçš„æ—¶é—´ã€‚
çº¿ç¨‹æ•°ä¸€èˆ¬è®¾ç½®ä¸ºï¼š
çº¿ç¨‹æ•° = CPUæ ¸æ•°+1 (ç°ä»£CPUæ”¯æŒè¶…çº¿ç¨‹)&lt;/p&gt;

&lt;h2 id=&quot;ioå¯†é›†å‹io-bound&quot;&gt;IOå¯†é›†å‹ï¼ˆI/O boundï¼‰&lt;/h2&gt;

&lt;p&gt;IOå¯†é›†å‹æŒ‡çš„æ˜¯ç³»ç»Ÿçš„CPUæ€§èƒ½ç›¸å¯¹ç¡¬ç›˜ã€å†…å­˜è¦å¥½å¾ˆå¤šï¼Œæ­¤æ—¶ï¼Œç³»ç»Ÿè¿ä½œï¼Œå¤§éƒ¨åˆ†çš„çŠ¶å†µæ˜¯CPUåœ¨ç­‰I/O (ç¡¬ç›˜/å†…å­˜) çš„è¯»/å†™æ“ä½œï¼Œæ­¤æ—¶CPU Loadingå¹¶ä¸é«˜ã€‚
I/O boundçš„ç¨‹åºä¸€èˆ¬åœ¨è¾¾åˆ°æ€§èƒ½æé™æ—¶ï¼ŒCPUå ç”¨ç‡ä»ç„¶è¾ƒä½ã€‚è¿™å¯èƒ½æ˜¯å› ä¸ºä»»åŠ¡æœ¬èº«éœ€è¦å¤§é‡I/Oæ“ä½œï¼Œè€Œpipelineåšå¾—ä¸æ˜¯å¾ˆå¥½ï¼Œæ²¡æœ‰å……åˆ†åˆ©ç”¨å¤„ç†å™¨èƒ½åŠ›ã€‚
çº¿ç¨‹æ•°ä¸€èˆ¬è®¾ç½®ä¸ºï¼š
çº¿ç¨‹æ•° = ï¼ˆï¼ˆçº¿ç¨‹ç­‰å¾…æ—¶é—´+çº¿ç¨‹CPUæ—¶é—´ï¼‰/çº¿ç¨‹CPUæ—¶é—´ ï¼‰* CPUæ•°ç›®&lt;/p&gt;

&lt;h2 id=&quot;cpuå¯†é›†å‹-vs-ioå¯†é›†å‹&quot;&gt;CPUå¯†é›†å‹ vs IOå¯†é›†å‹&lt;/h2&gt;

&lt;p&gt;æˆ‘ä»¬å¯ä»¥æŠŠä»»åŠ¡åˆ†ä¸ºè®¡ç®—å¯†é›†å‹å’ŒIOå¯†é›†å‹ã€‚
è®¡ç®—å¯†é›†å‹ä»»åŠ¡çš„ç‰¹ç‚¹æ˜¯è¦è¿›è¡Œå¤§é‡çš„è®¡ç®—ï¼Œæ¶ˆè€—CPUèµ„æºï¼Œæ¯”å¦‚è®¡ç®—åœ†å‘¨ç‡ã€å¯¹è§†é¢‘è¿›è¡Œé«˜æ¸…è§£ç ç­‰ç­‰ï¼Œå…¨é CPUçš„è¿ç®—èƒ½åŠ›ã€‚è¿™ç§è®¡ç®—å¯†é›†å‹ä»»åŠ¡è™½ç„¶ä¹Ÿå¯ä»¥ç”¨å¤šä»»åŠ¡å®Œæˆï¼Œä½†æ˜¯ä»»åŠ¡è¶Šå¤šï¼ŒèŠ±åœ¨ä»»åŠ¡åˆ‡æ¢çš„æ—¶é—´å°±è¶Šå¤šï¼ŒCPUæ‰§è¡Œä»»åŠ¡çš„æ•ˆç‡å°±è¶Šä½ï¼Œæ‰€ä»¥ï¼Œè¦æœ€é«˜æ•ˆåœ°åˆ©ç”¨CPUï¼Œè®¡ç®—å¯†é›†å‹ä»»åŠ¡åŒæ—¶è¿›è¡Œçš„æ•°é‡åº”å½“ç­‰äºCPUçš„æ ¸å¿ƒæ•°ã€‚
è®¡ç®—å¯†é›†å‹ä»»åŠ¡ç”±äºä¸»è¦æ¶ˆè€—CPUèµ„æºï¼Œå› æ­¤ï¼Œä»£ç è¿è¡Œæ•ˆç‡è‡³å…³é‡è¦ã€‚Pythonè¿™æ ·çš„è„šæœ¬è¯­è¨€è¿è¡Œæ•ˆç‡å¾ˆä½ï¼Œå®Œå…¨ä¸é€‚åˆè®¡ç®—å¯†é›†å‹ä»»åŠ¡ã€‚å¯¹äºè®¡ç®—å¯†é›†å‹ä»»åŠ¡ï¼Œæœ€å¥½ç”¨Cè¯­è¨€ç¼–å†™ã€‚
ç¬¬äºŒç§ä»»åŠ¡çš„ç±»å‹æ˜¯IOå¯†é›†å‹ï¼Œæ¶‰åŠåˆ°ç½‘ç»œã€ç£ç›˜IOçš„ä»»åŠ¡éƒ½æ˜¯IOå¯†é›†å‹ä»»åŠ¡ï¼Œè¿™ç±»ä»»åŠ¡çš„ç‰¹ç‚¹æ˜¯CPUæ¶ˆè€—å¾ˆå°‘ï¼Œä»»åŠ¡çš„å¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨ç­‰å¾…IOæ“ä½œå®Œæˆï¼ˆå› ä¸ºIOçš„é€Ÿåº¦è¿œè¿œä½äºCPUå’Œå†…å­˜çš„é€Ÿåº¦ï¼‰ã€‚å¯¹äºIOå¯†é›†å‹ä»»åŠ¡ï¼Œä»»åŠ¡è¶Šå¤šï¼ŒCPUæ•ˆç‡è¶Šé«˜ï¼Œä½†ä¹Ÿæœ‰ä¸€ä¸ªé™åº¦ã€‚å¸¸è§çš„å¤§éƒ¨åˆ†ä»»åŠ¡éƒ½æ˜¯IOå¯†é›†å‹ä»»åŠ¡ï¼Œæ¯”å¦‚Webåº”ç”¨ã€‚
IOå¯†é›†å‹ä»»åŠ¡æ‰§è¡ŒæœŸé—´ï¼Œ99%çš„æ—¶é—´éƒ½èŠ±åœ¨IOä¸Šï¼ŒèŠ±åœ¨CPUä¸Šçš„æ—¶é—´å¾ˆå°‘ï¼Œå› æ­¤ï¼Œç”¨è¿è¡Œé€Ÿåº¦æå¿«çš„Cè¯­è¨€æ›¿æ¢ç”¨Pythonè¿™æ ·è¿è¡Œé€Ÿåº¦æä½çš„è„šæœ¬è¯­è¨€ï¼Œå®Œå…¨æ— æ³•æå‡è¿è¡Œæ•ˆç‡ã€‚å¯¹äºIOå¯†é›†å‹ä»»åŠ¡ï¼Œæœ€åˆé€‚çš„è¯­è¨€å°±æ˜¯å¼€å‘æ•ˆç‡æœ€é«˜ï¼ˆä»£ç é‡æœ€å°‘ï¼‰çš„è¯­è¨€ï¼Œè„šæœ¬è¯­è¨€æ˜¯é¦–é€‰ï¼ŒCè¯­è¨€æœ€å·®ã€‚&lt;/p&gt;

&lt;h1 id=&quot;ä¸€ä»€ä¹ˆæ˜¯-forkjoin-æ¡†æ¶&quot;&gt;ä¸€ã€ä»€ä¹ˆæ˜¯ Fork/Join æ¡†æ¶ï¼Ÿ&lt;/h1&gt;

&lt;p&gt;Fork/Join æ¡†æ¶æ˜¯ Java7 æä¾›äº†çš„ä¸€ä¸ªç”¨äºå¹¶è¡Œæ‰§è¡Œä»»åŠ¡çš„æ¡†æ¶ï¼Œ æ˜¯ä¸€ä¸ªæŠŠå¤§ä»»åŠ¡åˆ†å‰²æˆè‹¥å¹²ä¸ªå°ä»»åŠ¡ï¼Œæœ€ç»ˆæ±‡æ€»æ¯ä¸ªå°ä»»åŠ¡ç»“æœåå¾—åˆ°å¤§ä»»åŠ¡ç»“æœçš„æ¡†æ¶ã€‚
Fork å°±æ˜¯æŠŠä¸€ä¸ªå¤§ä»»åŠ¡åˆ‡åˆ†ä¸ºè‹¥å¹²å­ä»»åŠ¡å¹¶è¡Œçš„æ‰§è¡Œï¼ŒJoin å°±æ˜¯åˆå¹¶è¿™äº›å­ä»»åŠ¡çš„æ‰§è¡Œç»“æœï¼Œæœ€åå¾—åˆ°è¿™ä¸ªå¤§ä»»åŠ¡çš„ç»“æœã€‚æ¯”å¦‚è®¡ç®—1+2+â€¦..ï¼‹10000ï¼Œå¯ä»¥åˆ†å‰²æˆ 10 ä¸ªå­ä»»åŠ¡ï¼Œæ¯ä¸ªå­ä»»åŠ¡åˆ†åˆ«å¯¹ 1000 ä¸ªæ•°è¿›è¡Œæ±‚å’Œï¼Œæœ€ç»ˆæ±‡æ€»è¿™ 10 ä¸ªå­ä»»åŠ¡çš„ç»“æœã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š&lt;/p&gt;

&lt;p&gt;Fork/Jionç‰¹æ€§ï¼š
ForkJoinPool ä¸æ˜¯ä¸ºäº†æ›¿ä»£ ExecutorServiceï¼Œè€Œæ˜¯å®ƒçš„è¡¥å……ï¼Œåœ¨æŸäº›åº”ç”¨åœºæ™¯ä¸‹æ€§èƒ½æ¯” ExecutorService æ›´å¥½ã€‚ï¼ˆè§ Java Tip: When to use ForkJoinPool vs ExecutorService ï¼‰
ForkJoinPool ä¸»è¦ç”¨äºå®ç°â€œåˆ†è€Œæ²»ä¹‹â€çš„ç®—æ³•ï¼Œç‰¹åˆ«æ˜¯åˆ†æ²»ä¹‹åé€’å½’è°ƒç”¨çš„å‡½æ•°ï¼Œä¾‹å¦‚ quick sort ç­‰ã€‚
ForkJoinPool æœ€é€‚åˆçš„æ˜¯è®¡ç®—å¯†é›†å‹çš„ä»»åŠ¡ï¼Œå¦‚æœå­˜åœ¨ I/Oï¼Œçº¿ç¨‹é—´åŒæ­¥ï¼Œsleep() ç­‰ä¼šé€ æˆçº¿ç¨‹é•¿æ—¶é—´é˜»å¡çš„æƒ…å†µæ—¶ï¼Œæœ€å¥½é…åˆä½¿ç”¨ ManagedBlockerã€‚&lt;/p&gt;

&lt;h1 id=&quot;äºŒå·¥ä½œçªƒå–ç®—æ³•&quot;&gt;äºŒã€å·¥ä½œçªƒå–ç®—æ³•&lt;/h1&gt;

&lt;p&gt;å·¥ä½œçªƒå–ï¼ˆwork-stealingï¼‰ç®—æ³•æ˜¯æŒ‡æŸä¸ªçº¿ç¨‹ä»å…¶ä»–é˜Ÿåˆ—é‡Œçªƒå–ä»»åŠ¡æ¥æ‰§è¡Œã€‚
æˆ‘ä»¬éœ€è¦åšä¸€ä¸ªæ¯”è¾ƒå¤§çš„ä»»åŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸ªä»»åŠ¡åˆ†å‰²ä¸ºè‹¥å¹²äº’ä¸ä¾èµ–çš„å­ä»»åŠ¡ï¼Œä¸ºäº†å‡å°‘çº¿ç¨‹é—´çš„ç«äº‰ï¼Œäºæ˜¯æŠŠè¿™äº›å­ä»»åŠ¡åˆ†åˆ«æ”¾åˆ°ä¸åŒçš„é˜Ÿåˆ—é‡Œï¼Œå¹¶ä¸ºæ¯ä¸ªé˜Ÿåˆ—åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹æ¥æ‰§è¡Œé˜Ÿåˆ—é‡Œçš„ä»»åŠ¡ï¼Œçº¿ç¨‹å’Œé˜Ÿåˆ—ä¸€ä¸€å¯¹åº”ï¼Œæ¯”å¦‚Açº¿ç¨‹è´Ÿè´£å¤„ç†Aé˜Ÿåˆ—é‡Œçš„ä»»åŠ¡ã€‚ä½†æ˜¯æœ‰çš„çº¿ç¨‹ä¼šå…ˆæŠŠè‡ªå·±é˜Ÿåˆ—é‡Œçš„ä»»åŠ¡å¹²å®Œï¼Œè€Œå…¶ä»–çº¿ç¨‹å¯¹åº”çš„é˜Ÿåˆ—é‡Œè¿˜æœ‰ä»»åŠ¡ç­‰å¾…å¤„ç†ã€‚å¹²å®Œæ´»çš„çº¿ç¨‹ä¸å…¶ç­‰ç€ï¼Œä¸å¦‚å»å¸®å…¶ä»–çº¿ç¨‹å¹²æ´»ï¼Œäºæ˜¯å®ƒå°±å»å…¶ä»–çº¿ç¨‹çš„é˜Ÿåˆ—é‡Œçªƒå–ä¸€ä¸ªä»»åŠ¡æ¥æ‰§è¡Œã€‚è€Œåœ¨è¿™æ—¶å®ƒä»¬ä¼šè®¿é—®åŒä¸€ä¸ªé˜Ÿåˆ—ï¼Œæ‰€ä»¥ä¸ºäº†å‡å°‘çªƒå–ä»»åŠ¡çº¿ç¨‹å’Œè¢«çªƒå–ä»»åŠ¡çº¿ç¨‹ä¹‹é—´çš„ç«äº‰ï¼Œé€šå¸¸ä¼šä½¿ç”¨åŒç«¯é˜Ÿåˆ—ï¼Œè¢«çªƒå–ä»»åŠ¡çº¿ç¨‹æ°¸è¿œä»åŒç«¯é˜Ÿåˆ—çš„å¤´éƒ¨æ‹¿ä»»åŠ¡æ‰§è¡Œï¼Œè€Œçªƒå–ä»»åŠ¡çš„çº¿ç¨‹æ°¸è¿œä»åŒç«¯é˜Ÿåˆ—çš„å°¾éƒ¨æ‹¿ä»»åŠ¡æ‰§è¡Œã€‚
å·¥ä½œçªƒå–ç®—æ³•çš„ä¼˜ç‚¹æ˜¯å……åˆ†åˆ©ç”¨çº¿ç¨‹è¿›è¡Œå¹¶è¡Œè®¡ç®—ï¼Œå¹¶å‡å°‘äº†çº¿ç¨‹é—´çš„ç«äº‰ï¼Œå…¶ç¼ºç‚¹æ˜¯åœ¨æŸäº›æƒ…å†µä¸‹è¿˜æ˜¯å­˜åœ¨ç«äº‰ï¼Œæ¯”å¦‚åŒç«¯é˜Ÿåˆ—é‡Œåªæœ‰ä¸€ä¸ªä»»åŠ¡æ—¶ã€‚å¹¶ä¸”æ¶ˆè€—äº†æ›´å¤šçš„ç³»ç»Ÿèµ„æºï¼Œæ¯”å¦‚åˆ›å»ºå¤šä¸ªçº¿ç¨‹å’Œå¤šä¸ªåŒç«¯é˜Ÿåˆ—ã€‚&lt;/p&gt;

&lt;p&gt;ForkJoinPool çš„æ¯ä¸ªå·¥ä½œçº¿ç¨‹éƒ½ç»´æŠ¤ç€ä¸€ä¸ªå·¥ä½œé˜Ÿåˆ—ï¼ˆWorkQueueï¼‰ï¼Œè¿™æ˜¯ä¸€ä¸ªåŒç«¯é˜Ÿåˆ—ï¼ˆDequeï¼‰ï¼Œé‡Œé¢å­˜æ”¾çš„å¯¹è±¡æ˜¯ä»»åŠ¡ï¼ˆForkJoinTaskï¼‰ã€‚
æ¯ä¸ªå·¥ä½œçº¿ç¨‹åœ¨è¿è¡Œä¸­äº§ç”Ÿæ–°çš„ä»»åŠ¡ï¼ˆé€šå¸¸æ˜¯å› ä¸ºè°ƒç”¨äº† fork()ï¼‰æ—¶ï¼Œä¼šæ”¾å…¥å·¥ä½œé˜Ÿåˆ—çš„é˜Ÿå°¾ï¼Œå¹¶ä¸”å·¥ä½œçº¿ç¨‹åœ¨å¤„ç†è‡ªå·±çš„å·¥ä½œé˜Ÿåˆ—æ—¶ï¼Œä½¿ç”¨çš„æ˜¯ LIFO æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯æ¬¡ä»é˜Ÿå°¾å–å‡ºä»»åŠ¡æ¥æ‰§è¡Œã€‚
æ¯ä¸ªå·¥ä½œçº¿ç¨‹åœ¨å¤„ç†è‡ªå·±çš„å·¥ä½œé˜Ÿåˆ—åŒæ—¶ï¼Œä¼šå°è¯•çªƒå–ä¸€ä¸ªä»»åŠ¡ï¼ˆæˆ–æ˜¯æ¥è‡ªäºåˆšåˆšæäº¤åˆ° pool çš„ä»»åŠ¡ï¼Œæˆ–æ˜¯æ¥è‡ªäºå…¶ä»–å·¥ä½œçº¿ç¨‹çš„å·¥ä½œé˜Ÿåˆ—ï¼‰ï¼Œçªƒå–çš„ä»»åŠ¡ä½äºå…¶ä»–çº¿ç¨‹çš„å·¥ä½œé˜Ÿåˆ—çš„é˜Ÿé¦–ï¼Œä¹Ÿå°±æ˜¯è¯´å·¥ä½œçº¿ç¨‹åœ¨çªƒå–å…¶ä»–å·¥ä½œçº¿ç¨‹çš„ä»»åŠ¡æ—¶ï¼Œä½¿ç”¨çš„æ˜¯ FIFO æ–¹å¼ã€‚
åœ¨é‡åˆ° join() æ—¶ï¼Œå¦‚æœéœ€è¦ join çš„ä»»åŠ¡å°šæœªå®Œæˆï¼Œåˆ™ä¼šå…ˆå¤„ç†å…¶ä»–ä»»åŠ¡ï¼Œå¹¶ç­‰å¾…å…¶å®Œæˆã€‚
åœ¨æ—¢æ²¡æœ‰è‡ªå·±çš„ä»»åŠ¡ï¼Œä¹Ÿæ²¡æœ‰å¯ä»¥çªƒå–çš„ä»»åŠ¡æ—¶ï¼Œè¿›å…¥ä¼‘çœ ã€‚&lt;/p&gt;

&lt;h1 id=&quot;ä¸‰forkjoinçš„ä½¿ç”¨&quot;&gt;ä¸‰ã€fork/joinçš„ä½¿ç”¨&lt;/h1&gt;

&lt;p&gt;ForkJoinTaskï¼šæˆ‘ä»¬è¦ä½¿ç”¨ ForkJoin æ¡†æ¶ï¼Œå¿…é¡»é¦–å…ˆåˆ›å»ºä¸€ä¸ª ForkJoin ä»»åŠ¡ã€‚å®ƒæä¾›åœ¨ä»»åŠ¡ä¸­æ‰§è¡Œ fork() å’Œ join() æ“ä½œçš„æœºåˆ¶ï¼Œé€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬ä¸éœ€è¦ç›´æ¥ç»§æ‰¿ ForkJoinTask ç±»ï¼Œè€Œåªéœ€è¦ç»§æ‰¿å®ƒçš„å­ç±»ï¼ŒFork/Join æ¡†æ¶æä¾›äº†ä»¥ä¸‹ä¸¤ä¸ªå­ç±»ï¼š
RecursiveActionï¼šç”¨äºæ²¡æœ‰è¿”å›ç»“æœçš„ä»»åŠ¡ã€‚(æ¯”å¦‚å†™æ•°æ®åˆ°ç£ç›˜ï¼Œç„¶åå°±é€€å‡ºäº†ã€‚ ä¸€ä¸ªRecursiveActionå¯ä»¥æŠŠè‡ªå·±çš„å·¥ä½œåˆ†å‰²æˆæ›´å°çš„å‡ å—ï¼Œ è¿™æ ·å®ƒä»¬å¯ä»¥ç”±ç‹¬ç«‹çš„çº¿ç¨‹æˆ–è€…CPUæ‰§è¡Œã€‚ æˆ‘ä»¬å¯ä»¥é€šè¿‡ç»§æ‰¿æ¥å®ç°ä¸€ä¸ªRecursiveAction)
RecursiveTask ï¼šç”¨äºæœ‰è¿”å›ç»“æœçš„ä»»åŠ¡ã€‚(å¯ä»¥å°†è‡ªå·±çš„å·¥ä½œåˆ†å‰²ä¸ºè‹¥å¹²æ›´å°ä»»åŠ¡ï¼Œå¹¶å°†è¿™äº›å­ä»»åŠ¡çš„æ‰§è¡Œåˆå¹¶åˆ°ä¸€ä¸ªé›†ä½“ç»“æœã€‚ å¯ä»¥æœ‰å‡ ä¸ªæ°´å¹³çš„åˆ†å‰²å’Œåˆå¹¶)
CountedCompleterï¼š åœ¨ä»»åŠ¡å®Œæˆæ‰§è¡Œåä¼šè§¦å‘æ‰§è¡Œä¸€ä¸ªè‡ªå®šä¹‰çš„é’©å­å‡½æ•°&lt;/p&gt;

&lt;p&gt;ForkJoinPool ï¼šForkJoinTask éœ€è¦é€šè¿‡ ForkJoinPool æ¥æ‰§è¡Œï¼Œä»»åŠ¡åˆ†å‰²å‡ºçš„å­ä»»åŠ¡ä¼šæ·»åŠ åˆ°å½“å‰å·¥ä½œçº¿ç¨‹æ‰€ç»´æŠ¤çš„åŒç«¯é˜Ÿåˆ—ä¸­ï¼Œè¿›å…¥é˜Ÿåˆ—çš„å¤´éƒ¨ã€‚å½“ä¸€ä¸ªå·¥ä½œçº¿ç¨‹çš„é˜Ÿåˆ—é‡Œæš‚æ—¶æ²¡æœ‰ä»»åŠ¡æ—¶ï¼Œå®ƒä¼šéšæœºä»å…¶ä»–å·¥ä½œçº¿ç¨‹çš„é˜Ÿåˆ—çš„å°¾éƒ¨è·å–ä¸€ä¸ªä»»åŠ¡ã€‚&lt;/p&gt;

&lt;p&gt;ä½¿ç”¨åœºæ™¯ç¤ºä¾‹ï¼š
å®šä¹‰fork/joinä»»åŠ¡ï¼Œå¦‚ä¸‹ç¤ºä¾‹ï¼Œéšæœºç”Ÿæˆ2000wæ¡æ•°æ®åœ¨æ•°ç»„å½“ä¸­ï¼Œç„¶åæ±‚å’Œ
/**&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;RecursiveTask å¹¶è¡Œè®¡ç®—ï¼ŒåŒæ­¥æœ‰è¿”å›å€¼&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;ForkJoinæ¡†æ¶å¤„ç†çš„ä»»åŠ¡åŸºæœ¬éƒ½èƒ½ä½¿ç”¨é€’å½’å¤„ç†ï¼Œæ¯”å¦‚æ±‚æ–æ³¢é‚£å¥‘æ•°åˆ—ç­‰ï¼Œä½†é€’å½’ç®—æ³•çš„ç¼ºé™·æ˜¯ï¼š&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;ä¸€åªä¼šåªç”¨å•çº¿ç¨‹å¤„ç†ï¼Œ&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;äºŒæ˜¯é€’å½’æ¬¡æ•°è¿‡å¤šæ—¶ä¼šå¯¼è‡´å †æ ˆæº¢å‡ºï¼›&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;ForkJoinè§£å†³äº†è¿™ä¸¤ä¸ªé—®é¢˜ï¼Œä½¿ç”¨å¤šçº¿ç¨‹å¹¶å‘å¤„ç†ï¼Œå……åˆ†åˆ©ç”¨è®¡ç®—èµ„æºæ¥æé«˜æ•ˆç‡ï¼ŒåŒæ—¶é¿å…å †æ ˆæº¢å‡ºå‘ç”Ÿã€‚&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;å½“ç„¶åƒæ±‚æ–æ³¢é‚£å¥‘æ•°åˆ—è¿™ç§å°é—®é¢˜ç›´æ¥ä½¿ç”¨çº¿æ€§ç®—æ³•æå®šå¯èƒ½æ›´ç®€å•ï¼Œå®é™…åº”ç”¨ä¸­å®Œå…¨æ²¡å¿…è¦ä½¿ç”¨ForkJoinæ¡†æ¶ï¼Œ&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;æ‰€ä»¥ForkJoinæ˜¯æ ¸å¼¹ï¼Œæ˜¯ç”¨æ¥å¯¹ä»˜å¤§å®¶ä¼™çš„ï¼Œæ¯”å¦‚è¶…å¤§æ•°ç»„æ’åºã€‚&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;æœ€ä½³åº”ç”¨åœºæ™¯ï¼šå¤šæ ¸ã€å¤šå†…å­˜ã€å¯ä»¥åˆ†å‰²è®¡ç®—å†åˆå¹¶çš„è®¡ç®—å¯†é›†å‹ä»»åŠ¡&lt;/p&gt;

    &lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;  &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*/&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;LongSum&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RecursiveTask&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Long&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;//ä»»åŠ¡æ‹†åˆ†çš„æœ€å°é˜€å€¼&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SEQUENTIAL_THRESHOLD&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;NPS&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1000L&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1000&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;extraWork&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// change to add more than just a sum&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;low&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;high&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;array&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;LongSum&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;arr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;hi&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;array&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;arr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;low&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;high&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;hi&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    
 &lt;span class=&quot;o&quot;&gt;/**&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;fork()æ–¹æ³•ï¼šå°†ä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—å¹¶å®‰æ’å¼‚æ­¥æ‰§è¡Œï¼Œä¸€ä¸ªä»»åŠ¡åº”è¯¥åªè°ƒç”¨ä¸€æ¬¡fork()å‡½æ•°ï¼Œé™¤éå·²ç»æ‰§è¡Œå®Œæ¯•å¹¶é‡æ–°åˆå§‹åŒ–ã€‚&lt;/li&gt;
  &lt;li&gt;tryUnfork()æ–¹æ³•ï¼šå°è¯•æŠŠä»»åŠ¡ä»é˜Ÿåˆ—ä¸­æ‹¿å‡ºå•ç‹¬å¤„ç†ï¼Œä½†ä¸ä¸€å®šæˆåŠŸã€‚&lt;/li&gt;
  &lt;li&gt;join()æ–¹æ³•ï¼šç­‰å¾…è®¡ç®—å®Œæˆå¹¶è¿”å›è®¡ç®—ç»“æœã€‚&lt;/li&gt;
  &lt;li&gt;isCompletedAbnormally()æ–¹æ³•ï¼šç”¨äºåˆ¤æ–­ä»»åŠ¡è®¡ç®—æ˜¯å¦å‘ç”Ÿå¼‚å¸¸ã€‚
 */&lt;/li&gt;
  &lt;li&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Long&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;compute&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
 &lt;span class=&quot;c1&quot;&gt;//ä»»åŠ¡è¢«æ‹†åˆ†åˆ°è¶³å¤Ÿå°æ—¶ï¼Œåˆ™å¼€å§‹æ±‚å’Œ&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;high&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;low&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SEQUENTIAL_THRESHOLD&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sum&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;low&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;high&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;sum&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;array&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;];&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;//å¦‚æœä»»åŠ¡ä»»ç„¶è¿‡å¤§ï¼Œåˆ™ç»§ç»­æ‹†åˆ†ä»»åŠ¡ï¼Œæœ¬è´¨å°±æ˜¯é€’å½’æ‹†åˆ†&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;low&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;high&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;low&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;LongSum&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;left&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;LongSum&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;array&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;low&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;LongSum&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;right&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;LongSum&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;array&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;high&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;left&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;fork&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;right&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;fork&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rightAns&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;right&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;join&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;leftAns&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;left&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;join&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;leftAns&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rightAns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;err&quot;&gt;#æ‰§è¡Œ&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fork&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;join&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ä»»åŠ¡&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;LongSumMain&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
   &lt;span class=&quot;c1&quot;&gt;//è·å–é€»è¾‘å¤„ç†å™¨æ•°é‡&lt;/span&gt;
   &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;NCPU&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Runtime&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getRuntime&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;availableProcessors&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
   &lt;span class=&quot;cm&quot;&gt;/** for time conversion */&lt;/span&gt;
   &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;NPS&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1000L&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1000&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;

   &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;calcSum&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;

   &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;reportSteals&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;

   &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Exception&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;array&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Utils&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;buildRandomIntArray&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;20000000&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;System&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;out&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;println&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;cpu-num:&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NCPU&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;//å•çº¿ç¨‹ä¸‹è®¡ç®—æ•°ç»„æ•°æ®æ€»å’Œ&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;calcSum&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;seqSum&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;array&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;System&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;out&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;println&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;seq sum=&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;calcSum&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;//é‡‡ç”¨fork/joinæ–¹å¼å°†æ•°ç»„æ±‚å’Œä»»åŠ¡è¿›è¡Œæ‹†åˆ†æ‰§è¡Œï¼Œæœ€ååˆå¹¶ç»“æœ&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;LongSum&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ls&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;LongSum&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;array&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;array&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;ForkJoinPool&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fjp&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ForkJoinPool&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//ä½¿ç”¨çš„çº¿ç¨‹æ•°&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;ForkJoinTask&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Long&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;result&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fjp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;submit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ls&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;System&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;out&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;println&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;forkjoin sum=&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;result&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;());&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;fjp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;shutdown&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
   &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;seqSum&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;array&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;kt&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sum&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;array&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
         &lt;span class=&quot;n&quot;&gt;sum&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;array&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;];&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
   &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;


&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h1 id=&quot;å››forkjoinæ¡†æ¶åŸç†&quot;&gt;å››ã€fork/joinæ¡†æ¶åŸç†&lt;/h1&gt;

&lt;p&gt;å¸¸é‡ä»‹ç»
ForkJoinPool ä¸ å†…éƒ¨ç±» WorkQueue å…±äº«çš„ä¸€äº›å¸¸é‡:
// Constants shared across ForkJoinPool and WorkQueue&lt;/p&gt;

&lt;p&gt;// é™å®šå‚æ•°
static final int SMASK = 0xffff;        //  ä½ä½æ©ç ï¼Œä¹Ÿæ˜¯æœ€å¤§ç´¢å¼•ä½
static final int MAX_CAP = 0x7fff;        //  å·¥ä½œçº¿ç¨‹æœ€å¤§å®¹é‡
static final int EVENMASK = 0xfffe;        //  å¶æ•°ä½ä½æ©ç 
static final int SQMASK = 0x007e;        //  workQueues æ•°ç»„æœ€å¤š64ä¸ªæ§½ä½&lt;/p&gt;

&lt;p&gt;// ctl å­åŸŸå’Œ WorkQueue.scanState çš„æ©ç å’Œæ ‡å¿—ä½
static final int SCANNING = 1;             // æ ‡è®°æ˜¯å¦æ­£åœ¨è¿è¡Œä»»åŠ¡
static final int INACTIVE = 1 Â«Â 31;       // å¤±æ´»çŠ¶æ€  è´Ÿæ•°
static final int SS_SEQ = 1 Â«Â 16;       // ç‰ˆæœ¬æˆ³ï¼Œé˜²æ­¢ABAé—®é¢˜&lt;/p&gt;

&lt;p&gt;// ForkJoinPool.config å’Œ WorkQueue.config çš„é…ç½®ä¿¡æ¯æ ‡è®°
static final int MODE_MASK = 0xffff Â«Â 16;  // æ¨¡å¼æ©ç 
static final int LIFO_QUEUE = 0; //LIFOé˜Ÿåˆ—
static final int FIFO_QUEUE = 1 Â«Â 16;//FIFOé˜Ÿåˆ—
static final int SHARED_QUEUE = 1 Â«Â 31;       // å…±äº«æ¨¡å¼é˜Ÿåˆ—ï¼Œè´Ÿæ•°&lt;/p&gt;

&lt;p&gt;ForkJoinPool ä¸­çš„ç›¸å…³å¸¸é‡å’Œå®ä¾‹å­—æ®µ:
//  ä½ä½å’Œé«˜ä½æ©ç 
private static final long SP_MASK = 0xffffffffL;
private static final long UC_MASK = ~SP_MASK;&lt;/p&gt;

&lt;p&gt;// æ´»è·ƒçº¿ç¨‹æ•°
private static final int AC_SHIFT = 48;
private static final long AC_UNIT = 0x0001L Â«Â AC_SHIFT; //æ´»è·ƒçº¿ç¨‹æ•°å¢é‡
private static final long AC_MASK = 0xffffL Â«Â AC_SHIFT; //æ´»è·ƒçº¿ç¨‹æ•°æ©ç &lt;/p&gt;

&lt;p&gt;// å·¥ä½œçº¿ç¨‹æ•°
private static final int TC_SHIFT = 32;
private static final long TC_UNIT = 0x0001L Â«Â TC_SHIFT; //å·¥ä½œçº¿ç¨‹æ•°å¢é‡
private static final long TC_MASK = 0xffffL Â«Â TC_SHIFT; //æ©ç 
private static final long ADD_WORKER = 0x0001L Â«Â (TC_SHIFT + 15);  // åˆ›å»ºå·¥ä½œçº¿ç¨‹æ ‡å¿—&lt;/p&gt;

&lt;p&gt;// æ± çŠ¶æ€
private static final int RSLOCK = 1;
private static final int RSIGNAL = 1 Â«Â 1;
private static final int STARTED = 1 Â«Â 2;
private static final int STOP = 1 Â«Â 29;
private static final int TERMINATED = 1 Â«Â 30;
private static final int SHUTDOWN = 1 Â«Â 31;&lt;/p&gt;

&lt;p&gt;// å®ä¾‹å­—æ®µ
volatile long ctl;                   // ä¸»æ§åˆ¶å‚æ•°
volatile int runState;               // è¿è¡ŒçŠ¶æ€é”
final int config;                    // å¹¶è¡Œåº¦|æ¨¡å¼
int indexSeed;                       // ç”¨äºç”Ÿæˆå·¥ä½œçº¿ç¨‹ç´¢å¼•
volatile WorkQueue[] workQueues;     // ä¸»å¯¹è±¡æ³¨å†Œä¿¡æ¯ï¼ŒworkQueue
final ForkJoinWorkerThreadFactory factory;// çº¿ç¨‹å·¥å‚
final UncaughtExceptionHandler ueh;  // æ¯ä¸ªå·¥ä½œçº¿ç¨‹çš„å¼‚å¸¸ä¿¡æ¯
final String workerNamePrefix;       // ç”¨äºåˆ›å»ºå·¥ä½œçº¿ç¨‹çš„åç§°
volatile AtomicLong stealCounter;    // å·å–ä»»åŠ¡æ€»æ•°ï¼Œä¹Ÿå¯ä½œä¸ºåŒæ­¥ç›‘è§†å™¨&lt;/p&gt;

&lt;p&gt;/** é™æ€åˆå§‹åŒ–å­—æ®µ */
//çº¿ç¨‹å·¥å‚
public static final ForkJoinWorkerThreadFactory defaultForkJoinWorkerThreadFactory;
//å¯åŠ¨æˆ–æ€æ­»çº¿ç¨‹çš„æ–¹æ³•è°ƒç”¨è€…çš„æƒé™
private static final RuntimePermission modifyThreadPermission;
// å…¬å…±é™æ€pool
static final ForkJoinPool common;
//å¹¶è¡Œåº¦ï¼Œå¯¹åº”å†…éƒ¨commonæ± 
static final int commonParallelism;
//å¤‡ç”¨çº¿ç¨‹æ•°ï¼Œåœ¨tryCompensateä¸­ä½¿ç”¨
private static int commonMaxSpares;
//åˆ›å»ºworkerNamePrefix(å·¥ä½œçº¿ç¨‹åç§°å‰ç¼€)æ—¶çš„åºå·
private static int poolNumberSequence;
//çº¿ç¨‹é˜»å¡ç­‰å¾…æ–°çš„ä»»åŠ¡çš„è¶…æ—¶å€¼(ä»¥çº³ç§’ä¸ºå•ä½)ï¼Œé»˜è®¤2ç§’
private static final long IDLE_TIMEOUT = 2000L * 1000L * 1000L; // 2sec
//ç©ºé—²è¶…æ—¶æ—¶é—´ï¼Œé˜²æ­¢timeræœªå‘½ä¸­
private static final long TIMEOUT_SLOP = 20L * 1000L * 1000L;  // 20ms
//é»˜è®¤å¤‡ç”¨çº¿ç¨‹æ•°
private static final int DEFAULT_COMMON_MAX_SPARES = 256;
//é˜»å¡å‰è‡ªæ—‹çš„æ¬¡æ•°ï¼Œç”¨åœ¨åœ¨awaitRunStateLockå’ŒawaitWorkä¸­
private static final int SPINS  = 0;
//indexSeedçš„å¢é‡
private static final int SEED_INCREMENT = 0x9e3779b9;&lt;/p&gt;

&lt;p&gt;ForkJoinPool çš„å†…éƒ¨çŠ¶æ€éƒ½æ˜¯é€šè¿‡ä¸€ä¸ª64ä½çš„ long å‹ å˜é‡ctlæ¥å­˜å‚¨ï¼Œå®ƒç”±å››ä¸ª16ä½çš„å­åŸŸç»„æˆ:
AC: æ­£åœ¨è¿è¡Œå·¥ä½œçº¿ç¨‹æ•°å‡å»ç›®æ ‡å¹¶è¡Œåº¦ï¼Œé«˜16ä½
TC: æ€»å·¥ä½œçº¿ç¨‹æ•°å‡å»ç›®æ ‡å¹¶è¡Œåº¦ï¼Œä¸­é«˜16ä½
SS: æ ˆé¡¶ç­‰å¾…çº¿ç¨‹çš„ç‰ˆæœ¬è®¡æ•°å’ŒçŠ¶æ€ï¼Œä¸­ä½16ä½
ID: æ ˆé¡¶ WorkQueue åœ¨æ± ä¸­çš„ç´¢å¼•(poolIndex)ï¼Œä½16ä½
ForkJoinPool.WorkQueue ä¸­çš„ç›¸å…³å±æ€§:
//åˆå§‹é˜Ÿåˆ—å®¹é‡ï¼Œ2çš„å¹‚
static final int INITIAL_QUEUE_CAPACITY = 1 Â«Â 13;
//æœ€å¤§é˜Ÿåˆ—å®¹é‡
static final int MAXIMUM_QUEUE_CAPACITY = 1 Â«Â 26; // 64M&lt;/p&gt;

&lt;p&gt;// å®ä¾‹å­—æ®µ
volatile int scanState;    // WokerçŠ¶æ€, &amp;lt;0: inactive; odd:scanning
int stackPred;             // è®°å½•å‰ä¸€ä¸ªæ ˆé¡¶çš„ctl
int nsteals;               // å·å–ä»»åŠ¡æ•°
int hint;                  // è®°å½•å·å–è€…ç´¢å¼•ï¼Œåˆå§‹ä¸ºéšæœºç´¢å¼•
int config;                // æ± ç´¢å¼•å’Œæ¨¡å¼
volatile int qlock;        // 1: locked, &amp;lt; 0: terminate; else 0
volatile int base;         //ä¸‹ä¸€ä¸ªpollæ“ä½œçš„ç´¢å¼•(æ ˆåº•/é˜Ÿåˆ—å¤´)
int top;                   //  ä¸‹ä¸€ä¸ªpushæ“ä½œçš„ç´¢å¼•(æ ˆé¡¶/é˜Ÿåˆ—å°¾)
ForkJoinTask&lt;?&gt;[] array;   // ä»»åŠ¡æ•°ç»„
final ForkJoinPool pool;   // the containing pool (may be null)
final ForkJoinWorkerThread owner; // å½“å‰å·¥ä½œé˜Ÿåˆ—çš„å·¥ä½œçº¿ç¨‹ï¼Œå…±äº«æ¨¡å¼ä¸‹ä¸ºnull
volatile Thread parker;    // è°ƒç”¨parké˜»å¡æœŸé—´ä¸ºownerï¼Œå…¶ä»–æƒ…å†µä¸ºnull
volatile ForkJoinTask&lt;?&gt; currentJoin;  // è®°å½•è¢«joinè¿‡æ¥çš„ä»»åŠ¡
volatile ForkJoinTask&amp;lt;?&amp;gt; currentSteal; // è®°å½•ä»å…¶ä»–å·¥ä½œé˜Ÿåˆ—å·å–è¿‡æ¥çš„ä»»åŠ¡&lt;/p&gt;

&lt;h2 id=&quot;1å¼‚å¸¸å¤„ç†&quot;&gt;1ã€å¼‚å¸¸å¤„ç†&lt;/h2&gt;

&lt;p&gt;ForkJoinTask åœ¨æ‰§è¡Œçš„æ—¶å€™å¯èƒ½ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œä½†æ˜¯æˆ‘ä»¬æ²¡åŠæ³•åœ¨ä¸»çº¿ç¨‹é‡Œç›´æ¥æ•è·å¼‚å¸¸ï¼Œæ‰€ä»¥ ForkJoinTask æä¾›äº† isCompletedAbnormally() æ–¹æ³•æ¥æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å·²ç»æŠ›å‡ºå¼‚å¸¸æˆ–å·²ç»è¢«å–æ¶ˆäº†ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ ForkJoinTask çš„ getException æ–¹æ³•è·å–å¼‚å¸¸ã€‚ç¤ºä¾‹å¦‚ä¸‹
if(task.isCompletedAbnormally()){
   System.out.println(task.getException());
}&lt;/p&gt;

&lt;p&gt;getException æ–¹æ³•è¿”å› Throwable å¯¹è±¡ï¼Œå¦‚æœä»»åŠ¡è¢«å–æ¶ˆäº†åˆ™è¿”å›CancellationExceptionã€‚å¦‚æœä»»åŠ¡æ²¡æœ‰å®Œæˆæˆ–è€…æ²¡æœ‰æŠ›å‡ºå¼‚å¸¸åˆ™è¿”å› nullã€‚&lt;/p&gt;

&lt;h2 id=&quot;2forkjoinpoolæ„é€ å‡½æ•°&quot;&gt;2ã€ForkJoinPoolæ„é€ å‡½æ•°&lt;/h2&gt;

&lt;p&gt;å…¶å®Œæ•´æ„é€ æ–¹æ³•å¦‚ä¸‹
private ForkJoinPool(int parallelism,
                     ForkJoinWorkerThreadFactory factory,
                     UncaughtExceptionHandler handler,
                     int mode,
                     String workerNamePrefix) {
    this.workerNamePrefix = workerNamePrefix;
    this.factory = factory;
    this.ueh = handler;
    this.config = (parallelism &amp;amp; SMASK) | mode;
    long np = (long)(-parallelism); // offset ctl counts
    this.ctl = ((np Â«Â AC_SHIFT) &amp;amp; AC_MASK) | ((np Â«Â TC_SHIFT) &amp;amp; TC_MASK);
}&lt;/p&gt;

&lt;p&gt;é‡è¦å‚æ•°è§£é‡Š
â‘ parallelismï¼šå¹¶è¡Œåº¦ï¼ˆ the parallelism levelï¼‰ï¼Œé»˜è®¤æƒ…å†µä¸‹è·Ÿæˆ‘ä»¬æœºå™¨çš„cpuä¸ªæ•°ä¿æŒä¸€è‡´ï¼Œä½¿ç”¨ Runtime.getRuntime().availableProcessors()å¯ä»¥å¾—åˆ°æˆ‘ä»¬æœºå™¨è¿è¡Œæ—¶å¯ç”¨çš„CPUä¸ªæ•°ã€‚
â‘¡factoryï¼šåˆ›å»ºæ–°çº¿ç¨‹çš„å·¥å‚ï¼ˆ the factory for creating new threadsï¼‰ã€‚é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨ForkJoinWorkerThreadFactory defaultForkJoinWorkerThreadFactoryã€‚
â‘¢handlerï¼šçº¿ç¨‹å¼‚å¸¸æƒ…å†µä¸‹çš„å¤„ç†å™¨ï¼ˆThread.UncaughtExceptionHandler handlerï¼‰ï¼Œè¯¥å¤„ç†å™¨åœ¨çº¿ç¨‹æ‰§è¡Œä»»åŠ¡æ—¶ç”±äºæŸäº›æ— æ³•é¢„æ–™åˆ°çš„é”™è¯¯è€Œå¯¼è‡´ä»»åŠ¡çº¿ç¨‹ä¸­æ–­æ—¶è¿›è¡Œä¸€äº›å¤„ç†ï¼Œé»˜è®¤æƒ…å†µä¸ºnullã€‚
â‘£asyncModeï¼šè¿™ä¸ªå‚æ•°è¦æ³¨æ„ï¼Œåœ¨ForkJoinPoolä¸­ï¼Œæ¯ä¸€ä¸ªå·¥ä½œçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ä»»åŠ¡é˜Ÿåˆ—ï¼ŒasyncModeè¡¨ç¤ºå·¥ä½œçº¿ç¨‹å†…çš„ä»»åŠ¡é˜Ÿåˆ—æ˜¯é‡‡ç”¨ä½•ç§æ–¹å¼è¿›è¡Œè°ƒåº¦ï¼Œå¯ä»¥æ˜¯å…ˆè¿›å…ˆå‡ºFIFOï¼Œä¹Ÿå¯ä»¥æ˜¯åè¿›å…ˆå‡ºLIFOã€‚å¦‚æœä¸ºtrueï¼Œåˆ™çº¿ç¨‹æ± ä¸­çš„å·¥ä½œçº¿ç¨‹åˆ™ä½¿ç”¨å…ˆè¿›å…ˆå‡ºæ–¹å¼è¿›è¡Œä»»åŠ¡è°ƒåº¦ï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯falseã€‚&lt;/p&gt;

&lt;h2 id=&quot;3forkjointask-fork-æ–¹æ³•&quot;&gt;3ã€ForkJoinTask fork æ–¹æ³•&lt;/h2&gt;

&lt;p&gt;fork() åšçš„å·¥ä½œåªæœ‰ä¸€ä»¶äº‹ï¼Œæ—¢æ˜¯æŠŠä»»åŠ¡æ¨å…¥å½“å‰å·¥ä½œçº¿ç¨‹çš„å·¥ä½œé˜Ÿåˆ—é‡Œã€‚å¯ä»¥å‚çœ‹ä»¥ä¸‹çš„æºä»£ç ï¼š
public final ForkJoinTask&lt;V&gt; fork() {
    Thread t;
    if ((t = Thread.currentThread()) instanceof ForkJoinWorkerThread)
        ((ForkJoinWorkerThread)t).workQueue.push(this);
    else
        ForkJoinPool.common.externalPush(this);
    return this;
}&lt;/V&gt;&lt;/p&gt;

&lt;h2 id=&quot;4forkjointask-join-æ–¹æ³•&quot;&gt;4ã€ForkJoinTask join æ–¹æ³•&lt;/h2&gt;

&lt;p&gt;join() çš„å·¥ä½œåˆ™å¤æ‚å¾—å¤šï¼Œä¹Ÿæ˜¯ join() å¯ä»¥ä½¿å¾—çº¿ç¨‹å…äºè¢«é˜»å¡çš„åŸå› â€”â€”ä¸åƒåŒåçš„ Thread.join()ã€‚
æ£€æŸ¥è°ƒç”¨ join() çš„çº¿ç¨‹æ˜¯å¦æ˜¯ ForkJoinThread çº¿ç¨‹ã€‚å¦‚æœä¸æ˜¯ï¼ˆä¾‹å¦‚ main çº¿ç¨‹ï¼‰ï¼Œåˆ™é˜»å¡å½“å‰çº¿ç¨‹ï¼Œç­‰å¾…ä»»åŠ¡å®Œæˆã€‚å¦‚æœæ˜¯ï¼Œåˆ™ä¸é˜»å¡ã€‚
æŸ¥çœ‹ä»»åŠ¡çš„å®ŒæˆçŠ¶æ€ï¼Œå¦‚æœå·²ç»å®Œæˆï¼Œç›´æ¥è¿”å›ç»“æœã€‚
å¦‚æœä»»åŠ¡å°šæœªå®Œæˆï¼Œä½†å¤„äºè‡ªå·±çš„å·¥ä½œé˜Ÿåˆ—å†…ï¼Œåˆ™å®Œæˆå®ƒã€‚
å¦‚æœä»»åŠ¡å·²ç»è¢«å…¶ä»–çš„å·¥ä½œçº¿ç¨‹å·èµ°ï¼Œåˆ™çªƒå–è¿™ä¸ªå°å·çš„å·¥ä½œé˜Ÿåˆ—å†…çš„ä»»åŠ¡ï¼ˆä»¥ FIFO æ–¹å¼ï¼‰ï¼Œæ‰§è¡Œï¼Œä»¥æœŸå¸®åŠ©å®ƒæ—©æ—¥å®Œæˆæ¬² join çš„ä»»åŠ¡ã€‚
å¦‚æœå·èµ°ä»»åŠ¡çš„å°å·ä¹Ÿå·²ç»æŠŠè‡ªå·±çš„ä»»åŠ¡å…¨éƒ¨åšå®Œï¼Œæ­£åœ¨ç­‰å¾…éœ€è¦ join çš„ä»»åŠ¡æ—¶ï¼Œåˆ™æ‰¾åˆ°å°å·çš„å°å·ï¼Œå¸®åŠ©å®ƒå®Œæˆå®ƒçš„ä»»åŠ¡ã€‚
é€’å½’åœ°æ‰§è¡Œç¬¬5æ­¥ã€‚
å°†ä¸Šè¿°æµç¨‹ç”»æˆåºåˆ—å›¾çš„è¯å°±æ˜¯è¿™ä¸ªæ ·å­ï¼š&lt;/p&gt;

&lt;h2 id=&quot;5forkjoinpoolsubmit-æ–¹æ³•&quot;&gt;5ã€ForkJoinPool.submit æ–¹æ³•&lt;/h2&gt;

&lt;p&gt;public &lt;T&gt; ForkJoinTask&lt;T&gt; submit(ForkJoinTask&lt;T&gt; task) {
    if (task == null)
        throw new NullPointerException();
//æäº¤åˆ°å·¥ä½œé˜Ÿåˆ—
    externalPush(task);
    return task;
}&lt;/T&gt;&lt;/T&gt;&lt;/T&gt;&lt;/p&gt;

&lt;p&gt;ForkJoinPool è‡ªèº«æ‹¥æœ‰å·¥ä½œé˜Ÿåˆ—ï¼Œè¿™äº›å·¥ä½œé˜Ÿåˆ—çš„ä½œç”¨æ˜¯ç”¨æ¥æ¥æ”¶ç”±å¤–éƒ¨çº¿ç¨‹ï¼ˆé ForkJoinThread çº¿ç¨‹ï¼‰æäº¤è¿‡æ¥çš„ä»»åŠ¡ï¼Œè€Œè¿™äº›å·¥ä½œé˜Ÿåˆ—è¢«ç§°ä¸º submitting queue ã€‚
submit() å’Œ fork() å…¶å®æ²¡æœ‰æœ¬è´¨åŒºåˆ«ï¼Œåªæ˜¯æäº¤å¯¹è±¡å˜æˆäº† submitting queue è€Œå·²ï¼ˆè¿˜æœ‰ä¸€äº›åŒæ­¥ï¼Œåˆå§‹åŒ–çš„æ“ä½œï¼‰ã€‚submitting queue å’Œå…¶ä»– work queue ä¸€æ ·ï¼Œæ˜¯å·¥ä½œçº¿ç¨‹â€çªƒå–â€œçš„å¯¹è±¡ï¼Œå› æ­¤å½“å…¶ä¸­çš„ä»»åŠ¡è¢«ä¸€ä¸ªå·¥ä½œçº¿ç¨‹æˆåŠŸçªƒå–æ—¶ï¼Œå°±æ„å‘³ç€æäº¤çš„ä»»åŠ¡çœŸæ­£å¼€å§‹è¿›å…¥æ‰§è¡Œé˜¶æ®µã€‚&lt;/p&gt;

&lt;h2 id=&quot;6forkjoinæ¡†æ¶æ‰§è¡Œæµç¨‹&quot;&gt;6ã€Fork/Joinæ¡†æ¶æ‰§è¡Œæµç¨‹&lt;/h2&gt;

&lt;p&gt;ForkJoinPool ä¸­çš„ä»»åŠ¡æ‰§è¡Œåˆ†ä¸¤ç§:
ç›´æ¥é€šè¿‡ FJP æäº¤çš„å¤–éƒ¨ä»»åŠ¡(external/submissions task)ï¼Œå­˜æ”¾åœ¨ workQueues çš„å¶æ•°æ§½ä½ï¼›
é€šè¿‡å†…éƒ¨ fork åˆ†å‰²çš„å­ä»»åŠ¡(Worker task)ï¼Œå­˜æ”¾åœ¨ workQueues çš„å¥‡æ•°æ§½ä½ã€‚&lt;/p&gt;</content><author><name>WenHao</name></author><summary type="html">ä»»åŠ¡æ€§è´¨ç±»å‹</summary></entry><entry><title type="html">å¹¶å‘ç¼–ç¨‹(åä¸€)-å¹¶å‘ç¼–ç¨‹ä¹‹å®šæ—¶ä»»åŠ¡&amp;amp;å®šæ—¶çº¿ç¨‹æ± </title><link href="http://localhost:4000/2020/07/11/ScheduleThread/" rel="alternate" type="text/html" title="å¹¶å‘ç¼–ç¨‹(åä¸€)-å¹¶å‘ç¼–ç¨‹ä¹‹å®šæ—¶ä»»åŠ¡&amp;å®šæ—¶çº¿ç¨‹æ± " /><published>2020-07-11T00:00:00+08:00</published><updated>2020-07-11T00:00:00+08:00</updated><id>http://localhost:4000/2020/07/11/ScheduleThread</id><content type="html" xml:base="http://localhost:4000/2020/07/11/ScheduleThread/">&lt;h1 id=&quot;scheduledthreadpoolexecutor&quot;&gt;ScheduledThreadPoolExecutor&lt;/h1&gt;

&lt;p&gt;å®šæ—¶çº¿ç¨‹æ± ç±»çš„ç±»ç»“æ„å›¾&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://gitee.com/fwh666/fwh_images/raw/master/fwh_images/clipboard.png&quot; alt=&quot;clipboard&quot; style=&quot;zoom:60%;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;å®ƒç”¨æ¥å¤„ç†å»¶æ—¶ä»»åŠ¡æˆ–å®šæ—¶ä»»åŠ¡ã€‚&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://gitee.com/fwh666/fwh_images/raw/master/fwh_images/image-20210724104605742.png&quot; alt=&quot;image-20210724104605742&quot; style=&quot;zoom:50%;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;å®ƒæ¥æ”¶SchduledFutureTaskç±»å‹çš„ä»»åŠ¡ï¼Œæ˜¯çº¿ç¨‹æ± è°ƒåº¦ä»»åŠ¡çš„æœ€å°å•ä½ï¼Œæœ‰ä¸‰ç§æäº¤ä»»åŠ¡çš„æ–¹å¼ï¼š
schedule
scheduledAtFixedRate
scheduledWithFixedDelay&lt;/p&gt;

&lt;p&gt;å®ƒé‡‡ç”¨DelayQueueå­˜å‚¨ç­‰å¾…çš„ä»»åŠ¡
DelayQueueå†…éƒ¨å°è£…äº†ä¸€ä¸ªPriorityQueueï¼Œå®ƒä¼šæ ¹æ®timeçš„å…ˆåæ—¶é—´æ’åºï¼Œè‹¥timeç›¸åŒåˆ™æ ¹æ®sequenceNumberæ’åºï¼›
DelayQueueä¹Ÿæ˜¯ä¸€ä¸ªæ— ç•Œé˜Ÿåˆ—ï¼›&lt;/p&gt;

&lt;h2 id=&quot;schduledfuturetask&quot;&gt;SchduledFutureTask&lt;/h2&gt;

&lt;p&gt;SchduledFutureTaskæ¥æ”¶çš„å‚æ•°(æˆå‘˜å˜é‡)ï¼š
private long timeï¼šä»»åŠ¡å¼€å§‹çš„æ—¶é—´
private final long sequenceNumber;ï¼šä»»åŠ¡çš„åºå·
private final long periodï¼šä»»åŠ¡æ‰§è¡Œçš„æ—¶é—´é—´éš”&lt;/p&gt;

&lt;h3 id=&quot;å·¥ä½œçº¿ç¨‹çš„æ‰§è¡Œè¿‡ç¨‹&quot;&gt;å·¥ä½œçº¿ç¨‹çš„æ‰§è¡Œè¿‡ç¨‹ï¼š&lt;/h3&gt;

&lt;p&gt;å·¥ä½œçº¿ç¨‹ä¼šä»DelayQueueå–å·²ç»åˆ°æœŸçš„ä»»åŠ¡å»æ‰§è¡Œï¼›
æ‰§è¡Œç»“æŸåé‡æ–°è®¾ç½®ä»»åŠ¡çš„åˆ°æœŸæ—¶é—´ï¼Œå†æ¬¡æ”¾å›DelayQueue&lt;/p&gt;

&lt;p&gt;ScheduledThreadPoolExecutorä¼šæŠŠå¾…æ‰§è¡Œçš„ä»»åŠ¡æ”¾åˆ°å·¥ä½œé˜Ÿåˆ—DelayQueueä¸­ï¼ŒDelayQueueå°è£…äº†ä¸€ä¸ªPriorityQueueï¼ŒPriorityQueueä¼šå¯¹é˜Ÿåˆ—ä¸­çš„ScheduledFutureTaskè¿›è¡Œæ’åºï¼Œå…·ä½“çš„æ’åºç®—æ³•å®ç°å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;compareTo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Delayed&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;other&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;other&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// compare zero if same object&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;other&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;instanceof&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ScheduledFutureTask&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;ScheduledFutureTask&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;?&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ScheduledFutureTask&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;?&amp;gt;)&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;other&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;diff&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;diff&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;diff&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sequenceNumber&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;sequenceNumber&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;diff&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;getDelay&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NANOSECONDS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;other&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getDelay&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NANOSECONDS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;diff&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;diff&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;é¦–å…ˆæŒ‰ç…§timeæ’åºï¼Œtimeå°çš„æ’åœ¨å‰é¢ï¼Œtimeå¤§çš„æ’åœ¨åé¢ï¼›
å¦‚æœtimeç›¸åŒï¼ŒæŒ‰ç…§sequenceNumberæ’åºï¼ŒsequenceNumberå°çš„æ’åœ¨å‰é¢ï¼ŒsequenceNumberå¤§çš„æ’åœ¨åé¢ï¼Œæ¢å¥è¯è¯´ï¼Œå¦‚æœä¸¤ä¸ªtaskçš„æ‰§è¡Œæ—¶é—´ç›¸åŒï¼Œä¼˜å…ˆæ‰§è¡Œå…ˆæäº¤çš„taskã€‚&lt;/p&gt;

&lt;p&gt;SchduledFutureTaskä¹‹runæ–¹æ³•å®ç°
runæ–¹æ³•æ˜¯è°ƒåº¦taskçš„æ ¸å¿ƒï¼Œtaskçš„æ‰§è¡Œå®é™…ä¸Šæ˜¯runæ–¹æ³•çš„æ‰§è¡Œã€‚&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;periodic&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;isPeriodic&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;//å¦‚æœå½“å‰çº¿ç¨‹æ± å·²ç»ä¸æ”¯æŒæ‰§è¡Œä»»åŠ¡ï¼Œåˆ™å–æ¶ˆ&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;canRunInCurrentRunState&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;periodic&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;cancel&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;//å¦‚æœä¸éœ€è¦å‘¨æœŸæ€§æ‰§è¡Œï¼Œåˆ™ç›´æ¥æ‰§è¡Œrunæ–¹æ³•ç„¶åç»“æŸ&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;periodic&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;ScheduledFutureTask&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;super&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;//å¦‚æœéœ€è¦å‘¨æœŸæ‰§è¡Œï¼Œåˆ™åœ¨æ‰§è¡Œå®Œä»»åŠ¡ä»¥åï¼Œè®¾ç½®ä¸‹ä¸€æ¬¡æ‰§è¡Œæ—¶é—´&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ScheduledFutureTask&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;super&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;runAndReset&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;())&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// è®¡ç®—ä¸‹æ¬¡æ‰§è¡Œè¯¥ä»»åŠ¡çš„æ—¶é—´&lt;/span&gt;
 &lt;span class=&quot;n&quot;&gt;setNextRunTime&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
 &lt;span class=&quot;c1&quot;&gt;//é‡å¤æ‰§è¡Œä»»åŠ¡&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;reExecutePeriodic&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;outerTask&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;å¦‚æœå½“å‰çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€ä¸å¯ä»¥æ‰§è¡Œä»»åŠ¡ï¼Œå–æ¶ˆè¯¥ä»»åŠ¡ï¼Œç„¶åç›´æ¥è¿”å›ï¼Œå¦åˆ™æ‰§è¡Œæ­¥éª¤2ï¼›
å¦‚æœä¸æ˜¯å‘¨æœŸæ€§ä»»åŠ¡ï¼Œè°ƒç”¨FutureTaskä¸­çš„runæ–¹æ³•æ‰§è¡Œï¼Œä¼šè®¾ç½®æ‰§è¡Œç»“æœï¼Œç„¶åç›´æ¥è¿”å›ï¼Œå¦åˆ™æ‰§è¡Œæ­¥éª¤3ï¼›
å¦‚æœæ˜¯å‘¨æœŸæ€§ä»»åŠ¡ï¼Œè°ƒç”¨FutureTaskä¸­çš„runAndResetæ–¹æ³•æ‰§è¡Œï¼Œä¸ä¼šè®¾ç½®æ‰§è¡Œç»“æœï¼Œç„¶åç›´æ¥è¿”å›ï¼Œå¦åˆ™æ‰§è¡Œæ­¥éª¤4å’Œæ­¥éª¤5ï¼›
è®¡ç®—ä¸‹æ¬¡æ‰§è¡Œè¯¥ä»»åŠ¡çš„å…·ä½“æ—¶é—´ï¼›
é‡å¤æ‰§è¡Œä»»åŠ¡ã€‚&lt;/p&gt;

&lt;p&gt;reExecutePeriodicæ–¹æ³•&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;reExecutePeriodic&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;RunnableScheduledFuture&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;?&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;task&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;canRunInCurrentRunState&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;kd&quot;&gt;super&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getQueue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;add&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;task&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;canRunInCurrentRunState&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;remove&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;task&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;task&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;cancel&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
            &lt;span class=&quot;nf&quot;&gt;ensurePrestart&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;


&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;è¯¥æ–¹æ³•å’ŒdelayedExecuteæ–¹æ³•ç±»ä¼¼ï¼Œä¸åŒçš„æ˜¯ï¼š
ç”±äºè°ƒç”¨reExecutePeriodicæ–¹æ³•æ—¶å·²ç»æ‰§è¡Œè¿‡ä¸€æ¬¡å‘¨æœŸæ€§ä»»åŠ¡äº†ï¼Œæ‰€ä»¥ä¸ä¼šrejectå½“å‰ä»»åŠ¡ï¼›
ä¼ å…¥çš„ä»»åŠ¡ä¸€å®šæ˜¯å‘¨æœŸæ€§ä»»åŠ¡ã€‚&lt;/p&gt;

&lt;p&gt;çº¿ç¨‹æ± ä»»åŠ¡çš„æäº¤
é¦–å…ˆæ˜¯scheduleæ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ˜¯æŒ‡ä»»åŠ¡åœ¨æŒ‡å®šå»¶è¿Ÿæ—¶é—´åˆ°è¾¾åè§¦å‘ï¼Œåªä¼šæ‰§è¡Œä¸€æ¬¡ã€‚&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ScheduledFuture&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;?&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;schedule&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Runnable&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;
                                   &lt;span class=&quot;kt&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;delay&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;
                                   &lt;span class=&quot;n&quot;&gt;TimeUnit&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;unit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;//å‚æ•°æ ¡éªŒ&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;command&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;unit&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;NullPointerException&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;//è¿™é‡Œæ˜¯ä¸€ä¸ªåµŒå¥—ç»“æ„ï¼Œé¦–å…ˆæŠŠç”¨æˆ·æäº¤çš„ä»»åŠ¡åŒ…è£…æˆScheduledFutureTask&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;//ç„¶ååœ¨è°ƒç”¨decorateTaskè¿›è¡ŒåŒ…è£…ï¼Œè¯¥æ–¹æ³•æ˜¯ç•™ç»™ç”¨æˆ·å»æ‰©å±•çš„ï¼Œé»˜è®¤æ˜¯ä¸ªç©ºæ–¹æ³•&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;RunnableScheduledFuture&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;?&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;decorateTask&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ScheduledFutureTask&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Void&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;
                                      &lt;span class=&quot;n&quot;&gt;triggerTime&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;delay&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;unit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)));&lt;/span&gt;
   &lt;span class=&quot;c1&quot;&gt;//åŒ…è£…å¥½ä»»åŠ¡ä»¥åï¼Œå°±è¿›è¡Œæäº¤äº†&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;delayedExecute&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;ä»»åŠ¡æäº¤æ–¹æ³•ï¼š&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;delayedExecute&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;RunnableScheduledFuture&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;?&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;task&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;//å¦‚æœçº¿ç¨‹æ± å·²ç»å…³é—­ï¼Œåˆ™ä½¿ç”¨æ‹’ç»ç­–ç•¥æŠŠæäº¤ä»»åŠ¡æ‹’ç»æ‰&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;isShutdown&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;())&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;reject&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;task&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;//ä¸ThreadPoolExecutorä¸åŒï¼Œè¿™é‡Œç›´æ¥æŠŠä»»åŠ¡åŠ å…¥å»¶è¿Ÿé˜Ÿåˆ—&lt;/span&gt;
        &lt;span class=&quot;kd&quot;&gt;super&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getQueue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;add&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;task&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;//ä½¿ç”¨ç”¨çš„DelayedWorkQueue&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;//å¦‚æœå½“å‰çŠ¶æ€æ— æ³•æ‰§è¡Œä»»åŠ¡ï¼Œåˆ™å–æ¶ˆ&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;isShutdown&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;canRunInCurrentRunState&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;task&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;isPeriodic&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;())&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;remove&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;task&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;task&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;cancel&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;//è¿™é‡Œæ˜¯å¢åŠ ä¸€ä¸ªworkerçº¿ç¨‹ï¼Œé¿å…æäº¤çš„ä»»åŠ¡æ²¡æœ‰workerå»æ‰§è¡Œ&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;//åŸå› å°±æ˜¯è¯¥ç±»æ²¡æœ‰åƒThreadPoolExecutorä¸€æ ·ï¼Œwokeræ»¡äº†æ‰æ”¾å…¥é˜Ÿåˆ—&lt;/span&gt;
          &lt;span class=&quot;n&quot;&gt;ensurePrestart&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;DelayedWorkQueue
ScheduledThreadPoolExecutorä¹‹æ‰€ä»¥è¦è‡ªå·±å®ç°é˜»å¡çš„å·¥ä½œé˜Ÿåˆ—ï¼Œæ˜¯å› ä¸ºScheduledThreadPoolExecutorè¦æ±‚çš„å·¥ä½œé˜Ÿåˆ—æœ‰äº›ç‰¹æ®Šã€‚
DelayedWorkQueueæ˜¯ä¸€ä¸ªåŸºäºå †çš„æ•°æ®ç»“æ„ï¼Œç±»ä¼¼äºDelayQueueå’ŒPriorityQueueã€‚åœ¨æ‰§è¡Œå®šæ—¶ä»»åŠ¡çš„æ—¶å€™ï¼Œæ¯ä¸ªä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´éƒ½ä¸åŒï¼Œæ‰€ä»¥DelayedWorkQueueçš„å·¥ä½œå°±æ˜¯æŒ‰ç…§æ‰§è¡Œæ—¶é—´çš„å‡åºæ¥æ’åˆ—ï¼Œæ‰§è¡Œæ—¶é—´è·ç¦»å½“å‰æ—¶é—´è¶Šè¿‘çš„ä»»åŠ¡åœ¨é˜Ÿåˆ—çš„å‰é¢ï¼ˆæ³¨æ„ï¼šè¿™é‡Œçš„é¡ºåºå¹¶ä¸æ˜¯ç»å¯¹çš„ï¼Œå †ä¸­çš„æ’åºåªä¿è¯äº†å­èŠ‚ç‚¹çš„ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´è¦æ¯”çˆ¶èŠ‚ç‚¹çš„ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´è¦å¤§ï¼Œè€Œå¶å­èŠ‚ç‚¹ä¹‹é—´å¹¶ä¸ä¸€å®šæ˜¯é¡ºåºçš„ï¼Œä¸‹æ–‡ä¸­ä¼šè¯´æ˜ï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;å †ç»“æ„å¦‚ä¸‹å›¾ï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://gitee.com/fwh666/fwh_images/raw/master/fwh_images/image-20210724104831530.png&quot; alt=&quot;image-20210724104831530&quot; style=&quot;zoom:50%;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;å¯è§ï¼ŒDelayedWorkQueueæ˜¯ä¸€ä¸ªåŸºäºæœ€å°å †ç»“æ„çš„é˜Ÿåˆ—ã€‚å †ç»“æ„å¯ä»¥ä½¿ç”¨æ•°ç»„è¡¨ç¤ºï¼Œå¯ä»¥è½¬æ¢æˆå¦‚ä¸‹çš„æ•°ç»„ï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://gitee.com/fwh666/fwh_images/raw/master/fwh_images/image-20210724104844534.png&quot; alt=&quot;image-20210724104844534&quot; style=&quot;zoom:50%;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;åœ¨è¿™ç§ç»“æ„ä¸­ï¼Œå¯ä»¥å‘ç°æœ‰å¦‚ä¸‹ç‰¹æ€§ï¼š
å‡è®¾ï¼Œç´¢å¼•å€¼ä»0å¼€å§‹ï¼Œå­èŠ‚ç‚¹çš„ç´¢å¼•å€¼ä¸ºkï¼Œçˆ¶èŠ‚ç‚¹çš„ç´¢å¼•å€¼ä¸ºpï¼Œåˆ™ï¼š
ä¸€ä¸ªèŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹çš„ç´¢å¼•ä¸ºï¼šk = p * 2 + 1ï¼›
ä¸€ä¸ªèŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹çš„ç´¢å¼•ä¸ºï¼šk = (p + 1) * 2ï¼›
ä¸€ä¸ªèŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹çš„ç´¢å¼•ä¸ºï¼šp = (k - 1) / 2ã€‚
ä¸ºä»€ä¹ˆè¦ä½¿ç”¨DelayedWorkQueueå‘¢ï¼Ÿ
å®šæ—¶ä»»åŠ¡æ‰§è¡Œæ—¶éœ€è¦å–å‡ºæœ€è¿‘è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼Œæ‰€ä»¥ä»»åŠ¡åœ¨é˜Ÿåˆ—ä¸­æ¯æ¬¡å‡ºé˜Ÿæ—¶ä¸€å®šè¦æ˜¯å½“å‰é˜Ÿåˆ—ä¸­æ‰§è¡Œæ—¶é—´æœ€é å‰çš„ï¼Œæ‰€ä»¥è‡ªç„¶è¦ä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—ã€‚
DelayedWorkQueueæ˜¯ä¸€ä¸ªä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œå®ƒå¯ä»¥ä¿è¯æ¯æ¬¡å‡ºé˜Ÿçš„ä»»åŠ¡éƒ½æ˜¯å½“å‰é˜Ÿåˆ—ä¸­æ‰§è¡Œæ—¶é—´æœ€é å‰çš„ï¼Œç”±äºå®ƒæ˜¯åŸºäºå †ç»“æ„çš„é˜Ÿåˆ—ï¼Œå †ç»“æ„åœ¨æ‰§è¡Œæ’å…¥å’Œåˆ é™¤æ“ä½œæ—¶çš„æœ€åæ—¶é—´å¤æ‚åº¦æ˜¯ O(logN)ã€‚&lt;/p&gt;

&lt;h3 id=&quot;delayedworkqueueå±æ€§&quot;&gt;DelayedWorkQueueå±æ€§&lt;/h3&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;// é˜Ÿåˆ—åˆå§‹å®¹é‡&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;INITIAL_CAPACITY&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// æ ¹æ®åˆå§‹å®¹é‡åˆ›å»ºRunnableScheduledFutureç±»å‹çš„æ•°ç»„&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RunnableScheduledFuture&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;?&amp;gt;[]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;queue&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RunnableScheduledFuture&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;?&amp;gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;INITIAL_CAPACITY&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;];&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ReentrantLock&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lock&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ReentrantLock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;size&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// leaderçº¿ç¨‹&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Thread&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;leader&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// å½“è¾ƒæ–°çš„ä»»åŠ¡åœ¨é˜Ÿåˆ—çš„å¤´éƒ¨å¯ç”¨æ—¶ï¼Œæˆ–è€…æ–°çº¿ç¨‹å¯èƒ½éœ€è¦æˆä¸ºleaderï¼Œåˆ™é€šè¿‡è¯¥æ¡ä»¶å‘å‡ºä¿¡å·&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Condition&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;available&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;newCondition&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;æ³¨æ„è¿™é‡Œçš„leaderï¼Œå®ƒæ˜¯Leader-Followeræ¨¡å¼çš„å˜ä½“ï¼Œç”¨äºå‡å°‘ä¸å¿…è¦çš„å®šæ—¶ç­‰å¾…ã€‚ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿå¯¹äºå¤šçº¿ç¨‹çš„ç½‘ç»œæ¨¡å‹æ¥è¯´ï¼š
æ‰€æœ‰çº¿ç¨‹ä¼šæœ‰ä¸‰ç§èº«ä»½ä¸­çš„ä¸€ç§ï¼šleaderå’Œfollowerï¼Œä»¥åŠä¸€ä¸ªå¹²æ´»ä¸­çš„çŠ¶æ€ï¼šproccesserã€‚å®ƒçš„åŸºæœ¬åŸåˆ™å°±æ˜¯ï¼Œæ°¸è¿œæœ€å¤šåªæœ‰ä¸€ä¸ªleaderã€‚è€Œæ‰€æœ‰followeréƒ½åœ¨ç­‰å¾…æˆä¸ºleaderã€‚çº¿ç¨‹æ± å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨äº§ç”Ÿä¸€ä¸ªLeaderè´Ÿè´£ç­‰å¾…ç½‘ç»œIOäº‹ä»¶ï¼Œå½“æœ‰ä¸€ä¸ªäº‹ä»¶äº§ç”Ÿæ—¶ï¼ŒLeaderçº¿ç¨‹é¦–å…ˆé€šçŸ¥ä¸€ä¸ªFollowerçº¿ç¨‹å°†å…¶ææ‹”ä¸ºæ–°çš„Leaderï¼Œç„¶åè‡ªå·±å°±å»å¹²æ´»äº†ï¼Œå»å¤„ç†è¿™ä¸ªç½‘ç»œäº‹ä»¶ï¼Œå¤„ç†å®Œæ¯•ååŠ å…¥Followerçº¿ç¨‹ç­‰å¾…é˜Ÿåˆ—ï¼Œç­‰å¾…ä¸‹æ¬¡æˆä¸ºLeaderã€‚è¿™ç§æ–¹æ³•å¯ä»¥å¢å¼ºCPUé«˜é€Ÿç¼“å­˜ç›¸ä¼¼æ€§ï¼ŒåŠæ¶ˆé™¤åŠ¨æ€å†…å­˜åˆ†é…å’Œçº¿ç¨‹é—´çš„æ•°æ®äº¤æ¢ã€‚&lt;/p&gt;

&lt;h3 id=&quot;offeræ–¹æ³•&quot;&gt;offeræ–¹æ³•&lt;/h3&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;offer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Runnable&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;//å‚æ•°æ ¡éªŒ&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;NullPointerException&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;RunnableScheduledFuture&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;?&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;RunnableScheduledFuture&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;?&amp;gt;)&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ReentrantLock&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lock&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;lock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;lock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;lock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;//æŸ¥çœ‹å½“å‰å…ƒç´ æ•°é‡ï¼Œå¦‚æœå¤§äºé˜Ÿåˆ—é•¿åº¦åˆ™è¿›è¡Œæ‰©å®¹&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;queue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;grow&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;//å…ƒç´ æ•°é‡åŠ 1&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;size&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;//å¦‚æœå½“å‰é˜Ÿåˆ—è¿˜æ²¡æœ‰å…ƒç´ ï¼Œåˆ™ç›´æ¥åŠ å…¥å¤´éƒ¨&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;queue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;//è®°å½•ç´¢å¼•&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;setIndex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
 &lt;span class=&quot;c1&quot;&gt;//æŠŠä»»åŠ¡åŠ å…¥å †ä¸­ï¼Œå¹¶è°ƒæ•´å †ç»“æ„ï¼Œè¿™é‡Œå°±ä¼šæ ¹æ®ä»»åŠ¡çš„è§¦å‘æ—¶é—´æ’åˆ—&lt;/span&gt;
             &lt;span class=&quot;c1&quot;&gt;//æŠŠéœ€è¦æœ€æ—©æ‰§è¡Œçš„ä»»åŠ¡æ”¾åœ¨å‰é¢&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;siftUp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;//å¦‚æœæ–°åŠ å…¥çš„å…ƒç´ å°±æ˜¯é˜Ÿåˆ—å¤´ï¼Œè¿™é‡Œæœ‰ä¸¤ç§æƒ…å†µ&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;//1.è¿™æ˜¯ç”¨æˆ·æäº¤çš„ç¬¬ä¸€ä¸ªä»»åŠ¡&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;//2.æ–°ä»»åŠ¡è¿›è¡Œå †è°ƒæ•´ä»¥åï¼Œæ’åœ¨é˜Ÿåˆ—å¤´&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;queue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// leaderè®¾ç½®ä¸ºnullä¸ºäº†ä½¿åœ¨takeæ–¹æ³•ä¸­çš„çº¿ç¨‹åœ¨é€šè¿‡available.signal();åä¼šæ‰§è¡Œavailable.awaitNanos(delay);&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;leader&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;//åŠ å…¥å…ƒç´ ä»¥åï¼Œå”¤é†’workerçº¿ç¨‹&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;available&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;signal&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;finally&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;lock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;unlock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;err&quot;&gt;ä»»åŠ¡æ’åº&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sift&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;æ–¹æ³•&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;siftUp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RunnableScheduledFuture&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;?&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// æ‰¾åˆ°çˆ¶èŠ‚ç‚¹çš„ç´¢å¼•&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// è·å–çˆ¶èŠ‚ç‚¹&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;parent&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;RunnableScheduledFuture&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;?&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;queue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;parent&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;];&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// å¦‚æœkeyèŠ‚ç‚¹çš„æ‰§è¡Œæ—¶é—´å¤§äºçˆ¶èŠ‚ç‚¹çš„æ‰§è¡Œæ—¶é—´ï¼Œä¸éœ€è¦å†æ’åºäº†&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;compareTo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
 &lt;span class=&quot;c1&quot;&gt;// å¦‚æœkey.compareTo(e) &amp;lt; 0ï¼Œè¯´æ˜keyèŠ‚ç‚¹çš„æ‰§è¡Œæ—¶é—´å°äºçˆ¶èŠ‚ç‚¹çš„æ‰§è¡Œæ—¶é—´ï¼Œéœ€è¦æŠŠçˆ¶èŠ‚ç‚¹ç§»åˆ°åé¢&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;queue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;setIndex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// è®¾ç½®ç´¢å¼•ä¸ºk&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;parent&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// keyè®¾ç½®ä¸ºæ’åºåçš„ä½ç½®ä¸­&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;queue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;setIndex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;ä»£ç å¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯å¾ªç¯çš„æ ¹æ®keyèŠ‚ç‚¹ä¸å®ƒçš„çˆ¶èŠ‚ç‚¹æ¥åˆ¤æ–­ï¼Œå¦‚æœkeyèŠ‚ç‚¹çš„æ‰§è¡Œæ—¶é—´å°äºçˆ¶èŠ‚ç‚¹ï¼Œåˆ™å°†ä¸¤ä¸ªèŠ‚ç‚¹äº¤æ¢ï¼Œä½¿æ‰§è¡Œæ—¶é—´é å‰çš„èŠ‚ç‚¹æ’åˆ—åœ¨é˜Ÿåˆ—çš„å‰é¢ã€‚
å‡è®¾æ–°å…¥é˜Ÿçš„èŠ‚ç‚¹çš„å»¶è¿Ÿæ—¶é—´ï¼ˆè°ƒç”¨getDelay()æ–¹æ³•è·å¾—ï¼‰æ˜¯5ï¼Œæ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼š
å…ˆå°†æ–°çš„èŠ‚ç‚¹æ·»åŠ åˆ°æ•°ç»„çš„å°¾éƒ¨ï¼Œè¿™æ—¶æ–°èŠ‚ç‚¹çš„ç´¢å¼•kä¸º7ï¼š&lt;/p&gt;

&lt;p&gt;è®¡ç®—æ–°çˆ¶èŠ‚ç‚¹çš„ç´¢å¼•ï¼šparent = (k - 1)Â Â»&amp;gt; 1ï¼Œparent = 3ï¼Œé‚£ä¹ˆqueue[3]çš„æ—¶é—´é—´éš”å€¼ä¸º8ï¼Œå› ä¸º 5 &amp;lt; 8 ï¼Œå°†æ‰§è¡Œqueue[7] = queue[3]ï¼š&lt;/p&gt;

&lt;p&gt;è¿™æ—¶å°†kè®¾ç½®ä¸º3ï¼Œç»§ç»­å¾ªç¯ï¼Œå†æ¬¡è®¡ç®—parentä¸º1ï¼Œqueue[1]çš„æ—¶é—´é—´éš”ä¸º3ï¼Œå› ä¸º 5 &amp;gt; 3 ï¼Œè¿™æ—¶é€€å‡ºå¾ªç¯ï¼Œæœ€ç»ˆkä¸º3ï¼š&lt;/p&gt;

&lt;p&gt;å¯è§ï¼Œæ¯æ¬¡æ–°å¢èŠ‚ç‚¹æ—¶ï¼Œåªæ˜¯æ ¹æ®çˆ¶èŠ‚ç‚¹æ¥åˆ¤æ–­ï¼Œè€Œä¸ä¼šå½±å“å…„å¼ŸèŠ‚ç‚¹ã€‚&lt;/p&gt;

&lt;h3 id=&quot;takeæ–¹æ³•&quot;&gt;takeæ–¹æ³•&lt;/h3&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;public RunnableScheduledFuture&amp;lt;?&amp;gt; take() throws InterruptedException {
    final ReentrantLock lock = this.lock;
    lock.lockInterruptibly();
    try {
        for (;;) {
            RunnableScheduledFuture&amp;lt;?&amp;gt; first = queue[0];
            if (first == null)
                available.await();
            else {
// è®¡ç®—å½“å‰æ—¶é—´åˆ°æ‰§è¡Œæ—¶é—´çš„æ—¶é—´é—´éš”
                long delay = first.getDelay(NANOSECONDS);
                if (delay &amp;lt;= 0)
                    return finishPoll(first);
                first = null; // don't retain ref while waiting
                // leaderä¸ä¸ºç©ºï¼Œé˜»å¡çº¿ç¨‹
if (leader != null)
                    available.await();
                else {
                    // leaderä¸ºç©ºï¼Œåˆ™æŠŠleaderè®¾ç½®ä¸ºå½“å‰çº¿ç¨‹ï¼Œ
Thread thisThread = Thread.currentThread();
                    leader = thisThread;
                    try {
                       // é˜»å¡åˆ°æ‰§è¡Œæ—¶é—´ 
available.awaitNanos(delay);
                    } finally {
// è®¾ç½®leader = nullï¼Œè®©å…¶ä»–çº¿ç¨‹æ‰§è¡Œavailable.awaitNanos(delay);
                        if (leader == thisThread)
                            leader = null;
                    }
                }
            }
        }
    } finally {
// å¦‚æœleaderä¸ä¸ºç©ºï¼Œåˆ™è¯´æ˜leaderçš„çº¿ç¨‹æ­£åœ¨æ‰§è¡Œavailable.awaitNanos(delay);
        // å¦‚æœqueue[0] == nullï¼Œè¯´æ˜é˜Ÿåˆ—ä¸ºç©º
        if (leader == null &amp;amp;&amp;amp; queue[0] != null)
            available.signal();
        lock.unlock();
    }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;takeæ–¹æ³•æ˜¯ä»€ä¹ˆæ—¶å€™è°ƒç”¨çš„å‘¢ï¼Ÿåœ¨ThreadPoolExecutorä¸­ï¼Œä»‹ç»äº†getTaskæ–¹æ³•ï¼Œå·¥ä½œçº¿ç¨‹ä¼šå¾ªç¯åœ°ä»workQueueä¸­å–ä»»åŠ¡ã€‚ä½†å®šæ—¶ä»»åŠ¡å´ä¸åŒï¼Œå› ä¸ºå¦‚æœä¸€æ—¦getTaskæ–¹æ³•å–å‡ºäº†ä»»åŠ¡å°±å¼€å§‹æ‰§è¡Œäº†ï¼Œè€Œè¿™æ—¶å¯èƒ½è¿˜æ²¡æœ‰åˆ°æ‰§è¡Œçš„æ—¶é—´ï¼Œæ‰€ä»¥åœ¨takeæ–¹æ³•ä¸­ï¼Œè¦ä¿è¯åªæœ‰åœ¨åˆ°æŒ‡å®šçš„æ‰§è¡Œæ—¶é—´çš„æ—¶å€™ä»»åŠ¡æ‰å¯ä»¥è¢«å–èµ°ã€‚
å†æ¥è¯´ä¸€ä¸‹leaderçš„ä½œç”¨ï¼Œè¿™é‡Œçš„leaderæ˜¯ä¸ºäº†å‡å°‘ä¸å¿…è¦çš„å®šæ—¶ç­‰å¾…ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹æˆä¸ºleaderæ—¶ï¼Œå®ƒåªç­‰å¾…ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„æ—¶é—´é—´éš”ï¼Œä½†å…¶å®ƒçº¿ç¨‹æ— é™æœŸç­‰å¾…ã€‚ leaderçº¿ç¨‹å¿…é¡»åœ¨ä»takeï¼ˆï¼‰æˆ–pollï¼ˆï¼‰è¿”å›ä¹‹å‰signalå…¶å®ƒçº¿ç¨‹ï¼Œé™¤éå…¶ä»–çº¿ç¨‹æˆä¸ºäº†leaderã€‚
ä¸¾ä¾‹æ¥è¯´ï¼Œå¦‚æœæ²¡æœ‰leaderï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œtakeæ—¶ï¼Œéƒ½è¦æ‰§è¡Œavailable.awaitNanos(delay)ï¼Œå‡è®¾å½“å‰çº¿ç¨‹æ‰§è¡Œäº†è¯¥æ®µä»£ç ï¼Œè¿™æ—¶è¿˜æ²¡æœ‰signalï¼Œç¬¬äºŒä¸ªçº¿ç¨‹ä¹Ÿæ‰§è¡Œäº†è¯¥æ®µä»£ç ï¼Œåˆ™ç¬¬äºŒä¸ªçº¿ç¨‹ä¹Ÿè¦è¢«é˜»å¡ã€‚å¤šä¸ªè¿™æ—¶æ‰§è¡Œè¯¥æ®µä»£ç æ˜¯æ²¡æœ‰ä½œç”¨çš„ï¼Œå› ä¸ºåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šä»takeä¸­è¿”å›queue[0]ï¼ˆå› ä¸ºæœ‰lockï¼‰ï¼Œå…¶ä»–çº¿ç¨‹è¿™æ—¶å†è¿”å›forå¾ªç¯æ‰§è¡Œæ—¶å–çš„queue[0]ï¼Œå·²ç»ä¸æ˜¯ä¹‹å‰çš„queue[0]äº†ï¼Œç„¶ååˆè¦ç»§ç»­é˜»å¡ã€‚
æ‰€ä»¥ï¼Œä¸ºäº†ä¸è®©å¤šä¸ªçº¿ç¨‹é¢‘ç¹çš„åšæ— ç”¨çš„å®šæ—¶ç­‰å¾…ï¼Œè¿™é‡Œå¢åŠ äº†leaderï¼Œå¦‚æœleaderä¸ä¸ºç©ºï¼Œåˆ™è¯´æ˜é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å·²ç»åœ¨ç­‰å¾…å‡ºé˜Ÿï¼Œè¿™æ—¶å…¶å®ƒçš„çº¿ç¨‹ä¼šä¸€ç›´é˜»å¡ï¼Œå‡å°‘äº†æ— ç”¨çš„é˜»å¡ï¼ˆæ³¨æ„ï¼Œåœ¨finallyä¸­è°ƒç”¨äº†signal()æ¥å”¤é†’ä¸€ä¸ªçº¿ç¨‹ï¼Œè€Œä¸æ˜¯signalAll()ï¼‰ã€‚&lt;/p&gt;

&lt;h3 id=&quot;poll-æ–¹æ³•&quot;&gt;poll æ–¹æ³•&lt;/h3&gt;

&lt;p&gt;ä¸‹é¢çœ‹ä¸‹pollæ–¹æ³•ï¼Œä¸takeç±»ä¼¼ï¼Œä½†è¿™é‡Œè¦æä¾›è¶…æ—¶åŠŸèƒ½ï¼š&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RunnableScheduledFuture&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;?&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;poll&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;timeout&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TimeUnit&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;unit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;InterruptedException&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nanos&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;unit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;toNanos&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;timeout&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ReentrantLock&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lock&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;lock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;lock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;lockInterruptibly&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(;;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;RunnableScheduledFuture&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;?&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;first&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;queue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;];&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;first&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nanos&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
                    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
                    &lt;span class=&quot;n&quot;&gt;nanos&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;available&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;awaitNanos&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nanos&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;kt&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;delay&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;first&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getDelay&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NANOSECONDS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// å¦‚æœdelay &amp;lt;= 0ï¼Œè¯´æ˜å·²ç»åˆ°äº†ä»»åŠ¡æ‰§è¡Œçš„æ—¶é—´ï¼Œè¿”å›ã€‚&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;delay&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
                    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;finishPoll&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;first&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// å¦‚æœnanos &amp;lt;= 0ï¼Œè¯´æ˜å·²ç»è¶…æ—¶ï¼Œè¿”å›null&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nanos&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
                    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;first&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// don't retain ref while waiting&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// nanos &amp;lt; delay è¯´æ˜éœ€è¦ç­‰å¾…çš„æ—¶é—´å°äºä»»åŠ¡è¦æ‰§è¡Œçš„å»¶è¿Ÿæ—¶é—´&lt;/span&gt;
                &lt;span class=&quot;c1&quot;&gt;// leader != null è¯´æ˜æœ‰å…¶å®ƒçº¿ç¨‹æ­£åœ¨å¯¹ä»»åŠ¡è¿›è¡Œé˜»å¡&lt;/span&gt;
                &lt;span class=&quot;c1&quot;&gt;// è¿™æ—¶é˜»å¡å½“å‰çº¿ç¨‹nanosçº³ç§’&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nanos&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;delay&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;leader&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
                    &lt;span class=&quot;n&quot;&gt;nanos&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;available&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;awaitNanos&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nanos&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;n&quot;&gt;Thread&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;thisThread&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Thread&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;currentThread&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
                    &lt;span class=&quot;n&quot;&gt;leader&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;thisThread&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                    &lt;span class=&quot;k&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// è¿™é‡Œçš„timeLeftè¡¨ç¤ºdelayå‡å»å®é™…çš„ç­‰å¾…æ—¶é—´&lt;/span&gt;
                        &lt;span class=&quot;kt&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;timeLeft&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;available&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;awaitNanos&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;delay&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
                       &lt;span class=&quot;c1&quot;&gt;// è®¡ç®—å‰©ä½™çš„ç­‰å¾…æ—¶é—´ &lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;nanos&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;delay&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;timeLeft&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;finally&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;leader&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;thisThread&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
                            &lt;span class=&quot;n&quot;&gt;leader&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
                &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;finally&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;leader&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;queue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;available&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;signal&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;lock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;unlock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;finishpollæ–¹æ³•&quot;&gt;finishPollæ–¹æ³•&lt;/h3&gt;

&lt;p&gt;å½“è°ƒç”¨äº†takeæˆ–è€…pollæ–¹æ³•èƒ½å¤Ÿè·å–åˆ°ä»»åŠ¡æ—¶ï¼Œä¼šè°ƒç”¨è¯¥æ–¹æ³•è¿›è¡Œè¿”å›ï¼š&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RunnableScheduledFuture&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;?&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;finishPoll&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;RunnableScheduledFuture&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;?&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// æ•°ç»„é•¿åº¦-1&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;s&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// å–å‡ºæœ€åä¸€ä¸ªèŠ‚ç‚¹&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;RunnableScheduledFuture&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;?&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;queue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;];&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;queue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// é•¿åº¦ä¸ä¸º0ï¼Œåˆ™ä»ç¬¬ä¸€ä¸ªå…ƒç´ å¼€å§‹æ’åºï¼Œç›®çš„æ˜¯è¦æŠŠæœ€åä¸€ä¸ªèŠ‚ç‚¹æ”¾åˆ°åˆé€‚çš„ä½ç½®ä¸Š&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;s&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;siftDown&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;setIndex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;siftdownæ–¹æ³•&quot;&gt;siftDownæ–¹æ³•&lt;/h3&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;siftDown&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;æ–¹æ³•ä½¿å †ä»&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;å¼€å§‹å‘ä¸‹è°ƒæ•´ï¼š&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;siftDown&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RunnableScheduledFuture&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;?&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// æ ¹æ®äºŒå‰æ ‘çš„ç‰¹æ€§ï¼Œæ•°ç»„é•¿åº¦é™¤ä»¥2ï¼Œè¡¨ç¤ºå–æœ‰å­èŠ‚ç‚¹çš„ç´¢å¼•&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;half&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;size&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// åˆ¤æ–­ç´¢å¼•ä¸ºkçš„èŠ‚ç‚¹æ˜¯å¦æœ‰å­èŠ‚ç‚¹&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;half&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// å·¦å­èŠ‚ç‚¹çš„ç´¢å¼•&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;child&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;RunnableScheduledFuture&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;?&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;queue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;child&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;];&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// å³å­èŠ‚ç‚¹çš„ç´¢å¼•&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;right&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;child&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// å¦‚æœæœ‰å³å­èŠ‚ç‚¹å¹¶ä¸”å·¦å­èŠ‚ç‚¹çš„æ—¶é—´é—´éš”å¤§äºå³å­èŠ‚ç‚¹ï¼Œå–æ—¶é—´é—´éš”æœ€å°çš„èŠ‚ç‚¹&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;right&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;size&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;compareTo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;queue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;right&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;queue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;child&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;right&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;];&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// å¦‚æœkeyçš„æ—¶é—´é—´éš”å°äºç­‰äºcçš„æ—¶é—´é—´éš”ï¼Œè·³å‡ºå¾ªç¯&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;compareTo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// è®¾ç½®è¦ç§»é™¤ç´¢å¼•çš„èŠ‚ç‚¹ä¸ºå…¶å­èŠ‚ç‚¹&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;queue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;setIndex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;child&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// å°†keyæ”¾å…¥ç´¢å¼•ä¸ºkçš„ä½ç½®&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;queue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;setIndex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;siftDownæ–¹æ³•æ‰§è¡Œæ—¶åŒ…å«ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯æ²¡æœ‰å­èŠ‚ç‚¹ï¼Œä¸€ç§æ˜¯æœ‰å­èŠ‚ç‚¹ï¼ˆæ ¹æ®halfåˆ¤æ–­ï¼‰ã€‚ä¾‹å¦‚ï¼š
æ²¡æœ‰å­èŠ‚ç‚¹çš„æƒ…å†µï¼š
å‡è®¾åˆå§‹çš„å †å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;p&gt;å‡è®¾ k = 3 ï¼Œé‚£ä¹ˆ k = half ï¼Œæ²¡æœ‰å­èŠ‚ç‚¹ï¼Œåœ¨æ‰§è¡ŒsiftDownæ–¹æ³•æ—¶ç›´æ¥æŠŠç´¢å¼•ä¸º3çš„èŠ‚ç‚¹è®¾ç½®ä¸ºæ•°ç»„çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼š&lt;/p&gt;

&lt;p&gt;æœ‰å­èŠ‚ç‚¹çš„æƒ…å†µï¼š
å‡è®¾ k = 0 ï¼Œé‚£ä¹ˆæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š
1ã€è·å–å·¦å­èŠ‚ç‚¹ï¼Œchild = 1 ï¼Œè·å–å³å­èŠ‚ç‚¹ï¼Œ right = 2 ï¼š&lt;/p&gt;

&lt;p&gt;2ã€ç”±äº right &amp;lt; size ï¼Œè¿™æ—¶æ¯”è¾ƒå·¦å­èŠ‚ç‚¹å’Œå³å­èŠ‚ç‚¹æ—¶é—´é—´éš”çš„å¤§å°ï¼Œè¿™é‡Œ 3 &amp;lt; 7 ï¼Œæ‰€ä»¥ c = queue[child] ï¼›
3ã€æ¯”è¾ƒkeyçš„æ—¶é—´é—´éš”æ˜¯å¦å°äºcçš„æ—¶é—´é—´éš”ï¼Œè¿™é‡Œä¸æ»¡è¶³ï¼Œç»§ç»­æ‰§è¡Œï¼ŒæŠŠç´¢å¼•ä¸ºkçš„èŠ‚ç‚¹è®¾ç½®ä¸ºcï¼Œç„¶åå°†kè®¾ç½®ä¸ºchildï¼›&lt;/p&gt;

&lt;p&gt;4ã€å› ä¸º half = 3 ï¼Œk = 1 ï¼Œç»§ç»­æ‰§è¡Œå¾ªç¯ï¼Œè¿™æ—¶çš„ç´¢å¼•å˜ä¸ºï¼š&lt;/p&gt;

&lt;p&gt;5ã€è¿™æ—¶å†ç»è¿‡å¦‚ä¸Šåˆ¤æ–­åï¼Œå°†kçš„å€¼ä¸º3ï¼Œæœ€ç»ˆçš„ç»“æœå¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;p&gt;6ã€æœ€åï¼Œå¦‚æœåœ¨finishPollæ–¹æ³•ä¸­è°ƒç”¨çš„è¯ï¼Œä¼šæŠŠç´¢å¼•ä¸º0çš„èŠ‚ç‚¹çš„ç´¢å¼•è®¾ç½®ä¸º-1ï¼Œè¡¨ç¤ºå·²ç»åˆ é™¤äº†è¯¥èŠ‚ç‚¹ï¼Œå¹¶ä¸”sizeä¹Ÿå‡äº†1ï¼Œæœ€åçš„ç»“æœå¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;p&gt;å¯è§ï¼Œsiftdownæ–¹æ³•åœ¨æ‰§è¡Œå®Œå¹¶ä¸æ˜¯æœ‰åºçš„ï¼Œä½†å¯ä»¥å‘ç°ï¼Œå­èŠ‚ç‚¹çš„ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´ä¸€å®šæ¯”çˆ¶èŠ‚ç‚¹çš„ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´è¦å¤§ï¼Œç”±äºæ¯æ¬¡éƒ½ä¼šå–å·¦å­èŠ‚ç‚¹å’Œå³å­èŠ‚ç‚¹ä¸­ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´æœ€å°çš„èŠ‚ç‚¹ï¼Œæ‰€ä»¥è¿˜æ˜¯å¯ä»¥ä¿è¯åœ¨takeå’Œpollæ—¶å‡ºé˜Ÿæ˜¯æœ‰åºçš„ã€‚&lt;/p&gt;

&lt;h3 id=&quot;removeæ–¹æ³•&quot;&gt;removeæ–¹æ³•&lt;/h3&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;remove&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Object&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ReentrantLock&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lock&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;lock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;lock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;lock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;indexOf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;setIndex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;queue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;s&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;RunnableScheduledFuture&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;?&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;replacement&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;queue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;];&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;queue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;s&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// ä»iå¼€å§‹å‘ä¸‹è°ƒæ•´&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;siftDown&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;replacement&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
 &lt;span class=&quot;c1&quot;&gt;// å¦‚æœqueue[i] == replacementï¼Œè¯´æ˜iæ˜¯å¶å­èŠ‚ç‚¹&lt;/span&gt;
            &lt;span class=&quot;c1&quot;&gt;// å¦‚æœæ˜¯è¿™ç§æƒ…å†µï¼Œä¸èƒ½ä¿è¯å­èŠ‚ç‚¹çš„ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´æ¯”çˆ¶èŠ‚ç‚¹çš„å¤§&lt;/span&gt;
            &lt;span class=&quot;c1&quot;&gt;// è¿™æ—¶éœ€è¦è¿›è¡Œä¸€æ¬¡å‘ä¸Šè°ƒæ•´&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;queue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;replacement&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;siftUp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;replacement&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;finally&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;lock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;unlock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;å‡è®¾åˆå§‹çš„å †ç»“æ„å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;p&gt;è¿™æ—¶è¦åˆ é™¤8çš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¿™æ—¶ k = 1ï¼Œkeyä¸ºæœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼š&lt;/p&gt;

&lt;p&gt;è¿™æ—¶é€šè¿‡ä¸Šæ–‡å¯¹siftDownæ–¹æ³•çš„åˆ†æï¼ŒsiftDownæ–¹æ³•æ‰§è¡Œåçš„ç»“æœå¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;p&gt;è¿™æ—¶ä¼šå‘ç°ï¼Œæœ€åä¸€ä¸ªèŠ‚ç‚¹çš„å€¼æ¯”çˆ¶èŠ‚ç‚¹è¿˜è¦å°ï¼Œæ‰€ä»¥è¿™é‡Œè¦æ‰§è¡Œä¸€æ¬¡siftUpæ–¹æ³•æ¥ä¿è¯å­èŠ‚ç‚¹çš„ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´è¦æ¯”çˆ¶èŠ‚ç‚¹çš„å¤§ï¼Œæ‰€ä»¥æœ€ç»ˆç»“æœå¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;h2 id=&quot;æ€»ç»“&quot;&gt;æ€»ç»“&lt;/h2&gt;

&lt;p&gt;ä¸»è¦æ€»ç»“ä¸ºä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š&lt;/p&gt;

&lt;p&gt;ä¸Timeræ‰§è¡Œå®šæ—¶ä»»åŠ¡çš„æ¯”è¾ƒï¼Œç›¸æ¯”Timerï¼ŒScheduedThreadPoolExecutoræœ‰ä»€ä¹ˆä¼˜ç‚¹ï¼›&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;ScheduledThreadPoolExecutorç»§æ‰¿è‡ªThreadPoolExecutorï¼Œæ‰€ä»¥å®ƒä¹Ÿæ˜¯ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œä¹Ÿæœ‰coorPoolSizeå’ŒworkQueueï¼Œ&lt;/li&gt;
  &lt;li&gt;ScheduledThreadPoolExecutorç‰¹æ®Šçš„åœ°æ–¹åœ¨äºï¼Œè‡ªå·±å®ç°äº†ä¼˜å…ˆå·¥ä½œé˜Ÿåˆ—DelayedWorkQueueï¼›&lt;/li&gt;
  &lt;li&gt;ScheduedThreadPoolExecutorå®ç°äº†ScheduledExecutorServiceï¼Œæ‰€ä»¥å°±æœ‰äº†ä»»åŠ¡è°ƒåº¦çš„æ–¹æ³•ï¼Œå¦‚scheduleï¼Œ&lt;/li&gt;
  &lt;li&gt;scheduleAtFixedRateå’ŒscheduleWithFixedDelayï¼ŒåŒæ—¶æ³¨æ„ä»–ä»¬ä¹‹é—´çš„åŒºåˆ«ï¼›&lt;/li&gt;
  &lt;li&gt;å†…éƒ¨ç±»ScheduledFutureTaskç»§æ‰¿è‡ªFutureTaskï¼Œå®ç°äº†ä»»åŠ¡çš„å¼‚æ­¥æ‰§è¡Œå¹¶ä¸”å¯ä»¥è·å–è¿”å›ç»“æœã€‚åŒæ—¶ä¹Ÿå®ç°äº†Delayedæ¥å£ï¼Œå¯ä»¥é€šè¿‡getDelayæ–¹æ³•è·å–å°†è¦æ‰§è¡Œçš„æ—¶é—´é—´éš”ï¼›&lt;/li&gt;
  &lt;li&gt;å‘¨æœŸä»»åŠ¡çš„æ‰§è¡Œå…¶å®æ˜¯è°ƒç”¨äº†FutureTaskç±»ä¸­çš„runAndResetæ–¹æ³•ï¼Œæ¯æ¬¡æ‰§è¡Œå®Œä¸è®¾ç½®ç»“æœå’ŒçŠ¶æ€ã€‚&lt;/li&gt;
  &lt;li&gt;è¯¦ç»†åˆ†æäº†DelayedWorkQueueçš„æ•°æ®ç»“æ„ï¼Œå®ƒæ˜¯ä¸€ä¸ªåŸºäºæœ€å°å †ç»“æ„çš„ä¼˜å…ˆé˜Ÿåˆ—ï¼Œå¹¶ä¸”æ¯æ¬¡å‡ºé˜Ÿæ—¶èƒ½å¤Ÿä¿è¯å–å‡ºçš„ä»»åŠ¡æ˜¯å½“å‰é˜Ÿåˆ—ä¸­ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´æœ€å°çš„ä»»åŠ¡ã€‚åŒæ—¶æ³¨æ„ä¸€ä¸‹ä¼˜å…ˆé˜Ÿåˆ—ä¸­å †çš„é¡ºåºï¼Œå †ä¸­çš„é¡ºåºå¹¶ä¸æ˜¯ç»å¯¹çš„ï¼Œä½†è¦ä¿è¯å­èŠ‚ç‚¹çš„å€¼è¦æ¯”çˆ¶èŠ‚ç‚¹çš„å€¼è¦å¤§ï¼Œè¿™æ ·å°±ä¸ä¼šå½±å“å‡ºé˜Ÿçš„é¡ºåºã€‚&lt;/li&gt;
  &lt;li&gt;æ€»ä½“æ¥è¯´ï¼ŒScheduedThreadPoolExecutorçš„é‡ç‚¹æ˜¯è¦ç†è§£ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´çš„è®¡ç®—ï¼Œä»¥åŠä¼˜å…ˆé˜Ÿåˆ—çš„å‡ºé˜Ÿã€å…¥é˜Ÿå’Œåˆ é™¤çš„è¿‡ç¨‹ï¼Œè¿™ä¸¤ä¸ªæ˜¯ç†è§£ScheduedThreadPoolExecutorçš„å…³é”®ã€‚&lt;/li&gt;
&lt;/ul&gt;</content><author><name>WenHao</name></author><summary type="html">ScheduledThreadPoolExecutor</summary></entry><entry><title type="html">å¹¶å‘ç¼–ç¨‹(å)-å¹¶å‘ç¼–ç¨‹ä¹‹Executorçº¿ç¨‹æ± åŸç†ä¸æºç è§£è¯»</title><link href="http://localhost:4000/2020/07/10/Excutor/" rel="alternate" type="text/html" title="å¹¶å‘ç¼–ç¨‹(å)-å¹¶å‘ç¼–ç¨‹ä¹‹Executorçº¿ç¨‹æ± åŸç†ä¸æºç è§£è¯»" /><published>2020-07-10T00:00:00+08:00</published><updated>2020-07-10T00:00:00+08:00</updated><id>http://localhost:4000/2020/07/10/Excutor</id><content type="html" xml:base="http://localhost:4000/2020/07/10/Excutor/">&lt;h1 id=&quot;çº¿ç¨‹&quot;&gt;çº¿ç¨‹&lt;/h1&gt;

&lt;p&gt;çº¿ç¨‹æ˜¯è°ƒåº¦CPUèµ„æºçš„æœ€å°å•ä½ï¼Œçº¿ç¨‹æ¨¡å‹åˆ†ä¸ºKLTæ¨¡å‹ä¸ULTæ¨¡å‹ï¼ŒJVMä½¿ç”¨çš„KLTæ¨¡å‹ï¼ŒJavaçº¿ç¨‹ä¸OSçº¿ç¨‹ä¿æŒ1:1çš„æ˜ å°„å…³ç³»ï¼Œä¹Ÿå°±æ˜¯è¯´æœ‰ä¸€ä¸ªjavaçº¿ç¨‹ä¹Ÿä¼šåœ¨æ“ä½œç³»ç»Ÿé‡Œæœ‰ä¸€ä¸ªå¯¹åº”çš„çº¿ç¨‹ã€‚Javaçº¿ç¨‹æœ‰å¤šç§ç”Ÿå‘½çŠ¶æ€
NEW,æ–°å»º
RUNNABLE,è¿è¡Œ
BLOCKED,é˜»å¡
WAITING,ç­‰å¾…
TIMED_WAITING,è¶…æ—¶ç­‰å¾…
TERMINATEDï¼Œç»ˆç»“
çŠ¶æ€åˆ‡æ¢å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://gitee.com/fwh666/fwh_images/raw/master/fwh_images/image-20210721201820296.png&quot; alt=&quot;image-20210721201820296&quot; style=&quot;zoom:50%;&quot; /&gt;&lt;/p&gt;

&lt;h1 id=&quot;åç¨‹&quot;&gt;åç¨‹&lt;/h1&gt;

&lt;p&gt;åç¨‹	(çº¤ç¨‹ï¼Œç”¨æˆ·çº§çº¿ç¨‹)ï¼Œç›®çš„æ˜¯ä¸ºäº†è¿½æ±‚æœ€å¤§åŠ›åº¦çš„å‘æŒ¥ç¡¬ä»¶æ€§èƒ½å’Œæå‡è½¯ä»¶çš„é€Ÿåº¦ï¼Œåç¨‹åŸºæœ¬åŸç†æ˜¯:åœ¨æŸä¸ªç‚¹æŒ‚èµ·å½“å‰çš„ä»»åŠ¡ï¼Œå¹¶ä¸”ä¿å­˜æ ˆä¿¡æ¯ï¼Œå»æ‰§è¡Œå¦ä¸€ä¸ªä»»åŠ¡ï¼›ç­‰å®Œæˆæˆ–è¾¾åˆ°æŸä¸ªæ¡ä»¶æ—¶ï¼Œå†è¿˜åŸåŸæ¥çš„æ ˆä¿¡æ¯å¹¶ç»§ç»­æ‰§è¡Œ(æ•´ä¸ªè¿‡ç¨‹çº¿ç¨‹ä¸éœ€è¦ä¸Šä¸‹æ–‡åˆ‡æ¢)ã€‚
JavaåŸç”Ÿä¸æ”¯æŒåç¨‹ï¼Œåœ¨çº¯javaä»£ç é‡Œéœ€è¦ä½¿ç”¨åç¨‹çš„è¯éœ€è¦å¼•å…¥ç¬¬ä¸‰æ–¹åŒ…,å¦‚ï¼šquasar&lt;/p&gt;

&lt;h1 id=&quot;çº¿ç¨‹æ± &quot;&gt;çº¿ç¨‹æ± &lt;/h1&gt;

&lt;p&gt;â€œçº¿ç¨‹æ± â€ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯ä¸€ä¸ªçº¿ç¨‹ç¼“å­˜ï¼Œçº¿ç¨‹æ˜¯ç¨€ç¼ºèµ„æºï¼Œå¦‚æœè¢«æ— é™åˆ¶çš„åˆ›å»ºï¼Œä¸ä»…ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œè¿˜ä¼šé™ä½ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œå› æ­¤Javaä¸­æä¾›çº¿ç¨‹æ± å¯¹çº¿ç¨‹è¿›è¡Œç»Ÿä¸€åˆ†é…ã€è°ƒä¼˜å’Œç›‘æ§
çº¿ç¨‹æ± ä»‹ç»
åœ¨webå¼€å‘ä¸­ï¼ŒæœåŠ¡å™¨éœ€è¦æ¥å—å¹¶å¤„ç†è¯·æ±‚ï¼Œæ‰€ä»¥ä¼šä¸ºä¸€ä¸ªè¯·æ±‚æ¥åˆ†é…ä¸€ä¸ªçº¿ç¨‹æ¥è¿›è¡Œå¤„ç†ã€‚å¦‚æœæ¯æ¬¡è¯·æ±‚éƒ½æ–°åˆ›å»ºä¸€ä¸ªçº¿ç¨‹çš„è¯å®ç°èµ·æ¥éå¸¸ç®€ä¾¿ï¼Œä½†æ˜¯å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼š
å¦‚æœå¹¶å‘çš„è¯·æ±‚æ•°é‡éå¸¸å¤šï¼Œä½†æ¯ä¸ªçº¿ç¨‹æ‰§è¡Œçš„æ—¶é—´å¾ˆçŸ­ï¼Œè¿™æ ·å°±ä¼šé¢‘ç¹çš„åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ï¼Œå¦‚æ­¤ä¸€æ¥ä¼šå¤§å¤§é™ä½ç³»ç»Ÿçš„æ•ˆç‡ã€‚å¯èƒ½å‡ºç°æœåŠ¡å™¨åœ¨ä¸ºæ¯ä¸ªè¯·æ±‚åˆ›å»ºæ–°çº¿ç¨‹å’Œé”€æ¯çº¿ç¨‹ä¸ŠèŠ±è´¹çš„æ—¶é—´å’Œæ¶ˆè€—çš„ç³»ç»Ÿèµ„æºè¦æ¯”å¤„ç†å®é™…çš„ç”¨æˆ·è¯·æ±‚çš„æ—¶é—´å’Œèµ„æºæ›´å¤šã€‚
é‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ç§åŠæ³•ä½¿æ‰§è¡Œå®Œä¸€ä¸ªä»»åŠ¡ï¼Œå¹¶ä¸è¢«é”€æ¯ï¼Œè€Œæ˜¯å¯ä»¥ç»§ç»­æ‰§è¡Œå…¶ä»–çš„ä»»åŠ¡å‘¢ï¼Ÿ
è¿™å°±æ˜¯çº¿ç¨‹æ± çš„ç›®çš„äº†ã€‚çº¿ç¨‹æ± ä¸ºçº¿ç¨‹ç”Ÿå‘½å‘¨æœŸçš„å¼€é”€å’Œèµ„æºä¸è¶³é—®é¢˜æä¾›äº†è§£å†³æ–¹æ¡ˆã€‚é€šè¿‡å¯¹å¤šä¸ªä»»åŠ¡é‡ç”¨çº¿ç¨‹ï¼Œçº¿ç¨‹åˆ›å»ºçš„å¼€é”€è¢«åˆ†æ‘Šåˆ°äº†å¤šä¸ªä»»åŠ¡ä¸Šã€‚
ä»€ä¹ˆæ—¶å€™ä½¿ç”¨çº¿ç¨‹æ± ï¼Ÿ
å•ä¸ªä»»åŠ¡å¤„ç†æ—¶é—´æ¯”è¾ƒçŸ­
éœ€è¦å¤„ç†çš„ä»»åŠ¡æ•°é‡å¾ˆå¤§
çº¿ç¨‹æ± ä¼˜åŠ¿
é‡ç”¨å­˜åœ¨çš„çº¿ç¨‹ï¼Œå‡å°‘çº¿ç¨‹åˆ›å»ºï¼Œæ¶ˆäº¡çš„å¼€é”€ï¼Œæé«˜æ€§èƒ½
æé«˜å“åº”é€Ÿåº¦ã€‚å½“ä»»åŠ¡åˆ°è¾¾æ—¶ï¼Œä»»åŠ¡å¯ä»¥ä¸éœ€è¦çš„ç­‰åˆ°çº¿ç¨‹åˆ›å»ºå°±èƒ½ç«‹å³æ‰§è¡Œã€‚
æé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§ã€‚çº¿ç¨‹æ˜¯ç¨€ç¼ºèµ„æºï¼Œå¦‚æœæ— é™åˆ¶çš„åˆ›å»ºï¼Œä¸ä»…ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œè¿˜ä¼šé™ä½ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥è¿›è¡Œç»Ÿä¸€çš„åˆ†é…ï¼Œè°ƒä¼˜å’Œç›‘æ§ã€‚&lt;/p&gt;

&lt;h2 id=&quot;çº¿ç¨‹çš„å®ç°æ–¹å¼&quot;&gt;çº¿ç¨‹çš„å®ç°æ–¹å¼&lt;/h2&gt;

&lt;p&gt;Runnable,Thread,Callable&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;// å®ç°Runnableæ¥å£çš„ç±»å°†è¢«Threadæ‰§è¡Œï¼Œè¡¨ç¤ºä¸€ä¸ªåŸºæœ¬çš„ä»»åŠ¡&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Runnable&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// runæ–¹æ³•å°±æ˜¯å®ƒæ‰€æœ‰çš„å†…å®¹ï¼Œå°±æ˜¯å®é™…æ‰§è¡Œçš„ä»»åŠ¡&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;abstract&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;//CallableåŒæ ·æ˜¯ä»»åŠ¡ï¼Œä¸Runnableæ¥å£çš„åŒºåˆ«åœ¨äºå®ƒæ¥æ”¶æ³›å‹ï¼ŒåŒæ—¶å®ƒæ‰§è¡Œä»»åŠ¡åå¸¦æœ‰è¿”å›å†…å®¹&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Callable&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;V&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// ç›¸å¯¹äºrunæ–¹æ³•çš„å¸¦æœ‰è¿”å›å€¼çš„callæ–¹æ³•&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;V&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Exception&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;executoræ¡†æ¶&quot;&gt;Executoræ¡†æ¶&lt;/h2&gt;

&lt;p&gt;Executoræ¥å£æ˜¯çº¿ç¨‹æ± æ¡†æ¶ä¸­æœ€åŸºç¡€çš„éƒ¨åˆ†ï¼Œå®šä¹‰äº†ä¸€ä¸ªç”¨äºæ‰§è¡ŒRunnableçš„executeæ–¹æ³•ã€‚
ä¸‹å›¾ä¸ºå®ƒçš„ç»§æ‰¿ä¸å®ç°&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://gitee.com/fwh666/fwh_images/raw/master/fwh_images/image-20210721201935737.png&quot; alt=&quot;image-20210721201935737&quot; style=&quot;zoom:50%;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºExecutorä¸‹æœ‰ä¸€ä¸ªé‡è¦å­æ¥å£ExecutorServiceï¼Œå…¶ä¸­å®šä¹‰äº†çº¿ç¨‹æ± çš„å…·ä½“è¡Œä¸º
1ï¼Œexecuteï¼ˆRunnable commandï¼‰ï¼šå±¥è¡ŒRuannableç±»å‹çš„ä»»åŠ¡,
2ï¼Œsubmitï¼ˆtaskï¼‰ï¼šå¯ç”¨æ¥æäº¤Callableæˆ–Runnableä»»åŠ¡ï¼Œå¹¶è¿”å›ä»£è¡¨æ­¤ä»»åŠ¡çš„Futureå¯¹è±¡
3ï¼Œshutdownï¼ˆï¼‰ï¼šåœ¨å®Œæˆå·²æäº¤çš„ä»»åŠ¡åå°é—­åŠäº‹ï¼Œä¸å†æ¥ç®¡æ–°ä»»åŠ¡,
4ï¼ŒshutdownNowï¼ˆï¼‰ï¼šåœæ­¢æ‰€æœ‰æ­£åœ¨å±¥è¡Œçš„ä»»åŠ¡å¹¶å°é—­åŠäº‹ã€‚
5ï¼ŒisTerminatedï¼ˆï¼‰ï¼šæµ‹è¯•æ˜¯å¦æ‰€æœ‰ä»»åŠ¡éƒ½å±¥è¡Œå®Œæ¯•äº†ã€‚
6ï¼ŒisShutdownï¼ˆï¼‰ï¼šæµ‹è¯•æ˜¯å¦è¯¥ExecutorServiceå·²è¢«å…³é—­ã€‚&lt;/p&gt;

&lt;h3 id=&quot;çº¿ç¨‹æ± é‡ç‚¹å±æ€§&quot;&gt;çº¿ç¨‹æ± é‡ç‚¹å±æ€§&lt;/h3&gt;

&lt;p&gt;private final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0));
private static final int COUNT_BITS = Integer.SIZE - 3;
private static final int CAPACITY   = (1 Â«Â COUNT_BITS) - 1;
ctl æ˜¯å¯¹çº¿ç¨‹æ± çš„è¿è¡ŒçŠ¶æ€å’Œçº¿ç¨‹æ± ä¸­æœ‰æ•ˆçº¿ç¨‹çš„æ•°é‡è¿›è¡Œæ§åˆ¶çš„ä¸€ä¸ªå­—æ®µï¼Œ å®ƒåŒ…å«ä¸¤éƒ¨åˆ†çš„ä¿¡æ¯: çº¿ç¨‹æ± çš„è¿è¡ŒçŠ¶æ€ (runState) å’Œçº¿ç¨‹æ± å†…æœ‰æ•ˆçº¿ç¨‹çš„æ•°é‡ (workerCount)ï¼Œè¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨äº†Integerç±»å‹æ¥ä¿å­˜ï¼Œé«˜3ä½ä¿å­˜runStateï¼Œä½29ä½ä¿å­˜workerCountã€‚COUNT_BITS å°±æ˜¯29ï¼ŒCAPACITYå°±æ˜¯1å·¦ç§»29ä½å‡1ï¼ˆ29ä¸ª1ï¼‰ï¼Œè¿™ä¸ªå¸¸é‡è¡¨ç¤ºworkerCountçš„ä¸Šé™å€¼ï¼Œå¤§çº¦æ˜¯5äº¿ã€‚&lt;/p&gt;

&lt;p&gt;ctlç›¸å…³æ–¹æ³•
private static int runStateOf(int c)     { return c &amp;amp; ~CAPACITY; }
private static int workerCountOf(int c)  { return c &amp;amp; CAPACITY; }
private static int ctlOf(int rs, int wc) { return rs | wc; }
runStateOfï¼šè·å–è¿è¡ŒçŠ¶æ€ï¼›
workerCountOfï¼šè·å–æ´»åŠ¨çº¿ç¨‹æ•°ï¼›
ctlOfï¼šè·å–è¿è¡ŒçŠ¶æ€å’Œæ´»åŠ¨çº¿ç¨‹æ•°çš„å€¼ã€‚&lt;/p&gt;

&lt;p&gt;çº¿ç¨‹æ± å­˜åœ¨5ç§çŠ¶æ€&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;RUNNING&lt;/span&gt;    &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;COUNT_BITS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//é«˜3ä½ä¸º111&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;SHUTDOWN&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;  &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;COUNT_BITS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//é«˜3ä½ä¸º000&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;STOP&lt;/span&gt;       &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;  &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;COUNT_BITS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//é«˜3ä½ä¸º001&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;TIDYING&lt;/span&gt;    &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;  &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;COUNT_BITS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//é«˜3ä½ä¸º010&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;TERMINATED&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;  &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;COUNT_BITS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//é«˜3ä½ä¸º011&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;1ã€RUNNING
(1) çŠ¶æ€è¯´æ˜ï¼šçº¿ç¨‹æ± å¤„åœ¨RUNNINGçŠ¶æ€æ—¶ï¼Œèƒ½å¤Ÿæ¥æ”¶æ–°ä»»åŠ¡ï¼Œä»¥åŠå¯¹å·²æ·»åŠ çš„ä»»åŠ¡è¿›è¡Œå¤„ç†ã€‚ 
(02) çŠ¶æ€åˆ‡æ¢ï¼šçº¿ç¨‹æ± çš„åˆå§‹åŒ–çŠ¶æ€æ˜¯RUNNINGã€‚æ¢å¥è¯è¯´ï¼Œçº¿ç¨‹æ± è¢«ä¸€æ—¦è¢«åˆ›å»ºï¼Œå°±å¤„äºRUNNINGçŠ¶æ€ï¼Œå¹¶ä¸”çº¿ç¨‹æ± ä¸­çš„ä»»åŠ¡æ•°ä¸º0ï¼&lt;/p&gt;

&lt;p&gt;2ã€ SHUTDOWN
(1) çŠ¶æ€è¯´æ˜ï¼šçº¿ç¨‹æ± å¤„åœ¨SHUTDOWNçŠ¶æ€æ—¶ï¼Œä¸æ¥æ”¶æ–°ä»»åŠ¡ï¼Œä½†èƒ½å¤„ç†å·²æ·»åŠ çš„ä»»åŠ¡ã€‚ 
(2) çŠ¶æ€åˆ‡æ¢ï¼šè°ƒç”¨çº¿ç¨‹æ± çš„shutdown()æ¥å£æ—¶ï¼Œçº¿ç¨‹æ± ç”±RUNNING -&amp;gt; SHUTDOWNã€‚&lt;/p&gt;

&lt;p&gt;3ã€STOP
(1) çŠ¶æ€è¯´æ˜ï¼šçº¿ç¨‹æ± å¤„åœ¨STOPçŠ¶æ€æ—¶ï¼Œä¸æ¥æ”¶æ–°ä»»åŠ¡ï¼Œä¸å¤„ç†å·²æ·»åŠ çš„ä»»åŠ¡ï¼Œå¹¶ä¸”ä¼šä¸­æ–­æ­£åœ¨å¤„ç†çš„ä»»åŠ¡ã€‚ 
(2) çŠ¶æ€åˆ‡æ¢ï¼šè°ƒç”¨çº¿ç¨‹æ± çš„shutdownNow()æ¥å£æ—¶ï¼Œçº¿ç¨‹æ± ç”±(RUNNING or SHUTDOWN ) -&amp;gt; STOPã€‚&lt;/p&gt;

&lt;p&gt;4ã€TIDYING
(1) çŠ¶æ€è¯´æ˜ï¼šå½“æ‰€æœ‰çš„ä»»åŠ¡å·²ç»ˆæ­¢ï¼Œctlè®°å½•çš„â€ä»»åŠ¡æ•°é‡â€ä¸º0ï¼Œçº¿ç¨‹æ± ä¼šå˜ä¸ºTIDYINGçŠ¶æ€ã€‚å½“çº¿ç¨‹æ± å˜ä¸ºTIDYINGçŠ¶æ€æ—¶ï¼Œä¼šæ‰§è¡Œé’©å­å‡½æ•°terminated()ã€‚terminated()åœ¨ThreadPoolExecutorç±»ä¸­æ˜¯ç©ºçš„ï¼Œè‹¥ç”¨æˆ·æƒ³åœ¨çº¿ç¨‹æ± å˜ä¸ºTIDYINGæ—¶ï¼Œè¿›è¡Œç›¸åº”çš„å¤„ç†ï¼›å¯ä»¥é€šè¿‡é‡è½½terminated()å‡½æ•°æ¥å®ç°ã€‚ 
(2) çŠ¶æ€åˆ‡æ¢ï¼šå½“çº¿ç¨‹æ± åœ¨SHUTDOWNçŠ¶æ€ä¸‹ï¼Œé˜»å¡é˜Ÿåˆ—ä¸ºç©ºå¹¶ä¸”çº¿ç¨‹æ± ä¸­æ‰§è¡Œçš„ä»»åŠ¡ä¹Ÿä¸ºç©ºæ—¶ï¼Œå°±ä¼šç”± SHUTDOWN -&amp;gt; TIDYINGã€‚ å½“çº¿ç¨‹æ± åœ¨STOPçŠ¶æ€ä¸‹ï¼Œçº¿ç¨‹æ± ä¸­æ‰§è¡Œçš„ä»»åŠ¡ä¸ºç©ºæ—¶ï¼Œå°±ä¼šç”±STOP -&amp;gt; TIDYINGã€‚&lt;/p&gt;

&lt;p&gt;5ã€ TERMINATED
(1) çŠ¶æ€è¯´æ˜ï¼šçº¿ç¨‹æ± å½»åº•ç»ˆæ­¢ï¼Œå°±å˜æˆTERMINATEDçŠ¶æ€ã€‚ 
(2) çŠ¶æ€åˆ‡æ¢ï¼šçº¿ç¨‹æ± å¤„åœ¨TIDYINGçŠ¶æ€æ—¶ï¼Œæ‰§è¡Œå®Œterminated()ä¹‹åï¼Œå°±ä¼šç”± TIDYING -&amp;gt; TERMINATEDã€‚
è¿›å…¥TERMINATEDçš„æ¡ä»¶å¦‚ä¸‹ï¼š
çº¿ç¨‹æ± ä¸æ˜¯RUNNINGçŠ¶æ€ï¼›
çº¿ç¨‹æ± çŠ¶æ€ä¸æ˜¯TIDYINGçŠ¶æ€æˆ–TERMINATEDçŠ¶æ€ï¼›
å¦‚æœçº¿ç¨‹æ± çŠ¶æ€æ˜¯SHUTDOWNå¹¶ä¸”workerQueueä¸ºç©ºï¼›
workerCountä¸º0ï¼›
è®¾ç½®TIDYINGçŠ¶æ€æˆåŠŸã€‚&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://gitee.com/fwh666/fwh_images/raw/master/fwh_images/image-20210721202042437.png&quot; alt=&quot;image-20210721202042437&quot; style=&quot;zoom:50%;&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;çº¿ç¨‹æ± çš„å…·ä½“å®ç°&quot;&gt;çº¿ç¨‹æ± çš„å…·ä½“å®ç°&lt;/h3&gt;

&lt;p&gt;ThreadPoolExecutor é»˜è®¤çº¿ç¨‹æ± 
ScheduledThreadPoolExecutor å®šæ—¶çº¿ç¨‹æ± &lt;/p&gt;

&lt;h1 id=&quot;threadpoolexecutor&quot;&gt;ThreadPoolExecutor&lt;/h1&gt;

&lt;p&gt;çº¿ç¨‹æ± çš„åˆ›å»º&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;ThreadPoolExecutor&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;corePoolSize&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;
                          &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;maximumPoolSize&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;
                          &lt;span class=&quot;kt&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;keepAliveTime&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;
                          &lt;span class=&quot;n&quot;&gt;TimeUnit&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;unit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;
                          &lt;span class=&quot;n&quot;&gt;BlockingQueue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Runnable&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;workQueue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;
                          &lt;span class=&quot;n&quot;&gt;ThreadFactory&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;threadFactory&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;
                          &lt;span class=&quot;n&quot;&gt;RejectedExecutionHandler&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;handler&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; 
  
  
 &lt;span class=&quot;err&quot;&gt;ä»»åŠ¡æäº¤&lt;/span&gt;
&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ã€&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;execute&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//æäº¤ä»»åŠ¡æ— è¿”å›å€¼&lt;/span&gt;
&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ã€&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Future&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;?&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;submit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//ä»»åŠ¡æ‰§è¡Œå®Œæˆåæœ‰è¿”å›å€¼&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;å‚æ•°è§£é‡Š&quot;&gt;å‚æ•°è§£é‡Š&lt;/h2&gt;

&lt;p&gt;corePoolSize
çº¿ç¨‹æ± ä¸­çš„æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå½“æäº¤ä¸€ä¸ªä»»åŠ¡æ—¶ï¼Œçº¿ç¨‹æ± åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œç›´åˆ°å½“å‰çº¿ç¨‹æ•°ç­‰äºcorePoolSizeï¼›å¦‚æœå½“å‰çº¿ç¨‹æ•°ä¸ºcorePoolSizeï¼Œç»§ç»­æäº¤çš„ä»»åŠ¡è¢«ä¿å­˜åˆ°é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…è¢«æ‰§è¡Œï¼›å¦‚æœæ‰§è¡Œäº†çº¿ç¨‹æ± çš„prestartAllCoreThreads()æ–¹æ³•ï¼Œçº¿ç¨‹æ± ä¼šæå‰åˆ›å»ºå¹¶å¯åŠ¨æ‰€æœ‰æ ¸å¿ƒçº¿ç¨‹ã€‚
maximumPoolSize
çº¿ç¨‹æ± ä¸­å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°ã€‚å¦‚æœå½“å‰é˜»å¡é˜Ÿåˆ—æ»¡äº†ï¼Œä¸”ç»§ç»­æäº¤ä»»åŠ¡ï¼Œåˆ™åˆ›å»ºæ–°çš„çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œå‰ææ˜¯å½“å‰çº¿ç¨‹æ•°å°äºmaximumPoolSizeï¼›
keepAliveTime
çº¿ç¨‹æ± ç»´æŠ¤çº¿ç¨‹æ‰€å…è®¸çš„ç©ºé—²æ—¶é—´ã€‚å½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å¤§äºcorePoolSizeçš„æ—¶å€™ï¼Œå¦‚æœè¿™æ—¶æ²¡æœ‰æ–°çš„ä»»åŠ¡æäº¤ï¼Œæ ¸å¿ƒçº¿ç¨‹å¤–çš„çº¿ç¨‹ä¸ä¼šç«‹å³é”€æ¯ï¼Œè€Œæ˜¯ä¼šç­‰å¾…ï¼Œç›´åˆ°ç­‰å¾…çš„æ—¶é—´è¶…è¿‡äº†keepAliveTimeï¼›
unit
keepAliveTimeçš„å•ä½ï¼›
workQueue
ç”¨æ¥ä¿å­˜ç­‰å¾…è¢«æ‰§è¡Œçš„ä»»åŠ¡çš„é˜»å¡é˜Ÿåˆ—ï¼Œä¸”ä»»åŠ¡å¿…é¡»å®ç°Runableæ¥å£ï¼Œåœ¨JDKä¸­æä¾›äº†å¦‚ä¸‹é˜»å¡é˜Ÿåˆ—ï¼š
1ã€ArrayBlockingQueueï¼šåŸºäºæ•°ç»„ç»“æ„çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ï¼ŒæŒ‰FIFOæ’åºä»»åŠ¡ï¼›
2ã€LinkedBlockingQueneï¼šåŸºäºé“¾è¡¨ç»“æ„çš„é˜»å¡é˜Ÿåˆ—ï¼ŒæŒ‰FIFOæ’åºä»»åŠ¡ï¼Œååé‡é€šå¸¸è¦é«˜äºArrayBlockingQueneï¼›
3ã€SynchronousQueneï¼šä¸€ä¸ªä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ï¼Œæ¯ä¸ªæ’å…¥æ“ä½œå¿…é¡»ç­‰åˆ°å¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ç§»é™¤æ“ä½œï¼Œå¦åˆ™æ’å…¥æ“ä½œä¸€ç›´å¤„äºé˜»å¡çŠ¶æ€ï¼Œååé‡é€šå¸¸è¦é«˜äºLinkedBlockingQueneï¼›
4ã€priorityBlockingQueneï¼šå…·æœ‰ä¼˜å…ˆçº§çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ï¼›
threadFactory
å®ƒæ˜¯ThreadFactoryç±»å‹çš„å˜é‡ï¼Œç”¨æ¥åˆ›å»ºæ–°çº¿ç¨‹ã€‚é»˜è®¤ä½¿ç”¨Executors.defaultThreadFactory() æ¥åˆ›å»ºçº¿ç¨‹ã€‚ä½¿ç”¨é»˜è®¤çš„ThreadFactoryæ¥åˆ›å»ºçº¿ç¨‹æ—¶ï¼Œä¼šä½¿æ–°åˆ›å»ºçš„çº¿ç¨‹å…·æœ‰ç›¸åŒçš„NORM_PRIORITYä¼˜å…ˆçº§å¹¶ä¸”æ˜¯éå®ˆæŠ¤çº¿ç¨‹ï¼ŒåŒæ—¶ä¹Ÿè®¾ç½®äº†çº¿ç¨‹çš„åç§°ã€‚
handler
çº¿ç¨‹æ± çš„é¥±å’Œç­–ç•¥ï¼Œå½“é˜»å¡é˜Ÿåˆ—æ»¡äº†ï¼Œä¸”æ²¡æœ‰ç©ºé—²çš„å·¥ä½œçº¿ç¨‹ï¼Œå¦‚æœç»§ç»­æäº¤ä»»åŠ¡ï¼Œå¿…é¡»é‡‡å–ä¸€ç§ç­–ç•¥å¤„ç†è¯¥ä»»åŠ¡ï¼Œçº¿ç¨‹æ± æä¾›äº†4ç§ç­–ç•¥ï¼š
1ã€AbortPolicyï¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œé»˜è®¤ç­–ç•¥ï¼›
2ã€CallerRunsPolicyï¼šç”¨è°ƒç”¨è€…æ‰€åœ¨çš„çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼›
3ã€DiscardOldestPolicyï¼šä¸¢å¼ƒé˜»å¡é˜Ÿåˆ—ä¸­é æœ€å‰çš„ä»»åŠ¡ï¼Œå¹¶æ‰§è¡Œå½“å‰ä»»åŠ¡ï¼›
4ã€DiscardPolicyï¼šç›´æ¥ä¸¢å¼ƒä»»åŠ¡ï¼›
ä¸Šé¢çš„4ç§ç­–ç•¥éƒ½æ˜¯ThreadPoolExecutorçš„å†…éƒ¨ç±»ã€‚
å½“ç„¶ä¹Ÿå¯ä»¥æ ¹æ®åº”ç”¨åœºæ™¯å®ç°RejectedExecutionHandleræ¥å£ï¼Œè‡ªå®šä¹‰é¥±å’Œç­–ç•¥ï¼Œå¦‚è®°å½•æ—¥å¿—æˆ–æŒä¹…åŒ–å­˜å‚¨ä¸èƒ½å¤„ç†çš„ä»»åŠ¡ã€‚&lt;/p&gt;

&lt;h2 id=&quot;çº¿ç¨‹æ± ç›‘æ§&quot;&gt;çº¿ç¨‹æ± ç›‘æ§&lt;/h2&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;getTaskCount&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//çº¿ç¨‹æ± å·²æ‰§è¡Œä¸æœªæ‰§è¡Œçš„ä»»åŠ¡æ€»æ•°&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;getCompletedTaskCount&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//å·²å®Œæˆçš„ä»»åŠ¡æ•°&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;getPoolSize&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//çº¿ç¨‹æ± å½“å‰çš„çº¿ç¨‹æ•°&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;getActiveCount&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//çº¿ç¨‹æ± ä¸­æ­£åœ¨æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æ•°é‡&lt;/span&gt;


&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;çº¿ç¨‹æ± åŸç†&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://gitee.com/fwh666/fwh_images/raw/master/fwh_images/image-20210721202223786.png&quot; alt=&quot;image-20210721202223786&quot; style=&quot;zoom:50%;&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;æºç åˆ†æ&quot;&gt;æºç åˆ†æ&lt;/h2&gt;

&lt;p&gt;executeæ–¹æ³•&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;execute&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Runnable&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;command&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;NullPointerException&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;cm&quot;&gt;/*

 * cltè®°å½•ç€runStateå’ŒworkerCount
   */&lt;/span&gt;
   &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ctl&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
   &lt;span class=&quot;cm&quot;&gt;/*
 * workerCountOfæ–¹æ³•å–å‡ºä½29ä½çš„å€¼ï¼Œè¡¨ç¤ºå½“å‰æ´»åŠ¨çš„çº¿ç¨‹æ•°ï¼›
 * å¦‚æœå½“å‰æ´»åŠ¨çº¿ç¨‹æ•°å°äºcorePoolSizeï¼Œåˆ™æ–°å»ºä¸€ä¸ªçº¿ç¨‹æ”¾å…¥çº¿ç¨‹æ± ä¸­ï¼›
 * å¹¶æŠŠä»»åŠ¡æ·»åŠ åˆ°è¯¥çº¿ç¨‹ä¸­ã€‚
   */&lt;/span&gt;
   &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;workerCountOf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;corePoolSize&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
   &lt;span class=&quot;cm&quot;&gt;/*
 * addWorkerä¸­çš„ç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºé™åˆ¶æ·»åŠ çº¿ç¨‹çš„æ•°é‡æ˜¯æ ¹æ®corePoolSizeæ¥åˆ¤æ–­è¿˜æ˜¯maximumPoolSizeæ¥åˆ¤æ–­ï¼›
 * å¦‚æœä¸ºtrueï¼Œæ ¹æ®corePoolSizeæ¥åˆ¤æ–­ï¼›
 * å¦‚æœä¸ºfalseï¼Œåˆ™æ ¹æ®maximumPoolSizeæ¥åˆ¤æ–­
   */&lt;/span&gt;
       &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;addWorker&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt;
           &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
   &lt;span class=&quot;cm&quot;&gt;/*
 * å¦‚æœæ·»åŠ å¤±è´¥ï¼Œåˆ™é‡æ–°è·å–ctlå€¼
   */&lt;/span&gt;
       &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ctl&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
   &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
   &lt;span class=&quot;cm&quot;&gt;/*
 * å¦‚æœå½“å‰çº¿ç¨‹æ± æ˜¯è¿è¡ŒçŠ¶æ€å¹¶ä¸”ä»»åŠ¡æ·»åŠ åˆ°é˜Ÿåˆ—æˆåŠŸ
   */&lt;/span&gt;
   &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;isRunning&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;workQueue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;offer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
   &lt;span class=&quot;c1&quot;&gt;// é‡æ–°è·å–ctlå€¼&lt;/span&gt;
       &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;recheck&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ctl&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// å†æ¬¡åˆ¤æ–­çº¿ç¨‹æ± çš„è¿è¡ŒçŠ¶æ€ï¼Œå¦‚æœä¸æ˜¯è¿è¡ŒçŠ¶æ€ï¼Œç”±äºä¹‹å‰å·²ç»æŠŠcommandæ·»åŠ åˆ°workQueueä¸­äº†ï¼Œ&lt;/span&gt;
   &lt;span class=&quot;c1&quot;&gt;// è¿™æ—¶éœ€è¦ç§»é™¤è¯¥command&lt;/span&gt;
   &lt;span class=&quot;c1&quot;&gt;// æ‰§è¡Œè¿‡åé€šè¿‡handlerä½¿ç”¨æ‹’ç»ç­–ç•¥å¯¹è¯¥ä»»åŠ¡è¿›è¡Œå¤„ç†ï¼Œæ•´ä¸ªæ–¹æ³•è¿”å›&lt;/span&gt;
       &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(!&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;isRunning&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;recheck&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;remove&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt;
           &lt;span class=&quot;n&quot;&gt;reject&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
   &lt;span class=&quot;cm&quot;&gt;/*
 * è·å–çº¿ç¨‹æ± ä¸­çš„æœ‰æ•ˆçº¿ç¨‹æ•°ï¼Œå¦‚æœæ•°é‡æ˜¯0ï¼Œåˆ™æ‰§è¡ŒaddWorkeræ–¹æ³•
 * è¿™é‡Œä¼ å…¥çš„å‚æ•°è¡¨ç¤ºï¼š
 * 1. ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºnullï¼Œè¡¨ç¤ºåœ¨çº¿ç¨‹æ± ä¸­åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œä½†ä¸å»å¯åŠ¨ï¼›
 * 2. ç¬¬äºŒä¸ªå‚æ•°ä¸ºfalseï¼Œå°†çº¿ç¨‹æ± çš„æœ‰é™çº¿ç¨‹æ•°é‡çš„ä¸Šé™è®¾ç½®ä¸ºmaximumPoolSizeï¼Œæ·»åŠ çº¿ç¨‹æ—¶æ ¹æ®maximumPoolSizeæ¥åˆ¤æ–­ï¼›
 * å¦‚æœåˆ¤æ–­workerCountå¤§äº0ï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œåœ¨workQueueä¸­æ–°å¢çš„commandä¼šåœ¨å°†æ¥çš„æŸä¸ªæ—¶åˆ»è¢«æ‰§è¡Œã€‚
   */&lt;/span&gt;
       &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;workerCountOf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;recheck&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
           &lt;span class=&quot;n&quot;&gt;addWorker&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
   &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
   &lt;span class=&quot;cm&quot;&gt;/*
 * å¦‚æœæ‰§è¡Œåˆ°è¿™é‡Œï¼Œæœ‰ä¸¤ç§æƒ…å†µï¼š
 * 1. çº¿ç¨‹æ± å·²ç»ä¸æ˜¯RUNNINGçŠ¶æ€ï¼›
 * 2. çº¿ç¨‹æ± æ˜¯RUNNINGçŠ¶æ€ï¼Œä½†workerCount &amp;gt;= corePoolSizeå¹¶ä¸”workQueueå·²æ»¡ã€‚
 * è¿™æ—¶ï¼Œå†æ¬¡è°ƒç”¨addWorkeræ–¹æ³•ï¼Œä½†ç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥ä¸ºfalseï¼Œå°†çº¿ç¨‹æ± çš„æœ‰é™çº¿ç¨‹æ•°é‡çš„ä¸Šé™è®¾ç½®ä¸ºmaximumPoolSizeï¼›
 * å¦‚æœå¤±è´¥åˆ™æ‹’ç»è¯¥ä»»åŠ¡
   */&lt;/span&gt;
   &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;addWorker&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt;
       &lt;span class=&quot;n&quot;&gt;reject&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
   &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;ç®€å•æ¥è¯´ï¼Œåœ¨æ‰§è¡Œexecute()æ–¹æ³•æ—¶å¦‚æœçŠ¶æ€ä¸€ç›´æ˜¯RUNNINGæ—¶ï¼Œçš„æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼š
å¦‚æœworkerCount &amp;lt; corePoolSizeï¼Œåˆ™åˆ›å»ºå¹¶å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œæ–°æäº¤çš„ä»»åŠ¡ï¼›
å¦‚æœworkerCount &amp;gt;= corePoolSizeï¼Œä¸”çº¿ç¨‹æ± å†…çš„é˜»å¡é˜Ÿåˆ—æœªæ»¡ï¼Œåˆ™å°†ä»»åŠ¡æ·»åŠ åˆ°è¯¥é˜»å¡é˜Ÿåˆ—ä¸­ï¼›
å¦‚æœworkerCount &amp;gt;= corePoolSize &amp;amp;&amp;amp; workerCount &amp;lt; maximumPoolSizeï¼Œä¸”çº¿ç¨‹æ± å†…çš„é˜»å¡é˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™åˆ›å»ºå¹¶å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œæ–°æäº¤çš„ä»»åŠ¡ï¼›
å¦‚æœworkerCount &amp;gt;= maximumPoolSizeï¼Œå¹¶ä¸”çº¿ç¨‹æ± å†…çš„é˜»å¡é˜Ÿåˆ—å·²æ»¡, åˆ™æ ¹æ®æ‹’ç»ç­–ç•¥æ¥å¤„ç†è¯¥ä»»åŠ¡, é»˜è®¤çš„å¤„ç†æ–¹å¼æ˜¯ç›´æ¥æŠ›å¼‚å¸¸ã€‚
è¿™é‡Œè¦æ³¨æ„ä¸€ä¸‹addWorker(null, false);ï¼Œä¹Ÿå°±æ˜¯åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œä½†å¹¶æ²¡æœ‰ä¼ å…¥ä»»åŠ¡ï¼Œå› ä¸ºä»»åŠ¡å·²ç»è¢«æ·»åŠ åˆ°workQueueä¸­äº†ï¼Œæ‰€ä»¥workeråœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œä¼šç›´æ¥ä»workQueueä¸­è·å–ä»»åŠ¡ã€‚æ‰€ä»¥ï¼Œåœ¨workerCountOf(recheck) == 0æ—¶æ‰§è¡ŒaddWorker(null, false);ä¹Ÿæ˜¯ä¸ºäº†ä¿è¯çº¿ç¨‹æ± åœ¨RUNNINGçŠ¶æ€ä¸‹å¿…é¡»è¦æœ‰ä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚&lt;/p&gt;

&lt;h3 id=&quot;executeæ–¹æ³•æ‰§è¡Œæµç¨‹å¦‚ä¸‹&quot;&gt;executeæ–¹æ³•æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š&lt;/h3&gt;

&lt;p&gt;&lt;img src=&quot;https://gitee.com/fwh666/fwh_images/raw/master/fwh_images/image-20210721202317964.png&quot; alt=&quot;image-20210721202317964&quot; style=&quot;zoom:50%;&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;addworkeræ–¹æ³•&quot;&gt;addWorkeræ–¹æ³•&lt;/h3&gt;

&lt;p&gt;addWorkeræ–¹æ³•çš„ä¸»è¦å·¥ä½œæ˜¯åœ¨çº¿ç¨‹æ± ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹å¹¶æ‰§è¡Œï¼ŒfirstTaskå‚æ•° ç”¨äºæŒ‡å®šæ–°å¢çš„çº¿ç¨‹æ‰§è¡Œçš„ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼Œcoreå‚æ•°ä¸ºtrueè¡¨ç¤ºåœ¨æ–°å¢çº¿ç¨‹æ—¶ä¼šåˆ¤æ–­å½“å‰æ´»åŠ¨çº¿ç¨‹æ•°æ˜¯å¦å°‘äºcorePoolSizeï¼Œfalseè¡¨ç¤ºæ–°å¢çº¿ç¨‹å‰éœ€è¦åˆ¤æ–­å½“å‰æ´»åŠ¨çº¿ç¨‹æ•°æ˜¯å¦å°‘äºmaximumPoolSizeï¼Œä»£ç å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;addWorker&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Runnable&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;firstTask&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;core&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nl&quot;&gt;retry:&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(;;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ctl&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// è·å–è¿è¡ŒçŠ¶æ€&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;runStateOf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;cm&quot;&gt;/*

   * è¿™ä¸ªifåˆ¤æ–­
      å¦‚æœrs &amp;gt;= SHUTDOWNï¼Œåˆ™è¡¨ç¤ºæ­¤æ—¶ä¸å†æ¥æ”¶æ–°ä»»åŠ¡ï¼›
        * æ¥ç€åˆ¤æ–­ä»¥ä¸‹3ä¸ªæ¡ä»¶ï¼Œåªè¦æœ‰1ä¸ªä¸æ»¡è¶³ï¼Œåˆ™è¿”å›falseï¼š
            1. rs == SHUTDOWNï¼Œè¿™æ—¶è¡¨ç¤ºå…³é—­çŠ¶æ€ï¼Œä¸å†æ¥å—æ–°æäº¤çš„ä»»åŠ¡ï¼Œä½†å´å¯ä»¥ç»§ç»­å¤„ç†é˜»å¡é˜Ÿåˆ—ä¸­å·²ä¿å­˜çš„ä»»åŠ¡
               * 2. firsTaskä¸ºç©º
               * 3. é˜»å¡é˜Ÿåˆ—ä¸ä¸ºç©º
               * 
               * é¦–å…ˆè€ƒè™‘rs == SHUTDOWNçš„æƒ…å†µ
               * è¿™ç§æƒ…å†µä¸‹ä¸ä¼šæ¥å—æ–°æäº¤çš„ä»»åŠ¡ï¼Œæ‰€ä»¥åœ¨firstTaskä¸ä¸ºç©ºçš„æ—¶å€™ä¼šè¿”å›falseï¼›
               * ç„¶åï¼Œå¦‚æœfirstTaskä¸ºç©ºï¼Œå¹¶ä¸”workQueueä¹Ÿä¸ºç©ºï¼Œåˆ™è¿”å›falseï¼Œ
               * å› ä¸ºé˜Ÿåˆ—ä¸­å·²ç»æ²¡æœ‰ä»»åŠ¡äº†ï¼Œä¸éœ€è¦å†æ·»åŠ çº¿ç¨‹äº†
                 */&lt;/span&gt;
                 &lt;span class=&quot;c1&quot;&gt;// Check if queue empty only if necessary.&lt;/span&gt;
                 &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SHUTDOWN&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt;
                 &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SHUTDOWN&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt;
                  &lt;span class=&quot;n&quot;&gt;firstTask&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt;
                  &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;workQueue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;isEmpty&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()))&lt;/span&gt;
                 &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                 &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(;;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                 &lt;span class=&quot;c1&quot;&gt;// è·å–çº¿ç¨‹æ•°&lt;/span&gt;
                 &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;wc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;workerCountOf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
                 &lt;span class=&quot;c1&quot;&gt;// å¦‚æœwcè¶…è¿‡CAPACITYï¼Œä¹Ÿå°±æ˜¯ctlçš„ä½29ä½çš„æœ€å¤§å€¼ï¼ˆäºŒè¿›åˆ¶æ˜¯29ä¸ª1ï¼‰ï¼Œè¿”å›falseï¼›&lt;/span&gt;
                 &lt;span class=&quot;c1&quot;&gt;// è¿™é‡Œçš„coreæ˜¯addWorkeræ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œå¦‚æœä¸ºtrueè¡¨ç¤ºæ ¹æ®corePoolSizeæ¥æ¯”è¾ƒï¼Œ&lt;/span&gt;
                 &lt;span class=&quot;c1&quot;&gt;// å¦‚æœä¸ºfalseåˆ™æ ¹æ®maximumPoolSizeæ¥æ¯”è¾ƒã€‚&lt;/span&gt;
                 &lt;span class=&quot;c1&quot;&gt;// &lt;/span&gt;
                 &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;wc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CAPACITY&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt;
                 &lt;span class=&quot;n&quot;&gt;wc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;core&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;corePoolSize&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;maximumPoolSize&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt;
                 &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                 &lt;span class=&quot;c1&quot;&gt;// å°è¯•å¢åŠ workerCountï¼Œå¦‚æœæˆåŠŸï¼Œåˆ™è·³å‡ºç¬¬ä¸€ä¸ªforå¾ªç¯&lt;/span&gt;
                 &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;compareAndIncrementWorkerCount&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt;
                 &lt;span class=&quot;k&quot;&gt;break&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;retry&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                 &lt;span class=&quot;c1&quot;&gt;// å¦‚æœå¢åŠ workerCountå¤±è´¥ï¼Œåˆ™é‡æ–°è·å–ctlçš„å€¼&lt;/span&gt;
                 &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ctl&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;// Re-read ctl&lt;/span&gt;
                 &lt;span class=&quot;c1&quot;&gt;// å¦‚æœå½“å‰çš„è¿è¡ŒçŠ¶æ€ä¸ç­‰äºrsï¼Œè¯´æ˜çŠ¶æ€å·²è¢«æ”¹å˜ï¼Œè¿”å›ç¬¬ä¸€ä¸ªforå¾ªç¯ç»§ç»­æ‰§è¡Œ&lt;/span&gt;
                 &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;runStateOf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
                 &lt;span class=&quot;k&quot;&gt;continue&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;retry&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                 &lt;span class=&quot;c1&quot;&gt;// else CAS failed due to workerCount change; retry inner loop&lt;/span&gt;
                 &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
                 &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
                 &lt;span class=&quot;kt&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;workerStarted&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                 &lt;span class=&quot;kt&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;workerAdded&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                 &lt;span class=&quot;n&quot;&gt;Worker&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;w&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                 &lt;span class=&quot;k&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                  &lt;span class=&quot;c1&quot;&gt;// æ ¹æ®firstTaskæ¥åˆ›å»ºWorkerå¯¹è±¡&lt;/span&gt;
                 &lt;span class=&quot;n&quot;&gt;w&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Worker&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;firstTask&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
                  &lt;span class=&quot;c1&quot;&gt;// æ¯ä¸€ä¸ªWorkerå¯¹è±¡éƒ½ä¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹&lt;/span&gt;
                 &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Thread&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;thread&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                 &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;t&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                 &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ReentrantLock&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mainLock&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;mainLock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                 &lt;span class=&quot;n&quot;&gt;mainLock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;lock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
                 &lt;span class=&quot;k&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                 &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;runStateOf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ctl&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;());&lt;/span&gt;
                 &lt;span class=&quot;c1&quot;&gt;// rs &amp;lt; SHUTDOWNè¡¨ç¤ºæ˜¯RUNNINGçŠ¶æ€ï¼›&lt;/span&gt;
                 &lt;span class=&quot;c1&quot;&gt;// å¦‚æœrsæ˜¯RUNNINGçŠ¶æ€æˆ–è€…rsæ˜¯SHUTDOWNçŠ¶æ€å¹¶ä¸”firstTaskä¸ºnullï¼Œå‘çº¿ç¨‹æ± ä¸­æ·»åŠ çº¿ç¨‹ã€‚&lt;/span&gt;
                 &lt;span class=&quot;c1&quot;&gt;// å› ä¸ºåœ¨SHUTDOWNæ—¶ä¸ä¼šåœ¨æ·»åŠ æ–°çš„ä»»åŠ¡ï¼Œä½†è¿˜æ˜¯ä¼šæ‰§è¡ŒworkQueueä¸­çš„ä»»åŠ¡&lt;/span&gt;
                 &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SHUTDOWN&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt;
                   &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SHUTDOWN&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;firstTask&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                 &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;isAlive&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;())&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// precheck that t is startable&lt;/span&gt;
                   &lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;IllegalThreadStateException&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
                 &lt;span class=&quot;c1&quot;&gt;// workersæ˜¯ä¸€ä¸ªHashSet&lt;/span&gt;
                 &lt;span class=&quot;n&quot;&gt;workers&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;add&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
                 &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;s&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;workers&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
                 &lt;span class=&quot;c1&quot;&gt;// largestPoolSizeè®°å½•ç€çº¿ç¨‹æ± ä¸­å‡ºç°è¿‡çš„æœ€å¤§çº¿ç¨‹æ•°é‡&lt;/span&gt;
                 &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;s&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;largestPoolSize&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
                   &lt;span class=&quot;n&quot;&gt;largestPoolSize&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                 &lt;span class=&quot;n&quot;&gt;workerAdded&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                 &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
                 &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;finally&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                 &lt;span class=&quot;n&quot;&gt;mainLock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;unlock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
                 &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
                 &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;workerAdded&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                 &lt;span class=&quot;c1&quot;&gt;// å¯åŠ¨çº¿ç¨‹&lt;/span&gt;
                 &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
                 &lt;span class=&quot;n&quot;&gt;workerStarted&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                 &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
                 &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
                 &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;finally&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                 &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(!&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;workerStarted&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
                 &lt;span class=&quot;n&quot;&gt;addWorkerFailed&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
                 &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
                 &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;workerStarted&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                 &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;workerç±»&quot;&gt;Workerç±»&lt;/h3&gt;

&lt;p&gt;çº¿ç¨‹æ± ä¸­çš„æ¯ä¸€ä¸ªçº¿ç¨‹è¢«å°è£…æˆä¸€ä¸ªWorkerå¯¹è±¡ï¼ŒThreadPoolç»´æŠ¤çš„å…¶å®å°±æ˜¯ä¸€ç»„Workerå¯¹è±¡ï¼Œè¯·å‚è§JDKæºç ã€‚
Workerç±»ç»§æ‰¿äº†AQSï¼Œå¹¶å®ç°äº†Runnableæ¥å£ï¼Œæ³¨æ„å…¶ä¸­çš„firstTaskå’Œthreadå±æ€§ï¼šfirstTaskç”¨å®ƒæ¥ä¿å­˜ä¼ å…¥çš„ä»»åŠ¡ï¼›threadæ˜¯åœ¨è°ƒç”¨æ„é€ æ–¹æ³•æ—¶é€šè¿‡ThreadFactoryæ¥åˆ›å»ºçš„çº¿ç¨‹ï¼Œæ˜¯ç”¨æ¥å¤„ç†ä»»åŠ¡çš„çº¿ç¨‹ã€‚
åœ¨è°ƒç”¨æ„é€ æ–¹æ³•æ—¶ï¼Œéœ€è¦æŠŠä»»åŠ¡ä¼ å…¥ï¼Œè¿™é‡Œé€šè¿‡getThreadFactory().newThread(this);æ¥æ–°å»ºä¸€ä¸ªçº¿ç¨‹ï¼ŒnewThreadæ–¹æ³•ä¼ å…¥çš„å‚æ•°æ˜¯thisï¼Œå› ä¸ºWorkeræœ¬èº«ç»§æ‰¿äº†Runnableæ¥å£ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰€ä»¥ä¸€ä¸ªWorkerå¯¹è±¡åœ¨å¯åŠ¨çš„æ—¶å€™ä¼šè°ƒç”¨Workerç±»ä¸­çš„runæ–¹æ³•ã€‚
Workerç»§æ‰¿äº†AQSï¼Œä½¿ç”¨AQSæ¥å®ç°ç‹¬å é”çš„åŠŸèƒ½ã€‚ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ReentrantLockæ¥å®ç°å‘¢ï¼Ÿå¯ä»¥çœ‹åˆ°tryAcquireæ–¹æ³•ï¼Œå®ƒæ˜¯ä¸å…è®¸é‡å…¥çš„ï¼Œè€ŒReentrantLockæ˜¯å…è®¸é‡å…¥çš„ï¼š
lockæ–¹æ³•ä¸€æ—¦è·å–äº†ç‹¬å é”ï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹æ­£åœ¨æ‰§è¡Œä»»åŠ¡ä¸­ï¼›
å¦‚æœæ­£åœ¨æ‰§è¡Œä»»åŠ¡ï¼Œåˆ™ä¸åº”è¯¥ä¸­æ–­çº¿ç¨‹ï¼›
å¦‚æœè¯¥çº¿ç¨‹ç°åœ¨ä¸æ˜¯ç‹¬å é”çš„çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯ç©ºé—²çš„çŠ¶æ€ï¼Œè¯´æ˜å®ƒæ²¡æœ‰åœ¨å¤„ç†ä»»åŠ¡ï¼Œè¿™æ—¶å¯ä»¥å¯¹è¯¥çº¿ç¨‹è¿›è¡Œä¸­æ–­ï¼›
çº¿ç¨‹æ± åœ¨æ‰§è¡Œshutdownæ–¹æ³•æˆ–tryTerminateæ–¹æ³•æ—¶ä¼šè°ƒç”¨interruptIdleWorkersæ–¹æ³•æ¥ä¸­æ–­ç©ºé—²çš„çº¿ç¨‹ï¼ŒinterruptIdleWorkersæ–¹æ³•ä¼šä½¿ç”¨tryLockæ–¹æ³•æ¥åˆ¤æ–­çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ˜¯å¦æ˜¯ç©ºé—²çŠ¶æ€ï¼›
ä¹‹æ‰€ä»¥è®¾ç½®ä¸ºä¸å¯é‡å…¥ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬ä¸å¸Œæœ›ä»»åŠ¡åœ¨è°ƒç”¨åƒsetCorePoolSizeè¿™æ ·çš„çº¿ç¨‹æ± æ§åˆ¶æ–¹æ³•æ—¶é‡æ–°è·å–é”ã€‚å¦‚æœä½¿ç”¨ReentrantLockï¼Œå®ƒæ˜¯å¯é‡å…¥çš„ï¼Œè¿™æ ·å¦‚æœåœ¨ä»»åŠ¡ä¸­è°ƒç”¨äº†å¦‚setCorePoolSizeè¿™ç±»çº¿ç¨‹æ± æ§åˆ¶çš„æ–¹æ³•ï¼Œä¼šä¸­æ–­æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ã€‚
æ‰€ä»¥ï¼ŒWorkerç»§æ‰¿è‡ªAQSï¼Œç”¨äºåˆ¤æ–­çº¿ç¨‹æ˜¯å¦ç©ºé—²ä»¥åŠæ˜¯å¦å¯ä»¥è¢«ä¸­æ–­ã€‚
æ­¤å¤–ï¼Œåœ¨æ„é€ æ–¹æ³•ä¸­æ‰§è¡Œäº†setState(-1);ï¼ŒæŠŠstateå˜é‡è®¾ç½®ä¸º-1ï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆåšå‘¢ï¼Ÿæ˜¯å› ä¸ºAQSä¸­é»˜è®¤çš„stateæ˜¯0ï¼Œå¦‚æœåˆšåˆ›å»ºäº†ä¸€ä¸ªWorkerå¯¹è±¡ï¼Œè¿˜æ²¡æœ‰æ‰§è¡Œä»»åŠ¡æ—¶ï¼Œè¿™æ—¶å°±ä¸åº”è¯¥è¢«ä¸­æ–­ï¼Œçœ‹ä¸€ä¸‹tryAquireæ–¹æ³•ï¼š&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;tryAcquire&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;unused&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;//casä¿®æ”¹stateï¼Œä¸å¯é‡å…¥&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;compareAndSetState&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; 
        &lt;span class=&quot;n&quot;&gt;setExclusiveOwnerThread&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Thread&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;currentThread&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;());&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;


&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;tryAcquireæ–¹æ³•æ˜¯æ ¹æ®stateæ˜¯å¦æ˜¯0æ¥åˆ¤æ–­çš„ï¼Œæ‰€ä»¥ï¼ŒsetState(-1);å°†stateè®¾ç½®ä¸º-1æ˜¯ä¸ºäº†ç¦æ­¢åœ¨æ‰§è¡Œä»»åŠ¡å‰å¯¹çº¿ç¨‹è¿›è¡Œä¸­æ–­ã€‚
æ­£å› ä¸ºå¦‚æ­¤ï¼Œåœ¨runWorkeræ–¹æ³•ä¸­ä¼šå…ˆè°ƒç”¨Workerå¯¹è±¡çš„unlockæ–¹æ³•å°†stateè®¾ç½®ä¸º0ã€‚&lt;/p&gt;

&lt;h3 id=&quot;runworkeræ–¹æ³•&quot;&gt;runWorkeræ–¹æ³•&lt;/h3&gt;

&lt;p&gt;åœ¨Workerç±»ä¸­çš„runæ–¹æ³•è°ƒç”¨äº†runWorkeræ–¹æ³•æ¥æ‰§è¡Œä»»åŠ¡ï¼ŒrunWorkeræ–¹æ³•çš„ä»£ç å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;runWorker&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Worker&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Thread&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;wt&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Thread&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;currentThread&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// è·å–ç¬¬ä¸€ä¸ªä»»åŠ¡&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Runnable&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;task&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;firstTask&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;firstTask&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// å…è®¸ä¸­æ–­&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;unlock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// allow interrupts&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// æ˜¯å¦å› ä¸ºå¼‚å¸¸é€€å‡ºå¾ªç¯&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;completedAbruptly&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// å¦‚æœtaskä¸ºç©ºï¼Œåˆ™é€šè¿‡getTaskæ¥è·å–ä»»åŠ¡&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;task&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;task&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;getTask&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;())&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;lock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;runStateAtLeast&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ctl&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;STOP&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt;
                    &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Thread&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;interrupted&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt;
                            &lt;span class=&quot;n&quot;&gt;runStateAtLeast&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ctl&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;STOP&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt;
                    &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;wt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;isInterrupted&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;())&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;wt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;interrupt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;beforeExecute&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;wt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;task&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;Throwable&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;thrown&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;n&quot;&gt;task&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
                &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;RuntimeException&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;n&quot;&gt;thrown&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Error&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;n&quot;&gt;thrown&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Throwable&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;n&quot;&gt;thrown&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
                &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;finally&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;n&quot;&gt;afterExecute&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;task&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;thrown&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
                &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;finally&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;task&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;completedTasks&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++;&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;unlock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;completedAbruptly&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;finally&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;processWorkerExit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;completedAbruptly&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;è¿™é‡Œè¯´æ˜ä¸€ä¸‹ç¬¬ä¸€ä¸ªifåˆ¤æ–­ï¼Œç›®çš„æ˜¯ï¼š
å¦‚æœçº¿ç¨‹æ± æ­£åœ¨åœæ­¢ï¼Œé‚£ä¹ˆè¦ä¿è¯å½“å‰çº¿ç¨‹æ˜¯ä¸­æ–­çŠ¶æ€ï¼›
å¦‚æœä¸æ˜¯çš„è¯ï¼Œåˆ™è¦ä¿è¯å½“å‰çº¿ç¨‹ä¸æ˜¯ä¸­æ–­çŠ¶æ€ï¼›
è¿™é‡Œè¦è€ƒè™‘åœ¨æ‰§è¡Œè¯¥ifè¯­å¥æœŸé—´å¯èƒ½ä¹Ÿæ‰§è¡Œäº†shutdownNowæ–¹æ³•ï¼ŒshutdownNowæ–¹æ³•ä¼šæŠŠçŠ¶æ€è®¾ç½®ä¸ºSTOPï¼Œå›é¡¾ä¸€ä¸‹STOPçŠ¶æ€ï¼š
ä¸èƒ½æ¥å—æ–°ä»»åŠ¡ï¼Œä¹Ÿä¸å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œä¼šä¸­æ–­æ­£åœ¨å¤„ç†ä»»åŠ¡çš„çº¿ç¨‹ã€‚åœ¨çº¿ç¨‹æ± å¤„äº RUNNING æˆ– SHUTDOWN çŠ¶æ€æ—¶ï¼Œè°ƒç”¨ shutdownNow() æ–¹æ³•ä¼šä½¿çº¿ç¨‹æ± è¿›å…¥åˆ°è¯¥çŠ¶æ€ã€‚
STOPçŠ¶æ€è¦ä¸­æ–­çº¿ç¨‹æ± ä¸­çš„æ‰€æœ‰çº¿ç¨‹ï¼Œè€Œè¿™é‡Œä½¿ç”¨Thread.interrupted()æ¥åˆ¤æ–­æ˜¯å¦ä¸­æ–­æ˜¯ä¸ºäº†ç¡®ä¿åœ¨RUNNINGæˆ–è€…SHUTDOWNçŠ¶æ€æ—¶çº¿ç¨‹æ˜¯éä¸­æ–­çŠ¶æ€çš„ï¼Œå› ä¸ºThread.interrupted()æ–¹æ³•ä¼šå¤ä½ä¸­æ–­çš„çŠ¶æ€ã€‚
æ€»ç»“ä¸€ä¸‹runWorkeræ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹ï¼š
whileå¾ªç¯ä¸æ–­åœ°é€šè¿‡getTask()æ–¹æ³•è·å–ä»»åŠ¡ï¼›
getTask()æ–¹æ³•ä»é˜»å¡é˜Ÿåˆ—ä¸­å–ä»»åŠ¡ï¼›
å¦‚æœçº¿ç¨‹æ± æ­£åœ¨åœæ­¢ï¼Œé‚£ä¹ˆè¦ä¿è¯å½“å‰çº¿ç¨‹æ˜¯ä¸­æ–­çŠ¶æ€ï¼Œå¦åˆ™è¦ä¿è¯å½“å‰çº¿ç¨‹ä¸æ˜¯ä¸­æ–­çŠ¶æ€ï¼›
è°ƒç”¨task.run()æ‰§è¡Œä»»åŠ¡ï¼›
å¦‚æœtaskä¸ºnullåˆ™è·³å‡ºå¾ªç¯ï¼Œæ‰§è¡ŒprocessWorkerExit()æ–¹æ³•ï¼›
runWorkeræ–¹æ³•æ‰§è¡Œå®Œæ¯•ï¼Œä¹Ÿä»£è¡¨ç€Workerä¸­çš„runæ–¹æ³•æ‰§è¡Œå®Œæ¯•ï¼Œé”€æ¯çº¿ç¨‹ã€‚
è¿™é‡Œçš„beforeExecuteæ–¹æ³•å’ŒafterExecuteæ–¹æ³•åœ¨ThreadPoolExecutorç±»ä¸­æ˜¯ç©ºçš„ï¼Œç•™ç»™å­ç±»æ¥å®ç°ã€‚
completedAbruptlyå˜é‡æ¥è¡¨ç¤ºåœ¨æ‰§è¡Œä»»åŠ¡è¿‡ç¨‹ä¸­æ˜¯å¦å‡ºç°äº†å¼‚å¸¸ï¼Œåœ¨processWorkerExitæ–¹æ³•ä¸­ä¼šå¯¹è¯¥å˜é‡çš„å€¼è¿›è¡Œåˆ¤æ–­ã€‚&lt;/p&gt;

&lt;h3 id=&quot;gettaskæ–¹æ³•&quot;&gt;getTaskæ–¹æ³•&lt;/h3&gt;

&lt;p&gt;getTaskæ–¹æ³•ç”¨æ¥ä»é˜»å¡é˜Ÿåˆ—ä¸­å–ä»»åŠ¡ï¼Œä»£ç å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Runnable&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;getTask&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// timeOutå˜é‡çš„å€¼è¡¨ç¤ºä¸Šæ¬¡ä»é˜»å¡é˜Ÿåˆ—ä¸­å–ä»»åŠ¡æ—¶æ˜¯å¦è¶…æ—¶&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;timedOut&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// Did the last poll() time out?&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(;;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ctl&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;runStateOf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// Check if queue empty only if necessary.&lt;/span&gt;
    &lt;span class=&quot;cm&quot;&gt;/*

   * å¦‚æœçº¿ç¨‹æ± çŠ¶æ€rs &amp;gt;= SHUTDOWNï¼Œä¹Ÿå°±æ˜¯éRUNNINGçŠ¶æ€ï¼Œå†è¿›è¡Œä»¥ä¸‹åˆ¤æ–­ï¼š
       1. rs &amp;gt;= STOPï¼Œçº¿ç¨‹æ± æ˜¯å¦æ­£åœ¨stopï¼›
          * 2. é˜»å¡é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºã€‚
          * å¦‚æœä»¥ä¸Šæ¡ä»¶æ»¡è¶³ï¼Œåˆ™å°†workerCountå‡1å¹¶è¿”å›nullã€‚
          * å› ä¸ºå¦‚æœå½“å‰çº¿ç¨‹æ± çŠ¶æ€çš„å€¼æ˜¯SHUTDOWNæˆ–ä»¥ä¸Šæ—¶ï¼Œä¸å…è®¸å†å‘é˜»å¡é˜Ÿåˆ—ä¸­æ·»åŠ ä»»åŠ¡ã€‚
            */&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SHUTDOWN&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;STOP&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;workQueue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;isEmpty&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;decrementWorkerCount&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
            &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;wc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;workerCountOf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
            &lt;span class=&quot;c1&quot;&gt;// Are workers subject to culling?&lt;/span&gt;
            &lt;span class=&quot;c1&quot;&gt;// timedå˜é‡ç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œè¶…æ—¶æ§åˆ¶ã€‚&lt;/span&gt;
            &lt;span class=&quot;c1&quot;&gt;// allowCoreThreadTimeOuté»˜è®¤æ˜¯falseï¼Œä¹Ÿå°±æ˜¯æ ¸å¿ƒçº¿ç¨‹ä¸å…è®¸è¿›è¡Œè¶…æ—¶ï¼›&lt;/span&gt;
            &lt;span class=&quot;c1&quot;&gt;// wc &amp;gt; corePoolSizeï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°é‡ï¼›&lt;/span&gt;
            &lt;span class=&quot;c1&quot;&gt;// å¯¹äºè¶…è¿‡æ ¸å¿ƒçº¿ç¨‹æ•°é‡çš„è¿™äº›çº¿ç¨‹ï¼Œéœ€è¦è¿›è¡Œè¶…æ—¶æ§åˆ¶&lt;/span&gt;
            &lt;span class=&quot;kt&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;timed&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;allowCoreThreadTimeOut&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;wc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;corePoolSize&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;cm&quot;&gt;/*
 * wc &amp;gt; maximumPoolSizeçš„æƒ…å†µæ˜¯å› ä¸ºå¯èƒ½åœ¨æ­¤æ–¹æ³•æ‰§è¡Œé˜¶æ®µåŒæ—¶æ‰§è¡Œäº†setMaximumPoolSizeæ–¹æ³•ï¼›
 * timed &amp;amp;&amp;amp; timedOut å¦‚æœä¸ºtrueï¼Œè¡¨ç¤ºå½“å‰æ“ä½œéœ€è¦è¿›è¡Œè¶…æ—¶æ§åˆ¶ï¼Œå¹¶ä¸”ä¸Šæ¬¡ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡å‘ç”Ÿäº†è¶…æ—¶
 * æ¥ä¸‹æ¥åˆ¤æ–­ï¼Œå¦‚æœæœ‰æ•ˆçº¿ç¨‹æ•°é‡å¤§äº1ï¼Œæˆ–è€…é˜»å¡é˜Ÿåˆ—æ˜¯ç©ºçš„ï¼Œé‚£ä¹ˆå°è¯•å°†workerCountå‡1ï¼›
 * å¦‚æœå‡1å¤±è´¥ï¼Œåˆ™è¿”å›é‡è¯•ã€‚
 * å¦‚æœwc == 1æ—¶ï¼Œä¹Ÿå°±è¯´æ˜å½“å‰çº¿ç¨‹æ˜¯çº¿ç¨‹æ± ä¸­å”¯ä¸€çš„ä¸€ä¸ªçº¿ç¨‹äº†ã€‚
 */&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;wc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;maximumPoolSize&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;timed&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;timedOut&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;wc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;workQueue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;isEmpty&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;compareAndDecrementWorkerCount&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;continue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;cm&quot;&gt;/*
     * æ ¹æ®timedæ¥åˆ¤æ–­ï¼Œå¦‚æœä¸ºtrueï¼Œåˆ™é€šè¿‡é˜»å¡é˜Ÿåˆ—çš„pollæ–¹æ³•è¿›è¡Œè¶…æ—¶æ§åˆ¶ï¼Œå¦‚æœåœ¨keepAliveTimeæ—¶é—´å†…æ²¡æœ‰è·å–åˆ°ä»»åŠ¡ï¼Œåˆ™è¿”å›nullï¼›
     * å¦åˆ™é€šè¿‡takeæ–¹æ³•ï¼Œå¦‚æœè¿™æ—¶é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™takeæ–¹æ³•ä¼šé˜»å¡ç›´åˆ°é˜Ÿåˆ—ä¸ä¸ºç©ºã€‚
     *
     */&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;Runnable&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;r&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;timed&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;?&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;workQueue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;poll&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;keepAliveTime&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TimeUnit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;NANOSECONDS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;workQueue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;take&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;r&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// å¦‚æœ r == nullï¼Œè¯´æ˜å·²ç»è¶…æ—¶ï¼ŒtimedOutè®¾ç½®ä¸ºtrue&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;timedOut&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;InterruptedException&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;retry&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// å¦‚æœè·å–ä»»åŠ¡æ—¶å½“å‰çº¿ç¨‹å‘ç”Ÿäº†ä¸­æ–­ï¼Œåˆ™è®¾ç½®timedOutä¸ºfalseå¹¶è¿”å›å¾ªç¯é‡è¯•&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;timedOut&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;}&lt;/p&gt;

&lt;p&gt;è¿™é‡Œé‡è¦çš„åœ°æ–¹æ˜¯ç¬¬äºŒä¸ªifåˆ¤æ–­ï¼Œç›®çš„æ˜¯æ§åˆ¶çº¿ç¨‹æ± çš„æœ‰æ•ˆçº¿ç¨‹æ•°é‡ã€‚ç”±ä¸Šæ–‡ä¸­çš„åˆ†æå¯ä»¥çŸ¥é“ï¼Œåœ¨æ‰§è¡Œexecuteæ–¹æ³•æ—¶ï¼Œå¦‚æœå½“å‰çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°é‡è¶…è¿‡äº†corePoolSizeä¸”å°äºmaximumPoolSizeï¼Œå¹¶ä¸”workQueueå·²æ»¡æ—¶ï¼Œåˆ™å¯ä»¥å¢åŠ å·¥ä½œçº¿ç¨‹ï¼Œä½†è¿™æ—¶å¦‚æœè¶…æ—¶æ²¡æœ‰è·å–åˆ°ä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯timedOutä¸ºtrueçš„æƒ…å†µï¼Œè¯´æ˜workQueueå·²ç»ä¸ºç©ºäº†ï¼Œä¹Ÿå°±è¯´æ˜äº†å½“å‰çº¿ç¨‹æ± ä¸­ä¸éœ€è¦é‚£ä¹ˆå¤šçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡äº†ï¼Œå¯ä»¥æŠŠå¤šäºcorePoolSizeæ•°é‡çš„çº¿ç¨‹é”€æ¯æ‰ï¼Œä¿æŒçº¿ç¨‹æ•°é‡åœ¨corePoolSizeå³å¯ã€‚
ä»€ä¹ˆæ—¶å€™ä¼šé”€æ¯ï¼Ÿå½“ç„¶æ˜¯runWorkeræ–¹æ³•æ‰§è¡Œå®Œä¹‹åï¼Œä¹Ÿå°±æ˜¯Workerä¸­çš„runæ–¹æ³•æ‰§è¡Œå®Œï¼Œç”±JVMè‡ªåŠ¨å›æ”¶ã€‚
getTaskæ–¹æ³•è¿”å›nullæ—¶ï¼Œåœ¨runWorkeræ–¹æ³•ä¸­ä¼šè·³å‡ºwhileå¾ªç¯ï¼Œç„¶åä¼šæ‰§è¡ŒprocessWorkerExitæ–¹æ³•ã€‚&lt;/p&gt;

&lt;h3 id=&quot;processworkerexitæ–¹æ³•&quot;&gt;processWorkerExitæ–¹æ³•&lt;/h3&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;processWorkerExit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Worker&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;completedAbruptly&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// å¦‚æœcompletedAbruptlyå€¼ä¸ºtrueï¼Œåˆ™è¯´æ˜çº¿ç¨‹æ‰§è¡Œæ—¶å‡ºç°äº†å¼‚å¸¸ï¼Œéœ€è¦å°†workerCountå‡1ï¼›&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// å¦‚æœçº¿ç¨‹æ‰§è¡Œæ—¶æ²¡æœ‰å‡ºç°å¼‚å¸¸ï¼Œè¯´æ˜åœ¨getTask()æ–¹æ³•ä¸­å·²ç»å·²ç»å¯¹workerCountè¿›è¡Œäº†å‡1æ“ä½œï¼Œè¿™é‡Œå°±ä¸å¿…å†å‡äº†ã€‚  &lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;completedAbruptly&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// If abrupt, then workerCount wasn't adjusted&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;decrementWorkerCount&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ReentrantLock&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mainLock&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;mainLock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;mainLock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;lock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;//ç»Ÿè®¡å®Œæˆçš„ä»»åŠ¡æ•°&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;completedTaskCount&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;completedTasks&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// ä»workersä¸­ç§»é™¤ï¼Œä¹Ÿå°±è¡¨ç¤ºç€ä»çº¿ç¨‹æ± ä¸­ç§»é™¤äº†ä¸€ä¸ªå·¥ä½œçº¿ç¨‹&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;workers&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;remove&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;finally&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;mainLock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;unlock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// æ ¹æ®çº¿ç¨‹æ± çŠ¶æ€è¿›è¡Œåˆ¤æ–­æ˜¯å¦ç»“æŸçº¿ç¨‹æ± &lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;tryTerminate&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ctl&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;cm&quot;&gt;/*

 * å½“çº¿ç¨‹æ± æ˜¯RUNNINGæˆ–SHUTDOWNçŠ¶æ€æ—¶ï¼Œå¦‚æœworkeræ˜¯å¼‚å¸¸ç»“æŸï¼Œé‚£ä¹ˆä¼šç›´æ¥addWorkerï¼›
 * å¦‚æœallowCoreThreadTimeOut=trueï¼Œå¹¶ä¸”ç­‰å¾…é˜Ÿåˆ—æœ‰ä»»åŠ¡ï¼Œè‡³å°‘ä¿ç•™ä¸€ä¸ªworkerï¼›
 * å¦‚æœallowCoreThreadTimeOut=falseï¼ŒworkerCountä¸å°‘äºcorePoolSizeã€‚
   */&lt;/span&gt;
   &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;runStateLessThan&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;STOP&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
       &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;completedAbruptly&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
           &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;min&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;allowCoreThreadTimeOut&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;corePoolSize&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
           &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;min&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;workQueue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;isEmpty&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;())&lt;/span&gt;
               &lt;span class=&quot;n&quot;&gt;min&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
           &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;workerCountOf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;min&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
               &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// replacement not needed&lt;/span&gt;
       &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
       &lt;span class=&quot;n&quot;&gt;addWorker&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
   &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
   &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;è‡³æ­¤ï¼ŒprocessWorkerExitæ‰§è¡Œå®Œä¹‹åï¼Œå·¥ä½œçº¿ç¨‹è¢«é”€æ¯ï¼Œä»¥ä¸Šå°±æ˜¯æ•´ä¸ªå·¥ä½œçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸï¼Œä»executeæ–¹æ³•å¼€å§‹ï¼ŒWorkerä½¿ç”¨ThreadFactoryåˆ›å»ºæ–°çš„å·¥ä½œçº¿ç¨‹ï¼ŒrunWorkeré€šè¿‡getTaskè·å–ä»»åŠ¡ï¼Œç„¶åæ‰§è¡Œä»»åŠ¡ï¼Œå¦‚æœgetTaskè¿”å›nullï¼Œè¿›å…¥processWorkerExitæ–¹æ³•ï¼Œæ•´ä¸ªçº¿ç¨‹ç»“æŸï¼Œå¦‚å›¾æ‰€ç¤ºï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://gitee.com/fwh666/fwh_images/raw/master/fwh_images/image-20210721202556982.png&quot; alt=&quot;image-20210721202556982&quot; style=&quot;zoom:50%;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;è¯¾ç¨‹æ€»ç»“
åˆ†æäº†çº¿ç¨‹çš„åˆ›å»ºï¼Œä»»åŠ¡çš„æäº¤ï¼ŒçŠ¶æ€çš„è½¬æ¢ä»¥åŠçº¿ç¨‹æ± çš„å…³é—­ï¼›
è¿™é‡Œé€šè¿‡executeæ–¹æ³•æ¥å±•å¼€çº¿ç¨‹æ± çš„å·¥ä½œæµç¨‹ï¼Œexecuteæ–¹æ³•é€šè¿‡corePoolSizeï¼ŒmaximumPoolSizeä»¥åŠé˜»å¡é˜Ÿåˆ—çš„å¤§å°æ¥åˆ¤æ–­å†³å®šä¼ å…¥çš„ä»»åŠ¡åº”è¯¥è¢«ç«‹å³æ‰§è¡Œï¼Œè¿˜æ˜¯åº”è¯¥æ·»åŠ åˆ°é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œè¿˜æ˜¯åº”è¯¥æ‹’ç»ä»»åŠ¡ã€‚
ä»‹ç»äº†çº¿ç¨‹æ± å…³é—­æ—¶çš„è¿‡ç¨‹ï¼Œä¹Ÿåˆ†æäº†shutdownæ–¹æ³•ä¸getTaskæ–¹æ³•å­˜åœ¨ç«æ€æ¡ä»¶ï¼›
åœ¨è·å–ä»»åŠ¡æ—¶ï¼Œè¦é€šè¿‡çº¿ç¨‹æ± çš„çŠ¶æ€æ¥åˆ¤æ–­åº”è¯¥ç»“æŸå·¥ä½œçº¿ç¨‹è¿˜æ˜¯é˜»å¡çº¿ç¨‹ç­‰å¾…æ–°çš„ä»»åŠ¡ï¼Œä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆå…³é—­çº¿ç¨‹æ± æ—¶è¦ä¸­æ–­å·¥ä½œçº¿ç¨‹ä»¥åŠä¸ºä»€ä¹ˆæ¯ä¸€ä¸ªworkeréƒ½éœ€è¦lockã€‚&lt;/p&gt;</content><author><name>WenHao</name></author><summary type="html">çº¿ç¨‹</summary></entry><entry><title type="html">å¹¶å‘ç¼–ç¨‹(ä¹)-Collectionsä¹‹Map&amp;amp;List&amp;amp;Setè¯¦è§£</title><link href="http://localhost:4000/2020/07/09/Collections%E4%B9%8BMap&List&Set/" rel="alternate" type="text/html" title="å¹¶å‘ç¼–ç¨‹(ä¹)-Collectionsä¹‹Map&amp;List&amp;Setè¯¦è§£" /><published>2020-07-09T00:00:00+08:00</published><updated>2020-07-09T00:00:00+08:00</updated><id>http://localhost:4000/2020/07/09/Collections%E4%B9%8BMap&amp;List&amp;Set</id><content type="html" xml:base="http://localhost:4000/2020/07/09/Collections%E4%B9%8BMap&amp;List&amp;Set/">&lt;h1 id=&quot;hashmap&quot;&gt;HashMap&lt;/h1&gt;

&lt;h2 id=&quot;æ•°æ®ç»“æ„&quot;&gt;æ•°æ®ç»“æ„&lt;/h2&gt;

&lt;p&gt;æ•°ç»„+é“¾è¡¨+(çº¢é»‘æ ‘jdk&amp;gt;=8)&lt;/p&gt;

&lt;h2 id=&quot;æºç åŸç†åˆ†æ&quot;&gt;æºç åŸç†åˆ†æ&lt;/h2&gt;

&lt;p&gt;é‡è¦æˆå‘˜å˜é‡
DEFAULT_INITIAL_CAPACITY = 1 Â«Â 4; Hashè¡¨é»˜è®¤åˆå§‹å®¹é‡
MAXIMUM_CAPACITY = 1 Â«Â 30; æœ€å¤§Hashè¡¨å®¹é‡
DEFAULT_LOAD_FACTOR = 0.75fï¼›é»˜è®¤åŠ è½½å› å­
TREEIFY_THRESHOLD = 8ï¼›é“¾è¡¨è½¬çº¢é»‘æ ‘é˜ˆå€¼
UNTREEIFY_THRESHOLD = 6ï¼›çº¢é»‘æ ‘è½¬é“¾è¡¨é˜ˆå€¼
MIN_TREEIFY_CAPACITY = 64ï¼›é“¾è¡¨è½¬çº¢é»‘æ ‘æ—¶hashè¡¨æœ€å°å®¹é‡é˜ˆå€¼ï¼Œè¾¾ä¸åˆ°ä¼˜å…ˆæ‰©å®¹ã€‚
å†…éƒ¨çš„æ‰§è¡Œæœºåˆ¶æºç 
è§è¯¾å ‚è®²è§£ã€‚
HashMapæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œä¸å®‰å…¨çš„å…·ä½“åŸå› å°±æ˜¯åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œæ‰©å®¹å¯èƒ½äº§ç”Ÿæ­»é”(Jdk1.7å­˜åœ¨)ä»¥åŠgetæ“ä½œå¯èƒ½å¸¦æ¥çš„æ•°æ®ä¸¢å¤±ã€‚&lt;/p&gt;

&lt;h2 id=&quot;jdk7-æ‰©å®¹æ­»é”åˆ†æ&quot;&gt;Jdk7-æ‰©å®¹æ­»é”åˆ†æ&lt;/h2&gt;

&lt;p&gt;æ­»é”é—®é¢˜æ ¸å¿ƒåœ¨äºä¸‹é¢ä»£ç ï¼Œå¤šçº¿ç¨‹æ‰©å®¹å¯¼è‡´å½¢æˆçš„é“¾è¡¨ç¯!&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;transfer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Entry&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;newTable&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rehash&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;newCapacity&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;newTable&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Entry&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;V&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;table&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;while&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;Entry&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;V&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;next&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;next&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;//ç¬¬ä¸€è¡Œ&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rehash&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;hash&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;key&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;hash&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
            &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;indexFor&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;hash&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;newCapacity&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;//ç¬¬äºŒè¡Œ&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;next&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;newTable&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;];&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;//ç¬¬ä¸‰è¡Œ&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;newTable&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;//ç¬¬å››è¡Œ&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;next&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;//ç¬¬äº”è¡Œ&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;å»æ‰äº†ä¸€äº›å†—ä½™çš„ä»£ç ï¼Œ å±‚æ¬¡ç»“æ„æ›´åŠ æ¸…æ™°äº†ã€‚
ç¬¬ä¸€è¡Œï¼šè®°å½•oldhashè¡¨ä¸­e.next
ç¬¬äºŒè¡Œï¼šrehashè®¡ç®—å‡ºæ•°ç»„çš„ä½ç½®(hashè¡¨ä¸­æ¡¶çš„ä½ç½®)
ç¬¬ä¸‰è¡Œï¼šeè¦æ’å…¥é“¾è¡¨çš„å¤´éƒ¨ï¼Œ æ‰€ä»¥è¦å…ˆå°†e.nextæŒ‡å‘new hashè¡¨ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ 
ç¬¬å››è¡Œï¼šå°†eæ”¾å…¥åˆ°new hashè¡¨çš„å¤´éƒ¨
ç¬¬äº”è¡Œï¼š è½¬ç§»eåˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œ ç»§ç»­å¾ªç¯ä¸‹å»&lt;/p&gt;

&lt;h3 id=&quot;å•çº¿ç¨‹æ‰©å®¹&quot;&gt;å•çº¿ç¨‹æ‰©å®¹&lt;/h3&gt;

&lt;p&gt;å‡è®¾ï¼šhashç®—æ³•å°±æ˜¯ç®€å•çš„keyä¸length(æ•°ç»„é•¿åº¦)æ±‚ä½™ã€‚hashè¡¨é•¿åº¦ä¸º2ï¼Œå¦‚æœä¸æ‰©å®¹ï¼Œ é‚£ä¹ˆå…ƒç´ keyä¸º3,5,7æŒ‰ç…§è®¡ç®—(key%table.length)çš„è¯éƒ½åº”è¯¥ç¢°æ’åˆ°table[1]ä¸Šã€‚
æ‰©å®¹ï¼šhashè¡¨é•¿åº¦ä¼šæ‰©å®¹ä¸º4é‡æ–°hashï¼Œkey=3 ä¼šè½åˆ°table[3]ä¸Š(3%4=3)ï¼Œ å½“å‰e.nextä¸ºkey(7), ç»§ç»­whileå¾ªç¯é‡æ–°hashï¼Œkey=7 ä¼šè½åˆ°table[3]ä¸Š(7%4=3), äº§ç”Ÿç¢°æ’ï¼Œ è¿™é‡Œé‡‡ç”¨çš„æ˜¯å¤´æ’å…¥æ³•ï¼Œæ‰€ä»¥key=7çš„Entryä¼šæ’åœ¨key=3å‰é¢(è¿™é‡Œå¯ä»¥å…·ä½“çœ‹whileè¯­å¥ä¸­ä»£ç )å½“å‰e.nextä¸ºkey(5), ç»§ç»­whileå¾ªç¯é‡æ–°hashï¼Œkey=5 ä¼šè½åˆ°table[1]ä¸Š(5%4=3)ï¼Œ å½“å‰e.nextä¸ºnull, è·³å‡ºwhileå¾ªç¯ï¼Œresizeç»“æŸã€‚
å¦‚ä¸‹å›¾æ‰€ç¤º&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://gitee.com/fwh666/fwh_images/raw/master/fwh_images/image-20210721200805156.png&quot; alt=&quot;image-20210721200805156&quot; style=&quot;zoom:50%;&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;å¤šçº¿ç¨‹æ‰©å®¹&quot;&gt;å¤šçº¿ç¨‹æ‰©å®¹&lt;/h3&gt;

&lt;p&gt;ä¸‹é¢å°±æ˜¯å¤šçº¿ç¨‹åŒæ—¶putçš„æƒ…å†µäº†ï¼Œ ç„¶ååŒæ—¶è¿›å…¥transferæ–¹æ³•ä¸­ï¼šå‡è®¾è¿™é‡Œæœ‰ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œäº†put()æ“ä½œï¼Œå¹¶è¿›å…¥äº†transfer()ç¯èŠ‚&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;while&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;Entry&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;V&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;next&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;next&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;//ç¬¬ä¸€è¡Œï¼Œçº¿ç¨‹1æ‰§è¡Œåˆ°æ­¤è¢«è°ƒåº¦æŒ‚èµ·&lt;/span&gt;
      &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;indexFor&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;hash&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;newCapacity&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;//ç¬¬äºŒè¡Œ&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;next&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;newTable&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;];&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;//ç¬¬ä¸‰è¡Œ&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;newTable&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;//ç¬¬å››è¡Œ&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;next&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;//ç¬¬äº”è¡Œ&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;é‚£ä¹ˆæ­¤æ—¶çŠ¶æ€ä¸ºï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://gitee.com/fwh666/fwh_images/raw/master/fwh_images/image-20210721200840587.png&quot; alt=&quot;image-20210721200840587&quot; style=&quot;zoom:50%;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;ä»ä¸Šé¢çš„å›¾æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå› ä¸ºçº¿ç¨‹1çš„ e æŒ‡å‘äº† key(3)ï¼Œè€Œ next æŒ‡å‘äº† key(7)ï¼Œåœ¨çº¿ç¨‹2 rehash åï¼Œå°±æŒ‡å‘äº†çº¿ç¨‹2 rehash åçš„é“¾è¡¨ã€‚
ç„¶åçº¿ç¨‹1è¢«å”¤é†’äº†ï¼š
æ‰§è¡Œe.next = newTable[i]ï¼Œäºæ˜¯ key(3)çš„ next æŒ‡å‘äº†çº¿ç¨‹1çš„æ–° Hash è¡¨ï¼Œå› ä¸ºæ–° Hash è¡¨ä¸ºç©ºï¼Œæ‰€ä»¥e.next = nullï¼Œ
æ‰§è¡ŒnewTable[i] = eï¼Œæ‰€ä»¥çº¿ç¨‹1çš„æ–° Hash è¡¨ç¬¬ä¸€ä¸ªå…ƒç´ æŒ‡å‘äº†çº¿ç¨‹2æ–° Hash è¡¨çš„ key(3)ã€‚å¥½äº†ï¼Œe å¤„ç†å®Œæ¯•ã€‚
æ‰§è¡Œe = nextï¼Œå°† e æŒ‡å‘ nextï¼Œæ‰€ä»¥æ–°çš„ e æ˜¯ key(7)
ç„¶åè¯¥æ‰§è¡Œ key(3)çš„ next èŠ‚ç‚¹ key(7)äº†:
ç°åœ¨çš„ e èŠ‚ç‚¹æ˜¯ key(7)ï¼Œé¦–å…ˆæ‰§è¡ŒEntry&amp;lt;K,V&amp;gt; next = e.next,é‚£ä¹ˆ next å°±æ˜¯ key(3)äº†
æ‰§è¡Œe.next = newTable[i]ï¼Œäºæ˜¯key(7) çš„ next å°±æˆäº† key(3)
æ‰§è¡ŒnewTable[i] = eï¼Œé‚£ä¹ˆçº¿ç¨‹1çš„æ–° Hash è¡¨ç¬¬ä¸€ä¸ªå…ƒç´ å˜æˆäº† key(7)
æ‰§è¡Œe = nextï¼Œå°† e æŒ‡å‘ nextï¼Œæ‰€ä»¥æ–°çš„ e æ˜¯ key(3)
æ­¤æ—¶çŠ¶æ€ä¸ºï¼š&lt;/p&gt;

&lt;p&gt;ç„¶ååˆè¯¥æ‰§è¡Œ key(7)çš„ next èŠ‚ç‚¹ key(3)äº†ï¼š
ç°åœ¨çš„ e èŠ‚ç‚¹æ˜¯ key(3)ï¼Œé¦–å…ˆæ‰§è¡ŒEntry&amp;lt;K,V&amp;gt; next = e.next,é‚£ä¹ˆ next å°±æ˜¯ null
æ‰§è¡Œe.next = newTable[i]ï¼Œäºæ˜¯key(3) çš„ next å°±æˆäº† key(7)
æ‰§è¡ŒnewTable[i] = eï¼Œé‚£ä¹ˆçº¿ç¨‹1çš„æ–° Hash è¡¨ç¬¬ä¸€ä¸ªå…ƒç´ å˜æˆäº† key(3)
æ‰§è¡Œe = nextï¼Œå°† e æŒ‡å‘ nextï¼Œæ‰€ä»¥æ–°çš„ e æ˜¯ key(7)
è¿™æ—¶å€™çš„çŠ¶æ€å¦‚å›¾æ‰€ç¤ºï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://gitee.com/fwh666/fwh_images/raw/master/fwh_images/image-20210721200914266.png&quot; alt=&quot;image-20210721200914266&quot; style=&quot;zoom:50%;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;å¾ˆæ˜æ˜¾ï¼Œç¯å½¢é“¾è¡¨å‡ºç°äº†ã€‚&lt;/p&gt;

&lt;h2 id=&quot;jdk8-æ‰©å®¹&quot;&gt;Jdk8-æ‰©å®¹&lt;/h2&gt;

&lt;p&gt;Java8 HashMapæ‰©å®¹è·³è¿‡äº†Jdk7æ‰©å®¹çš„å‘ï¼Œå¯¹æºç è¿›è¡Œäº†ä¼˜åŒ–ï¼Œé‡‡ç”¨é«˜ä½ä½æ‹†åˆ†è½¬ç§»æ–¹å¼ï¼Œé¿å…äº†é“¾è¡¨ç¯çš„äº§ç”Ÿã€‚
æ‰©å®¹å‰ï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://gitee.com/fwh666/fwh_images/raw/master/fwh_images/image-20210721200937044.png&quot; alt=&quot;image-20210721200937044&quot; style=&quot;zoom:50%;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;æ‰©å®¹åï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://gitee.com/fwh666/fwh_images/raw/master/fwh_images/image-20210721201000038.png&quot; alt=&quot;image-20210721201000038&quot; style=&quot;zoom:50%;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;ç”±äºJdk8å¼•å…¥äº†æ–°çš„æ•°æ®ç»“æ„ï¼Œæ‰€ä»¥putæ–¹æ³•è¿‡ç¨‹ä¹Ÿæœ‰äº†ä¸€å®šæ”¹è¿›ï¼Œå…¶è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://gitee.com/fwh666/fwh_images/raw/master/fwh_images/image-20210721201021553.png&quot; alt=&quot;image-20210721201021553&quot; style=&quot;zoom:50%;&quot; /&gt;&lt;/p&gt;

&lt;h1 id=&quot;concurrenthashmap&quot;&gt;ConcurrentHashMap&lt;/h1&gt;

&lt;h2 id=&quot;æ•°æ®ç»“æ„-1&quot;&gt;æ•°æ®ç»“æ„&lt;/h2&gt;

&lt;p&gt;ConcurrentHashMapçš„æ•°æ®ç»“æ„ä¸HashMapåŸºæœ¬ç±»ä¼¼ï¼ŒåŒºåˆ«åœ¨äºï¼š1ã€å†…éƒ¨åœ¨æ•°æ®å†™å…¥æ—¶åŠ äº†åŒæ­¥æœºåˆ¶(åˆ†æ®µé”)ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œè¯»æ“ä½œæ˜¯æ— é”æ“ä½œï¼›2ã€æ‰©å®¹æ—¶è€æ•°æ®çš„è½¬ç§»æ˜¯å¹¶å‘æ‰§è¡Œçš„ï¼Œè¿™æ ·æ‰©å®¹çš„æ•ˆç‡æ›´é«˜ã€‚&lt;/p&gt;

&lt;h2 id=&quot;å¹¶å‘å®‰å…¨æ§åˆ¶&quot;&gt;å¹¶å‘å®‰å…¨æ§åˆ¶&lt;/h2&gt;

&lt;p&gt;Java7 ConcurrentHashMapåŸºäºReentrantLockå®ç°åˆ†æ®µé”&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://gitee.com/fwh666/fwh_images/raw/master/fwh_images/image-20210721201057376.png&quot; alt=&quot;image-20210721201057376&quot; style=&quot;zoom:50%;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Java8ä¸­ ConcurrentHashMapåŸºäºåˆ†æ®µé”+CASä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œåˆ†æ®µé”åŸºäºsynchronizedå…³é”®å­—å®ç°ï¼›&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://gitee.com/fwh666/fwh_images/raw/master/fwh_images/image-20210721201130480.png&quot; alt=&quot;image-20210721201130480&quot; style=&quot;zoom:50%;&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;æºç åŸç†åˆ†æ-1&quot;&gt;æºç åŸç†åˆ†æ&lt;/h2&gt;

&lt;h3 id=&quot;é‡è¦æˆå‘˜å˜é‡&quot;&gt;é‡è¦æˆå‘˜å˜é‡&lt;/h3&gt;

&lt;p&gt;ConcurrentHashMapæ‹¥æœ‰å‡ºè‰²çš„æ€§èƒ½, åœ¨çœŸæ­£æŒæ¡å†…éƒ¨ç»“æ„æ—¶, å…ˆè¦æŒæ¡æ¯”è¾ƒé‡è¦çš„æˆå‘˜:
LOAD_FACTOR: è´Ÿè½½å› å­, é»˜è®¤75%, å½“tableä½¿ç”¨ç‡è¾¾åˆ°75%æ—¶, ä¸ºå‡å°‘tableçš„hashç¢°æ’, tabelé•¿åº¦å°†æ‰©å®¹ä¸€å€ã€‚è´Ÿè½½å› å­è®¡ç®—: å…ƒç´ æ€»ä¸ªæ•°%table.lengh
TREEIFY_THRESHOLD: é»˜è®¤8, å½“é“¾è¡¨é•¿åº¦è¾¾åˆ°8æ—¶, å°†ç»“æ„è½¬å˜ä¸ºçº¢é»‘æ ‘ã€‚
UNTREEIFY_THRESHOLD: é»˜è®¤6, çº¢é»‘æ ‘è½¬å˜ä¸ºé“¾è¡¨çš„é˜ˆå€¼ã€‚
MIN_TRANSFER_STRIDE: é»˜è®¤16, tableæ‰©å®¹æ—¶, æ¯ä¸ªçº¿ç¨‹æœ€å°‘è¿ç§»tableçš„æ§½ä½ä¸ªæ•°ã€‚
MOVED: å€¼ä¸º-1, å½“Node.hashä¸ºMOVEDæ—¶, ä»£è¡¨ç€tableæ­£åœ¨æ‰©å®¹
TREEBIN, ç½®ä¸º-2, ä»£è¡¨æ­¤å…ƒç´ åæ¥çº¢é»‘æ ‘ã€‚
nextTable: tableè¿ç§»è¿‡ç¨‹ä¸´æ—¶å˜é‡, åœ¨è¿ç§»è¿‡ç¨‹ä¸­å°†å…ƒç´ å…¨éƒ¨è¿ç§»åˆ°nextTableä¸Šã€‚
sizeCtl: ç”¨æ¥æ ‡å¿—tableåˆå§‹åŒ–å’Œæ‰©å®¹çš„,ä¸åŒçš„å–å€¼ä»£è¡¨ç€ä¸åŒçš„å«ä¹‰:
0: tableè¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–
-1: tableæ­£åœ¨åˆå§‹åŒ–
å°äº-1: å®é™…å€¼ä¸ºresizeStamp(n)Â«RESIZE_STAMP_SHIFT+2, è¡¨æ˜tableæ­£åœ¨æ‰©å®¹
å¤§äº0: åˆå§‹åŒ–å®Œæˆå, ä»£è¡¨tableæœ€å¤§å­˜æ”¾å…ƒç´ çš„ä¸ªæ•°, é»˜è®¤ä¸º0.75*n
transferIndex: tableå®¹é‡ä»næ‰©åˆ°2næ—¶, æ˜¯ä»ç´¢å¼•n-&amp;gt;1çš„å…ƒç´ å¼€å§‹è¿ç§», transferIndexä»£è¡¨å½“å‰å·²ç»è¿ç§»çš„å…ƒç´ ä¸‹æ ‡
ForwardingNode: ä¸€ä¸ªç‰¹æ®Šçš„NodeèŠ‚ç‚¹, å…¶hashcode=MOVED, ä»£è¡¨ç€æ­¤æ—¶tableæ­£åœ¨åšæ‰©å®¹æ“ä½œã€‚æ‰©å®¹æœŸé—´, è‹¥tableæŸä¸ªå…ƒç´ ä¸ºnull, é‚£ä¹ˆè¯¥å…ƒç´ è®¾ç½®ä¸ºForwardingNode, å½“ä¸‹ä¸ªçº¿ç¨‹å‘è¿™ä¸ªå…ƒç´ æ’å…¥æ•°æ®æ—¶, æ£€æŸ¥hashcode=MOVED, å°±ä¼šå¸®ç€æ‰©å®¹ã€‚
    ConcurrentHashMapç”±ä¸‰éƒ¨åˆ†æ„æˆ, table+é“¾è¡¨+çº¢é»‘æ ‘, å…¶ä¸­tableæ˜¯ä¸€ä¸ªæ•°ç»„, æ—¢ç„¶æ˜¯æ•°ç»„, å¿…é¡»è¦åœ¨ä½¿ç”¨æ—¶ç¡®å®šæ•°ç»„çš„å¤§å°, å½“tableå­˜æ”¾çš„å…ƒç´ è¿‡å¤šæ—¶, å°±éœ€è¦æ‰©å®¹, ä»¥å‡å°‘ç¢°æ’å‘ç”Ÿæ¬¡æ•°, æœ¬æ–‡å°±è®²è§£æ‰©å®¹çš„è¿‡ç¨‹ã€‚æ‰©å®¹æ£€æŸ¥ä¸»è¦å‘ç”Ÿåœ¨æ’å…¥å…ƒç´ (putVal())çš„è¿‡ç¨‹:
ä¸€ä¸ªçº¿ç¨‹æ’å®Œå…ƒç´ å, æ£€æŸ¥tableä½¿ç”¨ç‡, è‹¥è¶…è¿‡é˜ˆå€¼, è°ƒç”¨transferè¿›è¡Œæ‰©å®¹
ä¸€ä¸ªçº¿ç¨‹æ’å…¥æ•°æ®æ—¶, å‘ç°tableå¯¹åº”å…ƒç´ çš„hash=MOVED, é‚£ä¹ˆè°ƒç”¨helpTransfer()ååŠ©æ‰©å®¹ã€‚&lt;/p&gt;

&lt;h3 id=&quot;ååŠ©æ‰©å®¹helptransfer&quot;&gt;ååŠ©æ‰©å®¹helpTransfer&lt;/h3&gt;

&lt;p&gt;ä¸‹é¢æ˜¯ååŠ©æ‰©å®¹çš„è¿‡ç¨‹&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;V&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;[]&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;helpTransfer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;V&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;[]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tab&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;V&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//tableæ‰©å®¹&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;Node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;V&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;[]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nextTab&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tab&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;f&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;instanceof&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ForwardingNode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nextTab&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ForwardingNode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;V&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;)&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;nextTable&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;c1&quot;&gt;// æ ¹æ® length å¾—åˆ°ä¸€ä¸ªæ ‡è¯†ç¬¦å·&lt;/span&gt;
            &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;resizeStamp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tab&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nextTab&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nextTable&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;table&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tab&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt;
                   &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sizeCtl&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;//è¯´æ˜è¿˜åœ¨æ‰©å®¹&lt;/span&gt;
                &lt;span class=&quot;c1&quot;&gt;//åˆ¤æ–­æ˜¯å¦æ ‡å¿—å‘ç”Ÿäº†å˜åŒ–||  æ‰©å®¹ç»“æŸäº†&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RESIZE_STAMP_SHIFT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt;
                     &lt;span class=&quot;c1&quot;&gt;//è¾¾åˆ°æœ€å¤§çš„å¸®åŠ©çº¿ç¨‹ ||  åˆ¤æ–­æ‰©å®¹è½¬ç§»ä¸‹æ ‡æ˜¯å¦åœ¨è°ƒæ•´ï¼ˆæ‰©å®¹ç»“æŸï¼‰&lt;/span&gt;
                    &lt;span class=&quot;n&quot;&gt;sc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;MAX_RESIZERS&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;transferIndex&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
                    &lt;span class=&quot;k&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                &lt;span class=&quot;c1&quot;&gt;// å°† sizeCtl + 1, ï¼ˆè¡¨ç¤ºå¢åŠ äº†ä¸€ä¸ªçº¿ç¨‹å¸®åŠ©å…¶æ‰©å®¹ï¼‰&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;U&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;compareAndSwapInt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SIZECTL&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;n&quot;&gt;transfer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tab&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nextTab&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
                    &lt;span class=&quot;k&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nextTab&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;table&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;ä¸»è¦åšäº†å¦‚ä¸‹äº‹æƒ…:
æ£€æŸ¥æ˜¯å¦æ‰©å®¹å®Œæˆ
å¯¹sizeCtrl = sizeCtrl+1, ç„¶åè°ƒç”¨transfer()è¿›è¡ŒçœŸæ­£çš„æ‰©å®¹ã€‚&lt;/p&gt;

&lt;h3 id=&quot;æ‰©å®¹transfer&quot;&gt;æ‰©å®¹transfer&lt;/h3&gt;

&lt;p&gt;æ‰©å®¹çš„æ•´ä½“æ­¥éª¤å°±æ˜¯æ–°å»ºä¸€ä¸ªnextTab, sizeæ˜¯ä¹‹å‰çš„2å€, å°†tableä¸Šçš„éç©ºå…ƒç´ è¿ç§»åˆ°nextTabä¸Šé¢å»ã€‚&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;transfer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;V&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;[]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tab&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;V&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;[]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nextTab&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tab&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;stride&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;stride&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NCPU&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;NCPU&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;MIN_TRANSFER_STRIDE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
       &lt;span class=&quot;c1&quot;&gt;// subdivide rangeï¼Œæ¯ä¸ªçº¿ç¨‹æœ€å°‘è¿ç§»16ä¸ªæ§½ä½ï¼Œå¤§çš„è¯ï¼Œæœ€å¤š&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;stride&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;MIN_TRANSFER_STRIDE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// initiating  æ‰å¼€å§‹åˆå§‹åŒ–æ–°çš„nextTab&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nextTab&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;nd&quot;&gt;@SuppressWarnings&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;unchecked&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;Node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;V&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;[]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nt&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;V&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;[])&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;?,?&amp;gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;];&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;//æ‰©å®¹2å€&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;nextTab&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Throwable&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;      &lt;span class=&quot;c1&quot;&gt;// try to cope with OOME&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;sizeCtl&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Integer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;MAX_VALUE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;nextTable&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nextTab&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;transferIndex&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;//æ›´æ–°çš„è½¬ç§»ä¸‹æ ‡ï¼Œ&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nextn&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nextTab&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;ForwardingNode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;V&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fwd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ForwardingNode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;V&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nextTab&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;//æ˜¯å¦èƒ½å¤Ÿå‘å‰æ¨è¿›åˆ°ä¸‹ä¸€ä¸ªå‘¨æœŸ&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;advance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// to ensure sweep before committing nextTabï¼Œå®ŒæˆçŠ¶æ€ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ç»“æŸæ­¤æ–¹æ³•&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;finishing&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bound&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;Node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;V&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fh&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;advance&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//å–ä¸‹ä¸€ä¸ªå‘¨æœŸ&lt;/span&gt;
            &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nextIndex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nextBound&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;c1&quot;&gt;//æœ¬çº¿ç¨‹å¤„ç†çš„åŒºé—´èŒƒå›´ä¸º[bound, i),èŒƒå›´è¿˜æ²¡æœ‰å¤„ç†å®Œæˆï¼Œé‚£ä¹ˆå°±ç»§ç»­å¤„ç†&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(--&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bound&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;finishing&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;advance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;c1&quot;&gt;//ç›®å‰å¤„ç†åˆ°äº†è¿™é‡Œï¼ˆä»å¤§åˆ°å°ï¼Œ ä¸‹çº¿ï¼‰ï¼Œå¼€å§‹æ‰¾æ–°çš„ä¸€è½®çš„åŒºé—´&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nextIndex&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;transferIndex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;advance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
            &lt;span class=&quot;c1&quot;&gt;//è¿™ä¸ªæ¡ä»¶æ”¹å˜çš„æ˜¯transferIndexçš„å€¼ï¼Œä»16å˜æˆäº†1&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;U&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;compareAndSwapInt&lt;/span&gt;
                     &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TRANSFERINDEX&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nextIndex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;
                     &lt;span class=&quot;c1&quot;&gt;//nextBound æ˜¯è¿™æ¬¡è¿ç§»ä»»åŠ¡çš„è¾¹ç•Œï¼Œæ³¨æ„ï¼Œæ˜¯ä»åå¾€å‰&lt;/span&gt;
                      &lt;span class=&quot;n&quot;&gt;nextBound&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nextIndex&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;stride&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;?&lt;/span&gt;
                                   &lt;span class=&quot;n&quot;&gt;nextIndex&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;stride&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;bound&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nextBound&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//ä¸€å—åŒºé—´æœ€å°æ¡¶çš„ä¸‹æ ‡&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nextIndex&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//èƒ½å¤Ÿå¤„ç†çš„æœ€å¤§æ¡¶çš„ä¸‹æ ‡&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;advance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nextn&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//æ¯ä¸ªè¿ç§»çº¿ç¨‹éƒ½èƒ½è¾¾åˆ°è¿™é‡Œ&lt;/span&gt;
            &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;finishing&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//è¿ç§»å®Œæˆ&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;nextTable&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                &lt;span class=&quot;c1&quot;&gt;//ç›´æ¥æŠŠä»¥å‰çš„tableä¸¢å¼ƒäº†ï¼Œä¸Šé¢çš„MOVEç­‰æ ‡å¿—å…¨éƒ¨ä¸¢å¼ƒï¼Œä½¿ç”¨æ–°çš„&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;table&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nextTab&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;sizeCtl&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//æ‰©å¤§2n-0.5n = 1.50n, æ›´æ–°æ–°çš„å®¹é‡é˜ˆå€¼&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
            &lt;span class=&quot;c1&quot;&gt;//è¡¨ç¤ºå½“å‰çº¿ç¨‹è¿ç§»å®Œæˆäº†&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;U&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;compareAndSwapInt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SIZECTL&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sizeCtl&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                 &lt;span class=&quot;c1&quot;&gt;//æ³¨æ„æ­¤æ—¶scçš„å€¼å¹¶ä¸ç­‰äºsizeCtlï¼Œä¸Šä¸€æ­¥ï¼ŒsizeCtl=sizeCtl-1äº†ã€‚è¿™ä¸¤ä¸ªå¯¹è±¡è¿˜æ˜¯åˆ†å‰²çš„&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;resizeStamp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RESIZE_STAMP_SHIFT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
                    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;finishing&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;advance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// recheck before commit&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;//å¦‚æœå¯¹åº”ä½ç½®ä¸ºnullï¼Œ åˆ™å°†ForwardingNodeæ”¾åœ¨å¯¹åº”çš„åœ°æ–¹&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;f&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tabAt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tab&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;advance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;casTabAt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tab&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fwd&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fh&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;hash&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;MOVED&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//åˆ«çš„çº¿ç¨‹å·²ç»åœ¨å¤„ç†äº†ï¼Œå†æ¨è¿›ä¸€ä¸ªä¸‹æ ‡&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;advance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// already processedï¼Œæ¨åŠ¨åˆ°ä¸‹ä¸€ä¸ªå‘¨æœŸï¼Œä»ç„¶ä¼šæ£€æŸ¥iä¸boundæ˜¯å¦ç»“æŸ&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//è¯´æ˜ä½ç½®ä¸Šæœ‰å€¼äº†ï¼Œ&lt;/span&gt;
            &lt;span class=&quot;c1&quot;&gt;//éœ€è¦åŠ é”ï¼Œé˜²æ­¢å†å‘é‡Œé¢æ”¾å€¼ï¼Œåœ¨æ”¾æ•°æ®æ—¶ï¼Œä¹Ÿä¼šé”ä½ã€‚æ¯”å¦‚æ•´ä¸ªtableæ­£åœ¨è¿ç§»ï¼Œè¿˜æ²¡æœ‰è¿ç§»åˆ°è¿™ä¸ªå…ƒç´ ï¼Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹å‘è¿™ä¸ªèŠ‚ç‚¹æ’å…¥æ•°æ®ï¼Œæ­¤æ—¶è¿ç§»åˆ°è¿™é‡Œäº†ï¼Œä¼šè¢«é˜»å¡ä½&lt;/span&gt;
            &lt;span class=&quot;kd&quot;&gt;synchronized&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tabAt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tab&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;//åˆ¤æ–­iä¸‹æ ‡å’Œfæ˜¯å¦ç›¸åŒ&lt;/span&gt;
                    &lt;span class=&quot;n&quot;&gt;Node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;V&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ln&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;hn&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//é«˜ä½æ¡¶ï¼Œ åœ°ä½æ¡¶&lt;/span&gt;
                    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fh&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                        &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;runBit&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fh&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;//nä¸º2^n, å–ä½™ååªèƒ½æ˜¯2^n&lt;/span&gt;
                        &lt;span class=&quot;n&quot;&gt;Node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;V&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lastRun&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                        &lt;span class=&quot;c1&quot;&gt;///æ‰¾åˆ°æœ€åä¸€ä¸ªä¸å’Œfnç›¸åŒçš„èŠ‚ç‚¹&lt;/span&gt;
                        &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;V&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;next&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;next&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                            &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;hash&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                            &lt;span class=&quot;c1&quot;&gt;//åªè¦æ‰¾åˆ°è¿™ï¼Œä¹‹åçš„å–å€¼éƒ½æ˜¯ä¸€æ ·çš„ï¼Œä¸‹æ¬¡å¾ªç¯æ—¶ï¼Œå°±ä¸ç”¨å†å¾ªç¯åé¢çš„&lt;/span&gt;
                            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;runBit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                                &lt;span class=&quot;n&quot;&gt;runBit&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                                &lt;span class=&quot;n&quot;&gt;lastRun&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                            &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
                        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
                        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;runBit&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                            &lt;span class=&quot;n&quot;&gt;ln&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lastRun&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                            &lt;span class=&quot;n&quot;&gt;hn&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
                        &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//æ¯”å¦‚1ï¼Œ16ï¼Œ32,å¦‚æœä½ä½%16ï¼Œé‚£ä¹ˆè‚¯å®šæ˜¯0ã€‚&lt;/span&gt;
                            &lt;span class=&quot;n&quot;&gt;hn&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lastRun&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                            &lt;span class=&quot;n&quot;&gt;ln&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
                        &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;V&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lastRun&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;next&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                            &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ph&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;hash&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;K&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pk&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;V&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pv&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;val&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ph&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
                                 &lt;span class=&quot;c1&quot;&gt;//è¿™æ ·å°±æŠŠç›¸åŒä¸²çš„ç»™ä¸²èµ·æ¥äº†&lt;/span&gt;
                                &lt;span class=&quot;n&quot;&gt;ln&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;V&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ph&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pk&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pv&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ln&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
                            &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
                                &lt;span class=&quot;c1&quot;&gt;//è¿™æ ·å°±æŠŠç›¸åŒä¸²çš„ç»™ä¸²èµ·æ¥äº†ï¼Œæ³¨æ„è¿™é‡Œlnç”¨æ³•ï¼Œç¬¬ä¸€ä¸ªnextä¸ºnullï¼Œçƒ¦ç€ä¸²èµ·æ¥äº†ã€‚&lt;/span&gt;
                                &lt;span class=&quot;n&quot;&gt;hn&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;V&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ph&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pk&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pv&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;hn&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
                        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
                        &lt;span class=&quot;n&quot;&gt;setTabAt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nextTab&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ln&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//åç€ç»™ä¸²èµ·æ¥äº†&lt;/span&gt;
                        &lt;span class=&quot;n&quot;&gt;setTabAt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nextTab&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;hn&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
                        &lt;span class=&quot;n&quot;&gt;setTabAt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tab&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fwd&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
                        &lt;span class=&quot;n&quot;&gt;advance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
                    &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;f&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;instanceof&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TreeBin&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;// å¦‚æœæ˜¯çº¢é»‘æ ‘&lt;/span&gt;
                        &lt;span class=&quot;n&quot;&gt;TreeBin&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;V&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;TreeBin&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;V&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;)&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                        &lt;span class=&quot;n&quot;&gt;TreeNode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;V&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lo&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;loTail&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//ä¹Ÿæ˜¯é«˜ä½èŠ‚ç‚¹&lt;/span&gt;
                        &lt;span class=&quot;n&quot;&gt;TreeNode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;V&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;hi&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;hiTail&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;//ä¹Ÿæ˜¯é«˜ä½èŠ‚ç‚¹&lt;/span&gt;
                        &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;hc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                        &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;V&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;first&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;next&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//ä¸­åºéå†çº¢é»‘æ ‘&lt;/span&gt;
                            &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;h&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;hash&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                            &lt;span class=&quot;n&quot;&gt;TreeNode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;V&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TreeNode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;V&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;
                                &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;h&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;val&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
                            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;h&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//0çš„æ”¾ä½ä½&lt;/span&gt;
                                &lt;span class=&quot;c1&quot;&gt;//æ³¨æ„è¿™é‡Œp.prev = loTailï¼Œæ¯ä¸€ä¸ªpéƒ½æ˜¯ä¸‹ä¸€ä¸ªçš„prev&lt;/span&gt;
                                &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;prev&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;loTail&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
                                    &lt;span class=&quot;n&quot;&gt;lo&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//æŠŠå¤´è®°ä½&lt;/span&gt;
                                &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
                                    &lt;span class=&quot;n&quot;&gt;loTail&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;next&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;//ä¸Šä¸€æ¬¡çš„pçš„nextæ˜¯è¿™æ¬¡çš„p&lt;/span&gt;
                                &lt;span class=&quot;n&quot;&gt;loTail&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//æŠŠä¸Šæ¬¡pç»™è®°ä½&lt;/span&gt;
                                &lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                            &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
                            &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//é«˜ä½&lt;/span&gt;
                                &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;prev&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;hiTail&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
                                    &lt;span class=&quot;n&quot;&gt;hi&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//æŠŠå°¾è®°ä½&lt;/span&gt;
                                &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
                                    &lt;span class=&quot;n&quot;&gt;hiTail&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;next&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                                &lt;span class=&quot;n&quot;&gt;hiTail&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                                &lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;hc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                            &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
                        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
                        &lt;span class=&quot;n&quot;&gt;ln&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;UNTREEIFY_THRESHOLD&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;untreeify&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;// //åˆ¤æ–­æ˜¯å¦éœ€è¦è½¬åŒ–ä¸ºæ ‘&lt;/span&gt;
                            &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;hc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TreeBin&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;V&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//å¦‚æœæ²¡æœ‰é«˜ä½çš„è¯ï¼Œåˆ™éƒ¨åˆ†ä¸ºä¸¤ä¸ªæ ‘&lt;/span&gt;
                        &lt;span class=&quot;n&quot;&gt;hn&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;hc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;UNTREEIFY_THRESHOLD&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;untreeify&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;hi&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
                            &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TreeBin&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;V&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;hi&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                        &lt;span class=&quot;n&quot;&gt;setTabAt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nextTab&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ln&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
                        &lt;span class=&quot;n&quot;&gt;setTabAt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nextTab&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;hn&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
                        &lt;span class=&quot;n&quot;&gt;setTabAt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tab&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fwd&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
                        &lt;span class=&quot;n&quot;&gt;advance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
                    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
                &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;å…¶ä¸­æœ‰ä¸¤ä¸ªå˜é‡éœ€è¦äº†è§£ä¸‹:
advance: è¡¨ç¤ºæ˜¯å¦å¯ä»¥å‘ä¸‹ä¸€ä¸ªè½®å…ƒç´ è¿›è¡Œè¿ç§»ã€‚
finishing: tableæ‰€æœ‰å…ƒç´ æ˜¯å¦è¿ç§»å®Œæˆã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;å¤§è‡´åšäº†å¦‚ä¸‹äº‹æƒ…:&lt;/strong&gt;
ç¡®å®šçº¿ç¨‹æ¯è½®è¿ç§»å…ƒç´ çš„ä¸ªæ•°stride, æ¯”å¦‚è¿›æ¥ä¸€ä¸ªçº¿ç¨‹, ç¡®å®šæ‰©å®¹tableä¸‹æ ‡ä¸º(a,b]ä¹‹é—´å…ƒç´ , ä¸‹ä¸€ä¸ªçº¿ç¨‹æ‰©å®¹(b,c]ã€‚è¿™é‡Œå¯¹b-aæˆ–è€…c-bä¹Ÿæ˜¯ç”±æœ€å°å€¼16é™åˆ¶çš„ã€‚ ä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªçº¿ç¨‹æœ€å°‘æ‰©å®¹è¿ç»­16ä¸ªtableçš„å…ƒç´ ã€‚è€Œæ ‡å¿—å½“å‰è¿ç§»çš„ä¸‹æ ‡ä¿å­˜åœ¨transferIndexé‡Œé¢ã€‚
æ£€æŸ¥nextTabæ˜¯å¦å®Œæˆåˆå§‹åŒ–, è‹¥æ²¡æœ‰çš„è¯, è¯´æ˜æ˜¯ç¬¬ä¸€ä¸ªè¿ç§»çš„çº¿ç¨‹, å…ˆåˆå§‹åŒ–nextTab, sizeæ˜¯ä¹‹å‰tableçš„2å€ã€‚
è¿›å…¥whileå¾ªç¯æŸ¥æ‰¾æœ¬è½®è¿ç§»çš„tableä¸‹æ ‡å…ƒç´ åŒºé—´, ä¿å­˜åœ¨(bound, i]ä¸­, æ³¨æ„è¿™é‡Œæ˜¯åŠå¼€åŠé—­åŒºé—´ã€‚
ä»i -&amp;gt; boundå¼€å§‹éå†tableä¸­æ¯ä¸ªå…ƒç´ , è¿™é‡Œæ˜¯ä»å¤§åˆ°å°éå†çš„:
è‹¥è¯¥å…ƒç´ ä¸ºç©º, åˆ™å‘è¯¥å…ƒç´ æ ‡å†™å…¥ForwardingNode, ç„¶åæ£€æŸ¥ä¸‹ä¸€ä¸ªå…ƒç´ ã€‚ å½“åˆ«çš„çº¿ç¨‹å‘è¿™ä¸ªå…ƒç´ æ’å…¥æ•°æ®æ—¶, æ ¹æ®è¿™ä¸ªæ ‡å¿—ç¬¦çŸ¥é“äº†tableæ­£åœ¨è¢«åˆ«çš„çº¿ç¨‹è¿ç§», åœ¨putValä¸­å°±ä¼šè°ƒç”¨helpTransferå¸®ç€è¿ç§»ã€‚
è‹¥è¯¥å…ƒç´ çš„hash=MOVED, ä»£è¡¨æ¬¡tableæ­£åœ¨å¤„äºè¿ç§»ä¹‹ä¸­, è·³è¿‡ã€‚ æŒ‰é“ç†ä¸ä¼šè·‘ç€è¿™é‡Œçš„ã€‚
å¦åˆ™è¯´æ˜è¯¥å…ƒç´ è·Ÿç€çš„æ˜¯ä¸€ä¸ªé“¾è¡¨æˆ–è€…æ˜¯ä¸ªçº¢é»‘æ ‘ç»“æ„, è‹¥hash&amp;gt;0, åˆ™è¯´æ˜æ˜¯ä¸ªé“¾è¡¨, è‹¥f instanceof TreeBin, åˆ™è¯´æ˜æ˜¯ä¸ªçº¢é»‘æ ‘ç»“æ„ã€‚
é“¾è¡¨è¿ç§»åŸç†å¦‚ä¸‹: éå†é“¾è¡¨æ¯ä¸ªèŠ‚ç‚¹ã€‚ è‹¥èŠ‚ç‚¹çš„f.hash&amp;amp;n==0æˆç«‹, åˆ™å°†èŠ‚ç‚¹æ”¾åœ¨i, å¦åˆ™, åˆ™å°†èŠ‚ç‚¹æ”¾åœ¨n+iä¸Šé¢ã€‚
    è¿ç§»å‰, å¯¹è¯¥å…ƒç´ è¿›è¡ŒåŠ é”ã€‚ éå†é“¾è¡¨æ—¶, è¿™é‡Œä½¿ç”¨lastRunå˜é‡, ä¿ç•™çš„æ˜¯ä¸Šæ¬¡hashçš„å€¼, å‡å¦‚æ•´ä¸ªé“¾è¡¨å…¨éƒ¨èŠ‚ç‚¹f.hash&amp;amp;n==0, é‚£ä¹ˆç¬¬äºŒæ¬¡éå†, åªè¦æ‰¾åˆ°lastRunçš„å€¼, é‚£ä¹ˆè®¤ä¸ºä¹‹åçš„èŠ‚ç‚¹éƒ½æ˜¯ç›¸åŒå€¼, å‡å°‘äº†ä¸å¿…è¦çš„f.hash&amp;amp;nå–å€¼ã€‚éå†å®Œæ‰€æœ‰çš„èŠ‚ç‚¹å, æ­¤æ—¶å½¢æˆäº†ä¸¤æ¡é“¾è¡¨, lnå­˜æ”¾çš„æ˜¯f.hash&amp;amp;n=0çš„èŠ‚ç‚¹, hnå­˜æ”¾çš„æ˜¯é0çš„èŠ‚ç‚¹, ç„¶åå°†lnå­˜æ”¾åœ¨nextTableç¬¬iå…ƒç´ çš„ä½ç½®, n+iå­˜æ”¾åœ¨n+içš„ä½ç½®ã€‚
è“è‰²èŠ‚ç‚¹ä»£è¡¨:f.hash&amp;amp;n==0, ç»¿è‰²èŠ‚ç‚¹ä»£è¡¨f.hash&amp;amp;n!=0ã€‚ æœ€ç»ˆè“è‰²çš„èŠ‚ç‚¹ä»åœ¨å­˜æ”¾åœ¨(0, n)èŒƒå›´é‡Œ, ç»¿çš„èŠ‚ç‚¹å­˜æ”¾åœ¨(n, 2n-1)çš„èŒƒå›´ä¹‹å†…ã€‚
è¿ç§»é“¾è¡¨å’Œçº¢é»‘æ ‘çš„åŸç†æ˜¯ä¸€æ ·çš„, åœ¨çº¢é»‘æ ‘ä¸­, æˆ‘ä»¬è®°å½•äº†æ¯ä¸ªçº¢é»‘æ ‘çš„first(è¿™ä¸ªèŠ‚ç‚¹ä¸æ˜¯hashæœ€å°çš„èŠ‚ç‚¹)å’Œæ¯ä¸ªèŠ‚ç‚¹çš„next, æ ¹æ®è¿™ä¸¤ä¸ªå…ƒç´ , æˆ‘ä»¬å¯ä»¥è®¿é—®çº¢é»‘æ ‘æ‰€æœ‰çš„å…ƒç´ , çº¢é»‘æ ‘æ­¤æ—¶ä¹Ÿæ˜¯ä¸€ä¸ªé“¾è¡¨, çº¢é»‘æ ‘å’Œé“¾è¡¨è¿ç§»çš„è¿‡ç¨‹ä¸€æ ·ã€‚çº¢é»‘æ ‘æ ¹æ®è¿ç§»åæ‹†åˆ†æˆäº†hnå’Œln, æ ¹æ®é“¾è¡¨é•¿åº¦ç¡®å®šé“¾è¡¨æ˜¯çº¢é»‘æ ‘ç»“æ„è¿˜æ˜¯é€€åŒ–ä¸ºäº†é“¾è¡¨ã€‚
4.å¦‚ä½•ç¡®å®štableæ‰€æœ‰å…ƒç´ è¿ç§»å®Œæˆ:&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;//è¡¨ç¤ºå½“å‰çº¿ç¨‹è¿ç§»å®Œæˆäº†&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;U&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;compareAndSwapInt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SIZECTL&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sizeCtl&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
     &lt;span class=&quot;c1&quot;&gt;//æ³¨æ„æ­¤æ—¶scçš„å€¼å¹¶ä¸ç­‰äºsizeCtlï¼Œä¸Šä¸€æ­¥ï¼ŒsizeCtl=sizeCtl-1äº†ã€‚è¿™ä¸¤ä¸ªå¯¹è±¡è¿˜æ˜¯åˆ†å‰²çš„&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;resizeStamp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RESIZE_STAMP_SHIFT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;finishing&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;advance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// recheck before commit&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;ç¬¬ä¸€ä¸ªçº¿ç¨‹å¼€å§‹è¿ç§»æ—¶, è®¾ç½®äº†sizeCtl= resizeStamp(n) Â«Â RESIZE_STAMP_SHIFT+2, æ­¤åæ¯ä¸ªæ–°æ¥å¸®åŠ©è¿ç§»çš„çº¿ç¨‹éƒ½ä¼šsizeCtl=sizeCtl+1, å®Œæˆè¿ç§»å,sizeCtl-1, é‚£ä¹ˆåªè¦æœ‰ä¸€ä¸ªçº¿ç¨‹è¿˜å¤„äºè¿ç§»çŠ¶æ€, é‚£ä¹ˆsizeCtl&amp;gt; resizeStamp(n) Â«Â RESIZE_STAMP_SHIFT+2ä¸€ç›´æˆç«‹, å½“åªæœ‰æœ€åä¸€ä¸ªçº¿ç¨‹å®Œæˆè¿ç§»ä¹‹å, ç­‰å¼ä¸¤è¾¹æ‰æˆç«‹ã€‚ å¯èƒ½å¤§å®¶ä¼šæœ‰ç–‘é—®, ç¬¬ä¸€ä¸ªçº¿ç¨‹å¹¶æ²¡æœ‰å¯¹sizeCtl=sizeCtl+1, æ­¤æ—¶å®Œæˆåå†å‡ä¸€, é‚£ä¸æ˜¯ä¸ç›¸ç­‰äº†å—, æ³¨æ„è¿™é‡Œ, sizeCtlåœ¨å‡ä¸€å‰, å°†å€¼èµ‹ç»™äº†sc, ç­‰å¼æ¯”è¾ƒçš„æ˜¯scã€‚
æ€»ç»“
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€“
tableæ‰©å®¹è¿‡ç¨‹å°±æ˜¯å°†tableå…ƒç´ è¿ç§»åˆ°æ–°çš„tableä¸Š, åœ¨å…ƒç´ è¿ç§»æ—¶, å¯ä»¥å¹¶å‘å®Œæˆ, åŠ å¿«äº†è¿ç§»é€Ÿåº¦, åŒæ—¶ä¸è‡³äºé˜»å¡çº¿ç¨‹ã€‚æ‰€æœ‰å…ƒç´ è¿ç§»å®Œæˆå, æ—§çš„tableç›´æ¥ä¸¢å¤±, ç›´æ¥ä½¿ç”¨æ–°çš„tableã€‚&lt;/p&gt;

&lt;h1 id=&quot;copyonwriteæœºåˆ¶&quot;&gt;CopyOnWriteæœºåˆ¶&lt;/h1&gt;

&lt;p&gt;æ ¸å¿ƒæ€æƒ³ï¼šè¯»å†™åˆ†ç¦»ï¼Œç©ºé—´æ¢æ—¶é—´ï¼Œé¿å…ä¸ºä¿è¯å¹¶å‘å®‰å…¨å¯¼è‡´çš„æ¿€çƒˆçš„é”ç«äº‰ã€‚
åˆ’å…³é”®ç‚¹ï¼š
1ã€CopyOnWriteé€‚ç”¨äºè¯»å¤šå†™å°‘çš„æƒ…å†µï¼Œæœ€å¤§ç¨‹åº¦çš„æé«˜è¯»çš„æ•ˆç‡ï¼›
2ã€CopyOnWriteæ˜¯æœ€ç»ˆä¸€è‡´æ€§ï¼Œåœ¨å†™çš„è¿‡ç¨‹ä¸­ï¼ŒåŸæœ‰çš„è¯»çš„æ•°æ®æ˜¯ä¸ä¼šå‘ç”Ÿæ›´æ–°çš„ï¼Œåªæœ‰æ–°çš„è¯»æ‰èƒ½è¯»åˆ°æœ€æ–°æ•°æ®ï¼›
3ã€å¦‚ä½•ä½¿å…¶ä»–çº¿ç¨‹èƒ½å¤ŸåŠæ—¶è¯»åˆ°æ–°çš„æ•°æ®ï¼Œéœ€è¦ä½¿ç”¨volatileå˜é‡ï¼›
4ã€å†™çš„æ—¶å€™ä¸èƒ½å¹¶å‘å†™ï¼Œéœ€è¦å¯¹å†™æ“ä½œè¿›è¡ŒåŠ é”ï¼›&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://gitee.com/fwh666/fwh_images/raw/master/fwh_images/image-20210721201347355.png&quot; alt=&quot;image-20210721201347355&quot; style=&quot;zoom:50%;&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;æºç åŸç†&quot;&gt;æºç åŸç†&lt;/h2&gt;

&lt;p&gt;å†™æ—¶å¤åˆ¶&lt;/p&gt;

&lt;div class=&quot;language-java highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;cm&quot;&gt;/*

 *   æ·»åŠ å…ƒç´ api
      */&lt;/span&gt;
     &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;add&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;E&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
     &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ReentrantLock&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lock&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;lock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
     &lt;span class=&quot;n&quot;&gt;lock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;lock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
     &lt;span class=&quot;k&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
         &lt;span class=&quot;n&quot;&gt;Object&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elements&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;getArray&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
         &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;len&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elements&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
         &lt;span class=&quot;n&quot;&gt;Object&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;newElements&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Arrays&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;copyOf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;elements&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;len&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//å¤åˆ¶ä¸€ä¸ªarrayå‰¯æœ¬&lt;/span&gt;
         &lt;span class=&quot;n&quot;&gt;newElements&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//å¾€å‰¯æœ¬é‡Œå†™å…¥&lt;/span&gt;
         &lt;span class=&quot;n&quot;&gt;setArray&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;newElements&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//å‰¯æœ¬æ›¿æ¢åŸæœ¬ï¼Œæˆä¸ºæ–°çš„åŸæœ¬&lt;/span&gt;
         &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
     &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;finally&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
         &lt;span class=&quot;n&quot;&gt;lock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;unlock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
     &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
     &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
     &lt;span class=&quot;c1&quot;&gt;//è¯»api&lt;/span&gt;
     &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;E&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;index&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
     &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;getArray&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;index&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//æ— é”&lt;/span&gt;
     &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</content><author><name>WenHao</name></author><summary type="html">HashMap</summary></entry></feed>